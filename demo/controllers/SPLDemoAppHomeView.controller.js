/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.controller("splDemoController.SPLDemoAppHomeView",{demoODataModel:new sap.ui.model.odata.ODataModel(oSapSplUtils.getFQServiceUrl("/sap/spl/xs/demoSetup/services/demo.xsodata"),true),iInterval:null,selectedOrganizationId:null,selectedVehicleId:null,vehicleMessagePaths:{messagePath1:null,messagePath2:null},dateFormatter:function(d){if(d){return sap.ui.core.format.DateFormat.getDateInstance({pattern:"MMM dd, yyyy - HH:mm:ss",style:"short"},sap.ui.getCore().getConfiguration().getLocale()).format(new Date(d),true);}},onInit:function(){sap.ui.getCore().setModel(new sap.ui.model.json.JSONModel({}),"demoDataModel");sap.ui.getCore().setModel(new sap.ui.model.json.JSONModel({}),"demoVehicleListModel");sap.ui.getCore().setModel(new sap.ui.model.json.JSONModel({}),"demoMessageListModel");sap.ui.getCore().setModel(new sap.ui.model.json.JSONModel({}),"demoAllToursListModel");sap.ui.getCore().setModel(new sap.ui.model.json.JSONModel({}),"demoCurrentToursListModel");this.demoODataModel.setSizeLimit(1000);this.getOrganizationList();this.bindStopsLayout();this.bindAllToursLayout();},onBeforeRendering:function(){},postEventData:function(e){var t=this;var p={"action":"stopEvent","VehicleUUID":this.selectedVehicleId,"stopEvent":{"BusinessPartnerUUID":this.oSelectedOrgUUID,"TourUUID":e.getSource().getBindingContext().getObject()["tourUUID"],"StopUUID":e.getSource().getBindingContext().getObject()["stopUUID"],"EventCode":e.getSource().getBindingContext().getObject()["name"],"OccurranceTime":new Date().toJSON()}};$.ajax({url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/demoSetup/services/tours.xsjs"),async:true,type:"POST",contentType:"json; charset=UTF-8",beforeSend:function(){},data:JSON.stringify(p),success:function(d){if(d.constructor===String){d=JSON.parse(d);}t.getTourData(t.selectedVehicleId);},error:function(){sap.m.MessageToast.show("Stop Event Trigger Failed");},complete:function(){}});},postEventDataForTour:function(e){var t=this;var p={"action":"tourEvent","VehicleUUID":this.selectedVehicleId,"tourEvent":{"BusinessPartnerUUID":this.oSelectedOrgUUID,"TourUUID":e.getSource().getBindingContext().getObject()["tourUUID"],"StopUUID":e.getSource().getBindingContext().getObject()["stopUUID"],"EventCode":e.getSource().getBindingContext().getObject()["name"],"OccurranceTime":new Date().toJSON(),}};$.ajax({url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/demoSetup/services/tours.xsjs"),async:true,type:"POST",contentType:"json; charset=UTF-8",beforeSend:function(){},data:JSON.stringify(p),success:function(d){if(d.constructor===String){d=JSON.parse(d);}t.getTourData(t.selectedVehicleId);},error:function(){sap.m.MessageToast.show("Stop Event Trigger Failed");},complete:function(){}});},bindAllToursLayout:function(){var t=this;this.byId("allToursList").bindAggregation("items","/",function(i,o){return new sap.m.CustomListItem({content:new sap.m.Bar({design:"Header",contentLeft:new sap.m.Label({text:"{Name}"}),contentRight:{path:o.getPath()+"/actions",template:new sap.m.Button({text:"{description}",type:"Emphasized",visible:"{enabled}",press:jQuery.proxy(t.postEventDataForTour,t)})}})});});this.byId("allToursList").setModel(sap.ui.getCore().getModel("demoAllToursListModel"));},bindStopsLayout:function(){var t=this;this.byId("sapSplDemoStopsLayout").bindAggregation("content","/stops",function(i,o){if(o.getObject().Status==="A"||o.getObject().Status==="I"){return new sap.m.Panel({headerText:"{Name}",expanded:true,expandable:((o.getObject().actionGroups!==undefined&&o.getObject().actionGroups.length>0)?true:false),}).addStyleClass("sapSplDemoPanelWithoutPadding").addStyleClass("currentStopPanel").bindAggregation("content",o.getPath()+"/actionGroups",function(I,O){return new sap.m.Panel({headerText:"{description}",expanded:true,expandable:((O.getObject().actions!==undefined&&O.getObject().actions.length>0)?true:false),content:new sap.ui.layout.Grid({content:{path:O.getPath()+"/actions",template:new sap.m.Button({text:"{description}",type:"Emphasized",enabled:"{enabled}",press:jQuery.proxy(t.postEventData,t)})}}).addStyleClass("gridClass")}).addStyleClass("currentStopEventsPanel").addStyleClass("sapSplDemoPanelWithoutPadding");});}else{return new sap.m.Panel({headerText:"{Name}",expanded:false,expandable:false}).addStyleClass("currentStopPanel");}});this.byId("sapSplDemoStopsLayout").setModel(sap.ui.getCore().getModel("demoCurrentToursListModel"));this.byId("sapSplDemoStopsLayout").getBinding("content").sort(new sap.ui.model.Sorter("Name",true));},readMessages:function(o,v,m,i){var r=m["messagePath1"];var R=m["messagePath2"];i.demoODataModel.read(r,null,null,true,function(a){var b=a.results;i.demoODataModel.read(R,null,null,true,function(c){c=b.concat(c.results);sap.ui.getCore().getModel("demoMessageListModel").setSizeLimit(c.length+1);sap.ui.getCore().getModel("demoMessageListModel").setData({messages:c});sap.ui.getCore().getModel("demoMessageListModel").refresh();i.byId("splDemoMessageList").getBinding("items").sort(new sap.ui.model.Sorter("demoMessageListModel>CreationTime",true));},function(){});},function(){});},startReadingMessages:function(){var t=this;window.setTimeout(function(){t.iInterval=window.setInterval(function(){t.readMessages(t.selectedOrganizationId,t.selectedVehicleId,t.vehicleMessagePaths,t);},oSapSplDemoConfigurationBuilder.getConfiguration("messagePollingFrequence")||10000);},1000);},stopPollingMessages:function(){if(this.iInterval!==null||this.iInterval!==undefined){clearInterval(this.iInterval);}},triggerManualRefresh:function(){this.readMessages(this.selectedOrganizationId,this.selectedVehicleId,this.vehicleMessagePaths,this);},onAfterRendering:function(){this.byId("splDemoOrganizationsSelect").addEventDelegate({onAfterRendering:function(e){if(e.srcControl.getItems().length>0){e.srcControl.fireChange({selectedItem:e.srcControl.getItems()[0]});e.srcControl.first="true";}}});this.byId("splDemoVehiclesList").addEventDelegate({onAfterRendering:function(e){if(e.srcControl.getItems().length>0){e.srcControl.fireChange({selectedItem:e.srcControl.getItems()[0]});e.srcControl.first="true";}}});},onBeforeShow:function(){},performServiceCalls:function(){},fnReplyToChat:function(){new sap.m.Dialog({title:"Reply",content:[new sap.m.TextArea({rows:4,width:"100%"})],beginButton:new sap.m.Button({text:"Send",press:function(){}}),endButton:new sap.m.Button({text:"Cancel",press:function(e){e.getSource().getParent().close();}})}).open();},getOrganizationList:function(){this.demoODataModel.read("/Organizations",null,null,true,function(r){r.results.unshift({UUID:"ORGUUID",Organization_Name:"Select an organization"});sap.ui.getCore().getModel("demoDataModel").setSizeLimit(r.results.length+1);sap.ui.getCore().getModel("demoDataModel").setData({organizations:r.results});sap.ui.getCore().getModel("demoDataModel").refresh();},function(){});},handleChangeOfOrganization:function(e){function g(o,i){var O=oSapSplUtils.base64ToHex(o);var r="/Organizations(X'"+O+"')/Vehicles";i.demoODataModel.read(r,null,null,true,function(R){R.results.unshift({Device_UUID:"DEVICEUUID",RegistrationNumber:"Select a vehicle"});sap.ui.getCore().getModel("demoVehicleListModel").setSizeLimit(R.results.length+1);sap.ui.getCore().getModel("demoVehicleListModel").setData({vehicles:R.results});sap.ui.getCore().getModel("demoVehicleListModel").refresh();},function(){});}this.selectedOrganizationId=e.getParameter("selectedItem").getBindingContext("demoDataModel").getObject()["UUID"];this.byId("SplDemoSelectedVehicle").setText("");this.byId("SplDemoSelectedOrg").setText(e.getParameter("selectedItem").getBindingContext("demoDataModel").getObject()["Organization_Name"]+" : ");g(e.getParameter("selectedItem").getBindingContext("demoDataModel").getObject()["UUID"],this);this.oSelectedOrgUUID=e.getParameter("selectedItem").getBindingContext("demoDataModel").getObject()["UUID"];},getCurrentTour:function(U){var t=this;$.ajax({url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/demoSetup/services/tours.xsjs"),async:true,type:"POST",contentType:"json; charset=UTF-8",beforeSend:function(){},data:JSON.stringify({VehicleUUID:U,action:"getCurrentTourData"}),success:function(d){if(d.constructor===String){d=JSON.parse(d);}if(d.length>0){t.byId("currentTourPanel").setVisible(true);sap.ui.getCore().getModel("demoCurrentToursListModel").setData(d[0]);t.bindStopsLayout();}else{t.byId("currentTourPanel").setVisible(false);}},error:function(){sap.m.MessageToast.show("Current Tour Fetch Error");},complete:function(){}});},getTourData:function(U){var t=this;$.ajax({url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/demoSetup/services/tours.xsjs"),async:true,type:"POST",contentType:"json; charset=UTF-8",beforeSend:function(){},data:JSON.stringify({VehicleUUID:U,action:"getTourListData"}),success:function(d){if(d.constructor===String){d=JSON.parse(d);}if(d.length>0){t.byId("AllToursPanel").setVisible(true);sap.ui.getCore().getModel("demoAllToursListModel").setData(d);t.bindAllToursLayout();t.getCurrentTour(U);}else{t.byId("AllToursPanel").setVisible(false);t.byId("currentTourPanel").setVisible(false);}},error:function(){sap.m.MessageToast.show("Tours Fetch Error");},complete:function(){}});},handleSelectionOfVehicle:function(e){this.selectedVehicleId=e.getParameter("selectedItem").getBindingContext("demoVehicleListModel").getObject()["Vehicle_UUID"];this.byId("SplDemoSelectedVehicle").setText(e.getParameter("selectedItem").getBindingContext("demoVehicleListModel").getObject()["RegistrationNumber"]);this.getTourData(this.selectedVehicleId);this.vehicleMessagePaths.messagePath1="/Vehicles(X'"+oSapSplUtils.base64ToHex(this.selectedVehicleId)+"')/DeviceMessagesFromGeofences";this.vehicleMessagePaths.messagePath2="/Vehicles(X'"+oSapSplUtils.base64ToHex(this.selectedVehicleId)+"')/MessagesToDevices";},});
