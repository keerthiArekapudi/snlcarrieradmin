/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
jQuery.sap.require("sap.ui.core.util.Export");jQuery.sap.require("sap.ui.core.util.ExportTypeCSV");sap.ui.controller("splController.usageLog.usageLog",{onBeforeShow:function(e){this.setCurrentAppInfo(e);},onInit:function(){this.customDate1=null;this.customDate2=null;var t=this;this.fnsetTextFromResourceBundle();splReusable.libs.SapSplStyleSheetLoader.loadStyle("./resources/styles/sapSplUsageLog");if(!this.oUsageLogModel){this.oUsageLogModel=new sap.ui.model.json.JSONModel();this.fetchUsageLogData();}this.sSelectedTimeHorizon="C";var d={results:[{name:oSapSplUtils.getBundle().getText("CURRENT_MONTH"),key:"C"},{name:oSapSplUtils.getBundle().getText("LAST_MONTH"),key:"L"},{name:oSapSplUtils.getBundle().getText("LAST_QUARTER"),key:"Q"},{name:oSapSplUtils.getBundle().getText("LAST_QUARTER_TODATE"),key:"QTD"},{name:oSapSplUtils.getBundle().getText("MANUAL_SELECTION"),key:"Manual"}]};this.sapSplUsageTimeHorizonModel=new sap.ui.model.json.JSONModel();this.sapSplUsageTimeHorizonModel.setData(d);this.byId("SapSplUsageTimeHorizon").setModel(this.sapSplUsageTimeHorizonModel);this.getView().addEventDelegate({onAfterShow:function(){window.setTimeout(function(){t.getView().byId("SapSplUsageTimeHorizon").focus();},100);}});},fnsetTextFromResourceBundle:function(){this.getView().byId("usageLog").setTitle(oSapSplUtils.getBundle().getText("USAGE_LOG_LABEL"));this.getView().byId("btnDownloadCSV").setText(oSapSplUtils.getBundle().getText("DOWNLOAD_AS_CSV"));},setCurrentAppInfo:function(e){oSapSplHelpHandler.setAppHelpInfo({iUrl:"./help/SCLUsageLog.pdf",eUrl:"./help/SCLNotification.pdf"},e);},fnInstantiateCSVExporter:function(){var t=this;this.oExport=new sap.ui.core.util.Export({exportType:new sap.ui.core.util.ExportTypeCSV({separatorChar:","}),models:t.oUsageLogModel,rows:{path:"/results"},columns:[{name:oSapSplUtils.getBundle().getText("HUB_Name"),template:{content:{path:"Organization.Name"}}},{name:oSapSplUtils.getBundle().getText("TOTAL_BUSINESS_PARTNER"),template:{content:{path:"bupaCount"}}},{name:oSapSplUtils.getBundle().getText("TOTAL_HUB_USERS"),template:{content:{path:"userCount"}}},{name:oSapSplUtils.getBundle().getText("TOTAL_TELEMATIC_UNITS"),template:{content:{path:"deviceCount"}}},{name:oSapSplUtils.getBundle().getText("TOTAL_ACTIVE_DEVICES"),template:{content:{path:"activeDevicesCount"}}},{name:oSapSplUtils.getBundle().getText("TOTAL_INACTIVE_DEVICES"),template:{content:{path:"inactiveDevicesCount"}}},{name:oSapSplUtils.getBundle().getText("FROM"),template:{content:{path:"StartTime",formatter:splReusable.libs.SapSplModelFormatters.getDateFromStringForCSV}}},{name:oSapSplUtils.getBundle().getText("TO"),template:{content:{path:"EndTime",formatter:splReusable.libs.SapSplModelFormatters.getDateFromStringForCSV}}}]});},fetchUsageLogData:function(b,f,t){var a=this;oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/app/services/usageLog.xsjs/"),method:"POST",data:JSON.stringify(this.getPayLoadForUsageLog(b,f,t)),success:function(d){try{if(d.constructor===String){d=JSON.parse(d);}a.oUsageLogModel.setData({results:d});a.getView().byId("SapSplUsageDetail").setModel(a.oUsageLogModel);}catch(e){jQuery.sap.log.fatal("Invalid character identified in response of service");sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getBundle().getText("SPL_SYSTEM_RESPONSE_ERROR"),details:e.message});}},error:function(e){if(e){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+" "+e.statusText,details:e.responseText},jQuery.proxy(a.fireCancelAction,a));}}});},getPayLoadForUsageLog:function(b,f,t){var p={},d={};if(!f){b=(b)?b:"C";d=oSapSplUtils.getDateRange(b);}else{d["from"]=f;d["to"]=t;}p["StartTime"]=d["from"];p["EndTime"]=d["to"];this.StartTime=p["StartTime"];this.EndTime=p["EndTime"];return p;},onSelectOfListItem:function(e){var d=null;if(!oSplBaseApplication.getAppInstance().getPage("splView.profile.UsageLogDetails")){var u=sap.ui.view({viewName:"splView.profile.UsageLogDetails",id:"splView.profile.UsageLogDetails",type:sap.ui.core.mvc.ViewType.XML});u.addEventDelegate({onBeforeShow:jQuery.proxy(u.getController().onBeforeShow,u.getController())});oSplBaseApplication.getAppInstance().addPage(u);}d=e.getSource().getSelectedItem().getBindingContext().getObject();d["Filter"]=this.HorizonText;oSplBaseApplication.getAppInstance().to("splView.profile.UsageLogDetails",{data:e.getSource().getSelectedItem().getBindingContext().getObject()});e.getSource().removeSelections();},openDateRangeSelectionDialog:function(d,D){var s=null,t=this;s={id:"sapSplDateRangeSelection",dateValue:d,secondDateValue:D,placeholder:oSapSplUtils.getBundle().getText("DATE_RANGE_PLACEHOLDER"),displayFormat:"dd.MM.yyyy",change:function(e){var v=e.getParameter("valid");var a=e.oSource;if(v){a.setValueState(sap.ui.core.ValueState.None);}else{a.setValueState(sap.ui.core.ValueState.Error);}}};var o=new sap.m.Dialog("customDateDialog",{title:oSapSplUtils.getBundle().getText("MANUAL_SELECTION"),content:[new sap.ui.layout.form.SimpleForm({content:[new sap.m.Label({text:oSapSplUtils.getBundle().getText("DATE_RANGE")}),new sap.m.DateRangeSelection(s)]})],beginButton:new sap.m.Button({text:oSapSplUtils.getBundle().getText("OK"),press:function(e){if(e.getSource().getParent().getParent().getContent()[0].getContent()[1].getValueState()==="None"){t.handleCreationOfCustomDateRange(e);var f=sap.ui.getCore().byId("sapSplDateRangeSelection").getDateValue();var T=sap.ui.getCore().byId("sapSplDateRangeSelection").getSecondDateValue();if(sap.ui.getCore().byId("sapSplDateRangeSelection").getDateValue()&&sap.ui.getCore().byId("sapSplDateRangeSelection").getSecondDateValue()){t.fetchUsageLogData(null,f,T);sap.ui.getCore().byId("customDateDialog").close();sap.ui.getCore().byId("customDateDialog").destroy();}else{if(!sap.ui.getCore().byId("sapSplDateRangeSelection").getDateValue()){sap.ui.getCore().byId("sapSplDateRangeSelection").setValueState(sap.ui.core.ValueState.Error);}if(!sap.ui.getCore().byId("sapSplDateRangeSelection").getSecondDateValue()){sap.ui.getCore().byId("sapSplDateRangeSelection").setValueState(sap.ui.core.ValueState.Error);}}}}}),endButton:new sap.m.Button({text:oSapSplUtils.getBundle().getText("CANCEL"),press:function(e){e.getSource().getParent().getParent().close();e.getSource().getParent().getParent().destroy();t.byId("SapSplUsageTimeHorizon").setSelectedKey(t.sSelectedTimeHorizon);}})});o.open();o.attachAfterOpen(function(e){oSapSplUtils.fnSyncStyleClass(e.getSource());});},handlePressOfTimeHorizon:function(e){var s=e.getParameters().selectedItem.getBindingContext().getProperty().key;if(s==="Manual"){this.openDateRangeSelectionDialog(this.customDate1,this.customDate2);}else if(e.getParameters().selectedItem.getBindingContext().getProperty().key==="customRange"){this.sSelectedTimeHorizon=s;}else{this.sSelectedTimeHorizon=s;this.fetchUsageLogData(s);}},handleCreationOfCustomDateRange:function(e){var t=[],d=null,m={},c=false;d=e.getSource().getParent().getParent().getContent()[0].getContent()[1];this.customDate1=d.getDateValue();this.customDate2=d.getSecondDateValue();m=this.sapSplUsageTimeHorizonModel.getData();t=m.results;if(this.customDate1===null||this.customDate2===null){d.setValueState("Error");d.setValueStateText(oSapSplUtils.getBundle().getText("CUSTOM_RANGE_DATE_ERROR_STATE_TEXT"));}else{d.setValueState("None");for(var i=0;i<t.length;i++){if(t[i].key==="customRange"){c=true;t[i].name=d.getValue();break;}}if(c===false){t.push({key:"customRange",name:d.getValue()});}m["results"]=t;this.sapSplUsageTimeHorizonModel.setData(m);this.byId("SapSplUsageTimeHorizon").setSelectedKey("customRange");this.sSelectedTimeHorizon="customRange";e.getSource().getParent().close();e.getSource().getParent().destroy();}},onSelectOfTimeHorizon:function(e){var b=e.getSource().getSelectedItem().getBindingContext().getObject()["key"];this.fetchUsageLogData(b);this.HorizonText=e.getSource().getSelectedItem().getTitle();this.byId("SapSplUsageTimeHorizon").setText(oSapSplUtils.getBundle().getText("TIME_HORIZON",this.HorizonText));this.oTimeHorizonPopover.close();e.getSource().removeSelections();},handlePressOfCustomRange:function(){if(!this.UsageLogCustomDaterangeDialog){this.UsageLogCustomDaterangeDialog=sap.ui.xmlfragment("SapSplUsageLogCustomDateRange","splReusable.fragments.UsageLogCustomDaterange",this);sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogFromDate").addCustomData(new sap.ui.core.CustomData({key:"type",value:"from"}));sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogToDate").addCustomData(new sap.ui.core.CustomData({key:"type",value:"to"}));sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","CustomDateRangeToLabel").setText(oSapSplUtils.getBundle().getText("TO"));sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","CustomDateRangeFromLabel").setText(oSapSplUtils.getBundle().getText("FROM"));sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogOKButton").setText(oSapSplUtils.getBundle().getText("OK_BUTTON_TEXT"));sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogCancelButton").setText(oSapSplUtils.getBundle().getText("CANCEL"));sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogPage").setTitle(oSapSplUtils.getBundle().getText("SELECT_CUSTOM_TIME_RANGE"));}this.UsageLogCustomDaterangeDialog.open();},handlePressOfOk:function(){var f=null,t=null;f=splReusable.libs.SapSplModelFormatters.convertYyyymmddtoDate(sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogFromDate").getYyyymmdd());t=splReusable.libs.SapSplModelFormatters.convertYyyymmddtoDate(sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogToDate").getYyyymmdd());if(sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogFromDate").getYyyymmdd()&&sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogToDate").getYyyymmdd()){this.fetchUsageLogData(null,f,t);this.UsageLogCustomDaterangeDialog.close();}else{if(!sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogFromDate").getYyyymmdd()){sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogFromDate").setValueState(sap.ui.core.ValueState.Error);}if(!sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogToDate").getYyyymmdd()){sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogToDate").setValueState(sap.ui.core.ValueState.Error);}}},handlePressOfCancel:function(){this.UsageLogCustomDaterangeDialog.close();},handleChangeOfDatePicker:function(e){var f,t,d;f=splReusable.libs.SapSplModelFormatters.convertYyyymmddtoDate(sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogFromDate").getYyyymmdd());t=splReusable.libs.SapSplModelFormatters.convertYyyymmddtoDate(sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogToDate").getYyyymmdd());d=e.getSource();if(d.getCustomData()[0].getValue()==="from"){sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogFromDate").setValueState();}else{sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogToDate").setValueState();}if(f>t){sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogToDate").setYyyymmdd(sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogFromDate").getYyyymmdd());}},handlePressOfCSVButton:function(){var f=null;f=oSapSplUtils.getBundle().getText("USAGE_LOG_LABEL")+"_"+splReusable.libs.SapSplModelFormatters.getDateFromString(new Date());this.fnInstantiateCSVExporter();this.oExport.saveFile(f).always(function(){this.destroy();});},handleProfileBackNavigation:function(){var b=null;b=oSplBaseApplication.getAppInstance();if(b.getPreviousPage()){b.back();}else{b.to("splView.tileContainer.MasterTileContainer");}}});
