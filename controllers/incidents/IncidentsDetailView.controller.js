/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.controller("splController.incidents.IncidentsDetailView",{onInit:function(){this.fnDefineControlLabelsFromLocalizationBundle();var i=new sap.ui.model.json.JSONModel({isEdit:false,isDisplay:true,noData:true,isClicked:false});sap.ui.getCore().setModel(i,"SapSplIncidentsDetailModel");this.getView().setModel(sap.ui.getCore().getModel("SapSplIncidentsDetailModel"));this.byId("SapSplIncidentsDetailAssignedGeofencesTable").getBinding("items").filter([new sap.ui.model.Filter("isDeleted",sap.ui.model.FilterOperator.EQ,false)]);this.oDetailVBI=this.byId("oSapSplVBMap");this.oVBIModel=new sap.ui.model.json.JSONModel();this.oVBIModel.setData(oSapSplMapsDataMarshal.getMapsModelJSON(SapSplEnums.configJSON));sap.ui.getCore().setModel(this.oVBIModel,"oSapSplVBModel");this.getView().byId("oSapSplVBMap").bindProperty("config","oSapSplVBModel>/");this.getView().byId("oSapSplVBMap").setModel(sap.ui.getCore().getModel("oSapSplVBModel"));this.byId("sapSplIncidentsCategorySelect").setModel(new sap.ui.model.json.JSONModel());this.byId("sapSplIncidentsPrioritySelect").setModel(new sap.ui.model.json.JSONModel());this.prepareDataForEnums();this.aGateToGeofenceMapping={};this.oSapSplGeofencesForAssignmentModel=new sap.ui.model.odata.ODataModel(oSapSplUtils.getServiceMetadata("app",true));},prepareDataForEnums:function(){var e=null,c=[],p=[],t=this,T="",P={};P["Value"]=null;P["Value.description"]=oSapSplUtils.getBundle().getText("PLEASE_SELECT_PLACEHOLDER");e=new sap.ui.model.odata.ODataModel(oSapSplUtils.getServiceMetadata("utils",true));e.read("/Enumeration('IncidentCategory')/Values",null,null,false,function(r){c=r.results;T=c[0];c[0]=P;c[c.length]=T;t.byId("sapSplIncidentsCategorySelect").getModel().setData(c);},function(){jQuery.sap.log.error("prepareDataForEnums","Enumeration read failed","IncidentsDetailView.controller.js");});e.read("/Enumeration('Priority')/Values",null,null,false,function(r){p=r.results;p.splice(0,0,P);t.byId("sapSplIncidentsPrioritySelect").getModel().setData(p);},function(){jQuery.sap.log.error("prepareDataForEnums","Enumeration read failed","IncidentsDetailView.controller.js");});},fnNavigateToManageLocations:function(){var n="splView.liveApp.liveApp";var N=null;if(!sap.ui.getCore().byId("sapSplBaseApplication").getPage(n)){N=sap.ui.view({viewName:n,id:n,type:sap.ui.core.mvc.ViewType.XML});N.addEventDelegate({onBeforeShow:jQuery.proxy(N.getController().onBeforeShow,N.getController())});sap.ui.getCore().byId("sapSplBaseApplication").addPage(N);}oSplBaseApplication.getAppInstance().to(n,"slide");},onBeforeShow:function(){oSapSplUtils.setIsDirty(false);},fnToCaptureLiveChangeToSetIsDirtyFlag:function(){if(!oSapSplUtils.getIsDirty()){oSapSplUtils.setIsDirty(true);}},fnHandleOpenOfMapInDialog:function(e,t,m,T){var a=this,p={},c={},b={};this.oVBI=new sap.ui.vbm.VBI({width:jQuery(window).width()*0.8,height:jQuery(window).height()*0.8,plugin:false,submit:function(e){a.fnEventHandlerDialogMap(e);},config:"{oSapSplVBModel>/}"}).addStyleClass("VBI");new sap.m.Dialog({content:this.oVBI,title:T,leftButton:new sap.m.Button({text:oSapSplUtils.getBundle().getText("OK"),press:function(){if(m!=="Display"){a.fnToCaptureLiveChangeToSetIsDirtyFlag();}this.getParent().close();this.getParent().destroy();}}),rightButton:new sap.m.Button({text:oSapSplUtils.getBundle().getText("CANCEL"),press:function(){var c={},b;if(!a.selectedIncidentLocationGeometry){a.byId("oSapSPlVBMapHolder").setVisible(false);}c["Geometry"]=a.selectedIncidentLocationGeometry;var M=sap.ui.getCore().getModel("SapSplIncidentsDetailModel").getData();M["IncidentLocationGeometry"]=c["Geometry"];sap.ui.getCore().getModel("SapSplIncidentsDetailModel").setData(M);c["Name"]="";c["LocationID"]=a.selectedIncidentLocationGeometry;c["Tag"]="ALERT";if(c["Geometry"]){if(c["Geometry"].constructor===String&&c["Geometry"].length!==0){b=c["Geometry"].split(";");c["Geometry"]=JSON.stringify(oSapSplMapsDataMarshal.convertStringToGeoJSON(a.selectedIncidentLocationGeometry));a.fnShowMarkerInDetailMap(a.oDetailVBI,c,b[1],b[0]);}}else{oSapSplMapsDataMarshal.fnClearMap(a.oDetailVBI);oSapSplMapsDataMarshal.fnResetValues(a.oDetailVBI);}this.getParent().close();this.getParent().destroy();}})}).open().attachAfterOpen(function(e){oSapSplUtils.fnSyncStyleClass(e.getSource());});if(t==="Polygon"){p={};p["LocationID"]="key";p["Name"]=e.getSource().getBindingContext().getObject()["GeoFenceName"];if(e.getSource().getBindingContext().getProperty()["TechnicalLocationGeometry"]){p["Geometry"]=e.getSource().getBindingContext().getProperty()["TechnicalLocationGeometry"];this.fnApplyPolygonChangesBasedOnMode(this.oVBI,"Display",p,e.getSource().getBindingContext().getProperty()["TechnicalLocationGeometry"]);}else{p["Geometry"]=e.getSource().getBindingContext().getProperty()["Geometry"];this.fnApplyPolygonChangesBasedOnMode(this.oVBI,"Display",p,e.getSource().getBindingContext().getProperty()["Geometry"]);}}else if(t==="Flag"){c={};b={};c["Geometry"]=e.getSource().getModel().getData()["IncidentLocationGeometry"];c["Name"]="";c["LocationID"]=e.getSource().getModel().getData()["IncidentLocationGeometry"];c["Tag"]="ALERT";if(c["Geometry"]){b=c["Geometry"].split(";");c["Geometry"]=JSON.stringify(oSapSplMapsDataMarshal.convertStringToGeoJSON(c["Geometry"]));this.fnShowMarkerInDetailMap(this.oVBI,c,b[1],b[0]);}this.fnApplyFlagChangesBasedOnMode(this.oVBI,m,c);this.selectedIncidentLocationGeometry=e.getSource().getModel().getData()["IncidentLocationGeometry"];}},fnMakeChangesToDetailPageControlsBasedOnMode:function(m,c){var C={},a=null;this.byId("oSapSplVBMap").removeStyleClass("incidentsMapPlaceHolderDisplay");this.byId("oSapSplVBMap").removeStyleClass("incidentsMapPlaceHolderEdit");this.byId("SapSplIncidentsDetailPageForm").setTitle(oSapSplUtils.getBundle().getText("INCIDENTS_DETAIL_FORM_TITLE"));if(m==="Display"){this.byId("SapSplIncidentsDetailAssignedGeofencesTable").setVisible(true);this.byId("SapSplIncidentsNameInput").setEditable(false);this.byId("SapSplIncidentsLocationLabel").setVisible(false);this.byId("oSapSplVBMap").addStyleClass("incidentsMapPlaceHolderDisplay");if(c["IncidentLocationGeometry"]){oSapSplMapsDataMarshal.fnResetValues(this.oDetailVBI);oSapSplMapsDataMarshal.fnClearMap(this.oDetailVBI);C["Geometry"]=JSON.stringify(oSapSplMapsDataMarshal.convertStringToGeoJSON(c["IncidentLocationGeometry"]));C["Name"]="";C["LocationID"]=c["IncidentLocationGeometry"];C["Tag"]="ALERT";if(C["Geometry"]){this.byId("oSapSPlVBMapHolder").setVisible(true);a=c["IncidentLocationGeometry"].split(";");setTimeout(function(){this.fnShowMarkerInDetailMap(this.oDetailVBI,C,a[1],a[0]);}.bind(this),250);}else{this.byId("oSapSPlVBMapHolder").setVisible(false);}}else{this.byId("oSapSPlVBMapHolder").setVisible(false);}this.byId("SapSplIncidentsFooterDelete").setVisible(false);}else if(m==="Create"){this.byId("oSapSplVBMap").addStyleClass("incidentsMapPlaceHolderEdit");this.byId("oSapSPlVBMapHolder").setVisible(false);this.byId("SapSplIncidentsLocationLabel").setVisible(true);this.HeaderChangeMode="C";this.TextChangeMode="C";oSapSplMapsDataMarshal.fnResetValues(this.oDetailVBI);oSapSplMapsDataMarshal.fnClearMap(this.oDetailVBI);this.byId("SapSplIncidentsNameInput").setEditable(true);this.byId("SapSplIncidentsChangeGeoFenceAssignmentButton").setText(oSapSplUtils.getBundle().getText("INCIDENTS_ASSIGN_LOCATION"));this.byId("SapSplIncidentsFooterDelete").setVisible(false);}else{this.HeaderChangeMode=null;this.TextChangeMode=null;this.byId("oSapSplVBMap").addStyleClass("incidentsMapPlaceHolderEdit");this.byId("SapSplIncidentsNameInput").setEditable(true);this.byId("SapSplIncidentsLocationLabel").setVisible(true);if(c["Geometry"]){this.byId("oSapSPlVBMapHolder").setVisible(true);C["Geometry"]=JSON.stringify(oSapSplMapsDataMarshal.convertStringToGeoJSON(c["IncidentLocationGeometry"]));C["LocationSpecName"]="";C["LocationID"]=c["IncidentLocationGeometry"];C["Tag"]="ALERT";a=c["IncidentLocationGeometry"].split(";");this.fnShowMarkerInDetailMap(this.oDetailVBI,C,a[1],a[0]);}else{this.byId("oSapSPlVBMapHolder").setVisible(false);}this.byId("SapSplIncidentsChangeGeoFenceAssignmentButton").setText(oSapSplUtils.getBundle().getText("INCIDENTS_CHANGE_ASSIGNMENT"));this.byId("SapSplIncidentsFooterDelete").setVisible(true);}},fnApplyPolygonChangesBasedOnMode:function(v,m,p,c){this.bMode=false;oSapSplMapsDataMarshal.fnResetValues(v);oSapSplMapsDataMarshal.fnShowFences(p,v);var a=oSapSplMapsDataMarshal.convertGeoJSONToString(JSON.parse(c)).split(";");v.zoomToGeoPosition(parseFloat(a[0]),parseFloat(a[1]),14);},fnApplyFlagChangesBasedOnMode:function(v,m,f){if(m==="Display"){this.bMode=false;oSapSplMapsDataMarshal.fnResetValues(v);f["Name"]=oSapSplUtils.getBundle().getText("INCIDENT_LOCATION_TOOLTIP");oSapSplMapsDataMarshal.fnShowPointOfInterestFlags(f,v);var c=f.split(";");v.zoomToGeoPosition(c[0],c[1],14);}else if(m==="Edit"){this.bMode=true;}},fnShowMarkerInDetailMap:function(v,f,x,y){oSapSplMapsDataMarshal.fnClearMap(v);oSapSplMapsDataMarshal.fnResetValues(v);f["Name"]=oSapSplUtils.getBundle().getText("INCIDENT_LOCATION_TOOLTIP");oSapSplMapsDataMarshal.fnShowPointOfInterestFlags(f,v);if(x&&y){v.zoomToGeoPosition(parseFloat(y),parseFloat(x),14);}},fnEventHandlerDialogMap:function(e){if(JSON.parse(e.getParameter("data")).Action.object==="Map"){for(var i=0;i<JSON.parse(e.getParameter("data")).Action.AddActionProperties.AddActionProperty.length;i++){if(JSON.parse(e.getParameter("data")).Action.AddActionProperties.AddActionProperty[i].name==="pos"){var c=JSON.parse(e.getParameter("data")).Action.AddActionProperties.AddActionProperty[i]["#"];if(this.bMode){oSapSplMapsDataMarshal.isMapClickEabled=true;oSapSplMapsDataMarshal.fnRemoveVOsOnMap("All",this.oVBI);oSapSplMapsDataMarshal.fnCreatePointOfInterestFlag(c,this.oVBI,jQuery.proxy(this.fnCallback,this));oSapSplMapsDataMarshal.fnResetValues(this.oVBI);}}}}},fnEventHandler:function(){},fnChangeButtonEvent:function(e){if(e.getSource().getText()===oSapSplUtils.getBundle().getText("INCIDENTS_CHANGE_ASSIGNMENT")){this.fnHandleOpenOfMapInDialog(e,"Flag","Edit",oSapSplUtils.getBundle().getText("MAP_DIALOG_TITLE_EDIT"));}else{this.byId("oSapSPlVBMapHolder").setVisible(true);this.fnHandleOpenOfMapInDialog(e,"Flag","Edit",oSapSplUtils.getBundle().getText("MAP_DIALOG_TITLE_CREATE"));}},fnHandleClickOfDetailViewGeoFence:function(e){this.fnHandleOpenOfMapInDialog(e,"Polygon","Display",oSapSplUtils.getBundle().getText("MAP_DIALOG_TITLE_DISPLAY"));},fnCallback:function(p){this.byId("oSapSPlVBMapHolder").setVisible(true);var c={},P="";c=p["locationGeoCoords"][0];P=c["long"]+";"+c["lat"]+";"+c["alt"];this.setLocationTextAndChangeMarker(P,c["long"],c["lat"]);},setLocationTextAndChangeMarker:function(p,l,L){var c={};if(this.HeaderChangeMode!=="C"){this.HeaderChangeMode="U";}c["Geometry"]=JSON.stringify(oSapSplMapsDataMarshal.convertStringToGeoJSON(p));c["LocationSpecName"]="";c["LocationID"]=JSON.stringify(oSapSplMapsDataMarshal.convertStringToGeoJSON(p));c["Tag"]="ALERT";var m=sap.ui.getCore().getModel("SapSplIncidentsDetailModel").getData();m["IncidentLocationGeometry"]=p;this.fnShowMarkerInDetailMap(this.oDetailVBI,c,L,l);},fnhandleEditOfIncidentDetails:function(e){this.fnToCaptureLiveChangeToSetIsDirtyFlag();if(e.getSource().constructor===sap.m.Input){if(this.TextChangeMode!=="C"){this.TextChangeMode="U";}}else{if(this.HeaderChangeMode!=="C"){this.HeaderChangeMode="U";}}},fnHandlePressOfEditIncidents:function(){var n={};var m=sap.ui.getCore().getModel("SapSplIncidentsDetailModel").getData();n=jQuery.extend({},m);if(m["Geofences"]){n["Geofences"]=jQuery.extend([],m["Geofences"]);}else{n["Geofences"]=[];}n["isEdit"]=true;n["isDisplay"]=false;n["isNotCreate"]=true;sap.ui.getCore().getModel("SapSplIncidentsDetailModel").setData(n);this.fnMakeChangesToDetailPageControlsBasedOnMode("Edit",n);this.getView().byId("SapSplIncidentsNameInput").focus();},fnHandlePressOfCancelEditIncidents:function(){var t=this;if(oSapSplUtils.getIsDirty()){sap.m.MessageBox.show(oSapSplUtils.getBundle().getText("DATA_LOSS_WARNING_TEXT"),sap.m.MessageBox.Icon.WARNING,oSapSplUtils.getBundle().getText("WARNING"),[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.CANCEL],function(s){if(s==="YES"){t.selectMasterListItemOnBackNavigation();jQuery.proxy(t.handlePressOfOkDataLossWarningDialog(),t);oSapSplUtils.setIsDirty(false);}},null,oSapSplUtils.fnSyncStyleClass("messageBox"));}else{t.selectMasterListItemOnBackNavigation();jQuery.proxy(t.handlePressOfOkDataLossWarningDialog(),t);}sap.ui.getCore().byId("IncidentsMasters--sapSplIncidentSearch").focus();},selectMasterListItemOnBackNavigation:function(){var i,p,m;if(this.incidentSelected){p=this.incidentSelected;m=this.getView().getParent().getParent().getCurrentMasterPage().getController().byId("SapSplIncidentsList");for(i=0;i<m.getItems().length;i++){if(m.getItems()[i].sId.indexOf("oSapSplIncidentListItem")!==-1){if(m.getItems()[i].getBindingContext().getProperty().UUID===p){m.setSelectedItem(m.getItems()[i]);break;}}}}},handlePressOfOkDataLossWarningDialog:function(){var m=this.oCurentMasterItemData,n={};n=jQuery.extend({},m);n["Geofences"]=[];if(m){if(m["Geofences"]){n["Geofences"]=jQuery.extend([],m["Geofences"]);}n["noData"]=false;n["isClicked"]=true;}else{n["noData"]=true;n["isClicked"]=false;}if(!n){n={};}oSapSplMapsDataMarshal.fnClearMap(this.oDetailVBI);n["isEdit"]=false;n["isDisplay"]=true;n["isNotCreate"]=true;this.byId("SapSplIncidentsDetailAssignedGeofencesTable").setVisible(n["isClicked"]);var M=[];if(n["Geofences"]){M=jQuery.extend([],n["Geofences"]);}for(var i=0;i<M.length;i++){if(M[i]["isDeleted"]===true){M[i]["CHANGEMODE"]=null;M[i]["isDeleted"]=false;}}n["Geofences"]=M;sap.ui.getCore().getModel("SapSplIncidentsDetailModel").setData(n);this.fnMakeChangesToDetailPageControlsBasedOnMode("Display",n);this.byId("SapSplIncidentsDetailAssignedGeofencesTable").getBinding("items").filter([new sap.ui.model.Filter("isDeleted",sap.ui.model.FilterOperator.EQ,false)]);},fnSetSelectedMasterItemData:function(m){this.oCurentMasterItemData=jQuery.extend({},m);this.oCurentMasterItemData["Geofences"]=[];if(m["Geofences"]){for(var i=0;i<m["Geofences"].length;i++){this.oCurentMasterItemData["Geofences"].push(jQuery.extend({},m["Geofences"][i]));}}else{this.oCurentMasterItemData["Geofences"]=[];}},fnDefineControlLabelsFromLocalizationBundle:function(){this.byId("SapSplIncidentsDetailPageForm").setTitle(oSapSplUtils.getBundle().getText("INCIDENTS_DETAIL_FORM_TITLE"));this.byId("SapSplIncidentsNameLabel").setText(oSapSplUtils.getBundle().getText("INCIDENTS_NAME"));this.byId("SapSplIncidentsMessageLabel").setText(oSapSplUtils.getBundle().getText("INCIDENTS_MESSAGE"));this.byId("SapSplIncidentsCategoryLabel").setText(oSapSplUtils.getBundle().getText("INCIDENTS_CATEGORY"));this.byId("SapSplIncidentsPriorityLabel").setText(oSapSplUtils.getBundle().getText("INCIDENTS_PRIORITY"));this.byId("SapSplIncidentsCategoryLabelInDisplay").setText(oSapSplUtils.getBundle().getText("INCIDENTS_CATEGORY"));this.byId("SapSplIncidentsPriorityLabelInDisplay").setText(oSapSplUtils.getBundle().getText("INCIDENTS_PRIORITY"));this.byId("SapSplIncidentsLocationLabel").setText(oSapSplUtils.getBundle().getText("INCIDENTS_LOCATION"));this.byId("SapSplAssignedGeofencesTableColumnHeader_Geofence").setText(oSapSplUtils.getBundle().getText("INCIDENTS_GEOFENCE"));this.byId("SapSplAssignedGeofencesTableColumnHeader_Gate").setText(oSapSplUtils.getBundle().getText("INCIDENTS_GATES"));this.byId("SapSplIncidentsDetailAssignedGeofencesTable").setHeaderText(oSapSplUtils.getBundle().getText("INCIDENTS_ASSIGNED_GEOFENCES"));this.byId("SapSplIncidentsDetailPage").setTitle(oSapSplUtils.getBundle().getText("INCIDENTS_DETAIL_PAGE_TITLE"));this.byId("SapSplIncidentsAddGeoFenceButton").setText(oSapSplUtils.getBundle().getText("INCIDENTS_ADD_GEOFENCE"));this.byId("SapSplIncidentsViewGeoFenceLink").setText(oSapSplUtils.getBundle().getText("INCIDENTS_VIEW_DETAILS"));this.byId("SapSplIncidentsChangeGeoFenceAssignmentButton").setText(oSapSplUtils.getBundle().getText("INCIDENTS_CHANGE_ASSIGNMENT"));this.byId("SapSplIncidentsFooterEdit").setText(oSapSplUtils.getBundle().getText("MY_COLLEAGUES_EDIT_BUTTON"));this.byId("SapSplIncidentsFooterManageGeofences").setText(oSapSplUtils.getBundle().getText("INCIDENTS_FOOTER_MANAGE_GEOFENCES"));this.byId("SapSplIncidentsFooterSave").setText(oSapSplUtils.getBundle().getText("NEW_CONTACT_SAVE"));this.byId("SapSplIncidentsFooterCancel").setText(oSapSplUtils.getBundle().getText("MY_COLLEAGUES_CANCEL_BUTTON"));this.byId("SapSplIncidentsFooterDelete").setText(oSapSplUtils.getBundle().getText("INCIDENTS_FOOTER_DELETE"));this.byId("SapSplIncidentsDetailAssignedGeofencesTable").setNoDataText(oSapSplUtils.getBundle().getText("NO_GEOFENCES_ASSIGNED_TEXT"));this.byId("sapSplIncidentDetailNoDataLabel").setText(oSapSplUtils.getBundle().getText("NO_INCIDENTS_TEXT"));this.byId("SapSplDeleteGeofenceAssignmentButton").setTooltip(oSapSplUtils.getBundle().getText("DELETE_ASSIGNMENT_BUTTON_TOOLTIP"));},handleSelectOfGates:function(e){var I,c,b;b=e.getParameters().listItem.getBindingContext().getObject();c="TechnicalLocationID";if(b["ID"]==="ALL"){for(var i=0;i<e.getSource().getItems().length;i++){var s=e.getSource().getItems()[i].getBindingContext().getObject()["ID"];if(!s){e.getSource().getItems()[i].setSelected(e.getParameters().selected);e.getSource().fireSelectionChange({selected:e.getParameters().selected,listItem:e.getSource().getItems()[i]});}}var m=sap.ui.core.Fragment.byId("selectGeoFences","sapSplGeofenceToIncidentsAssignmentNavContainer").getPages()[1].oMasterListItem;m.getParent().fireSelectionChange({listItem:m,selected:e.getParameters().selected});}else{if(e.getParameters().selected){var C=true;for(I=0;I<this.aTempListOfSelections.length;I++){if(this.aTempListOfSelections[I][c]===b[c]&&this.aTempListOfSelections[I]["isDeleted"]===false){C=false;}}if(C){b["isStacked"]="1";b["CHANGEMODE"]="C";b["GeoFenceName"]=this.sSelectedGeofenceName;b["GateName"]=b["Name"];b["isDeleted"]=false;this.aTempListOfSelections.push(b);}}else{for(I=0;I<this.aTempListOfSelections.length;I++){if(this.aTempListOfSelections[I][c]===b[c]){this.aTempListOfSelections.splice(I,1);break;}}}}},fnHandleAddGeoFenceForIncidentAssignment:function(){var t=this;this.aTempListOfSelections=[];var m=sap.ui.getCore().getModel("SapSplIncidentsDetailModel").getData();if(m["Geofences"]){for(var i=0;i<m["Geofences"].length;i++){this.aTempListOfSelections.push(jQuery.extend(true,{},m["Geofences"][i]));}}else{this.aTempListOfSelections=[];}function h(c){if(sap.ui.getCore().getModel("GeofencesForAssignmentModel")){sap.ui.getCore().getModel("GeofencesForAssignmentModel").setData(t.getDataForFragment(c.results,"I"));sap.ui.core.Fragment.byId("selectGeoFences","listGeofencesPage").setModel(sap.ui.getCore().getModel("GeofencesForAssignmentModel"));}else{sap.ui.getCore().setModel(new sap.ui.model.json.JSONModel(t.getDataForFragment(c.results,"I")),"GeofencesForAssignmentModel");sap.ui.core.Fragment.byId("selectGeoFences","listGeofencesPage").setModel(sap.ui.getCore().getModel("GeofencesForAssignmentModel"));}}function a(e){var n=sap.ui.core.Fragment.byId("selectGeoFences","sapSplGeofenceToIncidentsAssignmentNavContainer");var c=n.getCurrentPage().sId;if(c.indexOf("Geofence")!==-1){var m=sap.ui.getCore().getModel("SapSplIncidentsDetailModel").getData();m["Geofences"]=t.aTempListOfSelections;sap.ui.getCore().getModel("SapSplIncidentsDetailModel").setData(m);t.byId("SapSplIncidentsDetailAssignedGeofencesTable").getBinding("items").filter(new sap.ui.model.Filter("isDeleted",sap.ui.model.FilterOperator.EQ,false));t.byId("SapSplIncidentsDetailAssignedGeofencesTable").setVisible(true);t.oLocationFragment=null;e.getSource().getParent().getParent().destroy();}else{n.back();}}function b(e){var n=sap.ui.core.Fragment.byId("selectGeoFences","sapSplGeofenceToIncidentsAssignmentNavContainer");var c=n.getCurrentPage().sId;if(c.indexOf("Geofence")!==-1){e.getSource().getParent().getParent().destroy();t.oLocationFragment=null;}else{n.back();}}if(!m["Geofences"]){m["Geofences"]=[];}if(!this.oLocationFragment){this.oLocationFragment=sap.ui.xmlfragment("selectGeoFences","splReusable.fragments.SelectGeofencesForIncidents",this);this.oLocationFragment.attachAfterOpen(function(e){oSapSplUtils.fnSyncStyleClass(e.getSource());});this.oLocationFragment.getBeginButton().attachPress(a);this.oLocationFragment.getEndButton().attachPress(b);sap.ui.core.Fragment.byId("selectGeoFences","sapSplGeofenceToIncidentAssignmentList").setBusy(true);sap.ui.core.Fragment.byId("selectGeoFences","listGeofencesPage").setTitle(oSapSplUtils.getBundle().getText("SEND_MESSAGE_SELECT_GEOFENCE"));sap.ui.core.Fragment.byId("selectGeoFences","sapSplSelectGatesPageTitle").setText(oSapSplUtils.getBundle().getText("SELECT_GATES"));sap.ui.core.Fragment.byId("selectGeoFences","sapSplGeofenceToIncidentAssignmentList").setNoDataText(oSapSplUtils.getBundle().getText("NO_DATA_TEXT_GEOFENCE"));sap.ui.core.Fragment.byId("selectGeoFences","sapSplGeofenceToIncidentAssignmentList").addEventDelegate({onAfterRendering:function(){var l=null;l=sap.ui.core.Fragment.byId("selectGeoFences","sapSplGeofenceToIncidentAssignmentList");if(l.getModel()){l.setBusy(false);l.setShowNoData(true);}else{l.setShowNoData(false);}}});sap.ui.core.Fragment.byId("selectGeoFences","listGatesPage").setModel(new sap.ui.model.json.JSONModel());sap.ui.core.Fragment.byId("selectGeoFences","sapSplSelectGeofencesForIncidentsConfirm").setText(oSapSplUtils.getBundle().getText("OK_BUTTON_TEXT"));sap.ui.core.Fragment.byId("selectGeoFences","sapSplSelectGeofencesForIncidentsCancel").setText(oSapSplUtils.getBundle().getText("CANCEL"));}var d=["$filter= Tag eq 'LC0004'"];this.oLocationFragment.open();jQuery("#selectGeoFences--SapSplGeofenceToIncidentAssignmentSelectDialog-dialog").addClass("assignGeofencesDialog");if(sap.ui.getCore().getModel("GeofencesForAssignmentModel")){this.oSapSplGeofencesForAssignmentModel.read("/MyLocations",null,d,true,h,function(){sap.ui.core.Fragment.byId("selectGeoFences","sapSplGeofenceToIncidentAssignmentList").setShowNoData(true);});}else{this.oSapSplGeofencesForAssignmentModel.read("/MyLocations",null,d,true,h,function(){sap.ui.core.Fragment.byId("selectGeoFences","sapSplGeofenceToIncidentAssignmentList").setShowNoData(true);});}},getDataForFragment:function(d){var a=this.aTempListOfSelections;for(var i=0;i<d.length;i++){d[i]["checked"]=false;for(var j=0;j<a.length;j++){if(a[j]["isStacked"]!=="1"){if(d[i]["LocationID"]===a[j]["LocationID"]&&a[j]["isDeleted"]===false){d[i]["checked"]=true;d[i]["ALL"]=true;}}}}return d;},fnHandlePressOfDeleteIncidents:function(){var t=this;sap.m.MessageBox.show(oSapSplUtils.getBundle().getText("INCIDENT_DELETE_CONFIRMATION"),sap.m.MessageBox.Icon.WARNING,oSapSplUtils.getBundle().getText("WARNING"),[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.CANCEL],function(s){if(s==="YES"){t.fnHandlePressOfSaveIncidents(null,"DELETE");oSapSplUtils.setIsDirty(false);}},null,oSapSplUtils.fnSyncStyleClass("messageBox"));},fnHandlePressOfSaveIncidents:function(e,t){var p=null,m=null,T=null;var a=this;if(t){T=t;}if(!T){if(sap.ui.getCore().getModel("SapSplIncidentsDetailModel").getData()["isNotCreate"]){T="PUT";}else{T="POST";}}p=this.preparePayLoadForPost(T);if(p["Header"].length>0||p["Text"].length>0||p["Location"].length>0){oSapSplBusyDialog.getBusyDialogInstance({title:oSapSplUtils.getBundle().getText("BUSY_DIALOG_MESSAGE")}).open();if(T==="DELETE"){T="POST";}oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getServiceMetadata("incidents",true),method:T,data:JSON.stringify(p),success:function(d,s,b){if(d.constructor===String){d=JSON.parse(d);}oSapSplBusyDialog.getBusyDialogInstance().close();m=sap.ui.getCore().getModel("SapSplIncidentsDetailModel").getData();if(b["status"]===200&&d["Error"].length===0){var c=new sap.ui.core.CustomData({key:"bRefreshTile",value:true});oSplBaseApplication.getAppInstance().getCurrentPage().destroyCustomData();oSplBaseApplication.getAppInstance().getCurrentPage().addCustomData(c);if(m["isNotCreate"]){sap.ca.ui.message.showMessageToast(oSapSplUtils.getBundle().getText("CHANGES_SAVED_SUCCESS"));}else{sap.ca.ui.message.showMessageToast(oSapSplUtils.getBundle().getText("INCIDENT_CREATE_SUCCESS"));}oSapSplUtils.setIsDirty(false);}else{var f=oSapSplUtils.getErrorMessagesfromErrorPayload(d)["ufErrorObject"];sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["errorWarningString"],details:f});}a.getView().getParent().getParent().getCurrentMasterPage().byId("SapSplIncidentsList").addCustomData(new sap.ui.core.CustomData({key:d.Header[0].UUID}));sap.ui.getCore().getModel("IncidentsListODataModel").refresh();},error:function(b){jQuery.sap.log.error("fnHandlePressOfSaveIncidents","ajax failed","IncidentsDetailView.controller.js");oSapSplBusyDialog.getBusyDialogInstance().close();sap.ui.getCore().getModel("SapSplIncidentsDetailModel").refresh();if(b&&b["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:b["status"]+" "+b.statusText,details:b.responseText});}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(b.responseText))["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(b.responseText))["ufErrorObject"]});}}});}},preparePayLoadForPost:function(m){var M={},I={},o={},c={},s="",a="";M["Header"]=[];M["Text"]=[];M["Recipient"]=[];M["Object"]="MessageTemplate";c=sap.ui.getCore().getModel("SapSplIncidentsDetailModel").getData();if(sap.ui.getCore().getModel("SapSplIncidentsDetailModel").getData()["isNotCreate"]){s=c["UUID"];}else{s=oSapSplUtils.getUUID();}if(!c["Name"]){a="";}else{a=c["Name"];}I["UUID"]=s;I["Name"]=a;I["Priority"]=this.byId("sapSplIncidentsPrioritySelect").getSelectedKey();I["Category"]=this.byId("sapSplIncidentsCategorySelect").getSelectedKey();I["SourceLocation"]=oSapSplMapsDataMarshal.convertStringToGeoJSON(c["IncidentLocationGeometry"]);I["isDeleted"]="0";I["OwnerID"]=oSapSplUtils.getCompanyDetails()["BasicInfo_CompanyID"];I["AuditTrail.CreatedBy"]=null;I["AuditTrail.ChangedBy"]=null;I["AuditTrail.CreationTime"]=null;I["AuditTrail.ChangeTime"]=null;if(I["Priority"]===""){I["Priority"]=null;}if(I["Category"]===""){I["Category"]=null;}M["Header"].push(I);if(m==="DELETE"){I.ChangeMode="D";}o["UUID"]=s;if(c["LongText"]){if(c["LongText"].length>50){o["ShortText"]=c["LongText"].substr(0,49);}else{o["ShortText"]=c["LongText"];}o["LongText"]=c["LongText"];}else{o["ShortText"]=null;o["LongText"]=null;}if(m==="DELETE"){o.ChangeMode="D";}M["Text"].push(o);if(c["Geofences"]){var A=c["Geofences"];for(var i=0;i<A.length;i++){var l={};if(A[i]["isDeleted"]===false){l["isDeleted"]="0";l["UUID"]=oSapSplUtils.getUUID();l["ParentUUID"]=s;l["RecipientType"]="Location";if(A[i]["isStacked"]==="0"){l["RecipientUUID"]=A[i]["LocationID"];}else{if(A[i]["TechnicalLocationID"]){l["RecipientUUID"]=A[i]["TechnicalLocationID"];}else{l["RecipientUUID"]=A[i]["LocationID"];}}l["AuditTrail.CreatedBy"]=null;l["AuditTrail.ChangedBy"]=null;l["AuditTrail.CreationTime"]=null;l["AuditTrail.ChangeTime"]=null;if(m==="DELETE"){l.ChangeMode="D";}M["Recipient"].push(l);}}}if(m==="DELETE"){M["Recipient"]=[];M.inputHasChangeMode=true;}return M;},fnHandleClickOfDeleteGeofence:function(e){var m=[],l="",d=null,i;this.fnToCaptureLiveChangeToSetIsDirtyFlag();d=sap.ui.getCore().getModel("SapSplIncidentsDetailModel").getData();for(i=0;i<d["Geofences"].length;i++){m.push(jQuery.extend({},d["Geofences"][i]));}var L="";var b=e.getSource().getParent().getBindingContext().getObject();if(b["isStacked"]==="0"){L="LocationID";}else{L="TechnicalLocationID";}l=b[L];for(i=0;i<m.length;i++){L="";if(m[i]["isStacked"]==="0"){L="LocationID";}else{L="TechnicalLocationID";}if(m[i][L]===l){m[i]["CHANGEMODE"]="D";m[i]["isDeleted"]=true;m[i]["checked"]=false;}}d["Geofences"]=m;sap.ui.getCore().getModel("SapSplIncidentsDetailModel").setData(d);this.byId("SapSplIncidentsDetailAssignedGeofencesTable").getBinding("items").filter(new sap.ui.model.Filter("isDeleted",sap.ui.model.FilterOperator.EQ,false));},handleBackNavigationInGeofenceDialog:function(){var n=sap.ui.core.Fragment.byId("selectGeoFences","sapSplGeofenceToIncidentsAssignmentNavContainer");n.back();},fnHandleClickOfListItem:function(e){var g=[];var n=sap.ui.core.Fragment.byId("selectGeoFences","sapSplGeofenceToIncidentsAssignmentNavContainer");var s=null;s=e.getSource();var m=oSapSplUtils.getFQServiceUrl("/sap/spl/xs/app/services/appl.xsodata/")+"MyLocations(X'"+oSapSplUtils.base64ToHex(s.getBindingContext().getObject().LocationID)+"')";var S=m.split("xsodata/");var a=S[S.length-1];a=encodeURIComponent(a)+"/GeofenceGates";var A=s.getBindingContext().getObject()["checked"];this.sSelectedGeofenceName=s.getBindingContext().getObject()["Name"];this.sSelectedGeofenceID=s.getBindingContext().getObject()["LocationID"];g=this.getAssignedGates(a,A,this);n.getPages()[1].oMasterListItem=s;this.aSelectedLocationGates=undefined;sap.ui.core.Fragment.byId("selectGeoFences","sapSplGeofenceToIncidentAssignmentGatesList").removeSelections();sap.ui.core.Fragment.byId("selectGeoFences","listGatesPage").getModel().setData(g);n.to(n.getPages()[1].sId,"slide");if(sap.ui.core.Fragment.byId("selectGeoFences","sapSplAssignGateSearch")){sap.ui.core.Fragment.byId("selectGeoFences","sapSplAssignGateSearch").setValue("");}},getCheckedGatesFromAssignments:function(g){if(g["ID"]==="ALL"){return g["checked"];}else{var a=this.aTempListOfSelections;var r=null,c;c="TechnicalLocationID";for(var j=0;j<a.length;j++){if(a[j][c]){if(g[c]===a[j][c]&&a[j]["isDeleted"]===false){r=true;break;}else{r=false;}}}return r;}},getAssignedGates:function(s,a,t){var A=[],b=false;if(!this.oDataModel){this.oDataModel=sap.ui.getCore().getModel("IncidentsToLocationMapODataModel");}this.oDataModel.read("/"+s,null,[],false,function(r){A=r.results;if(a!==undefined&&a!==null&&a===true){b=a;}if(A.length>0){var T=A[0];A[0]={Name:oSapSplUtils.getBundle().getText("ALL_DIRECTIONS_GATE"),ID:"ALL",checked:b};A[A.length]=T;}for(var i=0;i<A.length;i++){if(b===true){A[i]["checked"]=true;}else{A[i]["checked"]=t.getCheckedGatesFromAssignments(A[i]);}A[i]["isDeleted"]=false;A[i]["CHANGEMODE"]=null;}},function(){jQuery.sap.log.error("getAssignedGates","read failed","IncidentsDetailView.controller.js");});return A;},fnHandleSelectionChange:function(e){var i,c,b,p;b=e.getParameters().listItem.getBindingContext().getObject();c="LocationID";if(b["Stacked"]==="1"){c="TechnicalLocationID";}if(e.getParameters().selected){b["isStacked"]=b["Stacked"];b["CHANGEMODE"]="C";b["GeoFenceName"]=b["Name"];b["GateName"]="";b["isDeleted"]=false;this.aTempListOfSelections.push(b);for(i=0;i<this.aTempListOfSelections.length;i++){if(this.aTempListOfSelections[i]["GeofenceID"]){p=this.aTempListOfSelections[i]["GeofenceID"];}else if(this.aTempListOfSelections[i]["isStacked"]==="1"){p=this.aTempListOfSelections[i]["LocationID"];}else{p=null;}if(p===b[c]){this.aTempListOfSelections[i]["isDeleted"]=true;}}}else{for(i=0;i<this.aTempListOfSelections.length;i++){if(this.aTempListOfSelections[i]["GeofenceID"]){p=this.aTempListOfSelections[i]["GeofenceID"];}else if(this.aTempListOfSelections[i]["isStacked"]==="1"){p=this.aTempListOfSelections[i]["LocationID"];}else{p=null;}if(p===b[c]){this.aTempListOfSelections[i]["isDeleted"]=false;}}for(i=0;i<this.aTempListOfSelections.length;i++){if(this.aTempListOfSelections[i][c]===b[c]){this.aTempListOfSelections.splice(i,1);break;}}}e.getParameters().listItem.setSelected(e.getParameters().selected);},prepareSearchPayloadForGates:function(s,L){var p={};p.ObjectType="LocationGate";p.SearchTerm=s;p.FuzzinessThershold=SapSplEnums.fuzzyThreshold;p.MaximumNumberOfRecords=SapSplEnums.numberOfRecords;p.ProvideDetails=false;p.LocationID=this.sSelectedGeofenceID;return p;},callSearchServiceForGates:function(p){var t=this;oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/app/services/Search.xsjs"),method:"POST",async:false,data:JSON.stringify(p),success:function(d,s,m){oSapSplBusyDialog.getBusyDialogInstance().close();if(d.constructor!==Array){d=JSON.parse(d);}if(m["status"]===200){var l=sap.ui.core.Fragment.byId("selectGeoFences","sapSplGeofenceToIncidentAssignmentGatesList");if(d.length>0){if(t.aSelectedLocationGates){l.getModel().setData(t.aSelectedLocationGates);}l.getBinding("items").filter(oSapSplUtils.getSearchItemFilters(d,"GateUUID",true));}else{if(l.getModel().getData().length>0){t.aSelectedLocationGates=l.getModel().getData();}sap.ui.core.Fragment.byId("selectGeoFences","listGatesPage").getModel().setData([]);}}else if(d["Error"]&&d["Error"].length>0){var e=oSapSplUtils.getErrorMessagesfromErrorPayload(d)["ufErrorObject"];sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["errorWarningString"],details:e});}},error:function(e){jQuery.sap.log.error("callSearchService","ajax failed","IncidentsDetailView.controller.js");oSapSplBusyDialog.getBusyDialogInstance().close();if(e&&e["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+"\t"+e.statusText,details:e.responseText});}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getBundle().getText("INCORRECT_ARGUMENTS_ERROR_MESSAGE"),details:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["ufErrorObject"]});}},complete:function(){}});},fnToHandleSearchOfGates:function(e){var s=e.mParameters.query,S,p;S=sap.ui.core.Fragment.byId("selectGeoFences","sapSplGeofenceToIncidentAssignmentGatesList");if(s.length>2){p=this.prepareSearchPayloadForGates(s);this.callSearchServiceForGates(p);}else if(S.getBinding("items")!==undefined){if(this.aSelectedLocationGates){S.getModel().setData(this.aSelectedLocationGates);}S.getBinding("items").filter([]);}},fnToHandleSearchOfIncidents:function(e){var t=this;var s=e.mParameters.query,d;var S,p;function h(a){var l=sap.ui.core.Fragment.byId("selectGeoFences","sapSplGeofenceToIncidentAssignmentList");l.removeSelections();if(sap.ui.getCore().getModel("GeofencesForAssignmentModel")){sap.ui.getCore().getModel("GeofencesForAssignmentModel").setData(t.getDataForFragment(a.results));t.oLocationFragment.setModel(sap.ui.getCore().getModel("GeofencesForAssignmentModel"));}else{sap.ui.getCore().setModel(new sap.ui.model.json.JSONModel(t.getDataForFragment(a.results)),"GeofencesForAssignmentModel");t.oLocationFragment.setModel(sap.ui.getCore().getModel("GeofencesForAssignmentModel"));}}S=sap.ui.core.Fragment.byId("selectGeoFences","sapSplGeofenceToIncidentAssignmentList");if(s.length>2){p=this.prepareSearchPayload(s);this.callSearchService(p);}else if(S.getBinding("items")!==undefined){d=["$filter= Tag eq 'LC0004'"];this.oSapSplGeofencesForAssignmentModel.read("/MyLocations",null,d,false,h,function(){});}},prepareSearchPayload:function(s){var p={};p.UserID=oSapSplUtils.getLoggedOnUserDetails().userId;p.ObjectType="Location";p.SearchTerm=s;p.FuzzinessThershold=SapSplEnums.fuzzyThreshold;p.MaximumNumberOfRecords=SapSplEnums.numberOfRecords;p.ProvideDetails=true;p.SearchInNetwork=true;p.AdditionalCriteria={};p.AdditionalCriteria.TagFilter=[];p.AdditionalCriteria.TagFilter[0]="LC0004";return p;},callSearchService:function(p){var t=[],i,a=this,l;oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/app/services/Search.xsjs"),method:"POST",async:false,data:JSON.stringify(p),success:function(d,s,m){oSapSplBusyDialog.getBusyDialogInstance().close();if(d.constructor!==Array){d=JSON.parse(d);}if(m["status"]===200){if(d.length>0){for(i=0;i<d.length;i++){t.push(d[i].Details);}}l=sap.ui.core.Fragment.byId("selectGeoFences","sapSplGeofenceToIncidentAssignmentList");l.removeSelections();if(sap.ui.getCore().getModel("GeofencesForAssignmentModel")){sap.ui.getCore().getModel("GeofencesForAssignmentModel").setData(a.getDataForFragment(t));a.oLocationFragment.setModel(sap.ui.getCore().getModel("GeofencesForAssignmentModel"));}else{sap.ui.getCore().setModel(new sap.ui.model.json.JSONModel(a.getDataForFragment(t)),"GeofencesForAssignmentModel");a.oLocationFragment.setModel(sap.ui.getCore().getModel("GeofencesForAssignmentModel"));}}else if(d["Error"]&&d["Error"].length>0){var e=oSapSplUtils.getErrorMessagesfromErrorPayload(d)["ufErrorObject"];sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["errorWarningString"],details:e});}},error:function(e){jQuery.sap.log.error("callSearchService","ajax failed","IncidentsDetailView.controller.js");oSapSplBusyDialog.getBusyDialogInstance().close();if(e&&e["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+"\t"+e.statusText,details:e.responseText});}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getBundle().getText("INCORRECT_ARGUMENTS_ERROR_MESSAGE"),details:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["ufErrorObject"]});}},complete:function(){}});},onAfterRendering:function(){}});
