/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
jQuery.sap.require("sap.ca.ui.message.message");sap.ui.controller("splController.dialogs.SplAssignIncidenceToGeofence",{onInit:function(){this.navContainer=this.byId("sapSplAssignIncidenceToLocationNavContainer");this.oViewData=this.getView().getViewData();this.oClickedLocationDataWithIncidents=[];this.aIncidenceMasterdata=[];this.aIncidenceDataForBinding=[];if(!this.oSapSplAppModel){var a=oSapSplUtils.getServiceMetadata("app",true);this.oSapSplAppModel=new splModels.odata.ODataModel({url:a,json:true,user:undefined,password:undefined,headers:{"Cache-Control":"max-age=0"},tokenHandling:true,withCredentials:false,loadMetadataAsync:true,handleTimeOut:true,numberOfSecondsBeforeTimeOut:10000});this.oSapSplAppModel.attachEvent("timeOut",function(){jQuery.sap.log.error("oData time out","Failure of getLocationType() function's service call","MapsDetailsView.controller.js");});}oSapSplBusyDialog.getBusyDialogInstance().open();this.getLocationDataWithIncidents();this.byId("sapSplAssignIncidenceToLocationViewIncidencePageContentList").setNoDataText(oSapSplUtils.getBundle().getText("NO_DATA_TEXT"));this.byId("sapSplAssignIncidenceToLocationAssignIncidencePageContentList").setNoDataText(oSapSplUtils.getBundle().getText("NO_DATA_TEXT"));this.byId("sapSplAssignIncidenceToLocationViewIncidencePageTitle").setText(this.oViewData["Name"]);this.byId("sapSplAssignIncidenceToLocationAssignIncidencePageTitle").setText(this.oViewData["Name"]);},setParentDialogButtonStateBasedOnCurrentPage:function(p){if(!this.oAssignIncidenceButton){this.oAssignIncidenceButton=new sap.m.Button({press:jQuery.proxy(this.fnHandlePressOfAssignIncidenceButton,this)});}if(!this.oAssignIncidenceCloseButton){this.oAssignIncidenceCloseButton=new sap.m.Button({press:jQuery.proxy(this.fnHandlePressOfAssignIncidenceCloseButton,this)});}if(p==="ViewAssignedIncidenceForm"){this.oAssignIncidenceButton.setText(oSapSplUtils.getBundle().getText("SAVE"));this.oAssignIncidenceCloseButton.setText(oSapSplUtils.getBundle().getText("CANCEL"));this.oParentDialogInstance.setBeginButton(this.oAssignIncidenceButton);this.oParentDialogInstance.setEndButton(this.oAssignIncidenceCloseButton);}else{this.oAssignIncidenceButton.setText(oSapSplUtils.getBundle().getText("EDIT"));this.oAssignIncidenceCloseButton.setText(oSapSplUtils.getBundle().getText("CLOSE"));this.oParentDialogInstance.setBeginButton(this.oAssignIncidenceButton);this.oParentDialogInstance.setEndButton(this.oAssignIncidenceCloseButton);}},setParentDialogInstance:function(p){this.oParentDialogInstance=p;this.setParentDialogButtonStateBasedOnCurrentPage("AssignIncidenceForm");},fnHandlePressOfAssignIncidenceButton:function(e){if(this.navContainer.getCurrentPage().getId().indexOf("sapSplAssignIncidenceToLocationNavContainerViewIncidencePage")>-1){this.navContainer.to(this.navContainer.getPages()[1].sId,"slide");this.setParentDialogButtonStateBasedOnCurrentPage("ViewAssignedIncidenceForm");this.getIncidentMasterData();this.getDataForBinding();}else{if(this.aIncidenceMasterdata.length!==0){var m=e.getSource().getParent().getContent()[0].getContent()[0].getModel().getData();this.saveAssignment(m);oSapSplBusyDialog.getBusyDialogInstance().open();}}},fnHandlePressOfAssignIncidenceCloseButton:function(){if(this.navContainer.getCurrentPage().getId().indexOf("sapSplAssignIncidenceToLocationNavContainerViewIncidencePage")>-1){this.getView().getParent().getParent().close();this.getView().getParent().getParent().destroy();}else{this.setParentDialogButtonStateBasedOnCurrentPage("AssignIncidenceForm");this.navContainer.to(this.navContainer.getPages()[0].sId,"slide");oSapSplBusyDialog.getBusyDialogInstance().open();this.getLocationDataWithIncidents();}},constructPayloadForPost:function(m){var s=m;var h=false;var f={},r,i,j;f["Object"]="MessageTemplate";f["Header"]=[];f["Text"]=[];f["Recipient"]=[];for(i=0;i<s.length;i++){var H={};H["UUID"]=s[i]["UUID"];H["Name"]=s[i]["Name"];H["Priority"]=s[i]["Priority"];H["Category"]=s[i]["Category"];H["SourceLocation"]=JSON.parse(s[i]["IncidentLocationGeometry"]);H["OwnerID"]=s[i]["OwnerID"];H["isDeleted"]=s[i]["isDeleted"];H["AuditTrail.CreatedBy"]=null;H["AuditTrail.ChangedBy"]=null;H["AuditTrail.CreationTime"]=null;H["AuditTrail.ChangeTime"]=null;f["Header"].push(H);var t={};t["UUID"]=s[i]["UUID"];t["ShortText"]=s[i]["ShortText"];t["LongText"]=s[i]["LongText"];f["Text"].push(t);if(s[i]["checked"]===true){if(s[i]["AssignedLocations"]["results"].length!==0){for(j=0;j<s[i]["AssignedLocations"]["results"].length;j++){if(s[i]["AssignedLocations"]["results"][j]["LocationID"]===this.oViewData["LocationID"]){h=true;}r={};r["UUID"]=oSapSplUtils.getUUID();r["ParentUUID"]=s[i]["UUID"];r["RecipientType"]="Location";r["RecipientUUID"]=s[i]["AssignedLocations"]["results"][j]["LocationID"];r["isDeleted"]="0";r["AuditTrail.CreatedBy"]=null;r["AuditTrail.ChangedBy"]=null;r["AuditTrail.CreationTime"]=null;r["AuditTrail.ChangeTime"]=null;f["Recipient"].push(r);}if(!h){r={};r["UUID"]=oSapSplUtils.getUUID();r["ParentUUID"]=s[i]["UUID"];r["RecipientType"]="Location";r["RecipientUUID"]=this.oViewData["LocationID"];r["isDeleted"]="0";r["AuditTrail.CreatedBy"]=null;r["AuditTrail.ChangedBy"]=null;r["AuditTrail.CreationTime"]=null;r["AuditTrail.ChangeTime"]=null;f["Recipient"].push(r);}}else{r={};r["UUID"]=oSapSplUtils.getUUID();r["ParentUUID"]=s[i]["UUID"];r["RecipientType"]="Location";r["RecipientUUID"]=this.oViewData["LocationID"];r["isDeleted"]="0";r["AuditTrail.CreatedBy"]=null;r["AuditTrail.ChangedBy"]=null;r["AuditTrail.CreationTime"]=null;r["AuditTrail.ChangeTime"]=null;f["Recipient"].push(r);}}else{for(j=0;j<s[i]["AssignedLocations"]["results"].length;j++){if(s[i]["AssignedLocations"]["results"][j]["LocationID"]!==this.oViewData["LocationID"]){r={};r["UUID"]=oSapSplUtils.getUUID();r["ParentUUID"]=s[i]["UUID"];r["RecipientType"]="Location";r["RecipientUUID"]=s[i]["AssignedLocations"]["results"][j]["LocationID"];r["isDeleted"]="0";r["AuditTrail.CreatedBy"]=null;r["AuditTrail.ChangedBy"]=null;r["AuditTrail.CreationTime"]=null;r["AuditTrail.ChangeTime"]=null;f["Recipient"].push(r);}}}}return f;},saveAssignment:function(m){var t=this;var f=this.constructPayloadForPost(m);var s=oSapSplUtils.getServiceMetadata("message",true);oSapSplBusyDialog.getBusyDialogInstance().open();oSapSplAjaxFactory.fireAjaxCall({url:s,method:"PUT",data:JSON.stringify(f),success:function(r,a,x){if(r.constructor===String){r=JSON.parse(r);}if(x.status===200){oSapSplBusyDialog.getBusyDialogInstance().close();sap.ca.ui.message.showMessageToast("Location saved successfully");t.byId("sapSplAssignIncidenceToLocationNavContainer").back();t.getLocationDataWithIncidents();t.setParentDialogButtonStateBasedOnCurrentPage("AssignIncidenceForm");}else if(x.status===202){var e=oSapSplUtils.getErrorMessagesfromErrorPayload(r);sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(r)["errorWarningString"],details:e});oSapSplBusyDialog.getBusyDialogInstance().close();}},error:function(x,a,e){if(x){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:x["status"]+" "+x.statusText,details:x.responseText});}oSapSplBusyDialog.getBusyDialogInstance().close();jQuery.sap.log.error(e,a,"SplAssignIncidenceToGeofence.controller.js");},complete:function(){}});},getDataForBinding:function(){var I=jQuery.extend([],this.aIncidenceMasterdata);var a=this.aIncidenceMasterdata.length;var b=this.oClickedLocationDataWithIncidents.length;var c=0;for(var i=0;i<a;i++){if(b!==0){for(var j=0;j<b;j++){if(I[i]["UUID"]===this.oClickedLocationDataWithIncidents[j]["UUID"]){c++;I[i]["checked"]=true;I[i]["counter"]=c;}else{I[i]["checked"]=false;I[i]["counter"]=0;}}}else{I[i]["checked"]=false;I[i]["counter"]=0;}}this.oIncidentsVisualizationModel.setData(jQuery.extend([],I));this.byId("sapSplAssignIncidenceToLocationAssignIncidencePageContentList").getBinding("items").sort(new sap.ui.model.Sorter("counter",true));},getLocationDataWithIncidents:function(){var t=this;function s(d){var a=d.results[0]["Incidents"].results;for(var i=0;i<a.length;i++){a[i]["selected"]=true;}t.oClickedLocationDataWithIncidents=d.results[0]["Incidents"].results;oSapSplBusyDialog.getBusyDialogInstance().close();t.oIncidentsVisualizationModel=new sap.ui.model.json.JSONModel(t.oClickedLocationDataWithIncidents);t.getView().setModel(t.oIncidentsVisualizationModel);}function e(){oSapSplBusyDialog.getBusyDialogInstance().close();}var f="$filter=("+encodeURIComponent("LocationID eq "+"X"+"\'"+this.oViewData["LocationID"]+"\'")+")&$expand=Incidents";oSapSplBusyDialog.getBusyDialogInstance().open();this.oSapSplAppModel.read("/MyLocations",null,[f],false,s,e);},getIncidentMasterData:function(){var t=this;function s(d){t.aIncidenceMasterdata=d.results;oSapSplBusyDialog.getBusyDialogInstance().close();}function e(){oSapSplBusyDialog.getBusyDialogInstance().close();}var f="$expand=AssignedLocations";oSapSplBusyDialog.getBusyDialogInstance().open();this.oSapSplAppModel.read("/IncidentDetails",null,[f],false,s,e);}});
