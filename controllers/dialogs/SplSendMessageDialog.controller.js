/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
jQuery.sap.require("sap.ca.ui.message.message");sap.ui.controller("splController.dialogs.SplSendMessageDialog",{onInit:function(){var t=this;oSapSplUtils.setIsDirty(false);this.byId("SapSplMessageValidFromDateTime").setValue(new Date());this.byId("SapSplMessageValidToDateTime").setValue(new Date(new Date().getTime()+120*60000));this.navContainer=this.byId("SapSplSendMessageNavContainer");this.oSapSplValueHelpForSelectGeofencesInput=this.byId("SapSplValueHelpForSelectGeofencesInput");sap.ui.getCore().setModel(new sap.ui.model.json.JSONModel(),"sapSplSendMessageSelectDialogModel");this.byId("SapSplSendMessageSelectDialogList").setModel(sap.ui.getCore().getModel("sapSplSendMessageSelectDialogModel"));this.byId("SapSplSendMessageSelectDialogListIncident").setModel(sap.ui.getCore().getModel("sapSplSendMessageSelectDialogModel"));this.byId("SapSplSendMessageSelectViewList").setModel(sap.ui.getCore().getModel("sapSplSendMessageSelectDialogModel"));this.byId("SapSplMessageValidFromDateTime").addCustomData(new sap.ui.core.CustomData({key:"type",value:"From"}));this.byId("SapSplMessageValidToDateTime").addCustomData(new sap.ui.core.CustomData({key:"type",value:"To"}));this.getDataForGeofencesAndIncidents();this.fnDefineControlLabelsFromLocalizationBundle();this.oViewData=this.getView().getViewData();if(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["isIncidentEditable"]===0){this.byId("sapSplMessageToRecipientMessageFieldLayout").removeContent(1);}else{this.byId("sapSplAttachIncidentLink").setText(oSapSplUtils.getBundle().getText("ATTACH_INCIDENT_LINK"));}if(this.oViewData&&(this.oViewData["mode"]==="Trucks"||this.oViewData["mode"]==="All_Trucks")||(this.oViewData["mode"]==="Views")){this.byId("SapSplMessageReceipientsLabel").setText(oSapSplUtils.getBundle().getText("SEND_MESSAGE_RECIPIENTS_TRUCK"));this.byId("SapSplMessageValidFromDateTime").setVisible(false);this.byId("SapSplMessageValidToDateTime").setVisible(false);this.byId("SapSplGeofencesValueHelpCell").getParent().getParent().removeStyleClass("valueHelpMainLayout").addStyleClass("valueHelpMainLayoutForTruck");this.byId("SapSplValueHelpForSelectGeofencesInput").setVisible(false);this.byId("SapSplGeofencesValueHelpCell").destroyContent();if(this.oViewData["Reg"]&&this.oViewData["ID"]){this.byId("SapSplGeofencesValueHelpCell").addContent(this.getSelectedItemLayout({Reg:this.oViewData["Reg"],ID:this.oViewData["ID"]},"truck",this.oViewData["bAllowDelete"]));}else{if(this.oViewData["mode"]!=="Views"){this.byId("SapSplGeofencesValueHelpCell").addContent(new sap.m.Text({text:oSapSplUtils.getBundle().getText("SEND_MESSAGE_DIALOG_SELECT_TRUCKS")}).addStyleClass("selectTruckOnMapPlaceholder"));}else{this.byId("SapSplGeofencesValueHelpCell").addStyleClass("selectTruckOnMapPlaceholder");}}if(this.oViewData["mode"]==="All_Trucks"){for(var i=0;i<this.oViewData["trucks"].length;i++){oSapSplMapsDataMarshal.fnSelectDeselectTrucks(this.oViewData["trucks"][i],this.oViewData["liveAppInstance"],function(r){var S=[];for(var i=0;i<r.length;i++){var T={};T["ID"]=r[i]["DeviceUUID"];T["Position"]=r[i]["Position"];T["TourName"]=r[i]["TourName"];if(r[i]["RegistrationNumber"]===null){T["Reg"]=oSapSplUtils.getBundle().getText("TRUCK");}else{T["Reg"]=r[i]["RegistrationNumber"];}S.push(T);}t.fnHandleClickOfTrucksOnTheMap(S);},true);}}}if(this.oViewData&&(this.oViewData["mode"]==="Views")){this.navContainer.to(this.navContainer.getPages()[1].sId);this.byId("SapSplSendMessageSelectViewList").setModel(sap.ui.getCore().getModel("LiveAppODataModel"));var s=new sap.ui.model.Sorter("isMyCompanyView",false,function(c){var o=c.getProperty("OwnerName");var I=c.getProperty("isMyCompanyView");if(I===1){return{key:"My Owner",text:"{splI18NModel>MY_COMPANY_DISPLAY_AREAS}"};}else{return{key:o,text:o};}});this.byId("SapSplSendMessageSelectViewList").getBinding("items").sort(s);this.byId("SapSplSendMessageSelectViewList").addEventDelegate({onAfterRendering:function(e){e.srcControl.setBusy(false);var S=t.getView().getViewData().sSelectedDisplayArea;if(e.srcControl.getItems().length>0){if(S!==oSapSplUtils.getBundle().getText("SELECT_DISPLAY_AREA")){for(var i=0;i<e.srcControl.getItems().length;i++){if(e.srcControl.getItems()[i].getTitle()===S){e.srcControl.getItems()[i].setSelected(true);break;}}}}}});}else{this.navContainer.setInitialPage(this.navContainer.getPages()[0].sId);}this.getView().addEventDelegate({onAfterRendering:function(){setTimeout(function(){t.getView().getParent().getParent().$().css("top","100px");t.getView().getParent().getParent().$().css("left","90px");},1500);if(t.getView().byId("SapSplMessageReceipientsLabel").getText()!==oSapSplUtils.getBundle().getText("SEND_MESSAGE_RECIPIENTS_GEOFENCE")){setTimeout(function(){t.byId("SapSplMessageFromIncidentInput").focus();},1000);}else{setTimeout(function(){if(t.byId("SapSplValueHelpForSelectGeofencesInput")){t.byId("SapSplValueHelpForSelectGeofencesInput").focus();}},1000);}}});this.byId("SapSplSendMessagesPage").addEventDelegate({onAfterShow:function(){setTimeout(function(){if(t.byId("SapSplValueHelpForSelectGeofencesInput")){t.byId("SapSplValueHelpForSelectGeofencesInput").focus();}},100);}});this.byId("SapSplSendMessageSelectGeofencePage").addEventDelegate({onAfterShow:function(){setTimeout(function(){t.byId("SapSplsearchOfGeofences").focus();},500);}});},fnHandleChangeOfInputField:function(e){e.getSource().setValue("");},fnDefineControlLabelsFromLocalizationBundle:function(){this.byId("SapSplSendMessagesPage").setTitle(oSapSplUtils.getBundle().getText("SEND_MESSAGE_DIALOG_TITLE"));this.byId("SapSplSendMessageSelectViewPage").setTitle(oSapSplUtils.getBundle().getText("SEND_MESSAGE_VIA_VIEW_DIALOG_TITLE"));this.byId("SapSplMessageReceipientsLabel").setText(oSapSplUtils.getBundle().getText("SEND_MESSAGE_RECIPIENTS_GEOFENCE"));this.byId("SapSplValueHelpForSelectGeofencesInput").setPlaceholder(oSapSplUtils.getBundle().getText("SEND_MESSAGE_SELECT_GEOFENCE"));this.byId("SapSplIncidentMessageLabel").setText(oSapSplUtils.getBundle().getText("INCIDENTS_MESSAGE"));this.byId("SapSplMessageValidFrom").setText(oSapSplUtils.getBundle().getText("SEND_MESSAGE_VALID_FROM"));this.byId("SapSplMessageValidTo").setText(oSapSplUtils.getBundle().getText("SEND_MESSAGE_VALID_UNTIL"));this.byId("SapSplMessagePriorityLabel").setText(oSapSplUtils.getBundle().getText("INCIDENTS_PRIORITY"));this.byId("SapSplSendMessageSelectDialogList").setNoDataText(oSapSplUtils.getBundle().getText("NO_DATA_TEXT"));this.byId("SapSplSendMessageSelectDialogListIncident").setNoDataText(oSapSplUtils.getBundle().getText("NO_DATA_TEXT"));this.byId("SapSplPriorityRadioButton_1").setText(oSapSplUtils.getBundle().getText("INCIDENTS_PRIORITY_1"));this.byId("SapSplPriorityRadioButton_2").setText(oSapSplUtils.getBundle().getText("INCIDENTS_PRIORITY_2"));this.byId("SapSplPriorityRadioButton_3").setText(oSapSplUtils.getBundle().getText("INCIDENTS_PRIORITY_3"));this.byId("SapSplPriorityRadioButton_4").setText(oSapSplUtils.getBundle().getText("INCIDENTS_PRIORITY_4"));},getDataForGeofencesAndIncidents:function(){if(!this.oSapSplApplModel){this.oSapSplApplModel=new splModels.odata.ODataModel({url:oSapSplUtils.getServiceMetadata("app",true),json:true,user:undefined,password:undefined,headers:{"Cache-Control":"max-age=0"},tokenHandling:true,withCredentials:false,loadMetadataAsync:true,handleTimeOut:true,numberOfSecondsBeforeTimeOut:10000});}this.oSapSplApplModel.read("/MyLocations",null,["$filter=((Tag eq 'LC0004' or Tag eq 'LC0008') and isMyOrgObject eq '1') or ((Tag eq 'LC0004' or Tag eq 'LC0008') and isPublic eq '1') "],true,jQuery.proxy(this.fnSuccessOfMyLocationsRead,this),jQuery.proxy(this.fnFailOfMyLocationsRead,this));this.oSapSplApplModel.read("/IncidentDetails",null,["$filter=isDeleted eq '0'"],true,jQuery.proxy(this.fnSuccessOfIncidentsRead,this),jQuery.proxy(this.fnFailOfIncidentsRead,this));},fnSuccessOfMyLocationsRead:function(r){var s={};var a=[];var A={};A["bIsSelected"]=false;A["Name"]=oSapSplUtils.getBundle().getText("FILTER_LABEL_ALL");A["TitleID"]=oSapSplUtils.getBundle().getText("FILTER_LABEL_ALL");a.push(A);for(var i=0;i<r.results.length;i++){r.results[i]["bIsSelected"]=false;a.push(r.results[i]);}sap.ui.getCore().getModel("sapSplSendMessageSelectDialogModel").setSizeLimit(r.results.length+1);s=sap.ui.getCore().getModel("sapSplSendMessageSelectDialogModel").getData();s["Geofences"]=a;sap.ui.getCore().getModel("sapSplSendMessageSelectDialogModel").setData(s);this.oSapSplValueHelpForSelectGeofencesInput.setModel(sap.ui.getCore().getModel("sapSplSendMessageSelectDialogModel"));},fnHandleSelectOfViewItem:function(e){var t=this;if(this.byId("SapSplSendMessageSelectViewList").getSelectedItem().getCustomData().length===0){this.navContainer.to(this.navContainer.getPages()[0].sId,"slide");this.navContainer.getPages()[0].setShowNavButton(true);this.byId("SapSplSendMessageSelectViewList").getSelectedItem().addCustomData(new sap.ui.core.CustomData({key:"selected",value:true}));var d=this.byId("SapSplSendMessageSelectViewList").getSelectedItem().getBindingContext().getProperty().Name;this.navContainer.getPages()[0].setTitle(oSapSplUtils.getBundle().getText("SEND_MESSAGE_VIA_VIEW_DIALOG2_TITLE",d));this.byId("SapSplMessageReceipientsLabel").setText(oSapSplUtils.getBundle().getText("SEND_MESSAGE_RECIPIENTS_TRUCK_VIA_DISPLAY_VIEW",d));this.oSapSplSendMessageSendButton.setVisible(true);if(this.byId("sapSplMessageToRecipientTextArea")){setTimeout(function(){if(sap.ui.getCore().byId($(".sapSplMessageToRecipientTextArea").attr("id"))){sap.ui.getCore().byId($(".sapSplMessageToRecipientTextArea").attr("id")).focus();}},1000);}function s(D){var T=D.results;this.byId("SapSplGeofencesValueHelpCell").removeAllContent();for(var i=0;i<T.length;i++){oSapSplMapsDataMarshal.fnSelectDeselectTrucks(T[i],t.oViewData["liveAppInstance"],function(r){var S=[];for(var i=0;i<r.length;i++){var o={};o["ID"]=r[i]["DeviceUUID"];o["Position"]=r[i]["Position"];o["TourName"]=r[i]["TourName"];if(r[i]["RegistrationNumber"]===null){o["Reg"]=oSapSplUtils.getBundle().getText("TRUCK");}else{o["Reg"]=r[i]["RegistrationNumber"];}S.push(o);}t.fnHandleClickOfTrucksOnTheMap(S);});}this.aSelectedTrucksForBackNavigation=T;};function f(){jQuery.sap.log.error("Trucks inside display area","read failed","liveApp.controller.js");};var F="$filter=("+encodeURIComponent("LocationID eq "+"X"+"\'"+oSapSplUtils.base64ToHex(e.getParameters().listItem.getBindingContext().getProperty().LocationID)+"\'")+")";oSapSplBusyDialog.getBusyDialogInstance().open();this.oSapSplApplModel.read("/TrackableObjectsWithinView",null,[F],false,jQuery.proxy(s,this),jQuery.proxy(f,this));oSapSplBusyDialog.getBusyDialogInstance().close();jQuery(".sapUiBLy").css("z-index","0");}},fnHandlePressOfSendMessageBackButton:function(){this.navContainer.back();this.oSapSplSendMessageSendButton.setVisible(false);for(var i=0;i<this.aSelectedTrucksForBackNavigation.length;i++){oSapSplMapsDataMarshal.fnSelectDeselectTrucks(this.aSelectedTrucksForBackNavigation[i],this.oViewData["liveAppInstance"],function(){});}this.aSelectedTrucksForBackNavigation=[];this.byId("SapSplSendMessageSelectViewList").getSelectedItem().destroyCustomData();},fnFailOfMyIncidentsRead:function(){},fnSuccessOfIncidentsRead:function(r){var s={};for(var i=0;i<r.results.length;i++){r.results[i]["bIsSelected"]=false;}s=sap.ui.getCore().getModel("sapSplSendMessageSelectDialogModel").getData();s["Incidents"]=r.results;sap.ui.getCore().getModel("sapSplSendMessageSelectDialogModel").setData(s);},fnFailOfMyLocationsRead:function(){},setParentDialogButtonStateBasedOnCurrentPage:function(p){this.oParentDialogInstance.destroyBeginButton();this.oParentDialogInstance.destroyEndButton();this.oSapSplSendMessageSendButton=null;this.oSapSplSendMessageCancelButton=null;this.oSapSplSendMessageSelectOKButton=null;this.oSapSplSendMessageSelectCancelButton=null;if(!this.oSapSplSendMessageSendButton){this.oSapSplSendMessageSendButton=new sap.m.Button({text:oSapSplUtils.getBundle().getText("SEND_MESSAGE_ACTION_TEXT"),press:jQuery.proxy(this.fnHandlePressOfSendMessageDialog,this),enabled:true});}if(!this.oSapSplSendMessageCancelButton){this.oSapSplSendMessageCancelButton=new sap.m.Button({text:oSapSplUtils.getBundle().getText("MY_COLLEAGUES_CANCEL_BUTTON"),press:jQuery.proxy(this.fnHandlePressOfSendMessageDialogCancel,this)});}if(!this.oSapSplSendMessageSelectOKButton){this.oSapSplSendMessageSelectOKButton=new sap.m.Button({text:oSapSplUtils.getBundle().getText("OK_BUTTON_TEXT"),press:jQuery.proxy(this.fnHandlePressOfButtonWithSelection,this)});}if(!this.oSapSplSendMessageSelectCancelButton){this.oSapSplSendMessageSelectCancelButton=new sap.m.Button({text:oSapSplUtils.getBundle().getText("MY_COLLEAGUES_CANCEL_BUTTON"),press:jQuery.proxy(this.fnHandlePressOfButtonWithOutSelection,this)});}if(p==="Form"){this.oParentDialogInstance.setBeginButton(this.oSapSplSendMessageSendButton);this.oParentDialogInstance.setEndButton(this.oSapSplSendMessageCancelButton);}else if(p==="Select_Multi"){this.oParentDialogInstance.setBeginButton(this.oSapSplSendMessageSelectOKButton);this.oParentDialogInstance.setEndButton(this.oSapSplSendMessageSelectCancelButton);}else{this.oParentDialogInstance.setEndButton(this.oSapSplSendMessageSelectCancelButton);}},fnValueHelpForSelectGeofences:function(){this.fnOpenDialogForValueHelp(oSapSplUtils.getBundle().getText("SEND_MESSAGE_SELECT_GEOFENCE"),"Geofences");},fnValueHelpForIncidentMessage:function(){this.fnOpenDialogForValueHelp(oSapSplUtils.getBundle().getText("SEND_MESSAGE_SELECT_INCIDENT"),"Incidents");},fnHandlePressOfSendMessageDialogCancel:function(){var t=this;if(oSapSplUtils.getIsDirty()){sap.m.MessageBox.show(oSapSplUtils.getBundle().getText("DATA_LOSS_WARNING_TEXT"),sap.m.MessageBox.Icon.WARNING,oSapSplUtils.getBundle().getText("WARNING"),[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.CANCEL],function(s){if(s==="YES"){if(t.oViewData["mode"]==="All_Trucks"){for(var i=0;i<t.oViewData["trucks"].length;i++){oSapSplMapsDataMarshal.fnSelectDeselectTrucks(t.oViewData["trucks"][i],t.oViewData["liveAppInstance"]);}}t.getView().getParent().getParent().close();oSapSplUtils.setIsDirty(false);}else{jQuery(".sapMDialogBlockLayerInit").css("display","none");}},null,oSapSplUtils.fnSyncStyleClass("messageBox"));}else{t.getView().getParent().getParent().close();oSapSplUtils.setIsDirty(false);}},fnHandlePressOfButtonWithOutSelection:function(){this.setParentDialogButtonStateBasedOnCurrentPage("Form");this.navContainer.back();},fnHandlePressOfButtonWithSelection:function(){this.setParentDialogButtonStateBasedOnCurrentPage("Form");if(this.byId("SapSplSendMessageNavContainer").getCurrentPage().sId.split("--")[1]==="SapSplSendMessageSelectGeofencePage"){this.byId("SapSplsearchOfGeofences").setValue("");this.byId("SapSplSendMessageSelectDialogList").getBinding("items").filter([]);this.fnChangeValueHelpWithSelectedItem(this.byId("SapSplSendMessageSelectDialogList"));}else{this.fnChangeValueHelpWithSelectedItem(this.byId("SapSplSendMessageSelectDialogListIncident"));}this.navContainer.back();},fnChangeValueHelpWithSelectedItem:function(s){var c=null,I=null,t=this;if(s.getMode()==="MultiSelect"){if(s.getSelectedItems().length>0){oSapSplUtils.setIsDirty(true);c=this.byId("SapSplGeofencesValueHelpCell").getContent();I=c[c.length-1];this.byId("SapSplGeofencesValueHelpCell").removeAllContent();this.byId("SapSplGeofencesValueHelpCell").addContent(I);var a=s.getSelectedItems();for(var i=0;i<a.length;i++){if(!a[i].getBindingContext().getProperty()["TitleID"]){if(!this.isGeofenceIsInTheValueHelpList(a[i].getBindingContext().getProperty()["LocationID"])){this.byId("SapSplGeofencesValueHelpCell").insertContent(this.getSelectedItemLayout(a[i].getBindingContext().getProperty(),"geofence"),0);this.byId("SapSplGeofencesValueHelpLayout").removeStyleClass("redBorder");}this.byId("SapSplValueHelpForSelectGeofencesInput").setValue("");}}window.setTimeout(function(){t.byId("SapSplValueHelpForSelectGeofencesInput").$().children()[0].focus();},1000);}}else{if(s.getSelectedItem()){oSapSplUtils.setIsDirty(true);this.selectedIncidentSourceLocation=null;var o=s.getSelectedItem().getBindingContext().getProperty();var C=new sap.ui.core.CustomData({key:"ID",value:{id:o["UUID"],type:"incident",object:o["Name"]}});this.byId("sapSplAttachIncidentLink").destroyCustomData();this.byId("sapSplAttachIncidentLink").addCustomData(C);this.byId("sapSplAttachIncidentLink").setText(o["Name"]);if(o["LongText"]){this.byId("SapSplMessageFromIncidentInput").setValue(o["LongText"]);this.byId("sapSplMessageToRecipientMessageFieldLayout").removeStyleClass("redBorder");}this.selectedIncidentSourceLocation=o["IncidentLocationGeometry"];if(o["Priority"]){this.fnPriorityRadioButtonLayoutAccess("set",o["Priority"]);}}}},fnPriorityRadioButtonLayoutAccess:function(m,p){var r=this.byId("SapSplSendMessagePriorityRadioButtonHolder").getContent();var b="";if(m==="set"&&p){for(var i=0;i<r.length;i++){b=r[i].sId.split("_");if(b[b.length-1]===p){r[i].setSelected(true);}else{r[i].setSelected(false);}}}else if(m==="get"){for(var j=0;j<r.length;j++){if(r[j].getSelected()){b=r[j].sId.split("_");return b[b.length-1];}}}},sapSplHandleDateChange:function(e){var t=this;oSapSplUtils.setIsDirty(true);if(e&&e.getSource()&&e.getSource().getCustomData()[0]&&e.getSource().getCustomData()[0].getValue()==="To"){if(new Date(e.getSource().getValue())<new Date(t.byId("SapSplMessageValidFromDateTime").getValue())){t.byId("SapSplMessageValidToDateTime").setValue(t.byId("SapSplMessageValidFromDateTime").getValue());}}else{if(new Date(e.getSource().getValue())>new Date(t.byId("SapSplMessageValidToDateTime").getValue())){t.byId("SapSplMessageValidToDateTime").setValue(t.byId("SapSplMessageValidFromDateTime").getValue());}}},sapSplChangeDirtyFlag:function(e){oSapSplUtils.setIsDirty(true);if(e.getParameters("newValue").length===0){this.byId("sapSplMessageToRecipientMessageFieldLayout").addStyleClass("redBorder");}else{this.byId("sapSplMessageToRecipientMessageFieldLayout").removeStyleClass("redBorder");}},getThreadUUID:function(f){var r=null;oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/app/services/appl.xsodata/ThreadList?"+f+"&$format=json"),method:"GET",async:false,success:function(d){if(d.d.results.length>0){r=d.d.results[0]["ThreadUUID"];}else{r=oSapSplUtils.getUUID();}},error:function(){r=oSapSplUtils.getUUID();}});return r;},fnGetListOfRecipientsFromValueHelpControl:function(p,I,s,e,S){var r=null,a=[];r=this.byId("SapSplGeofencesValueHelpCell").getContent();var u=oSapSplUtils.getUUID();var h={},t={};h["UUID"]=u;h["Type"]="DM";h["TemplateUUID"]=I;h["Priority"]=p;h["OwnerID"]=oSapSplUtils.getCompanyDetails()["BasicInfo_CompanyID"];h["SenderID"]=oSapSplUtils.getCompanyDetails()["BasicInfo_CompanyID"];h["Validity.StartTime"]=s;h["Validity.EndTime"]=e;h["AuditTrail.CreatedBy"]=null;h["AuditTrail.ChangedBy"]=null;h["AuditTrail.CreationTime"]=null;h["AuditTrail.ChangeTime"]=null;if(this.selectedIncidentSourceLocation){h["SourceLocation"]=JSON.parse(this.selectedIncidentSourceLocation);}else{h["SourceLocation"]=null;}var R="Location";if(this.oViewData&&this.oViewData["mode"]&&(this.oViewData["mode"]==="Trucks"||this.oViewData["mode"]==="All_Trucks")){R="Truck";}for(var i=0;i<r.length;i++){if((r[i].constructor!==sap.m.Input)&&(r[i].constructor!==sap.m.Text)){var o={};o["RecipientUUID"]=r[i].getCustomData()[0].getValue().id;o["UUID"]=oSapSplUtils.getUUID();o["ParentUUID"]=u;o["RecipientType"]=R;o["isRead"]="0";a.push(o);}}if(a.length===1){var f="$filter=("+encodeURIComponent("RecipientUUID eq "+"X"+"\'"+oSapSplUtils.base64ToHex(a[0]["RecipientUUID"])+"\'")+" and "+encodeURIComponent("SenderID eq "+"X"+"\'"+oSapSplUtils.base64ToHex(oSapSplUtils.getCompanyDetails()["BasicInfo_CompanyID"])+"\'")+") or ("+encodeURIComponent("SenderID eq "+"X"+"\'"+oSapSplUtils.base64ToHex(a[0]["RecipientUUID"])+"\'")+" and "+encodeURIComponent("RecipientUUID eq "+"X"+"\'"+oSapSplUtils.base64ToHex(oSapSplUtils.getCompanyDetails()["BasicInfo_CompanyID"])+"\')");h["ThreadUUID"]=this.getThreadUUID(f);}else{h["ThreadUUID"]=oSapSplUtils.getUUID();}t["UUID"]=u;t["ShortText"]=S;t["LongText"]=S;return{Header:[h],Recipient:a,Text:[t],Object:"MessageOccurrence"};},fnIsAllMandatoryFieldsFilled:function(){var r=true;if(this.byId("SapSplGeofencesValueHelpCell").getContent().length===0||(this.byId("SapSplGeofencesValueHelpCell").getContent().length===1&&(this.byId("SapSplGeofencesValueHelpCell").getContent()[0].constructor===sap.m.Text||this.byId("SapSplGeofencesValueHelpCell").getContent()[0].constructor===sap.m.Input))){this.byId("SapSplGeofencesValueHelpLayout").addStyleClass("redBorder");r=false;}else{this.byId("SapSplGeofencesValueHelpLayout").removeStyleClass("redBorder");}if(this.byId("SapSplMessageFromIncidentInput").getValue().length===0){this.byId("sapSplMessageToRecipientMessageFieldLayout").addStyleClass("redBorder");r=false;}else{this.byId("sapSplMessageToRecipientMessageFieldLayout").removeStyleClass("redBorder");}return r;},fnHandlePressOfSendMessageDialog:function(){if(this.fnIsAllMandatoryFieldsFilled()){var p=null;var t=this;p=this.preparePayLoadForMessagePost();oSapSplBusyDialog.getBusyDialogInstance().open();oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getServiceMetadata("message",true),method:"POST",beforeSend:function(r){r.setRequestHeader("X-CSRF-Token",oSapSplUtils.getCSRFToken());},contentType:"json; charset=UTF-8",data:JSON.stringify(p),success:function(d,s,m){oSapSplBusyDialog.getBusyDialogInstance().close();if(d.constructor===String){d=JSON.parse(d);}if(m["status"]===200&&d["Error"].length===0){sap.ca.ui.message.showMessageToast(oSapSplUtils.getBundle().getText("MESSAGE_SENT_SUCCESSFULLY"));oSapSplUtils.setIsDirty(false);t.fnHandlePressOfSendMessageDialogCancel();}else{var e=oSapSplUtils.getErrorMessagesfromErrorPayload(d)["ufErrorObject"];sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["errorWarningString"],details:e});}},error:function(e){oSapSplBusyDialog.getBusyDialogInstance().close();if(e&&e["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+" "+e.statusText,details:e.responseText});}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["ufErrorObject"]});}},complete:function(){}});}},fireCancelAction:function(){$(".sapMDialogBlockLayerInit").css("z-index","0");},preparePayLoadForMessagePost:function(){var p="",I=null,s="",e="",S="";if(this.byId("sapSplAttachIncidentLink")&&this.byId("sapSplAttachIncidentLink").getCustomData().length>0){I=this.byId("sapSplAttachIncidentLink").getCustomData()[0].getValue().id;}else{I="";}p=this.fnPriorityRadioButtonLayoutAccess("get");s=this.byId("SapSplMessageValidFromDateTime").getValue().toString();e=this.byId("SapSplMessageValidToDateTime").getValue().toString();S=this.byId("SapSplMessageFromIncidentInput").getValue();return this.fnGetListOfRecipientsFromValueHelpControl(p,I,new Date(s).toJSON(),new Date(e).toJSON(),S);},fnOpenDialogForValueHelp:function(t,p){var n="";if(p==="Geofences"){this.setParentDialogButtonStateBasedOnCurrentPage("Select_Multi");n=this.navContainer.getPages()[2].sId;this.byId("SapSplSendMessageSelectDialogTitle").setText(t);}else{this.setParentDialogButtonStateBasedOnCurrentPage("Select_Single");n=this.navContainer.getPages()[3].sId;this.byId("SapSplSendMessageSelectDialogTitleIncident").setText(t);}this.navContainer.to(n,"slide");},setParentDialogInstance:function(p,P){this.oParentDialogInstance=p;this.oPRMMessagingController=P;this.setParentDialogButtonStateBasedOnCurrentPage("Form");if(this.oViewData&&(this.oViewData["mode"]==="Views")){this.oSapSplSendMessageSendButton.setVisible(false);}},getSelectedItemLayout:function(i,m,a){var d=null,I=null,o=null,s="",b="",c=null;if(m&&m==="geofence"){s=i["Name"];b=i["LocationID"];}else if(m&&m==="truck"){s=i["Reg"];b=i["ID"];}else{s=i["Name"];b=i["UUID"];}if(s&&s.constructor===String&&s.length>=25){s=s.substring(0,25)+"...";}c=new sap.ui.core.CustomData({key:"ID",value:{id:b,type:m,object:i}});var t=this;d=new sap.m.Button({text:"x",type:"Unstyled"}).addStyleClass("itemLayoutButton").addStyleClass("deleteItemButton");if(m==="truck"){d.setEnabled(true);}if(a!==undefined&&a===false){d.setVisible(false);}I=new sap.m.Button({text:s,type:"Unstyled"}).addStyleClass("itemLayoutButton").addStyleClass("itemDetailButton");o=new sap.ui.layout.HorizontalLayout({content:[I,d]}).addStyleClass("itemLayout");d.attachPress(function(e){var S=e.getSource().getParent();var T=S.getCustomData()[0].getValue().type;var O=S.getCustomData()[0].getValue().object;t.fnChangeTheSelectionOfListItems(S,false,T,true);setTimeout(function(){if(t.byId("SapSplGeofencesValueHelpCell").getContent().length>0){t.byId("SapSplGeofencesValueHelpCell").getContent()[0].getContent()[0].$().focus();}},250);S.destroy();if(T==="geofence"){window.setTimeout(function(){t.oSapSplValueHelpForSelectGeofencesInput.$().children()[0].focus();},1000);t.oSapSplValueHelpForSelectGeofencesInput.setPlaceholder("");}else if(T==="incident"){t.byId("SapSplMessageFromIncidentInput").setValue("");}else{if(O){O["DeviceUUID"]=O["ID"];if(O["Reg"]===oSapSplUtils.getBundle().getText("TRUCK")){O["RegistrationNumber"]=null;}else{O["RegistrationNumber"]=O["Reg"];}oSapSplMapsDataMarshal.fnSelectDeselectTrucks(O,t.oPRMMessagingController.byId("oSapSplLiveAppMap"),function(){});}}});return o.addCustomData(c);},fnHandleCheckUncheckOfListItem:function(e){var I=e.getParameter("listItem");var m=sap.ui.getCore().getModel("sapSplSendMessageSelectDialogModel").getData();var g=m["Geofences"];if(!I.getBindingContext().getProperty()["TitleID"]){if(I.getSelected()===false){for(var i=0;i<g.length;i++){if(g[i]["TitleID"]){g[i]["bIsSelected"]=false;break;}}this.fnDeleteTheButtonLayoutBasedOnListItemCheck(I.getBindingContext().getProperty().LocationID);oSapSplMapsDataMarshal.isGeofenceSelectDeselectEnabled=true;oSapSplMapsDataMarshal.fnSelectDeselectFences(I.getBindingContext().getProperty(),this.oPRMMessagingController.byId("oSapSplLiveAppMap"),function(){});}else{oSapSplMapsDataMarshal.isGeofenceSelectDeselectEnabled=true;oSapSplMapsDataMarshal.fnSelectDeselectFences(I.getBindingContext().getProperty(),this.oPRMMessagingController.byId("oSapSplLiveAppMap"),function(){});}}else{if(g&&g.length>1){for(var j=0;j<g.length;j++){if(!g[j]["TitleID"]){if(I.getSelected()===true){I.getParent().getItems()[j].setSelected(true);I.getParent().fireSelect({listItem:I.getParent().getItems()[j]});}else{I.getParent().getItems()[j].setSelected(false);I.getParent().fireSelect({listItem:I.getParent().getItems()[j]});}}}}}m["Geofences"]=g;sap.ui.getCore().getModel("sapSplSendMessageSelectDialogModel").setData(m);},fnChangeTheSelectionOfListItems:function(s,I,t,m){if(t!=="truck"){var S=sap.ui.getCore().getModel("sapSplSendMessageSelectDialogModel").getData();var o=S.Geofences;for(var i=0;i<o.length;i++){var U=s.getCustomData()[0].getValue().id;if(o[i]["LocationID"]===U){o[i]["bIsSelected"]=I;if(m){oSapSplMapsDataMarshal.fnSelectDeselectFences(o[i],this.oPRMMessagingController.byId("oSapSplLiveAppMap"),function(){});}break;}}S["Geofences"]=o;sap.ui.getCore().getModel("sapSplSendMessageSelectDialogModel").setData(S);}},fnHandleClickOfTrucksOnTheMap:function(s){oSapSplUtils.setIsDirty(true);this.byId("SapSplGeofencesValueHelpCell").removeAllContent();for(var i=0;i<s.length;i++){this.byId("SapSplGeofencesValueHelpCell").insertContent(this.getSelectedItemLayout(s[i],"truck"),0);this.byId("SapSplGeofencesValueHelpLayout").removeStyleClass("redBorder");}if(s.length===0){this.byId("SapSplGeofencesValueHelpCell").insertContent(new sap.m.Text({text:oSapSplUtils.getBundle().getText("SEND_MESSAGE_DIALOG_SELECT_TRUCKS")}).addStyleClass("selectTruckOnMapPlaceholder"));}},fnHandleClickOfGeofenceOnTheMap:function(s){oSapSplUtils.setIsDirty(true);var c=this.byId("SapSplGeofencesValueHelpCell").getContent();var I=c[c.length-1];this.byId("SapSplGeofencesValueHelpCell").removeAllContent();this.byId("SapSplGeofencesValueHelpCell").addContent(I);for(var i=0;i<s.length;i++){if(!this.isGeofenceIsInTheValueHelpList(s[i]["LocationID"])){this.byId("SapSplGeofencesValueHelpCell").insertContent(this.getSelectedItemLayout(s[i],"geofence"),0);this.byId("SapSplGeofencesValueHelpLayout").removeStyleClass("redBorder");}this.byId("SapSplValueHelpForSelectGeofencesInput").setValue("");}var S=sap.ui.getCore().getModel("sapSplSendMessageSelectDialogModel").getData();var o=S.Geofences;for(var j=0;j<o.length;j++){o[j]["bIsSelected"]=false;}S["Geofences"]=o;sap.ui.getCore().getModel("sapSplSendMessageSelectDialogModel").setData(S);var C=this.byId("SapSplGeofencesValueHelpCell").getContent();for(var k=0;k<C.length;k++){if(C[k].constructor!==sap.m.Input){this.fnChangeTheSelectionOfListItems(C[k],true,"geofence",false);}}},fnDeleteTheButtonLayoutBasedOnListItemCheck:function(U){var g=this.byId("SapSplGeofencesValueHelpCell").getContent();for(var i=0;i<g.length;i++){if(g[i].constructor!==sap.m.Input){if(g[i].getCustomData()[0].getValue().id===U){g[i].destroy();}}}},fnValueHelpForSelectGeofencesSuggestItemSelected:function(e){if(!this.isGeofenceIsInTheValueHelpList(e.getParameter("selectedItem").getBindingContext().getProperty()["LocationID"])){var s=this.getSelectedItemLayout(e.getParameter("selectedItem").getBindingContext().getProperty(),"geofence");this.byId("SapSplGeofencesValueHelpCell").insertContent(s,0);this.byId("SapSplGeofencesValueHelpLayout").removeStyleClass("redBorder");this.fnChangeTheSelectionOfListItems(s,true,"geofence");}this.byId("SapSplValueHelpForSelectGeofencesInput").setValue("");var t=this;window.setTimeout(function(){t.byId("SapSplValueHelpForSelectGeofencesInput").$().children()[0].focus();},1000);},isGeofenceIsInTheValueHelpList:function(U){var s=this.byId("SapSplGeofencesValueHelpCell").getContent();var _=false;for(var i=0;i<s.length;i++){if(s[i].constructor!==sap.m.Input){if(s[i].getCustomData()[0].getValue()["id"]===U){_=true;break;}}}return _;},fnHandleClickOfListItem:function(e){var s=null;s=e.getSource();if(s.getSelected()){s.setSelected(false);}else{s.setSelected(true);}s.getParent().fireSelect({listItem:s});},fnToHandleSearchOfGeofences:function(e){var s=e.getParameters().query;var S;if(s[s.length-1]==="*"){s=s.slice(0,-1);}if(s[0]==="*"){s=s.slice(1,s.length);}S=this.getView().byId("SapSplSendMessageSelectDialogList");if(s.length>2){S.getBinding("items").filter(new sap.ui.model.Filter([new sap.ui.model.Filter("Name",sap.ui.model.FilterOperator.NE,oSapSplUtils.getBundle().getText("FILTER_LABEL_ALL")),new sap.ui.model.Filter("Name",sap.ui.model.FilterOperator.Contains,s)],true));}else{S.getBinding("items").filter([]);}},fnToHandleSearchOfIncidents:function(e){var s=e.getParameters().query;var S,p;S=this.getView().byId("SapSplSendMessageSelectDialogListIncident");if(s.length>2){p=this.prepareSearchPayload(s,"I");this.callSearchService(p,"I");}else if(S.getBinding("items")!==undefined){sap.ui.getCore().getModel("sapSplSendMessageSelectDialogModel").setData({Incidents:[]});this.oSapSplApplModel.read("/IncidentDetails",null,["$filter=isDeleted eq '0'"],true,jQuery.proxy(this.fnSuccessOfIncidentsRead,this),jQuery.proxy(this.fnFailOfIncidentsRead,this));}},prepareSearchPayload:function(s,p){var a={};a.UserID=oSapSplUtils.getLoggedOnUserDetails().userID;if(p==="I"){a.ObjectType="Message";a.AdditionalCriteria={};a.AdditionalCriteria.MessageObjectType="I";}if(p==="G"){a.ObjectType="Location";a.AdditionalCriteria={};a.AdditionalCriteria.TagFilter=[];a.AdditionalCriteria.TagFilter[0]="LC0004";}a.SearchTerm=s;a.FuzzinessThershold=SapSplEnums.fuzzyThreshold;a.MaximumNumberOfRecords=SapSplEnums.numberOfRecords;a.ProvideDetails=true;a.SearchInNetwork=true;return a;},callSearchService:function(p,a){var t=[],i,b=this,s;oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/app/services/Search.xsjs"),method:"POST",contentType:"json; charset=UTF-8",async:false,beforeSend:function(r){r.setRequestHeader("X-CSRF-Token",oSapSplUtils.getCSRFToken());r.setRequestHeader("Cache-Control","max-age=0");},data:JSON.stringify(p),success:function(d,c,m){oSapSplBusyDialog.getBusyDialogInstance().close();if(d.constructor===String){d=JSON.parse(d);}if(m["status"]===200){s=sap.ui.getCore().getModel("sapSplSendMessageSelectDialogModel").getData();if(d.length>0){for(i=0;i<d.length;i++){t.push(d[i].Details);}if(a==="I"){s["Incidents"]=t;sap.ui.getCore().getModel("sapSplSendMessageSelectDialogModel").setData(s);}if(a==="G"){s["Geofences"]=t;sap.ui.getCore().getModel("sapSplSendMessageSelectDialogModel").setData(s);}}else{if(a==="I"){s["Incidents"]=[];sap.ui.getCore().getModel("sapSplSendMessageSelectDialogModel").setData(s);}if(a==="G"){s["Geofences"]=[];sap.ui.getCore().getModel("sapSplSendMessageSelectDialogModel").setData(s);}}b.oSapSplValueHelpForSelectGeofencesInput.setModel(sap.ui.getCore().getModel("sapSplSendMessageSelectDialogModel"));}else if(d["Error"]&&d["Error"].length>0){var e=oSapSplUtils.getErrorMessagesfromErrorPayload(d)["ufErrorObject"];sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["errorWarningString"],details:e});}},error:function(e){oSapSplBusyDialog.getBusyDialogInstance().close();s=sap.ui.getCore().getModel("sapSplSendMessageSelectDialogModel").getData();if(a==="I"){s["Incidents"]=[];sap.ui.getCore().getModel("sapSplSendMessageSelectDialogModel").setData(s);}if(a==="G"){s["Geofences"]=[];sap.ui.getCore().getModel("sapSplSendMessageSelectDialogModel").setData(s);}b.oSapSplValueHelpForSelectGeofencesInput.setModel(sap.ui.getCore().getModel("sapSplSendMessageSelectDialogModel"));if(e&&e["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+"\t"+e.statusText,details:e.responseText});}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getBundle().getText("INCORRECT_ARGUMENTS_ERROR_MESSAGE"),details:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["ufErrorObject"]});}},complete:function(){}});}});
