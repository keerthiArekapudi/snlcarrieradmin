/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
jQuery.sap.require("sap.ca.ui.message.message");sap.ui.controller("splController.dialogs.SplSendMessageBusinessPartnerDialog",{onInit:function(){var t=this;this.navContainer=this.byId("SapSplSendMessageBusinessPartnerNavContainer");this.fnDefineControlLabelsFromLocalizationBundle();this.businessPartnerSelected=[];this.businessPartnerExisting={};this.incidentSelected={};if(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["isIncidentEditable"]===0){this.byId("sapSplMessageToRecipientMessageFieldLayout").removeContent(1);}else{this.byId("sapSplAttachIncidentLink").setText(oSapSplUtils.getBundle().getText("ATTACH_INCIDENT_LINK"));}this.getView().addEventDelegate({onAfterRendering:function(){setTimeout(function(){t.getView().byId("SapSplValueHelpForSelectBusinessPartnerInput").focus();},200);}});this.byId("SapSplSendMessageSelectBusinessPartnerPage").addEventDelegate({onAfterShow:function(){t.getDataForBusinessPartners();if(t.byId("SapSplSearchOfSelectBusinessPartnerPage")){setTimeout(function(){t.byId("SapSplSearchOfSelectBusinessPartnerPage").focus();},10);}}});this.byId("SapSplSendMessageSelectBusinessPartnerUsersPage").addEventDelegate({onAfterShow:function(e){setTimeout(function(){t.byId("SapSplSearchOfSelectBusinessPartnerUsersPage").focus();},10);}});this.byId("SapSplSendMessageBusinessPartnerPage").addEventDelegate({onAfterShow:function(){setTimeout(function(){t.byId("SapSplValueHelpForSelectBusinessPartnerInput").focus();},10);}});this.byId("SapSplSendMessageSelectIncidentsPage").addEventDelegate({onAfterShow:function(){t.getDataForIncidents();if(t.byId("SapSplSearchOfSelectIncidentsPage")){setTimeout(function(){t.byId("SapSplSearchOfSelectIncidentsPage").focus();},10);}}});},getDataForBusinessPartners:function(){if(!this.oSapSplApplModel){this.oSapSplApplModel=new splModels.odata.ODataModel({url:oSapSplUtils.getServiceMetadata("app",true),json:true,user:undefined,password:undefined,headers:{"Cache-Control":"max-age=0"},tokenHandling:true,withCredentials:false,loadMetadataAsync:true,handleTimeOut:true,numberOfSecondsBeforeTimeOut:10000});}this.oSapSplApplModel.read("/DistinctRoles",null,[],true,jQuery.proxy(this.fnSuccessOfMyBusinessPartnersRead,this),jQuery.proxy(this.fnFailOfMyBusinessPartnersRead,this));},getDataForIncidents:function(){if(!this.oSapSplApplModel){this.oSapSplApplModel=new splModels.odata.ODataModel({url:oSapSplUtils.getServiceMetadata("app",true),json:true,user:undefined,password:undefined,headers:{"Cache-Control":"max-age=0"},tokenHandling:true,withCredentials:false,loadMetadataAsync:true,handleTimeOut:true,numberOfSecondsBeforeTimeOut:10000});}this.oSapSplApplModel.read("/IncidentDetails",null,["$filter=isDeleted eq '0'"],true,jQuery.proxy(this.fnSuccessOfIncidentsRead,this),jQuery.proxy(this.fnFailOfIncidentsRead,this));},fnSuccessOfMyBusinessPartnersRead:function(r){var m=null;if(!sap.ui.getCore().getModel("SapSplValueHelpForSelectBusinessPartnersModel")){m=new sap.ui.model.json.JSONModel({BusinessPartners:r.results});sap.ui.getCore().setModel(m,"SapSplValueHelpForSelectBusinessPartnersModel");}else{sap.ui.getCore().getModel("SapSplValueHelpForSelectBusinessPartnersModel").setData({BusinessPartners:r.results});}this.byId("SapSplSendMessageBusinessPartnerSelectDialogList").setModel(sap.ui.getCore().getModel("SapSplValueHelpForSelectBusinessPartnersModel"));},fnFailOfMyIncidentsRead:function(){},sapSplChangeDirtyFlag:function(e){oSapSplUtils.setIsDirty(true);if(e.getParameters("newValue").length===0){this.byId("sapSplMessageToRecipientMessageFieldLayout").addStyleClass("redBorder");}else{this.byId("sapSplMessageToRecipientMessageFieldLayout").removeStyleClass("redBorder");}},fnSuccessOfIncidentsRead:function(r){var m=null;if(!sap.ui.getCore().getModel("SapSplValueHelpForSelectIncidentModel")){m=new sap.ui.model.json.JSONModel({Incidents:r.results});sap.ui.getCore().setModel(m,"SapSplValueHelpForSelectIncidentModel");}else{sap.ui.getCore().getModel("SapSplValueHelpForSelectIncidentModel").setData({Incidents:r.results});}this.byId("SapSplSendMessageIncidentSelectDialogList").setModel(sap.ui.getCore().getModel("SapSplValueHelpForSelectIncidentModel"));},fnFailOfMyBusinessPartnersRead:function(){},fnDefineControlLabelsFromLocalizationBundle:function(){this.byId("SapSplSendMessageBusinessPartnerPage").setTitle(oSapSplUtils.getBundle().getText("SEND_MESSAGE_DIALOG_TITLE"));this.byId("SapSplValueHelpForSelectBusinessPartnerInput").setPlaceholder(oSapSplUtils.getBundle().getText("SEND_MESSAGE_SELECT_BUSINESS_PARTNER_PAGE_TITLE"));this.byId("SapSplSendMessageBusinessPartnerSelectDialogList").setNoDataText(oSapSplUtils.getBundle().getText("NO_DATA_TEXT"));this.byId("SapSplSendMessageIncidentSelectDialogList").setNoDataText(oSapSplUtils.getBundle().getText("NO_DATA_TEXT"));this.byId("SapSplSendMessageBusinessPartnerSelectUserDialogList").setNoDataText(oSapSplUtils.getBundle().getText("NO_DATA_TEXT"));this.byId("SapSplMessageBusinessPartnerReceipientsLabel").setText(oSapSplUtils.getBundle().getText("RECIPIENTS"));this.byId("SapSplIncidentMessageBusinessPartnerLabel").setText(oSapSplUtils.getBundle().getText("INCIDENTS_MESSAGE"));this.byId("SapSplMessageBusinessPartnerPriorityLabel").setText(oSapSplUtils.getBundle().getText("INCIDENTS_PRIORITY"));this.byId("SapSplPriorityRadioButton_1").setText(oSapSplUtils.getBundle().getText("INCIDENTS_PRIORITY_1"));this.byId("SapSplPriorityRadioButton_2").setText(oSapSplUtils.getBundle().getText("INCIDENTS_PRIORITY_2"));this.byId("SapSplPriorityRadioButton_3").setText(oSapSplUtils.getBundle().getText("INCIDENTS_PRIORITY_3"));this.byId("SapSplPriorityRadioButton_4").setText(oSapSplUtils.getBundle().getText("INCIDENTS_PRIORITY_4"));},setParentDialogButtonStateBasedOnCurrentPage:function(p){if(!this.oSapSplSendMessageSendButton){this.oSapSplSendMessageSendButton=new sap.m.Button({press:jQuery.proxy(this.fnHandlePressOfSendMessageDialog,this)});}if(!this.oSapSplSendMessageCancelButton){this.oSapSplSendMessageCancelButton=new sap.m.Button({press:jQuery.proxy(this.fnHandlePressOfSendMessageDialogCancel,this)});}if(p==="SendMessageForm"){this.oSapSplSendMessageSendButton.setText(oSapSplUtils.getBundle().getText("SEND_MESSAGE_ACTION_TEXT"));this.oSapSplSendMessageCancelButton.setText(oSapSplUtils.getBundle().getText("MY_COLLEAGUES_CANCEL_BUTTON"));this.oParentDialogInstance.setBeginButton(this.oSapSplSendMessageSendButton);this.oParentDialogInstance.setEndButton(this.oSapSplSendMessageCancelButton);}else if(p==="BusinessPartners"){this.oSapSplSendMessageCancelButton.setText(oSapSplUtils.getBundle().getText("MY_COLLEAGUES_CANCEL_BUTTON"));this.oSapSplSendMessageSendButton.setText(oSapSplUtils.getBundle().getText("OK_BUTTON_TEXT"));this.oParentDialogInstance.setBeginButton(this.oSapSplSendMessageSendButton);this.oParentDialogInstance.setEndButton(this.oSapSplSendMessageCancelButton);}else if(p==="Incidents"){this.oSapSplSendMessageCancelButton.setText(oSapSplUtils.getBundle().getText("MY_COLLEAGUES_CANCEL_BUTTON"));this.oParentDialogInstance.setBeginButton(this.oSapSplSendMessageCancelButton);}else{this.oSapSplSendMessageSendButton.setText(oSapSplUtils.getBundle().getText("OK_BUTTON_TEXT"));this.oSapSplSendMessageCancelButton.setText(oSapSplUtils.getBundle().getText("MY_COLLEAGUES_CANCEL_BUTTON"));this.oParentDialogInstance.setBeginButton(this.oSapSplSendMessageSendButton);this.oParentDialogInstance.setEndButton(this.oSapSplSendMessageCancelButton);}},fnValueHelpForSelectBusinessPartner:function(){var m;if(sap.ui.getCore().getModel("SapSplValueHelpForSelectBusinessPartnersModel")){m=sap.ui.getCore().getModel("SapSplValueHelpForSelectBusinessPartnersModel").getData();}else{m={};m["BusinessPartners"]=[];}this.fnOpenDialogForValueHelp(oSapSplUtils.getBundle().getText("SEND_MESSAGE_SELECT_BUSINESS_PARTNER_PAGE_TITLE"),"BusinessPartners","MultiSelect","Role.description","","Navigation",undefined,m);},fnValueHelpForIncidentMessage:function(){var m;if(sap.ui.getCore().getModel("SapSplValueHelpForSelectIncidentModel")){m=sap.ui.getCore().getModel("SapSplValueHelpForSelectIncidentModel").getData();}else{m={};m["Incidents"]=[];}this.fnOpenDialogForValueHelp(oSapSplUtils.getBundle().getText("SEND_MESSAGE_SELECT_INCIDENT"),"Incidents","SingleSelectMaster","Name","LongText",undefined,undefined,m);},fnHandlePressOfSendMessageDialogCancel:function(){var t=this;if(oSapSplUtils.getIsDirty()){sap.m.MessageBox.show(oSapSplUtils.getBundle().getText("DATA_LOSS_WARNING_TEXT"),sap.m.MessageBox.Icon.WARNING,oSapSplUtils.getBundle().getText("WARNING"),[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.CANCEL],function(s){if(s==="YES"){t.getView().getParent().getParent().close();t.getView().getParent().getParent().destroy();oSapSplUtils.setIsDirty(false);}},null,oSapSplUtils.fnSyncStyleClass("messageBox"));}else{this.getView().getParent().getParent().close();this.getView().getParent().getParent().destroy();}},fnHandlePressOfBackButtonToSendMessagePage:function(){this.fnHandlePressOfSendMessageDialog();},fnHandlePressOfBusinessPartnerUsersBackButton:function(){this.fnHandlePressOfSendMessageDialog();},fnHandlePressOfSendMessageDialog:function(){if(this.navContainer.getCurrentPage().getId().indexOf("SapSplSendMessageBusinessPartnerPage")>-1){this.fnPreparePayloadToSendMessage();}else{var s,i,r,m,e={};if(this.navContainer.getCurrentPage().getId().indexOf("SapSplSendMessageSelectBusinessPartnerUsersPage")>-1){e.mParameters={};e.mParameters.query="";s=this.byId("SapSplSendMessageBusinessPartnerSelectUserDialogList").getSelectedItems();if(s.length>0){this.setIsDirtyFlagOfUtils();r=this.byId("SapSplSendMessageBusinessPartnerSelectUserDialogList").getItems()[0].getBindingContext().getProperty()["Role.description"];if(r){this.businessPartnerSelected[r]=[];if(!this.businessPartnerExisting[r]){this.businessPartnerExisting[r]=s.length;}}for(i=0;i<s.length;i++){this.businessPartnerSelected[r][i]={};this.businessPartnerSelected[r][i]["UUID"]=s[i].getBindingContext().getProperty()["UUID"];this.businessPartnerSelected[r][i]["Organization_Name"]=s[i].getBindingContext().getProperty()["Organization_Name"];}}else{if(this.byId("SapSplSendMessageBusinessPartnerSelectUserDialogList").getItems().length){this.businessPartnerSelected[this.byId("SapSplSendMessageBusinessPartnerSelectUserDialogList").getItems()[0].getBindingContext().getProperty()["Role.description"]]=[];}}if(sap.ui.getCore().getModel("SapSplValueHelpForSelectBusinessPartnersModel")){m=sap.ui.getCore().getModel("SapSplValueHelpForSelectBusinessPartnersModel").getData();}else{m={};m["BusinessPartners"]=[];}this.fnOpenDialogForValueHelp(oSapSplUtils.getBundle().getText("SEND_MESSAGE_SELECT_BUSINESS_PARTNER_PAGE_TITLE"),"BusinessPartners","MultiSelect","Role.description","","Navigation",undefined,sap.ui.getCore().getModel("SapSplValueHelpForSelectBusinessPartnersModel").getData());}else{var I,S,f,F;e.mParameters={};e.mParameters.query="";I=this.byId("SapSplSendMessageBusinessPartnerSelectDialogList").getItems();for(i=0;i<I.length;i++){if(I[i].getSelected()===true){this.setIsDirtyFlagOfUtils();S=function(R){var M=new sap.ui.model.json.JSONModel(),j;M.setData({BusinessPartnerUsers:R.results});if(!this.businessPartnerExisting[I[i].getBindingContext().getProperty()["Role.description"]]){this.businessPartnerExisting[I[i].getBindingContext().getProperty()["Role.description"]]=R.results.length;}if(M.getData()["BusinessPartnerUsers"].length>0){if(I[i].getBindingContext().getProperty()["Role.description"]){this.businessPartnerSelected[I[i].getBindingContext().getProperty()["Role.description"]]=[];for(j=0;j<M.getData()["BusinessPartnerUsers"].length;j++){this.businessPartnerSelected[I[i].getBindingContext().getProperty()["Role.description"]][j]={};this.businessPartnerSelected[I[i].getBindingContext().getProperty()["Role.description"]][j]["UUID"]=M.getData()["BusinessPartnerUsers"][j].UUID;this.businessPartnerSelected[I[i].getBindingContext().getProperty()["Role.description"]][j]["Organization_Name"]=M.getData()["BusinessPartnerUsers"][j]["Organization_Name"];}}}else{this.businessPartnerSelected[I[i].getBindingContext().getProperty()["Role.description"]]=[];}};f=function(){};F="$filter=Role eq \'"+I[i].getBindingContext().getProperty()["Role"]+"\' and RequestStatus eq '1'";if(this.businessPartnerSelected[I[i].getBindingContext().getProperty()["Role.description"]]){if(this.businessPartnerSelected[I[i].getBindingContext().getProperty()["Role.description"]].length!==this.businessPartnerExisting[I[i].getBindingContext().getProperty()["Role.description"]]){this.oSapSplApplModel.read("/RecipientList",null,[F],false,jQuery.proxy(S,this),jQuery.proxy(f,this));}}else{this.oSapSplApplModel.read("/RecipientList",null,[F],false,jQuery.proxy(S,this),jQuery.proxy(f,this));}}else{if(this.businessPartnerSelected[I[i].getBindingContext().getProperty()["Role.description"]]){if(this.businessPartnerSelected[I[i].getBindingContext().getProperty()["Role.description"]].length===this.businessPartnerExisting[I[i].getBindingContext().getProperty()["Role.description"]]){this.businessPartnerSelected[I[i].getBindingContext().getProperty()["Role.description"]]={};}}}}this.setParentDialogButtonStateBasedOnCurrentPage("SendMessageForm");this.navContainer.to(this.navContainer.getPages()[0].sId,"slide");if(this.navContainer.getPreviousPage().getId().indexOf("SapSplSendMessageSelectBusinessPartnerPage")>-1){this.updateValueHelpControl("bupa");}else{this.updateValueHelpControl("incident");}}}},getThreadUUID:function(f){var r=null;oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/app/services/appl.xsodata/ThreadList?"+f+"&$format=json"),method:"GET",async:false,success:function(d){if(d.d.results.length>0){r=d.d.results[0]["ThreadUUID"];}else{r=oSapSplUtils.getUUID();}},error:function(){r=oSapSplUtils.getUUID();}});return r;},fnPreparePayloadToSendMessage:function(){var r,i,p={},a={},b={},s=[],I,t=this,u="";p["Header"]=[];p["Recipient"]=[];p["Text"]=[];u=oSapSplUtils.getUUID();b.UUID=u;if(this.incidentSelected.UUID){b.TemplateUUID=this.incidentSelected.UUID;}else{b.TemplateUUID="";}b.Priority=this.fnPriorityRadioButtonLayoutAccess("get");b["OwnerID"]=oSapSplUtils.getCompanyDetails()["BasicInfo_CompanyID"];b["SenderID"]=oSapSplUtils.getCompanyDetails()["BasicInfo_CompanyID"];b["AuditTrail.CreatedBy"]=null;b["AuditTrail.ChangedBy"]=null;b["AuditTrail.CreationTime"]=null;b["AuditTrail.ChangeTime"]=null;if(this.incidentSelected.SourceLocation){b["SourceLocation"]=JSON.parse(this.incidentSelected.SourceLocation);}else{b["SourceLocation"]=null;}a.UUID=u;if(this.incidentSelected.ShortText){a.ShortText=this.incidentSelected.ShortText;}else{a.ShortText=this.byId("SapSplMessageFromIncidentInput").getValue();}a.LongText=this.byId("SapSplMessageFromIncidentInput").getValue();r=sap.ui.getCore().getModel("SapSplValueHelpForSelectBusinessPartnersModel").getData()["BusinessPartners"];for(i=0;i<r.length;i++){s=this.businessPartnerSelected[r[i]["Role.description"]];if(s&&s.length>0){for(I=0;I<s.length;I++){p["Recipient"].push(this.prepareMessagePayloadObject(s[I].UUID,b.UUID));}}}if(p["Recipient"].length===1){var f="$filter=("+encodeURIComponent("RecipientUUID eq "+"X"+"\'"+oSapSplUtils.base64ToHex(p["Recipient"][0]["RecipientUUID"])+"\'")+" and "+encodeURIComponent("SenderID eq "+"X"+"\'"+oSapSplUtils.base64ToHex(oSapSplUtils.getCompanyDetails()["BasicInfo_CompanyID"])+"\'")+") or ("+encodeURIComponent("SenderID eq "+"X"+"\'"+oSapSplUtils.base64ToHex(p["Recipient"][0]["RecipientUUID"])+"\'")+" and "+encodeURIComponent("RecipientUUID eq "+"X"+"\'"+oSapSplUtils.base64ToHex(oSapSplUtils.getCompanyDetails()["BasicInfo_CompanyID"])+"\')");b["ThreadUUID"]=this.getThreadUUID(f);}else{b["ThreadUUID"]=oSapSplUtils.getUUID();}p["Header"][0]=b;p["Text"][0]=a;p["Object"]="MessageOccurrence";if(p["Recipient"].length>0&&a.LongText.length!==0){oSapSplBusyDialog.getBusyDialogInstance({title:oSapSplUtils.getBundle().getText("BUSY_DIALOG_MESSAGE")}).open();window.setTimeout(function(){oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getServiceMetadata("message",true),method:"POST",contentType:"json; charset=UTF-8",async:false,beforeSend:function(c){c.setRequestHeader("X-CSRF-Token",oSapSplUtils.getCSRFToken());c.setRequestHeader("Cache-Control","max-age=0");},data:JSON.stringify(p),success:function(d,c,m){oSapSplBusyDialog.getBusyDialogInstance().close();if(d.constructor===String){d=JSON.parse(d);}if(m["status"]===200&&d["Error"].length===0){sap.ca.ui.message.showMessageToast(oSapSplUtils.getBundle().getText("MESSAGE_SENT_SUCCESSFULLY"));oSapSplUtils.setIsDirty(false);t.getView().getParent().getParent().close();t.getView().getParent().getParent().destroy();}else{var e=oSapSplUtils.getErrorMessagesfromErrorPayload(d)["ufErrorObject"];sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["errorWarningString"],details:e});}},error:function(e){oSapSplBusyDialog.getBusyDialogInstance().close();if(e&&e["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+" "+e.statusText,details:e.responseText});}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["ufErrorObject"]});}},complete:function(){}});},50);}else{if(a.LongText.length===0){this.byId("sapSplMessageToRecipientMessageFieldLayout").addStyleClass("redBorder");}else{this.byId("sapSplMessageToRecipientMessageFieldLayout").removeStyleClass("redBorder");}if(p["Recipient"].length===0){this.byId("SapSplBupaValueHelpLayout").addStyleClass("redBorder");}else{this.byId("SapSplBupaValueHelpLayout").removeStyleClass("redBorder");}}},prepareMessagePayloadObject:function(u,U){var p={};p.UUID=oSapSplUtils.getUUID();p.RecipientType="BusinessPartner";p.RecipientUUID=u;p.ParentUUID=U;p.isRead="0";return p;},fnPriorityRadioButtonLayoutAccess:function(m,p){var r=this.byId("SapSplSendMessagePriorityRadioButtonHolder").getContent(),i,b;if(m==="set"&&p){for(i=0;i<r.length;i++){b=r[i].sId.split("_");if(b[b.length-1]===p){r[i].setSelected(true);}else{r[i].setSelected(false);}}}else if(m==="get"){for(i=0;i<r.length;i++){if(r[i].getSelected()){b=r[i].sId.split("_");return b[b.length-1];}}}},fnOpenDialogForValueHelp:function(t,p,i,T,d,I,s,m){var o,S;var a=this,b,c;this.tempSelectedItems=[];if(p==="BusinessPartners"){this.byId("SapSplSendMessageBusinessPartnerSelectDialogTitle").setText(t);this.navContainer.to(this.navContainer.getPages()[1].sId,"slide");S=this.byId("SapSplSendMessageBusinessPartnerSelectDialogList");b=m["BusinessPartners"].length;}else if(p==="Incidents"){this.navContainer.to(this.navContainer.getPages()[2].sId,"slide");window.setTimeout(function(){a.byId("SapSplSendMessageIncidentSelectDialogTitle").setText(t);},200);S=this.byId("SapSplSendMessageIncidentSelectDialogList");b=m["Incidents"].length;}else{this.navContainer.to(this.navContainer.getPages()[3].sId,"slide");this.byId("SapSplSendMessageBusinessPartnerSelectUserDialogTitle").setText(t);S=this.byId("SapSplSendMessageBusinessPartnerSelectUserDialogList");}this.setParentDialogButtonStateBasedOnCurrentPage(p);S.setMode(i);if(d===""){o=new sap.m.StandardListItem({title:"{"+T+"}",type:I,selected:s}).attachPress(jQuery.proxy(a.fnHandlePressOfListItem,a));}else{o=new sap.m.StandardListItem({title:"{"+T+"}",description:"{"+d+"}",type:I,selected:s}).attachPress(jQuery.proxy(a.fnHandlePressOfListItem,a));}function f(r){var M=new sap.ui.model.json.JSONModel();M.setData({BusinessPartnerUsers:r.results});sap.ui.getCore().setModel(M,"SapSplBusinessPartnerUsersModel");this.byId("SapSplSendMessageBusinessPartnerSelectUserDialogList").setModel(sap.ui.getCore().getModel("SapSplBusinessPartnerUsersModel"));}function F(){}if(p==="BusinessPartnerUsers"){var e="$filter=Role.description eq \'"+m+"\' and RequestStatus eq '1'";this.oSapSplApplModel.read("/RecipientList",null,[e],false,jQuery.proxy(f,this),jQuery.proxy(F,this));}S.unbindAggregation("items");S.bindAggregation("items","/"+p,o);if(p==="BusinessPartnerUsers"){S.getModel().setData(sap.ui.getCore().getModel("SapSplBusinessPartnerUsersModel").getData());if(sap.ui.getCore().getModel("SapSplBusinessPartnerUsersModel").getData()["BusinessPartnerUsers"].length===0){this.oParentDialogInstance.setEndButton();this.oParentDialogInstance.setBeginButton(this.oSapSplSendMessageCancelButton);}if(s===false){if(!this.businessPartnerExisting[m]){this.businessPartnerExisting[m]=sap.ui.getCore().getModel("SapSplBusinessPartnerUsersModel").getData().BusinessPartnerUsers.length;}S.removeSelections();var l=S.getModel().getData(),j;if(l.length>0){for(c=0;c<l.length;c++){if(this.businessPartnerSelected[l[c]["Role.description"]]!==undefined){var g=this.businessPartnerSelected[l[0]["Role.description"]];for(j=0;j<g.length;j++){if(g[j]["UUID"]===l[c]["UUID"]){this.byId("SapSplSendMessageBusinessPartnerSelectUserDialogList").getItems()[c].setSelected(true);this.tempSelectedItems.push(g[j]["UUID"]);break;}}}}}}else{for(c=0;c<sap.ui.getCore().getModel("SapSplBusinessPartnerUsersModel").getData().BusinessPartnerUsers.length;c++){this.tempSelectedItems.push(sap.ui.getCore().getModel("SapSplBusinessPartnerUsersModel").getData().BusinessPartnerUsers[c].UUID);}}}if(p==="BusinessPartners"){var h=this.byId("SapSplSendMessageBusinessPartnerSelectDialogList").getItems();if(h.length>0){for(c=0;c<h.length;c++){var k,n;if(h[c].getBindingContext()&&this.businessPartnerExisting[h[c].getBindingContext().getProperty()["Role.description"]]&&this.businessPartnerSelected[h[c].getBindingContext().getProperty()["Role.description"]]){k=this.businessPartnerExisting[h[c].getBindingContext().getProperty()["Role.description"]];n=this.businessPartnerSelected[h[c].getBindingContext().getProperty()["Role.description"]].length;if(k===n){h[c].setSelected(true);this.tempSelectedItems.push(h[c].getBindingContext().getProperty()["Role.description"]);}else{h[c].setSelected(false);}}else{h[c].setSelected(false);}}}}},setParentDialogInstance:function(p){this.oParentDialogInstance=p;this.setParentDialogButtonStateBasedOnCurrentPage("SendMessageForm");},fnHandlePressOfListItem:function(e){var t=oSapSplUtils.getBundle().getText("SEND_MESSAGE_SELECT_BUSINESS_PARTNER_USER_PAGE_TITLE",e.getSource().getBindingContext().getObject()["Role.description"]);this.currentBusinessPartner={};this.currentBusinessPartner["Role"]=e.getSource().getBindingContext().getObject()["Role"];this.currentBusinessPartner["Role.description"]=e.getSource().getBindingContext().getObject()["Role.description"];this.navContainer.to(this.navContainer.getPages()[3].sId,"slide");this.fnOpenDialogForValueHelp(t,"BusinessPartnerUsers","MultiSelect","Organization_Name","",undefined,e.getSource().getSelected(),e.getSource().getTitle());},fnHandleSelectIncidentOfListItem:function(){var s;if(this.navContainer.getCurrentPage().getId().indexOf("SapSplSendMessageSelectIncidentsPage")>-1){this.setIsDirtyFlagOfUtils();s=this.byId("SapSplSendMessageIncidentSelectDialogList").getSelectedItem();if(s){this.incidentSelected.UUID=s.getBindingContext().getProperty()["UUID"];this.incidentSelected.Name=s.getBindingContext().getProperty()["Name"];this.incidentSelected.LongText=s.getBindingContext().getProperty()["LongText"];this.incidentSelected.ShortText=s.getBindingContext().getProperty()["ShortText"];this.incidentSelected.Priority=s.getBindingContext().getProperty()["Priority"];this.incidentSelected.SourceLocation=s.getBindingContext().getProperty()["IncidentLocationGeometry"];}this.setParentDialogButtonStateBasedOnCurrentPage("SendMessageForm");this.navContainer.to(this.navContainer.getPages()[0].sId,"slide");this.updateValueHelpControl("incident");this.fnPriorityRadioButtonLayoutAccess("set",this.incidentSelected.Priority);this.byId("sapSplAttachIncidentLink").setText(this.incidentSelected.Name);this.byId("SapSplMessageFromIncidentInput").setValue(this.incidentSelected.LongText);this.byId("sapSplMessageToRecipientMessageFieldLayout").removeStyleClass("redBorder");}},getSelectedItemLayout:function(i,m){var d=null,I=null,o=null,s="",a="",c=null,b="";if(m&&m==="bupa"){s=i["Organization_Name"];a=i["UUID"];b=i["type"];c=new sap.ui.core.CustomData({key:"ID",value:{id:a,mode:m,type:b}});}else{s=i["Name"];a=i["UUID"];c=new sap.ui.core.CustomData({key:"ID",value:{id:a,mode:m}});}var t=this;d=new sap.m.Button({text:"x",type:"Unstyled"}).addStyleClass("itemLayoutButton").addStyleClass("deleteItemButton");I=new sap.m.Button({text:s,type:"Unstyled"}).addStyleClass("itemLayoutButton").addStyleClass("itemDetailButton");o=new sap.ui.commons.layout.HorizontalLayout({content:[I,d]}).addStyleClass("itemLayout");d.attachPress(function(e){var S=e.getSource().getParent();t.fnDeleteTheSelectedBupaFromArray(S.getCustomData()[0].getValue());S.destroy();});return o.addCustomData(c);},fnDeleteTheSelectedBupaFromArray:function(d){if(d["mode"]==="bupa"){var n=[];var s=this.businessPartnerSelected[d["type"]];for(var i=0;i<s.length;i++){if(s[i]["UUID"]!==d["id"]){n.push(s[i]);}}this.businessPartnerSelected[d["type"]]=n;}else{this.incidentSelected={};this.byId("SapSplSendMessageIncidentSelectDialogList").removeSelections();}},updateValueHelpControl:function(p){var t=this,a=[],l,c,i;if(p==="bupa"){jQuery.each(this.businessPartnerExisting,function(k){var s=t.businessPartnerSelected[k];if(s){for(var b=0;b<s.length;b++){s[b]["type"]=k;a.push(s[b]);}}});c=t.byId("SapSplBupaValueHelpCell").getContent();i=c[c.length-1];t.byId("SapSplBupaValueHelpCell").removeAllContent();t.byId("SapSplBupaValueHelpCell").addContent(i);t.byId("SapSplValueHelpForSelectBusinessPartnerInput").addStyleClass("sapSplSendMessageToBuPaDisableInputField");for(var b=0;b<a.length;b++){l=t.getSelectedItemLayout(a[b],"bupa");t.byId("SapSplBupaValueHelpCell").insertContent(l,0);this.byId("SapSplBupaValueHelpLayout").removeStyleClass("redBorder");}}},fnHandleSelectOfBusinessPartnerUsersListItem:function(){},setIsDirtyFlagOfUtils:function(){if(!oSapSplUtils.getIsDirty()){oSapSplUtils.setIsDirty(true);}},fnToHandleSearchOfSelectBusinessPartnerUsersPage:function(e){var f="$filter=Role eq \'"+this.currentBusinessPartner.Role+"\' and RequestStatus eq '1'";var s=e.mParameters.query;var S,p,i,I,u;S=this.getView().byId("SapSplSendMessageBusinessPartnerSelectUserDialogList");if(s.length>2){p=this.prepareSearchPayload(s,"B");this.callSearchService(p,"B");}else if(S.getBinding("items")!==undefined){function a(r){sap.ui.getCore().getModel("SapSplBusinessPartnerUsersModel").setData({BusinessPartnerUsers:r.results});u=this.getView().byId("SapSplSendMessageBusinessPartnerSelectUserDialogList");u.removeSelections();for(i=0;i<this.tempSelectedItems.length;i++){for(I=0;I<u.getItems().length;I++){if(this.tempSelectedItems[i]===u.getItems()[I].getBindingContext().getObject().UUID){u.setSelectedItem(u.getItems()[I]);}}}};function F(){};this.oSapSplApplModel.read("/RecipientList",null,[f],false,jQuery.proxy(a,this),jQuery.proxy(F,this));}},fnToHandleSearchOfSelectBusinessPartnerPage:function(e){var s=e.mParameters.query;var S,p,u,i,I;S=this.getView().byId("SapSplSendMessageBusinessPartnerSelectDialogList");if(s.length>2){p=this.prepareSearchPayload(s,"R");this.callSearchService(p,"R");}else if(S.getBinding("items")!==undefined){sap.ui.getCore().getModel("SapSplValueHelpForSelectBusinessPartnersModel").setData({BusinessPartners:[]});this.oSapSplApplModel.read("/DistinctRoles",null,[],false,jQuery.proxy(this.fnSuccessOfMyBusinessPartnersRead,this),jQuery.proxy(this.fnFailOfMyBusinessPartnersRead,this));u=this.getView().byId("SapSplSendMessageBusinessPartnerSelectDialogList");u.removeSelections();for(i=0;i<this.tempSelectedItems.length;i++){for(I=0;I<u.getItems().length;I++){if(this.tempSelectedItems[i]===u.getItems()[I].getBindingContext().getObject()["Role.description"]){u.setSelectedItem(u.getItems()[I]);}}}}},fnToHandleSearchOfIncidents:function(e){var s=e.getParameters().query;var S,p;S=this.getView().byId("SapSplSendMessageIncidentSelectDialogList");if(s.length>2){p=this.prepareSearchPayload(s,"I");this.callSearchService(p,"I");}else if(S.getBinding("items")!==undefined){sap.ui.getCore().getModel("SapSplValueHelpForSelectIncidentModel").setData({Incidents:[]});this.oSapSplApplModel.read("/IncidentDetails",null,["$filter=isDeleted eq '0'"],true,jQuery.proxy(this.fnSuccessOfIncidentsRead,this),jQuery.proxy(this.fnFailOfIncidentsRead,this));}},prepareSearchPayload:function(s,p){var a={};a.UserID=oSapSplUtils.getLoggedOnUserDetails().userId;if(p==="I"){a.AdditionalCriteria={};a.ObjectType="Message";a.AdditionalCriteria.MessageObjectType="I";}if(p==="R"){a.ObjectType="Role";}if(p==="B"){a.AdditionalCriteria={};a.ObjectType="BusinessPartner";a.AdditionalCriteria.BusinessPartnerType="O";a.AdditionalCriteria.SearchPending=false;a.AdditionalCriteria.Role=[];a.AdditionalCriteria.Role[0]=this.currentBusinessPartner.Role;}a.SearchTerm=s;a.FuzzinessThershold=SapSplEnums.fuzzyThreshold;a.MaximumNumberOfRecords=SapSplEnums.numberOfRecords;a.ProvideDetails=true;a.SearchInNetwork=true;return a;},callSearchService:function(p,a){var t=[],i,I,b=this,u;oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/app/services/Search.xsjs"),method:"POST",async:false,data:JSON.stringify(p),success:function(d,s,m){oSapSplBusyDialog.getBusyDialogInstance().close();if(d.constructor===String){d=JSON.parse(d);}if(m["status"]===200){if(d.length>0){for(i=0;i<d.length;i++){t.push(d[i].Details);}if(a==="I"){sap.ui.getCore().getModel("SapSplValueHelpForSelectIncidentModel").setData({Incidents:t});}if(a==="R"){sap.ui.getCore().getModel("SapSplValueHelpForSelectBusinessPartnersModel").setData({BusinessPartners:t});u=b.getView().byId("SapSplSendMessageBusinessPartnerSelectDialogList");u.removeSelections();for(i=0;i<b.tempSelectedItems.length;i++){for(I=0;I<u.getItems().length;I++){if(b.tempSelectedItems[i]===u.getItems()[I].getBindingContext().getObject()["Role.description"]){u.setSelectedItem(u.getItems()[I]);}}}}if(a==="B"){sap.ui.getCore().getModel("SapSplBusinessPartnerUsersModel").setData({BusinessPartnerUsers:t});u=b.getView().byId("SapSplSendMessageBusinessPartnerSelectUserDialogList");u.removeSelections();for(i=0;i<b.tempSelectedItems.length;i++){for(I=0;I<u.getItems().length;I++){if(b.tempSelectedItems[i]===u.getItems()[I].getBindingContext().getObject().UUID){u.setSelectedItem(u.getItems()[I]);}}}}}else{if(a==="I"){sap.ui.getCore().getModel("SapSplValueHelpForSelectIncidentModel").setData({Incidents:[]});}if(a==="R"){sap.ui.getCore().getModel("SapSplValueHelpForSelectBusinessPartnersModel").setData({BusinessPartners:t});}if(a==="B"){sap.ui.getCore().getModel("SapSplBusinessPartnerUsersModel").setData({BusinessPartnerUsers:t});}}}else if(d["Error"]&&d["Error"].length>0){var e=oSapSplUtils.getErrorMessagesfromErrorPayload(d)["ufErrorObject"];sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["errorWarningString"],details:e});}},error:function(e){oSapSplBusyDialog.getBusyDialogInstance().close();if(a==="I"){sap.ui.getCore().getModel("SapSplValueHelpForSelectIncidentModel").setData({Incidents:[]});}if(a==="R"){sap.ui.getCore().getModel("SapSplValueHelpForSelectBusinessPartnersModel").setData({BusinessPartners:t});}if(a==="B"){sap.ui.getCore().getModel("SapSplBusinessPartnerUsersModel").setData({BusinessPartnerUsers:t});}if(e&&e["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+"\t"+e.statusText,details:e.responseText});}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getBundle().getText("INCORRECT_ARGUMENTS_ERROR_MESSAGE"),details:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["ufErrorObject"]});}},complete:function(){}});},fnHandleSelectionChange:function(e){var i;if(e.getParameters().selected){if(e.getParameters().id.indexOf("SapSplSendMessageBusinessPartnerSelectDialogList")>-1){this.tempSelectedItems.push(e.getParameters().listItem.getBindingContext().getObject()["Role.description"]);}else{if(e.getParameters().id.indexOf("SapSplSendMessageBusinessPartnerSelectUserDialogList")>-1){this.tempSelectedItems.push(e.getParameters().listItem.getBindingContext().getObject().UUID);}}}else{for(i=0;i<this.tempSelectedItems.length;i++){if(e.getParameters().id.indexOf("SapSplSendMessageBusinessPartnerSelectDialogList")>-1){if(this.tempSelectedItems[i]===e.getParameters().listItem.getBindingContext().getObject()["Role.description"]){this.tempSelectedItems.splice(i,1);break;}}else{if(e.getParameters().id.indexOf("SapSplSendMessageBusinessPartnerSelectUserDialogList")>-1){if(this.tempSelectedItems[i]===e.getParameters().listItem.getBindingContext().getObject().UUID){this.tempSelectedItems.splice(i,1);break;}}}}}}});
