/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.controller("splController.dialogs.SplSelectLocationDialog",{onInit:function(){this.oViewData=this.getView().getViewData();var t=this;this.oFilteredColumnsForStops={"SapSplStopTypeButton_1":{"BuildingID":{selected:false,query:""},"CityName":{selected:false,query:""},"CountryName":{selected:false,query:""},"StreetPostalCode":{selected:false,query:""},"StreetName":{selected:false,query:""},"RegionName":{selected:false,query:""}},"SapSplStopTypeButton_2":{"BuildingID":{selected:false,query:""},"CityName":{selected:false,query:""},"CountryName":{selected:false,query:""},"StreetPostalCode":{selected:false,query:""},"StreetName":{selected:false,query:""},"RegionName":{selected:false,query:""}}};this.getView().setModel(sap.ui.getCore().getModel("ToursOverviewODataModel"));this.aFiltersForPreviousStops=[new sap.ui.model.Filter("isDeleted",sap.ui.model.FilterOperator.EQ,"0"),new sap.ui.model.Filter("Type",sap.ui.model.FilterOperator.EQ,"L00004"),new sap.ui.model.Filter("Tag",sap.ui.model.FilterOperator.EQ,"LC0005")];this.aFiltersForContainerTerminals=[new sap.ui.model.Filter("isDeleted",sap.ui.model.FilterOperator.EQ,"0"),new sap.ui.model.Filter("Type",sap.ui.model.FilterOperator.EQ,"L00001"),new sap.ui.model.Filter("Tag",sap.ui.model.FilterOperator.EQ,"LC0003")];this.fnDefineControlLabelsFromLocalizationBundle();this.getView().byId("SapSplSelectLocationDialogTable").getBinding("rows").filter([new sap.ui.model.Filter("isDeleted",sap.ui.model.FilterOperator.EQ,"0"),new sap.ui.model.Filter("Type",sap.ui.model.FilterOperator.EQ,"L00004"),new sap.ui.model.Filter("Tag",sap.ui.model.FilterOperator.EQ,"LC0005")]);this.byId("SapSplStopTypeButton_1").setType("Emphasized");this.sSelectedButton="SapSplStopTypeButton_1";this.appliedFilters=this.getView().byId("SapSplSelectLocationDialogTable").getBinding("rows").aFilters;this.appliedSorters=this.getView().byId("SapSplSelectLocationDialogTable").getBinding("rows").aSorters;sap.ui.getCore().getModel("ToursOverviewODataModel").attachRequestCompleted(function(e){if(!e.getParameters().errorobject){this.byId("SapSplSelectLocationDialogTable").setBusy(false);}}.bind(this));sap.ui.getCore().getModel("ToursOverviewODataModel").attachRequestFailed(function(e){if(!e.getParameters().errorobject){this.byId("SapSplSelectLocationDialogTable").setBusy(false);}}.bind(this));},fnDefineControlLabelsFromLocalizationBundle:function(){this.byId("SapSplSelectLocationDialogTableColumnHeader_AddressField1").setText(oSapSplUtils.getBundle().getText("HOUSE_NUMBER"));this.byId("SapSplSelectLocationDialogTableColumnHeader_AddressField2").setText(oSapSplUtils.getBundle().getText("STREET_NAME"));this.byId("SapSplSelectLocationDialogTableColumnHeader_City").setText(oSapSplUtils.getBundle().getText("NEW_LOCATION_CITY_LABEL"));this.byId("SapSplSelectLocationDialogTableColumnHeader_ZipCode").setText(oSapSplUtils.getBundle().getText("NEW_LOCATION_ZIPCODE_LABEL"));this.byId("SapSplSelectLocationDialogTableColumnHeader_Region").setText(oSapSplUtils.getBundle().getText("NEW_LOCATION_REGION_LABEL"));this.byId("SapSplSelectLocationDialogTableColumnHeader_Country").setText(oSapSplUtils.getBundle().getText("NEW_LOCATION_COUNRTY_LABEL"));this.byId("SapSplSelectLocationDialogTable").setNoDataText(oSapSplUtils.getBundle().getText("NO_STOPS_TEXT"));this.byId("SapSplStopTypeButton_1").setText(oSapSplUtils.getBundle().getText("MY_PREVIOUS_STOPS"));this.byId("SapSplStopTypeButton_2").setText(oSapSplUtils.getBundle().getText("CONTAINER_TERMINALS"));},setParentDialogInstance:function(p){this.oParentDialogInstance=p;this.setButtonForDialog();},fnHandleFilterOfSelectionLocations:function(e){this.byId("SapSplSelectLocationDialogTable").setBusy(true);var t=this;var f=e.getParameter("column").getFilterProperty();var F=e.getParameter("value");var a=[];var q={};q=new sap.ui.model.Filter(f,sap.ui.model.FilterOperator.Contains,F);a.push(q);e.preventDefault();if(F!==""){this.oFilteredColumnsForStops[this.sSelectedButton][f].selected=true;this.oFilteredColumnsForStops[this.sSelectedButton][f].query=F;$.each(t.getView().byId("SapSplSelectLocationDialogTable").getBinding("rows").aFilters,function(k,v){if(v.sPath!==f){a.push(v);}});}else{this.oFilteredColumnsForStops[this.sSelectedButton][f].selected=false;this.oFilteredColumnsForStops[this.sSelectedButton][f].query=F;a=[];$.each(t.getView().byId("SapSplSelectLocationDialogTable").getBinding("rows").aFilters,function(k,v){if(v.sPath!==f){a.push(v);}});}$.each(t.byId("SapSplSelectLocationDialogTable").getColumns(),function(k,v){v.setFiltered(t.oFilteredColumnsForStops[t.sSelectedButton][v.getFilterProperty()].selected);v.setFilterValue(t.oFilteredColumnsForStops[t.sSelectedButton][v.getFilterProperty()].query);});this.getView().byId("SapSplSelectLocationDialogTable").getBinding("rows").filter(a);this.getView().byId("SapSplSelectLocationDialogTable").getBinding("rows").sort(this.appliedSorters);},setButtonForDialog:function(){this.oSapSplNewLocationCancelButton=new sap.m.Button({id:"sapSplNewLocationDialogCancel",press:jQuery.proxy(this.fnHandlePressOfNewLocationDialogCancel,this)});this.oSapSplNewLocationCancelButton.setText(oSapSplUtils.getBundle().getText("CANCEL"));this.oParentDialogInstance.setBeginButton(this.oSapSplNewLocationCancelButton);},fnHandlePressOfLocationListItem:function(e){var m=$.extend(true,{},sap.ui.getCore().getModel("SplCreateNewTourModel").getData());var s=e.getParameter("rowContext").getProperty();var i,a=[];for(var I=0;I<m.stopsRow.length;I++){if(I!==this.oViewData.rowIndex&&m.stopsRow[this.oViewData.rowIndex].items.length!==0){if(s.LocationID===m.stopsRow[I].LocationUUID){for(i=0;i<m.Items.length;i++){if(m.Items[i].pickStopIndex===I&&m.Items[i].dropStopIndex===this.oViewData.rowIndex){a.push({ItemID:m.Items[i].ItemID,UUID:m.Items[i].UUID});}if(m.Items[i].pickStopIndex===this.oViewData.rowIndex&&m.Items[i].dropStopIndex===I){a.push({ItemID:m.Items[i].ItemID,UUID:m.Items[i].UUID});}}}}}if(a.length>0){var t=oSapSplUtils.getBundle().getText("SAME_STOP_SELECTION_DIALOG_MSG");var b=oSapSplUtils.getBundle().getText("LIST_OF_FREIGHT_ITEMS_MSG")+":";this.affectedFreightItems=$.extend(true,[],a);splReusable.libs.SapSplStyleSheetLoader.loadStyle("./resources/styles/splDeleteRearrangingStopsWarningDialog","css");var d=sap.ui.view({viewName:"splView.dialogs.SplDeleteRearrangingStopsWarningDialog",type:sap.ui.core.mvc.ViewType.XML,viewData:{DialogText1:t,DialogText2:b,AffectedFreightItems:a,dialogType:"S"}});var c=new sap.m.Dialog({content:d,title:oSapSplUtils.getBundle().getText("WARNING"),icon:"sap-icon://warning2"}).addStyleClass("SapSplDeleteRearrangingWarningDialog").open();function h(e){e.getSource().destroy();if(e.getParameters().origin.getId().indexOf("sapSplDeleteRearrangingStopsWarningDialogCancel")===-1){m=this.fnChangeStopToNewSelectedItem(m,s);m=this.fnDeleteFreightItemAssignments(this.affectedFreightItems,m);sap.ui.getCore().getModel("SplCreateNewTourModel").setData(m);}};c.attachAfterClose(jQuery.proxy(h,this));d.getController().setParentDialogInstance(c);}else{m=this.fnChangeStopToNewSelectedItem(m,s);sap.ui.getCore().getModel("SplCreateNewTourModel").setData(m);}},fnChangeStopToNewSelectedItem:function(m,s){m.stopsRow[this.oViewData.rowIndex]["LocationUUID"]=s["LocationID"];m.stopsRow[this.oViewData.rowIndex]["Address.Name1"]=s["BuildingID"];m.stopsRow[this.oViewData.rowIndex]["Address.Town"]=s["CityName"];m.stopsRow[this.oViewData.rowIndex]["Address.Name2"]=s["StreetName"];m.stopsRow[this.oViewData.rowIndex]["Address.PostalCode"]=s["StreetPostalCode"];m.stopsRow[this.oViewData.rowIndex]["Address.Country"]=s["CountryName"];m.stopsRow[this.oViewData.rowIndex]["Address.Region"]=s["RegionName"];m.stopsRow[this.oViewData.rowIndex]["AddressUUID"]=s["AddressUUID"];m.stopsRow[this.oViewData.rowIndex]["Name"]=s["Name"];if(s["Tag"]&&s["Tag"]==="LC0003"){m.stopsRow[this.oViewData.rowIndex]["Tag"]=s["Tag"];m.stopsRow[this.oViewData.rowIndex]["StopPartnerName"]=s["OwnerName"];m.stopsRow[this.oViewData.rowIndex]["StopPartnerUUID"]=s["OwnerID"];}else{m.stopsRow[this.oViewData.rowIndex]["Tag"]=null;m.stopsRow[this.oViewData.rowIndex]["StopPartnerName"]=null;m.stopsRow[this.oViewData.rowIndex]["StopPartnerUUID"]=null;}if(s["isEditable"]!==null&&s["isEditable"]!==undefined&&s["isEditable"]===1){m.stopsRow[this.oViewData.rowIndex]["canEditStopLocation"]="1";}else{m.stopsRow[this.oViewData.rowIndex]["canEditStopLocation"]="0";}for(var i=0;i<m.stopsRow[this.oViewData.rowIndex].items.length;i++){m.stopsRow[this.oViewData.rowIndex].items[i].PartnerOrderID=null;m.stopsRow[this.oViewData.rowIndex].items[i].ExternalStopDestination=null;}m.stopsRow[this.oViewData.rowIndex].labels.newlocationlink=oSapSplUtils.getBundle().getText("EDIT_STOP");this.fnToCaptureLiveChangeToSetFlag();this.getView().getParent().close();return m;},fnDeleteFreightItemAssignments:function(i,m){var I,k;for(I=0;I<m.Items.length;I++){for(k=0;k<i.length;k++){if(i[k].UUID===m.Items[I].UUID){for(k=0;k<m.stopsRow[m.Items[I].pickStopIndex].items.length;k++){if(m.stopsRow[m.Items[I].pickStopIndex].items[k].ItemUUID===m.Items[I].UUID){m.stopsRow[m.Items[I].pickStopIndex].items[k].IsDeleted="1";m.stopsRow[m.Items[I].pickStopIndex].items[k].Action="N";break;}}for(k=0;k<m.stopsRow[m.Items[I].dropStopIndex].items.length;k++){if(m.stopsRow[m.Items[I].dropStopIndex].items[k].ItemUUID===m.Items[I].UUID){m.stopsRow[m.Items[I].dropStopIndex].items[k].IsDeleted="1";m.stopsRow[m.Items[I].dropStopIndex].items[k].Action="N";break;}}m.Items[I].pickStopIndex=-1;m.Items[I].pickActionHappened="N";m.Items[I].dropStopIndex=-1;m.Items[I].dropActionHappened="N";break;}}}return m;},fnToCaptureLiveChangeToSetFlag:function(){if(!oSapSplUtils.getIsDirty()){oSapSplUtils.setIsDirty(true);}},fnHandlePressOfNewLocationDialogCancel:function(){this.getView().getParent().close();},fnHandelStopTypesSegmentedButton:function(e){var t=this;if(e.getParameters().id.indexOf("SapSplStopTypeButton_1")!==-1){this.aFiltersForContainerTerminals=this.getView().byId("SapSplSelectLocationDialogTable").getBinding("rows").aFilters;this.getView().byId("SapSplSelectLocationDialogTable").getBinding("rows").filter(this.aFiltersForPreviousStops);this.byId("SapSplStopTypeButton_1").setType("Emphasized");this.byId("SapSplStopTypeButton_2").setType("Default");this.sSelectedButton="SapSplStopTypeButton_1";}else{this.aFiltersForPreviousStops=this.getView().byId("SapSplSelectLocationDialogTable").getBinding("rows").aFilters;this.getView().byId("SapSplSelectLocationDialogTable").getBinding("rows").filter(this.aFiltersForContainerTerminals);this.byId("SapSplStopTypeButton_2").setType("Emphasized");this.byId("SapSplStopTypeButton_1").setType("Default");this.sSelectedButton="SapSplStopTypeButton_2";}this.appliedFilters=this.getView().byId("SapSplSelectLocationDialogTable").getBinding("rows").aFilters;$.each(t.byId("SapSplSelectLocationDialogTable").getColumns(),function(k,v){v.setFiltered(t.oFilteredColumnsForStops[t.sSelectedButton][v.getFilterProperty()].selected);v.setFilterValue(t.oFilteredColumnsForStops[t.sSelectedButton][v.getFilterProperty()].query);});},fnToHandleSearchOfAddress:function(e){var s=e.getParameters().query;var S;var p,t=this;S=this.getView().byId("SapSplSelectLocationDialogTable");if(s.length>2){p=this.prepareSearchPayload(s);this.callSearchService(p);}else if(S.getBinding("rows")===undefined||S.getBinding("rows").aFilters.length>1){S.unbindAggregation("rows");S.bindRows({path:"/MyLocations",template:t.getView().byId("oSapSplSearchTemplate")});S.getBinding("rows").filter(this.appliedFilters);}},prepareSearchPayload:function(s){var p={};p.UserID=oSapSplUtils.getLoggedOnUserDetails().usreID;p.ObjectType="Location";p.SearchTerm=s;p.FuzzinessThershold=SapSplEnums.fuzzyThreshold;p.MaximumNumberOfRecords=SapSplEnums.numberOfRecords;p.ProvideDetails=false;p.SearchInNetwork=true;if(this.byId("SapSplStopTypeButton_1").getType()==="Emphasized"){p.AdditionalCriteria={TypeFilter:["L00004"],tagFilter:[" LC0005"]};}else{p.AdditionalCriteria={TagFilter:["LC0003"],TypeFilter:["L00001"]};}return p;},callSearchService:function(p){var s,S=[],o;var t=this;oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/app/services/Search.xsjs"),method:"POST",async:false,data:JSON.stringify(p),success:function(d,a,m){oSapSplBusyDialog.getBusyDialogInstance().close();if(d.constructor===Object){d=JSON.parse(d);}if(m["status"]===200){o=t.getView().byId("SapSplSelectLocationDialogTable");S.push(new sap.ui.model.Filter("isDeleted",sap.ui.model.FilterOperator.EQ,"0"));if(t.byId("SapSplStopTypeButton_1").getType()==="Emphasized"){S.concat([new sap.ui.model.Filter("Type",sap.ui.model.FilterOperator.EQ,"L00004"),new sap.ui.model.Filter("Tag",sap.ui.model.FilterOperator.EQ,"LC005")]);}else{S.concat([new sap.ui.model.Filter("Type",sap.ui.model.FilterOperator.EQ,"L00001"),new sap.ui.model.Filter("Tag",sap.ui.model.FilterOperator.EQ,"LC0003")]);}o.unbindAggregation("rows");if(d.length>0){s=oSapSplUtils.getSearchItemFilters(d,"LocationID");if(s.aFilters.length>0){S.push(s);}o.bindRows({path:"/MyLocations",template:t.getView().byId("oSapSplSearchTemplate")});o.getBinding("rows").filter(S);}}else if(d["Error"]&&d["Error"].length>0){var e=oSapSplUtils.getErrorMessagesfromErrorPayload(d)["ufErrorObject"];sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["errorWarningString"],details:e});}},error:function(e){oSapSplBusyDialog.getBusyDialogInstance().close();if(e&&e["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+"\t"+e.statusText,details:e.responseText});}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["ufErrorObject"]});}},complete:function(){}});}});
