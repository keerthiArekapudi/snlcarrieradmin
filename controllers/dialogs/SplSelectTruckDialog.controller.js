/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.controller("splController.dialogs.SplSelectTruckDialog",{onInit:function(){this.oSplSelectTruckModel=new sap.ui.model.json.JSONModel();this.oSplSelectTruckModel.setSizeLimit(100000);this.oSplSelectTruckModel.setData({});this.getView().setModel(this.oSplSelectTruckModel);this.navContainer=this.byId("SapSplSelectTruckDialogNavContainer");this.getListOfAvailableTrucks();this.fnDefineControlLabelsFromLocalizationBundle();},getListOfAvailableTrucks:function(){var t=this;sap.ui.getCore().getModel("TourCreateAssignTruckList").read("/MyTrackableObjects",null,["$filter=Status ne 'I' and isDeleted ne '1'"],false,function(d){d.ShowTours=oSapSplUtils.getBundle().getText("SHOW_TOURS");t.oSplSelectTruckModel.setData(d);},function(){});},getListOfVehicleAssignedTours:function(t){var T=[];sap.ui.getCore().getModel("ToursOverViewPageODataModel").read("/Tours",null,["$expand=Stops&$filter= VehicleUUID eq X\'"+oSapSplUtils.base64ToHex(t)+"\'","$orderby=Planned_StartTime  desc,RegistrationNumber"],false,function(d){T=d.results;},function(){});return T;},fnDefineControlLabelsFromLocalizationBundle:function(){this.byId("SapSplSelectTruckDialogTableColumnHeader_LicencePlate").setText(oSapSplUtils.getBundle().getText("LICENCE_PLATE"));this.byId("SapSplSelectTruckDialogTableColumnHeader_DriverName").setText(oSapSplUtils.getBundle().getText("DRIVER"));this.byId("SapSplSelectTruckDialogTableColumnHeader_Vehicletype").setText(oSapSplUtils.getBundle().getText("VEHICLE_TYPE"));this.byId("SapSplSelectTruckDialogTableColumnHeader_OtherTours").setText(oSapSplUtils.getBundle().getText("OTHER_TOURS"));this.byId("SapSplSelectTruckDialogTableHeader").setText(oSapSplUtils.getBundle().getText("NUMBER_OF_AVAILABLE_TRUCKS",[this.oSplSelectTruckModel.getData().results.length]));this.byId("SapSplSelectTruckDialogTable").setNoDataText(oSapSplUtils.getBundle().getText("NO_TRUCKS_TEXT"));this.byId("SapSplTourDetailsDialogTable").setNoDataText(oSapSplUtils.getBundle().getText("TOURS_NO_DATA"));this.byId("SapSplTourDetailsDialogTableColumnHeader_TourName").setText(oSapSplUtils.getBundle().getText("TOUR_NAME"));this.byId("SapSplTourDetailsDialogTableColumnHeader_Date").setText(oSapSplUtils.getBundle().getText("DATE"));this.byId("SapSplTourDetailsDialogTableColumnHeader_Arrive").setText(oSapSplUtils.getBundle().getText("ARRIVE"));this.byId("SapSplTourDetailsDialogTableColumnHeader_Leave").setText(oSapSplUtils.getBundle().getText("LEAVE"));this.byId("SapSplTourDetailsDialogTableColumnHeader_Stops").setText(oSapSplUtils.getBundle().getText("STOPS"));},setParentDialogInstance:function(p){this.oParentDialogInstance=p;this.setButtonForDialog();this.selectTableItem();},selectTableItem:function(){var m=sap.ui.getCore().getModel("SplCreateNewTourModel").getData(),i;var v=this.byId("SapSplSelectTruckDialogTable");if(m.VehicleUUID){for(i=0;i<v.getItems().length;i++){if(v.getItems()[i].getBindingContext().getProperty().UUID===m.VehicleUUID){v.setSelectedItem(v.getItems()[i]);break;}}}},setButtonForDialog:function(){this.oSapSplNewLocationOkButton=new sap.m.Button({press:jQuery.proxy(this.fnHandlePressOfNewLocationDialogOk,this)});this.oSapSplNewLocationCancelButton=new sap.m.Button({press:jQuery.proxy(this.fnHandlePressOfNewLocationDialogCancel,this)});this.oSapSplNewLocationOkButton.setText(oSapSplUtils.getBundle().getText("OK_BUTTON_TEXT"));this.oSapSplNewLocationCancelButton.setText(oSapSplUtils.getBundle().getText("CANCEL"));this.oParentDialogInstance.setBeginButton(this.oSapSplNewLocationOkButton);this.oParentDialogInstance.setEndButton(this.oSapSplNewLocationCancelButton);},fnToCaptureLiveChangeToSetFlag:function(){if(!oSapSplUtils.getIsDirty()){oSapSplUtils.setIsDirty(true);}},fnHandlePressOfNewLocationDialogOk:function(){var m=$.extend(true,{},sap.ui.getCore().getModel("SplCreateNewTourModel").getData());var s=this.byId("SapSplSelectTruckDialogTable").getSelectedItems();if(s.length>0){var a=s[0].getBindingContext().getProperty();m.RegistrationNumber=a["RegistrationNumber"];m.DriverName=a["DriverName"];m.VehicleUUID=a["UUID"];sap.ui.getCore().getModel("SplCreateNewTourModel").setData(m);this.fnToCaptureLiveChangeToSetFlag();}this.getView().getParent().getParent().close();this.getView().getParent().getParent().destroy();},fnHandlePressOfNewLocationDialogCancel:function(){this.getView().getParent().getParent().close();this.getView().getParent().getParent().destroy();},fnHandlePressOfBackButtonToSendMessagePage:function(){},fnHandlePressOfShowTours:function(e){var t=this,i,I,a,b,c;var d=this.getListOfVehicleAssignedTours(e.getSource().getBindingContext().getProperty().UUID);var f=[];var m=$.extend(true,{},this.oSplSelectTruckModel.getData());for(i=0;i<d.length;i++){if(d[i].VehicleUUID!==null&&d[i].VehicleUUID===e.getSource().getBindingContext().getProperty().UUID){for(I=0;I<d[i].Stops.results.length;I++){d[i].Stops.results[I]["Planned_ArrivalDate"]=d[i].Stops.results[I]["Planned_ArrivalTime"];}a=$.extend(true,[],d[i].Stops.results);for(I=1;I<d[i].Stops.results.length;I++){b=(typeof(d[i].Stops.results[I]["Planned_ArrivalDate"])==="object")?d[i].Stops.results[I]["Planned_ArrivalDate"].getFullYear():(new Date(parseInt(d[i].Stops.results[I]["Planned_ArrivalDate"].match(/([0-9])+/g)[0],10))).getFullYear();c=(typeof(d[i].Stops.results[I-1]["Planned_ArrivalDate"])==="object")?d[i].Stops.results[I-1]["Planned_ArrivalDate"].getFullYear():(new Date(parseInt(d[i].Stops.results[I-1]["Planned_ArrivalDate"].match(/([0-9])+/g)[0],10))).getFullYear();if(b===c){b=(typeof(d[i].Stops.results[I]["Planned_ArrivalDate"])==="object")?d[i].Stops.results[I]["Planned_ArrivalDate"].getMonth():(new Date(parseInt(d[i].Stops.results[I]["Planned_ArrivalDate"].match(/([0-9])+/g)[0],10))).getMonth();c=(typeof(d[i].Stops.results[I-1]["Planned_ArrivalDate"])==="object")?d[i].Stops.results[I-1]["Planned_ArrivalDate"].getMonth():(new Date(parseInt(d[i].Stops.results[I-1]["Planned_ArrivalDate"].match(/([0-9])+/g)[0],10))).getMonth();if(b===c){b=(typeof(d[i].Stops.results[I]["Planned_ArrivalDate"])==="object")?d[i].Stops.results[I]["Planned_ArrivalDate"].getDate():(new Date(parseInt(d[i].Stops.results[I]["Planned_ArrivalDate"].match(/([0-9])+/g)[0],10))).getDate();c=(typeof(d[i].Stops.results[I-1]["Planned_ArrivalDate"])==="object")?d[i].Stops.results[I-1]["Planned_ArrivalDate"].getDate():(new Date(parseInt(d[i].Stops.results[I-1]["Planned_ArrivalDate"].match(/([0-9])+/g)[0],10))).getDate();if(b===c){a[I]["Planned_ArrivalDate"]="";}}}}d[i].Stops.results=a;f.push(d[i]);}}this.oParentDialogInstance.setBeginButton(this.oSapSplNewLocationCancelButton);m.tours=f;this.oSplSelectTruckModel.setData(m);this.navContainer.to(this.navContainer.getPages()[1].sId,"slide");this.oParentDialogInstance.getCustomHeader().getContentMiddle()[0].setText(oSapSplUtils.getBundle().getText("TOUR_DETAILS_LABEL",e.getSource().getBindingContext().getProperty().RegistrationNumber));this.oParentDialogInstance.getCustomHeader().addContentLeft(new sap.m.Button({icon:"sap-icon://nav-back",press:function(){this.getParent().getParent().getCustomHeader().getContentMiddle()[0].setText(oSapSplUtils.getBundle().getText("SELECT_TRUCK_DIALOG_TITLE"));this.getParent().getParent().getCustomHeader().removeAllContentLeft();t.oParentDialogInstance.setBeginButton(t.oSapSplNewLocationOkButton);t.oParentDialogInstance.setEndButton(t.oSapSplNewLocationCancelButton);t.navContainer.back();}}));}});
