/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
jQuery.sap.require("sap.ca.ui.message.message");sap.ui.controller("splController.dialogs.SplTruckDeviceStatusDialog",{onInit:function(){this.oViewData=this.getView().getViewData();this.oSplTruckDeviceStatusModel=new sap.ui.model.json.JSONModel();this.oSplTruckDeviceStatusModel.setData(this.oViewData);this.getView().setModel(this.oSplTruckDeviceStatusModel);if(this.oViewData["data"]["isSharedByMyOrg"]&&this.oViewData["data"]["isSharedByMyOrg"]){this.byId("SapSplDeactivateDeregisterWarningMessageLayout").setVisible(true);}this.fnDefineControlLabelsFromLocalizationBundle();},fnDefineControlLabelsFromLocalizationBundle:function(){this.byId("SapSplDeactivateTruckFormContainerRegistrationNumberLabel").setText(oSapSplUtils.getBundle().getText("VEHICLE_REGISTRATION_NUMBER"));this.byId("SapSplDeactivateTruckFormContainerDeviceIDLabel").setText(oSapSplUtils.getBundle().getText("DEVICE_ID"));this.byId("SapSplDeactivateDeregisterWarningMessage").setText(oSapSplUtils.getBundle().getText("VEHICLE_DEACTIVATE_DEREGISTER_WARNING"));},fnPreparePayloadTruck:function(m){var M=this.oSplTruckDeviceStatusModel.getData().data;var s={};s.data=[];var S={};S["VehicleUUID"]=M["UUID"];S["VehicleType"]=M["Type"];S["VehiclePublicName"]=M["PublicName"];S["DriverID"]=M["DriverID"];S["VehicleRegistrationNumber"]=M["RegistrationNumber"];S["VehicleCountryCode"]=M["CountryCode"];if(m==="Deactivate Truck"){S["VehicleStatus"]="I";S["VehicleChangeMode"]="U";}else if(m==="Deregister Truck"){S["VehicleStatus"]=M.Status;S["VehicleChangeMode"]="U";}else{S["VehicleStatus"]="A";S["VehicleChangeMode"]="U";}if(M["ImageUrl"]){S["VehicleImageUrl"]=M["ImageUrl"];}else{S["VehicleImageUrl"]=null;}S["VehicleisDeleted"]="0";S["OwnerID"]=M["OwnerID"];S["DeviceUUID"]=M["DeviceUUID"];S["DeviceType"]=M["DeviceType"];S["DeviceUniqueID"]=M["UniqueID"];S["DevicePhoneNumber"]=null;S["DevicePublicName"]=M["DevicePublicName"];S["DeviceStatus"]=M["DeviceStatus"];S["DeviceisDeleted"]="0";if(m==="Deregister Truck"){S.ChangeMode="D";s.inputHasChangeMode=true;}s.data.push(S);return s;},fnTruckActionServieCall:function(m){var t=this;this.sModeTruckAction=m;oSapSplBusyDialog.getBusyDialogInstance({title:oSapSplUtils.getBundle().getText("BUSY_DIALOG_MESSAGE")}).open();var p=this.fnPreparePayloadTruck(m);var T="PUT",u=oSapSplUtils.getServiceMetadata("deviceVehicleAssignment",true);if(m==="Deregister Truck"){T="POST";}window.setTimeout(function(){var a={url:u,method:T,async:false,beforeSend:function(r){r.setRequestHeader("X-CSRF-Token",oSapSplUtils.getCSRFToken());},contentType:"json",data:JSON.stringify(p),success:jQuery.proxy(t.onSuccess,t),error:jQuery.proxy(t.onError,t)};oSapSplAjaxFactory.fireAjaxCall(a);},20);},onSuccess:function(d,s,m){var t=this;oSapSplBusyDialog.getBusyDialogInstance().close();if(d.constructor===String){d=JSON.parse(d);}var M=t.oSplTruckDeviceStatusModel.getData().data;oSapSplUtils.getCurrentMasterPageVehicle().byId("SapSplVehiclesList").addCustomData(new sap.ui.core.CustomData({key:d.Vehicle.data[0].UUID}));if(t.getView().getParent()){t.getView().getParent().destroyContent();}if(m["status"]===200&&d["Error"].length===0){var c=new sap.ui.core.CustomData({key:"bRefreshTile",value:true});oSplBaseApplication.getAppInstance().getCurrentPage().destroyCustomData();oSplBaseApplication.getAppInstance().getCurrentPage().addCustomData(c);oSapSplBusyDialog.getBusyDialogInstance().close();if(this.sModeTruckAction==="Deactivate Truck"){sap.m.MessageToast.show(oSapSplUtils.getBundle().getText("VEHICLE_DEACTIVATED_SUCCESSFULLY_MSG",M.RegistrationNumber),{width:"25em",offset:"0 -115"});if(M.DevicePublicName!==undefined&&M.DevicePublicName!==null){sap.m.MessageToast.show(oSapSplUtils.getBundle().getText("DEVICE_DEACTIVATED_SUCCESSFULLY_MSG",M.DevicePublicName),{width:"25em"});}}else if(this.sModeTruckAction==="Deregister Truck"){sap.m.MessageToast.show(oSapSplUtils.getBundle().getText("VEHICLE_DEREGISTER_SUCCESSFULLY_MSG",M.RegistrationNumber),{width:"25em",offset:"0 -115"});if(M.DevicePublicName!==undefined&&M.DevicePublicName!==null){sap.m.MessageToast.show(oSapSplUtils.getBundle().getText("DEVICE_DEREGISTER_SUCCESSFULLY_MSG",M.DevicePublicName),{width:"25em"});}}else if(this.sModeTruckAction==="Activate Truck"){sap.m.MessageToast.show(oSapSplUtils.getBundle().getText("VEHICLE_ACTIVATED_SUCCESSFULLY_MSG",M.RegistrationNumber),{width:"25em",offset:"0 -115"});if(M.DevicePublicName!==undefined&&M.DevicePublicName!==null){sap.m.MessageToast.show(oSapSplUtils.getBundle().getText("DEVICE_ACTIVATED_SUCCESSFULLY_MSG",M.DevicePublicName),{width:"25em"});}}var a=sap.ui.getCore().getModel("SapSplMyVehicleDetailModel").getData();a["noData"]=true;a["isClicked"]=false;sap.ui.getCore().getModel("SapSplMyVehicleDetailModel").setData(a);sap.ui.getCore().getModel("myVehiclesListODataModel").refresh();}else{oSapSplBusyDialog.getBusyDialogInstance().close();sap.ui.getCore().getModel("myVehiclesListODataModel").refresh();if(d["Error"].length!==0){var e=oSapSplUtils.getErrorMessagesfromErrorPayload(d)["ufErrorObject"];var b=oSapSplUtils.getErrorMessagesfromErrorPayload(d)["errorWarningString"];sap.ca.ui.message.showMessageBox({type:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["messageTitle"],message:b,details:e});}}},onError:function(e){var t=this;oSapSplBusyDialog.getBusyDialogInstance().close();if(t.getView().getParent()){t.getView().getParent().close();t.getView().getParent().destroyContent();}if(e&&e["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+" "+e.statusText,details:e.responseText});}else{if(e.responseText.constructor===String){e.responseText=JSON.parse(e.responseText);}var d=e.responseText;sap.ca.ui.message.showMessageBox({type:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["messageTitle"],message:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["ufErrorObject"]});}},fnPerformActionBasedOnMode:function(){if(this.oViewData.mode==="Deactivate Truck"){this.fnTruckActionServieCall(this.oViewData.mode);}else if(this.oViewData.mode==="Activate Truck"){this.fnTruckActionServieCall(this.oViewData.mode);}else if(this.oViewData.mode==="Deregister Truck"){this.fnTruckActionServieCall(this.oViewData.mode);}},onAfterRendering:function(){}});
