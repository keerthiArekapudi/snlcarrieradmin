/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
jQuery.sap.require("sap.ca.ui.message.message");sap.ui.controller("splController.dialogs.SplCreateEditLocationDialog",{fnMakeChangesToRulesTableBasedOnData:function(l,m){var w=this.byId("sapSplRadarGeofenceRulesTableRunsWithTourItem"),W=this.byId("sapSplRadarGeofenceRulesTableRunsWithoutTourItem");var s=null;if(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["canViewRulesWithoutTour"]!==1){W.setVisible(false);w.setSelected(true);w.addStyleClass("listItemWithoutSelect");}if(m==="Edit"){if(l.isRadar==="1"){this.byId("splCheckboxForInBoundMessaging").setSelected(true);this.byId("splCheckboxForInBoundMessaging").fireSelect();this._isRadarGeofence=true;}else{this._isRadarGeofence=false;}if(l.RunsWithTour==="1"){w.setSelected(true);s=w;}else if(l.RunsWithTour==="0"){W.setSelected(true);s=W;}if(l.Entry==="1"){s.getCells()[1].setSelected(true);}else if(l.Entry==="0"){s.getCells()[1].setSelected(false);}if(l.Exit==="1"){s.getCells()[2].setSelected(true);}else if(l.Exit==="0"){s.getCells()[2].setSelected(false);}}},fnHandleSelectOfRuleTableItem:function(e){var w=this.byId("sapSplRadarGeofenceRulesTableRunsWithTourItem"),W=this.byId("sapSplRadarGeofenceRulesTableRunsWithoutTourItem");var s=e.getParameters().listItem;if(s.sId===w.sId){w.getCells()[1].setEnabled(true);w.getCells()[2].setEnabled(true);W.getCells()[1].setEnabled(false);W.getCells()[2].setEnabled(false);w.getCells()[1].setSelected(true);w.getCells()[2].setSelected(true);W.getCells()[1].setSelected(false);W.getCells()[2].setSelected(false);}else{W.getCells()[1].setEnabled(true);W.getCells()[2].setEnabled(true);w.getCells()[1].setEnabled(false);w.getCells()[2].setEnabled(false);W.getCells()[1].setSelected(true);W.getCells()[2].setSelected(true);w.getCells()[1].setSelected(false);w.getCells()[2].setSelected(false);}},fnFetchStatusTrackingDetails:function(){var l=this.getView().getViewData()[3];var L=this.getView().getViewData()[2];this.byId("sapSplBusinessPartnersTrackedList").setBusy(true);if(l){l.getLocationDetailsFromLocationID(L.LocationID,L.Type,function(d){this.byId("sapSplBusinessPartnersTrackedList").setBusy(false);var D=this.getView().getModel().getData();D["status"]=d.results;this.getView().getModel().setData(D);}.bind(jQuery.extend(true,{},this)),function(){jQuery.sap.log.error("fnHandleLocationDetailsDisplay","Failure of function call","liveApp.controller.js");},false,"StatusOfRadars",true);}},fnFetchIncidentsAndGatesAssigned:function(){var l=this.getView().getViewData()[3];var L=this.getView().getViewData()[2];if(l){if(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["isIncidentEditable"]!==0){l.getLocationDetailsFromLocationID(L.LocationID,L.Type,function(d){var D=this.getView().getModel().getData();D["Incidents"]=d;this.getView().getModel().setData(D);}.bind(jQuery.extend(true,{},this)),function(){jQuery.sap.log.error("fnHandleLocationDetailsDisplay","Failure of function call","liveApp.controller.js");},false,"Incidents",true);}this.byId("splValueHelpForLocationGates").setBusy(true);l.getLocationDetailsFromLocationID(L.LocationID,L.Type,function(d){this.byId("splValueHelpForLocationGates").setBusy(false);var D=this.getView().getModel().getData();D["GeofenceGates"]=d;D["edgeToGateMap"]=l.fnGetEdgeToGateMap(D);oSapSplMapsDataMarshal.fnEditFences(L,l.byId("oSapSplLiveAppMap"));this.getView().getModel().setData(D);}.bind(jQuery.extend(true,{},this)),function(){jQuery.sap.log.error("fnHandleLocationDetailsDisplay","Failure of function call","liveApp.controller.js");},false,"GeofenceGates",true);}},onInit:function(){var t=this;this.aRemovedGates=[];this.navContainer=this.byId("SplCreateEditLocationDialogNavContainer");this.aClickedGates=[];if(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["canViewRulesWithTour"]!==1){this.byId("splCheckboxForInBoundMessaging").setVisible(false);}else{this.byId("splCheckboxForInBoundMessaging").setVisible(true);}if(this.getView().getViewData()&&this.getView().getViewData()[1]==="Edit"){if(this.getView().getViewData()[0]==="LC0001"){this.byId("SplCreateEditLocationDialogHomePage").setTitle(oSapSplUtils.getBundle().getText("EDIT_BRIDGE"));}else if(this.getView().getViewData()[0]==="LC0002"){this.byId("SplCreateEditLocationDialogHomePage").setTitle(oSapSplUtils.getBundle().getText("EDIT_PARKINGSPACE"));}else if(this.getView().getViewData()[0]==="LC0003"){this.byId("SplCreateEditLocationDialogHomePage").setTitle(oSapSplUtils.getBundle().getText("EDIT_CONTAINER_TERMINAL"));}else{this.byId("SplCreateEditLocationDialogHomePage").setTitle(oSapSplUtils.getBundle().getText("EDIT_GEOFENCE"));if(this.getView().getViewData()[2].isRadar==="1"){this.fnMakeChangesToRulesTableBasedOnData(this.getView().getViewData()[2],"Edit");if(splReusable.libs.SapSplModelFormatters.CanViewTrackingStatusLink(this.getView().getViewData()[2].isRadar,this.getView().getViewData()[2].Type,sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["canViewRulesWithoutTour"])){if(this.getView().getViewData()[2].status===undefined){this.fnFetchStatusTrackingDetails();}this.navContainer.to(this.navContainer.getPages()[this.navContainer.getPages().length-1].sId);this.navContainer.getPages()[this.navContainer.getPages().length-1].setTitle(oSapSplUtils.getBundle().getText("EDIT_GEOFENCE"));}else{this.fnFetchIncidentsAndGatesAssigned();}}else{this.fnFetchIncidentsAndGatesAssigned();this.fnMakeChangesToRulesTableBasedOnData(this.getView().getViewData()[2],"Edit");}}}else{if(this.getView().getViewData()[0]==="LC0001"){this.byId("SplCreateEditLocationDialogHomePage").setTitle(oSapSplUtils.getBundle().getText("ADD_BRIDGE"));}else if(this.getView().getViewData()[0]==="LC0002"){this.byId("SplCreateEditLocationDialogHomePage").setTitle(oSapSplUtils.getBundle().getText("ADD_PARKINGSPACE"));}else if(this.getView().getViewData()[0]==="LC0003"){this.byId("SplCreateEditLocationDialogHomePage").setTitle(oSapSplUtils.getBundle().getText("ADD_CONTAINER_TERMINAL"));}else{this.byId("SplCreateEditLocationDialogHomePage").setTitle(oSapSplUtils.getBundle().getText("ADD_GEOFENCE"));this.fnMakeChangesToRulesTableBasedOnData(this.getView().getViewData()[2],"Create");}}if(this.getView().getViewData()[0]==="LC0004"||this.getView().getViewData()[0]==="LC0008"){this.byId("SplCreateEditLocationDialogBuildingID").setVisible(false);this.byId("SplCreateEditLocationDialogBuildingIDInput").setVisible(false);this.byId("SplCreateEditLocationDialogStreetName").setVisible(false);this.byId("SplCreateEditLocationDialogStreetNameInput").setVisible(false);this.byId("SplCreateEditLocationDialogCityName").setVisible(false);this.byId("SplCreateEditLocationDialogCityNameInput").setVisible(false);this.byId("SplCreateEditLocationDialogPostalCode").setVisible(false);this.byId("SplCreateEditLocationDialogPostalCodeInput").setVisible(false);this.byId("SplCreateEditLocationDialogAddressRegionCode").setVisible(false);this.byId("SplCreateEditLocationDialogRegionCodeInput").setVisible(false);this.byId("SplCreateEditLocationDialogCountryCode").setVisible(false);this.byId("SplCreateEditLocationDialogCountryCodeInput").setVisible(false);this.byId("SplCreateEditLocationDialogWebcamURL").setVisible(false);this.byId("SplCreateEditLocationDialogWebcamURLInput").setVisible(false);this.byId("splCheckboxForIsPublic").setVisible(splReusable.libs.SapSplModelFormatters.sapSplGetVisibilityBasedOnSubscriptionModel(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["canPublish"]));}else{this.byId("splCheckboxForIsPublic").setVisible(false);this.byId("splListForLocationCoOrdinates").setVisible(false);this.byId("SplCreateEditLocationDialogInstructionLabelForAdd").setVisible(false);this.byId("SplCreateEditLocationDialogInstructionLabelForDelete").setVisible(false);}this.byId("splListForLocationCoOrdinates").addEventDelegate({onAfterRendering:function(e){if(e.srcControl.getItems().length<4){e.srcControl.setMode("None");}else{e.srcControl.setMode("Delete");}}});this.getView().addEventDelegate({onAfterRendering:function(e){setTimeout(function(){if(t.byId("splInputNameOfLocation")){t.byId("splInputNameOfLocation").focus();}if(t.byId("SapSplParkingSpaceCreateEditPageNameInput")){t.byId("SapSplParkingSpaceCreateEditPageNameInput").focus();}t.getView().getParent().getParent().$().css("top","100px");t.getView().getParent().getParent().$().css("left","90px");},1000);}});this.fnDefineControlLabelsFromLocalizationBundle();},fnHandleInboundMessagingCheckChange:function(e){this.byId("sapSplRadarGeofenceRulesTable").setVisible(e.getSource().getSelected());},fnDefineControlLabelsFromLocalizationBundle:function(){this.byId("SplCreateEditLocationDialogBuildingID").setText(oSapSplUtils.getBundle().getText("NEW_LOCATION_ADDRESS_FIELD_TITLE","1"));this.byId("SplCreateEditLocationDialogStreetName").setText(oSapSplUtils.getBundle().getText("NEW_LOCATION_ADDRESS_FIELD_TITLE","2"));this.byId("SplCreateEditLocationDialogCityName").setText(oSapSplUtils.getBundle().getText("NEW_LOCATION_CITY_LABEL"));this.byId("SplCreateEditLocationDialogPostalCode").setText(oSapSplUtils.getBundle().getText("NEW_LOCATION_ZIPCODE_LABEL"));this.byId("SplCreateEditLocationDialogAddressRegionCode").setText(oSapSplUtils.getBundle().getText("NEW_LOCATION_COUNRTY_LABEL"));this.byId("SplCreateEditLocationDialogCountryCode").setText(oSapSplUtils.getBundle().getText("NEW_LOCATION_REGION_LABEL"));this.byId("sapSplGatesLabel").setText(oSapSplUtils.getBundle().getText("INCIDENTS_GATES"));this.byId("splLabelForCreationTimeOfLocation").setText(oSapSplUtils.getBundle().getText("LOCATION_CREATED_ON_LABEL"));this.byId("splLabelForLocationCoOrdinates").setText(oSapSplUtils.getBundle().getText("CO_ORDINATES"));this.byId("SplCreateEditLocationDialogGatesPage").setTitle(oSapSplUtils.getBundle().getText("SELECT_GATE"));this.byId("SapSplGatesDetailsList").setNoDataText(oSapSplUtils.getBundle().getText("NO_GATES_DEFINED"));this.byId("oSapSplAddGateButton").setText(oSapSplUtils.getBundle().getText("ADD_GATE"));this.byId("SplCreateEditLocationDialogAddGatePage").setTitle(oSapSplUtils.getBundle().getText("ADD_GATE"));this.byId("sapSplSelectGeofenceSideText").setText(oSapSplUtils.getBundle().getText("SELECT_ONE_SIDE_OF_GEOFENCE"));this.byId("splLabelForNameOfLocation").setText(oSapSplUtils.getBundle().getText("LOCATION_NAME_NOT_EMPTY"));this.byId("splInputNameOfLocation").setPlaceholder(oSapSplUtils.getBundle().getText("LOCATION_ENTER_NAME_PLACEHOLDER"));this.byId("splLabelForGatesOfLocation").setText(oSapSplUtils.getBundle().getText("LOCATION_GATES_FIELD"));this.byId("splLabelForIncidentsAssigned").setText(oSapSplUtils.getBundle().getText("LOCATION_INCIDENTS_ASSIGNED_LABEL"));this.byId("sapSplAddGateLabel").setText(oSapSplUtils.getBundle().getText("LOCATION_NAME_NOT_EMPTY"));this.byId("splCheckboxForIsPublic").setText(oSapSplUtils.getBundle().getText("LOCATION_PUBLIC_FIELD"));this.byId("SplCreateEditLocationDialogWebcamURL").setText(oSapSplUtils.getBundle().getText("WEBCAM_URL_LABEL"));this.byId("splListForLocationCoOrdinates").setNoDataText("NO_COORDINATES_AVAILABLE_TEXT");this.byId("SplCreateEditLocationDialogInstructionLabelForAdd").setText(oSapSplUtils.getBundle().getText("LOCATION_EDIT_INSTRUCTION_LABEL_ADD"));this.byId("SplCreateEditLocationDialogInstructionLabelForDelete").setText(oSapSplUtils.getBundle().getText("LOCATION_EDIT_INSTRUCTION_LABEL_DELETE"));},fnHandleValueHelpForLocationGates:function(){var n=this.navContainer.getPages()[1].sId;this.navContainer.to(n,"slide");var m=this.getView().getModel().getData();m["Geometry"]=oSapSplMapsDataMarshal.convertStringToGeoJSON(this.oLiveAppInstance.fnCordinateArrayToCordinateString(m["locationGeoCoords"]));m["Geometry"]=JSON.stringify(m["Geometry"]);this.getView().getModel().setData(m);oSapSplMapsDataMarshal.fnShowFences(m,this.oLiveAppInstance.byId("oSapSplLiveAppMap"),"onFocus");if(m["GeofenceGates"]!==undefined&&m["GeofenceGates"]!==null){this.aAssignedGates=jQuery.extend(true,{},m["GeofenceGates"]);for(var i=0;i<m["GeofenceGates"]["results"].length;i++){var s=m["GeofenceGates"]["results"][i]["GateUUID"].split("+").join("").split("/").join("").split("?").join("").split("%").join("").split("#").join("").split("&").join("").split("=").join("");jQuery("."+s).parent().parent().show();oSapSplMapsDataMarshal.fnShowGates(m["GeofenceGates"]["results"][i],this.oLiveAppInstance.byId("oSapSplLiveAppMap"));}}if(m.GeofenceGates.results.length<m.locationGeoCoords.length){this.byId("oSapSplAddGateButton").setEnabled(true);}else{this.byId("oSapSplAddGateButton").setEnabled(false);}},fnHandleClickOfAddGateButton:function(){this.byId("sapSplAddGateInput").setValue("");this.oLiveAppInstance.fnHandleGeofenceGateSelectionMode(this.getView().getModel().getData());var n=this.navContainer.getPages()[2].sId;this.navContainer.to(n,"slide");this.getView().getParent().getParent().getBeginButton().setEnabled(false);},sapSplChangeDirtyFlag:function(e){oSapSplUtils.setIsDirty(true);if(e.getSource().getValue().length>0){e.getSource().setValueState("None");}},fnIsAllMandatoryFieldsFilled:function(){var r=true,s=false;if(this.byId("SplCreateEditLocationDialogBuildingIDInput").getVisible()===true&&this.byId("SplCreateEditLocationDialogBuildingIDInput").getValue().length===0){this.byId("SplCreateEditLocationDialogBuildingIDInput").setValueStateText(oSapSplUtils.getBundle().getText("EMPTY_ERROR_MESSAGE"));this.byId("SplCreateEditLocationDialogBuildingIDInput").setValueState("Error");r=false;}else{this.byId("SplCreateEditLocationDialogBuildingIDInput").setValueState("None");}if(this.byId("SplCreateEditLocationDialogStreetNameInput").getVisible()===true&&this.byId("SplCreateEditLocationDialogStreetNameInput").getValue().length===0){this.byId("SplCreateEditLocationDialogStreetNameInput").setValueStateText(oSapSplUtils.getBundle().getText("EMPTY_ERROR_MESSAGE"));this.byId("SplCreateEditLocationDialogStreetNameInput").setValueState("Error");r=false;}else{this.byId("SplCreateEditLocationDialogStreetNameInput").setValueState("None");}if(this.byId("SplCreateEditLocationDialogCityNameInput").getVisible()===true&&this.byId("SplCreateEditLocationDialogCityNameInput").getValue().length===0){this.byId("SplCreateEditLocationDialogCityNameInput").setValueStateText(oSapSplUtils.getBundle().getText("EMPTY_ERROR_MESSAGE"));this.byId("SplCreateEditLocationDialogCityNameInput").setValueState("Error");r=false;}else{this.byId("SplCreateEditLocationDialogCityNameInput").setValueState("None");}if(this.byId("SplCreateEditLocationDialogRegionCodeInput").getVisible()===true&&this.byId("SplCreateEditLocationDialogRegionCodeInput").getValue().length===0){this.byId("SplCreateEditLocationDialogRegionCodeInput").setValueStateText(oSapSplUtils.getBundle().getText("EMPTY_ERROR_MESSAGE"));this.byId("SplCreateEditLocationDialogRegionCodeInput").setValueState("Error");r=false;}else{this.byId("SplCreateEditLocationDialogRegionCodeInput").setValueState("None");}if(this.byId("SplCreateEditLocationDialogCountryCodeInput").getVisible()===true&&this.byId("SplCreateEditLocationDialogCountryCodeInput").getValue().length===0){this.byId("SplCreateEditLocationDialogCountryCodeInput").setValueStateText(oSapSplUtils.getBundle().getText("EMPTY_ERROR_MESSAGE"));this.byId("SplCreateEditLocationDialogCountryCodeInput").setValueState("Error");r=false;}else{this.byId("SplCreateEditLocationDialogCountryCodeInput").setValueState("None");}if(this.byId("SplCreateEditLocationDialogPostalCodeInput").getVisible()===true&&this.byId("SplCreateEditLocationDialogPostalCodeInput").getValue().length===0){this.byId("SplCreateEditLocationDialogPostalCodeInput").setValueStateText(oSapSplUtils.getBundle().getText("EMPTY_ERROR_MESSAGE"));this.byId("SplCreateEditLocationDialogPostalCodeInput").setValueState("Error");r=false;}else{this.byId("SplCreateEditLocationDialogPostalCodeInput").setValueState("None");}if(this.byId("splInputNameOfLocation").getValue().length===0){this.byId("splInputNameOfLocation").setValueStateText(oSapSplUtils.getBundle().getText("EMPTY_ERROR_MESSAGE"));this.byId("splInputNameOfLocation").setValueState("Error");r=false;}else{this.byId("splInputNameOfLocation").setValueState("None");}if(this.byId("splCheckboxForInBoundMessaging").getSelected()===true){if(!this.byId("sapSplRadarGeofenceRulesTable").getSelectedItem()){r=false;s=true;}else{if(this.byId("sapSplRadarGeofenceRulesTable").getSelectedItem().getCells()[1].getSelected()===false&&this.byId("sapSplRadarGeofenceRulesTable").getSelectedItem().getCells()[2].getSelected()===false){r=false;s=true;}}if(s===true){sap.m.MessageBox.show(oSapSplUtils.getBundle().getText("MESSAGE_FOR_RULE_SELECTION_ERROR"),sap.m.MessageBox.Icon.ERROR,oSapSplUtils.getBundle().getText("ERROR"),[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],function(a){jQuery(".sapUiBLy").css("z-index","0");});}}return r;},handlePressOfDialogOK:function(e){var c=this.navContainer.getCurrentPage().sId,i,s,m;if(c.indexOf("Home")!==-1){if(this.fnIsAllMandatoryFieldsFilled()){var p=this.getConstructedPayloadForPost(this.getView().getModel().getData());this.handleSaveLocationAction(p,"Create",e);}}else if(c.indexOf("Gates")!==-1){this.byId("splValueHelpForLocationGates").setValue(splReusable.libs.SapSplModelFormatters.getGatesName(this.getView().getModel().getData()["GeofenceGates"]["results"]));oSapSplMapsDataMarshal.fnEditFences(this.getView().getModel().getData(),this.oLiveAppInstance.byId("oSapSplLiveAppMap"));oSapSplMapsDataMarshal.fnRemoveGates(this.oLiveAppInstance.byId("oSapSplLiveAppMap"));jQuery(".vbi-detail").remove();this.navContainer.back();}else if(c.indexOf("Incident")!==-1){var I=[];m=this.getView().getModel().getData();for(i=0;i<m["AssignedIncidents"]["results"].length;i++){if(m["AssignedIncidents"]["results"][i]["isChecked"]===true){I.push(m["AssignedIncidents"]["results"][i]);}}m["Incidents"]["results"]=I;this.getView().getModel().setData(m);this.navContainer.back();}else if(c.indexOf("Warning")!==-1){this.navContainer.to(this.navContainer.getPages()[0].sId);this.fnFetchIncidentsAndGatesAssigned();}else{oSapSplMapsDataMarshal.fnRemoveGates(this.oLiveAppInstance.byId("oSapSplLiveAppMap"));oSapSplMapsDataMarshal.fnShowFences(this.getView().getModel().getData(),this.oLiveAppInstance.byId("oSapSplLiveAppMap"),"onFocus");m=sap.ui.getCore().getModel("sapSplLocationCreateEditDialogModel").getData();m["GeofenceGates"]["results"].push(this.fnPrepareNewGateObject(this.byId("sapSplAddGateInput").getValue(),this.aClickedGates[this.aClickedGates.length-1],m["LocationID"]));m["edgeToGateMap"]=this.oLiveAppInstance.fnGetEdgeToGateMap(m);sap.ui.getCore().getModel("sapSplLocationCreateEditDialogModel").setData(m);oSapSplMapsDataMarshal.fnShowFences(m,this.oLiveAppInstance.byId("oSapSplLiveAppMap"),"onFocus");this.aClickedGates=[];this.navContainer.back();for(i=0;i<m["GeofenceGates"]["results"].length;i++){s=m["GeofenceGates"]["results"][i]["GateUUID"].split("+").join("").split("/").join("").split("?").join("").split("%").join("").split("#").join("").split("&").join("").split("=").join("");oSapSplMapsDataMarshal.fnShowGates(m["GeofenceGates"]["results"][i],this.oLiveAppInstance.byId("oSapSplLiveAppMap"));}if(m.GeofenceGates.results.length<m.locationGeoCoords.length){this.byId("oSapSplAddGateButton").setEnabled(true);}else{this.byId("oSapSplAddGateButton").setEnabled(false);}}},fnPrepareNewGateObject:function(n,g,l){var r={};r["Name"]=n;r["LocationID"]=l;r["GateUUID"]=oSapSplUtils.getUUID();r["GateGeometry"]=JSON.stringify(g);r["new"]=true;return r;},fnHandleDeleteOfListItem:function(e){this.fnHandleDeleteOfGateAndUpdateModel(e.getParameters().listItem.getBindingContext().getObject()["GateUUID"],true);},fnHandleDeleteOfGateAndUpdateModel:function(g,s){var m=this.getView().getModel().getData(),G=[],i;if(m["GeofenceGates"]["results"].length>0){G=m["GeofenceGates"]["results"];for(i=0;i<G.length;i++){if(G[i]["GateUUID"]===g){G[i]["deleted"]=true;var S=G[i]["GateUUID"].split("+").join("").split("/").join("").split("?").join("").split("%").join("").split("#").join("").split("&").join("").split("=").join("");jQuery("."+S).hide();this.aRemovedGates.push(G.splice(i,1)[0]);}}}this.getView().getModel().setData(m);oSapSplMapsDataMarshal.fnRemoveGates(this.oLiveAppInstance.byId("oSapSplLiveAppMap"));if(s&&s===true){if(m["GeofenceGates"]!==undefined&&m["GeofenceGates"]!==null){for(i=0;i<m["GeofenceGates"]["results"].length;i++){oSapSplMapsDataMarshal.fnShowGates(m["GeofenceGates"]["results"][i],this.oLiveAppInstance.byId("oSapSplLiveAppMap"));}}}if(m.GeofenceGates.results.length<m.locationGeoCoords.length){this.byId("oSapSplAddGateButton").setEnabled(true);}else{this.byId("oSapSplAddGateButton").setEnabled(false);}},handlePressOfDialogCancel:function(e){var c=this.navContainer.getCurrentPage().sId,m;this.getView().getParent().getParent().getBeginButton().setEnabled(true);if(c.indexOf("Home")!==-1||c.indexOf("Warning")!==-1){var d=jQuery.extend(true,{},e);if(oSapSplUtils.getIsDirty()){sap.m.MessageBox.show(oSapSplUtils.getBundle().getText("DATA_LOSS_WARNING_TEXT"),sap.m.MessageBox.Icon.WARNING,oSapSplUtils.getBundle().getText("WARNING"),[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.CANCEL],function(a){if(a==="YES"){d.getSource().getParent().close();oSapSplUtils.setIsDirty(false);}else{jQuery(".sapUiBLy").css("z-index","0");}},null,oSapSplUtils.fnSyncStyleClass("messageBox"));}else{d.getSource().getParent().close();d.getSource().getParent().destroy();}}else if(c.indexOf("Gates")!==-1){oSapSplMapsDataMarshal.fnEditFences(this.getView().getModel().getData(),this.oLiveAppInstance.byId("oSapSplLiveAppMap"));oSapSplMapsDataMarshal.fnRemoveGates(this.oLiveAppInstance.byId("oSapSplLiveAppMap"));m=this.getView().getModel().getData();m["GeofenceGates"]=this.aAssignedGates;this.getView().getModel().setData(m);for(var i=0;i<m["GeofenceGates"]["results"].length;i++){var s=m["GeofenceGates"]["results"][i]["GateUUID"].split("+").join("").split("/").join("").split("?").join("").split("%").join("").split("#").join("").split("&").join("").split("=").join("");jQuery("."+s).hide();}this.navContainer.back();}else if(c.indexOf("Incident")!==-1){this.getView().getModel().setData(this.oDialogData);this.navContainer.back();}else{this.aClickedGates=[];oSapSplMapsDataMarshal.fnRemoveGates(this.oLiveAppInstance.byId("oSapSplLiveAppMap"));oSapSplMapsDataMarshal.fnShowFences(this.getView().getModel().getData(),this.oLiveAppInstance.byId("oSapSplLiveAppMap"),"onFocus");this.aClickedGates=[];this.navContainer.back();m=this.getView().getModel().getData();if(m.GeofenceGates.results.length<m.locationGeoCoords.length){this.byId("oSapSplAddGateButton").setEnabled(true);}else{this.byId("oSapSplAddGateButton").setEnabled(false);}}},handleChangeOfGateNameField:function(e){if(e.getParameters().newValue.split(" ").join("").length!==0&&this.aClickedGates.length!==0){this.getView().getParent().getParent().getBeginButton().setEnabled(true);}else{this.getView().getParent().getParent().getBeginButton().setEnabled(false);}},handleDeletionOfGateOnTheMap:function(g){if(this.aRemovedGates===undefined){this.aRemovedGates=[];}this.aRemovedGates.push(g);},handleClickOfGateOnTheMap:function(c){this.aClickedGates.push(JSON.parse(c));if(this.byId("sapSplAddGateInput").getValue().split(" ").join("").length!==0){this.getView().getParent().getParent().getBeginButton().setEnabled(true);}},setLiveAppControllerInstance:function(l){this.oLiveAppInstance=l;},handleSaveLocationAction:function(p,m,e){var t=this;var s=e.getSource();var S=oSapSplUtils.getServiceMetadata("newLocation",true);var T=this.getView().getModel().getData()["Tag"];oSapSplBusyDialog.getBusyDialogInstance({title:oSapSplUtils.getBundle().getText("BUSY_DIALOG_MESSAGE")}).open();oSapSplAjaxFactory.fireAjaxCall({url:S,method:"PUT",data:JSON.stringify(p),success:function(d,a,b){if(d.constructor===String){d=JSON.parse(d);}if(b["status"]===200&&d["Error"].length===0){if(d&&d.Header&&d.Header[0]){t.oLiveAppInstance.newCreatedVisualObject=d.Header[0].LocationID;}else{t.oLiveAppInstance.newCreatedVisualObject=null;}t.fnHandleSaveIncidents();oSapSplBusyDialog.getBusyDialogInstance().close();sap.ca.ui.message.showMessageToast(oSapSplUtils.getBundle().getText("LOCATION_SAVED_SUCCESSFULLY"));oSapSplUtils.setIsDirty(false);s.getParent().close();s.getParent().destroy();}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["ufErrorObject"]}).attachAfterClose(function(){jQuery(".sapUiBLy").css("z-index","0");});oSapSplBusyDialog.getBusyDialogInstance().close();}},error:function(a){if(a&&a["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:a["status"]+" "+a.statusText,details:a.responseText}).attachAfterClose(function(){jQuery(".sapUiBLy").css("z-index","0");});}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(a.responseText))["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(a.responseText))["ufErrorObject"]}).attachAfterClose(function(){jQuery(".sapUiBLy").css("z-index","0");});}oSapSplBusyDialog.getBusyDialogInstance().close();jQuery.sap.log.error(a["status"],a.statusText,"MapsDetailView.controller.js");},complete:function(){jQuery(".sapUiBLy").css("z-index","0");}});},splDeleteCordinateInEditDialog:function(e){var t=this,c="";var l=e.getSource().getModel();var m=l.getData();var L=m["locationGeoCoords"];var I=e.getSource().indexOfItem(e.getParameters()["listItem"]);var w=oSapSplMapsDataMarshal.fnCheckPointWithinGate(m["GeofenceGates"].results,L[I]);if(w.length>0){c=oSapSplUtils.getBundle().getText("LOCATION_POINT_DELETE_CONFIRMATION");sap.m.MessageBox.show(c,sap.m.MessageBox.Icon.WARNING,oSapSplUtils.getBundle().getText("WARNING"),[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],function(s){jQuery(".sapUiBLy").css("z-index","0");if(s==="OK"){for(var i=0;i<w.length;i++){t.fnHandleDeleteOfGateAndUpdateModel(w[i]["GateUUID"],false);}t.byId("splValueHelpForLocationGates").setValue(splReusable.libs.SapSplModelFormatters.getGatesName(t.getView().getModel().getData()["GeofenceGates"]["results"]));L.splice(I,1);m["locationGeoCoords"]=L;m["Geometry"]=JSON.stringify(oSapSplMapsDataMarshal.convertStringToGeoJSON(t.oLiveAppInstance.fnCordinateArrayToCordinateString(L)));l.setData(m);oSapSplMapsDataMarshal.fnEditFences(m,t.oLiveAppInstance.byId("oSapSplLiveAppMap"));}},null,oSapSplUtils.fnSyncStyleClass("messageBox"));}else{L.splice(I,1);m["locationGeoCoords"]=L;m["Geometry"]=JSON.stringify(oSapSplMapsDataMarshal.convertStringToGeoJSON(t.oLiveAppInstance.fnCordinateArrayToCordinateString(L)));l.setData(m);oSapSplMapsDataMarshal.fnEditFences(m,t.oLiveAppInstance.byId("oSapSplLiveAppMap"));}},getConstructedPayloadForPost:function(v){try{function g(v){var o=v,A=[];for(var L=0,f=o["locationGeoCoords"].length;L<f;L++){var C=o["locationGeoCoords"][L]["long"]+";"+o["locationGeoCoords"][L]["lat"]+";"+o["locationGeoCoords"][L]["alt"];A.push(C);}return A.join(";");};var I=null,G="",s=null;var l=v["LocationID"];if(v.shapeChanged===true){s=true;}else{s=false;}if(!l){l=oSapSplUtils.getUUID();G=oSapSplMapsDataMarshal.convertStringToGeoJSON(g(v));}else{G=oSapSplMapsDataMarshal.convertStringToGeoJSON(g(v));}this.locationID=l;var a=v["AddressUUID"];if(!a){a=oSapSplUtils.getUUID();}if(this.byId("splCheckboxForIsPublic").getSelected()===true){I="1";}else{I="0";}if(G===undefined||G===null){G={type:"Polygon",coordinates:[[]]};}var r={"inputHasChangeMode":true,"Header":[{"LocationID":l,"Name":v["Name"],"OwnerID":oSapSplUtils.getCompanyDetails()["BasicInfo_CompanyID"],"Type":v["Type"],"Geometry":G,"Stacked":"0","isPublic":I,"ParentLocationID":null,"ImageUrl":v["ImageUrl"],"Website":v["Website"],"WebcamUrl":v["WebcamUrl"],"PhoneNumber":null,"AdditionalInformation":v["AdditionalInformation"],"ChangeMode":(this.getView().getViewData()[1]==="Edit"?"U":"I"),"unauthenticatedObserverGeofence":s}],"Texts":[{"LocationID":l,"Type":"T","Text":v["Tag"],"ObjectUUID":l,"LocaleLanguage":null,"ChangeMode":"U"},{"LocationID":l,"Type":"D","Text":"","ObjectUUID":l,"LocaleLanguage":null,"ChangeMode":"U"},{"LocationID":l,"Type":"A","Text":"","ObjectUUID":l,"LocaleLanguage":null,"ChangeMode":"U"}]};if(this.getView().getViewData()[0]!=="LC0004"&&this.getView().getViewData()[0]!=="LC0008"){r["Address"]=[{"UUID":a,"LocationID":l,"BuildingID":v["BuildingID"],"StreetName":v["StreetName"],"CityName":v["CityName"],"StreetPostalCode":v["StreetPostalCode"],"RegionName":v["RegionName"],"CountryName":v["CountryName"],"ChangeMode":"U"}];}if(!v["GeofenceGates"]["results"]){v["GeofenceGates"]["results"]=[];}var b=[];for(var i=0;i<v["GeofenceGates"]["results"].length;i++){var t={};if(v["GeofenceGates"]["results"][i]["new"]&&v["GeofenceGates"]["results"][i]["new"]===false){b.splice(i,1);}else{t["Geometry"]=JSON.parse(v["GeofenceGates"]["results"][i]["GateGeometry"]);t["UUID"]=v["GeofenceGates"]["results"][i]["GateUUID"];if(!v["GeofenceGates"]["results"][i]["LocationID"]){t["LocationID"]=l;}else{t["LocationID"]=v["GeofenceGates"]["results"][i]["LocationID"];}t["Name"]=v["GeofenceGates"]["results"][i]["Name"];t["isDeleted"]="0";t["ChangeMode"]="U";b.push(t);}}for(var j=0;j<this.aRemovedGates.length;j++){if(this.aRemovedGates[j]["new"]!==true){b.push({UUID:this.aRemovedGates[j]["GateUUID"],ChangeMode:"D"});}}r["Gate"]=b;var S=false,c=false,T=this.byId("sapSplRadarGeofenceRulesTable");if(this.byId("splCheckboxForInBoundMessaging").getSelected()===true&&T.getSelectedItem()){var R={},d=null;r["Header"][0]["Type"]="L00005";r["Texts"][0]["Text"]="LC0008";if(v["RuleUUID"]){d=v["RuleUUID"];}else{d=oSapSplUtils.getUUID();S=true;}r["Radar"]=[];R.UUID=d;R.ObservationGF=l;R.OwnerID=oSapSplUtils.getCompanyDetails()["BasicInfo_CompanyID"];R.Name=v["Name"];R.Gate=null;R.ChangeMode="U";if(T.indexOfItem(T.getSelectedItem())===0){R.RunsWithTour="1";R.Entry=(T.getSelectedItem().getCells()[1].getSelected()===true?"1":"0");R.Exit=(T.getSelectedItem().getCells()[2].getSelected()===true?"1":"0");}else{R.RunsWithTour="0";R.Entry=(T.getSelectedItem().getCells()[1].getSelected()===true?"1":"0");R.Exit=(T.getSelectedItem().getCells()[2].getSelected()===true?"1":"0");}r["Radar"].push(R);}else{if(this._isRadarGeofence===true){R={};r["Radar"]=[];r["Radar"].push({UUID:v["RuleUUID"],ChangeMode:"D"});}}return r;}catch(e){jQuery.sap.log.error(e.message,"Failure of getConstructedPayloadForPost function call","MapsDetailView.controller.js");}},preparePayLoadForPost:function(){var I=null;if(this.getView().getViewData()[2]){I=this.getView().getViewData()[2].Incidents.results;}var m=this.getView().getModel().getData();var a;if(!m.AssignedIncidents){a=m.AssignedIncidents={results:[]};}else{a=m.AssignedIncidents.results;}var M={};M["Header"]=[];M["Text"]=[];M["Recipient"]=[];M["Object"]="MessageTemplate";M["inputHasChangeMode"]=true;for(var i=0;i<a.length;i++){var o={};o["UUID"]=a[i]["UUID"];o["Name"]=a[i]["Name"];o["Priority"]=a[i]["Priority"];o["Category"]=a[i]["Category"];o["SourceLocation"]=JSON.parse(a[i]["IncidentLocationGeometry"]);o["isDeleted"]=a[i]["isDeleted"];o["OwnerID"]=a[i]["OwnerID"];o["AuditTrail.CreatedBy"]=null;o["AuditTrail.ChangedBy"]=null;o["AuditTrail.CreationTime"]=null;o["AuditTrail.ChangeTime"]=null;o["ChangeMode"]="U";var b={};b["UUID"]=a[i]["UUID"];b["ShortText"]=a[i]["ShortText"];b["LongText"]=a[i]["LongText"];b["ChangeMode"]="U";var l={};l["ParentUUID"]=a[i]["UUID"];l["RecipientType"]="Location";l["RecipientUUID"]=this.locationID;l["AuditTrail.CreatedBy"]=null;l["AuditTrail.ChangedBy"]=null;l["AuditTrail.CreationTime"]=null;l["AuditTrail.ChangeTime"]=null;if(a[i]["checkedUnchecked"]===1){l["ChangeMode"]="I";l["UUID"]=oSapSplUtils.getUUID();M["Header"].push(o);M["Text"].push(b);M["Recipient"].push(l);}else if(a[i]["checkedUnchecked"]===-1){if(I){for(var j=0;j<I.length;j++){if(a[i]["UUID"]===I[j]["UUID"]){l["UUID"]=I[j]["AssignmentUUID"];break;}}l["ChangeMode"]="D";M["Header"].push(o);M["Text"].push(b);M["Recipient"].push(l);}}}return M;},fnHandleSaveIncidents:function(){var p=this.preparePayLoadForPost();if(p.Header&&p.Header.length&&p.Header.length>0){oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getServiceMetadata("incidents",true),method:"PUT",data:JSON.stringify(p),success:function(d,s,m){if(d.constructor===String){d=JSON.parse(d);}if(m["status"]===200&&d["Error"].length===0){oSapSplUtils.setIsDirty(false);}else{var e=oSapSplUtils.getErrorMessagesfromErrorPayload(d)["ufErrorObject"];sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["errorWarningString"],details:e}).attachAfterClose(function(){jQuery(".sapUiBLy").css("z-index","0");});}},error:function(e){jQuery.sap.log.error("fnHandlePressOfSaveIncidents","ajax failed","IncidentsDetailView.controller.js");oSapSplBusyDialog.getBusyDialogInstance().close();if(e&&e["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+" "+e.statusText,details:e.responseText}).attachAfterClose(function(){jQuery(".sapUiBLy").css("z-index","0");});}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["ufErrorObject"]}).attachAfterClose(function(){jQuery(".sapUiBLy").css("z-index","0");});}}});}},fnHandleListItemSelection:function(e){if(e.getParameters().listItem.getSelected()===true){e.getParameters().listItem.getBindingContext().getObject()["checkedUnchecked"]=1;}else if(e.getParameters().listItem.getSelected()===false){e.getParameters().listItem.getBindingContext().getObject()["checkedUnchecked"]=-1;}},fnPrepareModelForIncidence:function(d){var I=d.results;var a=I.length;var D=this.getView().getModel().getData();var m=D.Incidents.results;var M=m.length;for(var i=0;i<a;i++){I[i]["isChecked"]=false;I[i]["checkedUnchecked"]=0;for(var j=0;j<M;j++){if(I[i]["UUID"]===m[j]["UUID"]){I[i]["isChecked"]=true;I[i]["checkedUnchecked"]=0;}}}D.AssignedIncidents={};D.AssignedIncidents.results=I;this.oDialogData=jQuery.extend(true,{},D);this.byId("SplCreateEditLocationDialogAssignIncidentPage").setTitle(oSapSplUtils.getBundle().getText("INCIDENTS_MASTER_PAGE_TITLE",a.toString()));this.getView().getModel().setData(D);},getIncidentData:function(s,e){var f="$filter=isDeleted eq '0'";this.oSapSplApplModel=sap.ui.getCore().getModel("LiveAppODataModel");oSapSplBusyDialog.getBusyDialogInstance().open();this.oSapSplApplModel.read("/IncidentDetails",null,[f],false,jQuery.proxy(s,this),jQuery.proxy(e,this));oSapSplBusyDialog.getBusyDialogInstance().close();jQuery(".sapUiBLy").css("z-index","0");},fnHandleValueHelpForIncidenceAssignment:function(){var n=this.navContainer.getPages()[3].sId;this.getIncidentData(this.fnPrepareModelForIncidence,function(){});this.navContainer.to(n,"slide");}});
