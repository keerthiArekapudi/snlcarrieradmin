/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.controller("splController.dialogs.SplEditDisplayAreaSettings",{onInit:function(){this.getView().setModel(sap.ui.getCore().getModel("LiveAppODataModel"));var s=new sap.ui.model.Sorter("isMyCompanyView",false,function(c){var o=c.getProperty("OwnerName");var i=c.getProperty("isMyCompanyView");if(i===1){return{key:"My Owner",text:"{splI18NModel>MY_COMPANY_DISPLAY_AREAS}"};}else{return{key:o,text:o};}});this.oMainSettingsObject={};this.byId("isPublicColumn").setVisible(splReusable.libs.SapSplModelFormatters.sapSplGetVisibilityBasedOnSubscriptionModel(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["canPublishDisplayArea"]));this.byId("SapSplEditDisplayAreaSettingsTable").getBinding("items").sort(s);},fnHandleChangeOfName:function(e){this.fnMaintainMainSettingsObject(e.getParameters().newValue,"Name",e.getSource().getBindingContext().getProperty(),"Header");},fnHandleSelectOfFavourite:function(e){this.fnMaintainMainSettingsObject((e.getParameters().selected===true)?"1":"0","Favourite",e.getSource().getBindingContext().getProperty(),"DisplayArea");},fnHandleSelectOfDefault:function(e){if(e.getParameters().selected===true){this.getView().getViewData().oMapInstance.defaultDisplayArea=e.getSource().getBindingContext().getProperty();}this.fnMaintainMainSettingsObject((e.getParameters().selected===true)?"1":"0","isDefault",e.getSource().getBindingContext().getProperty(),"DisplayArea");},fnHandleSelectOfPublic:function(e){this.fnMaintainMainSettingsObject((e.getParameters().selected===true)?"1":"0","isPublic",e.getSource().getBindingContext().getProperty(),"Header");},fnHandleDeleteOfDisplayArea:function(e){var o=e.getSource().getBindingContext().getProperty();this.oMainSettingsObject[o.LocationID]={};this.oMainSettingsObject[o.LocationID]["Header"]={"LocationID":o["LocationID"],"Name":o["Name"],"OwnerID":o["OwnerID"],"Geometry":JSON.parse(o["Geometry"]),"Type":"L00002","ChangeMode":"D"};e.getSource().getParent().$().css("display","none");},fnMaintainMainSettingsObject:function(v,p,o,P){if(!this.oMainSettingsObject[o.LocationID]){this.oMainSettingsObject[o.LocationID]={};}if(!this.oMainSettingsObject[o.LocationID][P]){this.oMainSettingsObject[o.LocationID][P]={};if(P==="Header"){this.oMainSettingsObject[o.LocationID][P]={"LocationID":o["LocationID"],"Name":o["Name"],"OwnerID":o["OwnerID"],"Type":"L00002","ChangeMode":"U","Geometry":JSON.parse(o["Geometry"]),"isPublic":o["isPublic"].toString()};}else{this.oMainSettingsObject[o.LocationID][P]={"UUID":sap.ui.getCore().getModel("loggedOnUserModel").getData().profile.UUID,"LocationID":o["LocationID"],"Favourite":o["Favourite"].toString(),"isDefault":o["isDefault"].toString(),"ChangeMode":"U"};}}this.oMainSettingsObject[o.LocationID][P][p]=v;},setParentDialogInstance:function(p){this.oParentDialogInstance=p;this.setButtonForDialog();},setButtonForDialog:function(){this.oSapSplDisplayAreaSettingsSaveButton=new sap.m.Button({text:"{splI18NModel>NEW_CONTACT_SAVE}",press:jQuery.proxy(this.fnHandlePressOfSaveDisplayAreaSettings,this)});this.oSapSplDisplayAreaSettingsCancelButton=new sap.m.Button({text:"{splI18NModel>CANCEL}",press:jQuery.proxy(this.fnHandlePressOfCancelDisplayAreaSettings,this)});this.oParentDialogInstance.setBeginButton(this.oSapSplDisplayAreaSettingsSaveButton);this.oParentDialogInstance.setEndButton(this.oSapSplDisplayAreaSettingsCancelButton);},fnHandlePressOfSaveDisplayAreaSettings:function(){var t=this;var p={},d=[];p["Header"]=[];p["Personalization"]={};jQuery.each(this.oMainSettingsObject,function(k,o){if(o["Header"]){p["Header"].push(o["Header"]);}if(o["DisplayArea"]){d.push(o["DisplayArea"]);}});p["Personalization"].DisplayArea=d;p["inputHasChangeMode"]=true;var s=oSapSplUtils.getServiceMetadata("newLocation",true);oSapSplBusyDialog.getBusyDialogInstance({title:oSapSplUtils.getBundle().getText("BUSY_DIALOG_MESSAGE")}).open();oSapSplAjaxFactory.fireAjaxCall({url:s,method:"PUT",data:JSON.stringify(p),success:function(a,b,m){if(a.constructor===String){a=JSON.parse(a);}if(m["status"]===200&&a["Error"].length===0){t.oParentDialogInstance.close();oSapSplBusyDialog.getBusyDialogInstance().close();sap.ca.ui.message.showMessageToast(oSapSplUtils.getBundle().getText("CHANGES_SAVED_SUCCESS"));oSapSplUtils.setIsDirty(false);}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(a)["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(a)["ufErrorObject"]});oSapSplBusyDialog.getBusyDialogInstance().close();}},error:function(e){if(e&&e["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+" "+e.statusText,details:e.responseText});}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["ufErrorObject"]});}oSapSplBusyDialog.getBusyDialogInstance().close();jQuery.sap.log.error(e["status"],e.statusText,"CreateDisplayAreaDialog.controller.js");},complete:function(){}});},fnHandlePressOfCancelDisplayAreaSettings:function(e){e.getSource().getParent().close();e.getSource().getParent().destroy();}});
