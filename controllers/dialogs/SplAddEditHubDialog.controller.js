/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.controller("splController.dialogs.SplAddEditHubDialog",{onInit:function(){this.oPreviouslySelectedItem=null;var t=this;sap.ui.getCore().setModel(new sap.ui.model.json.JSONModel({visible:true,subScriptionAccepted:false}),"splSearchVisibilityModel");splReusable.libs.SapSplStyleSheetLoader.loadStyle("./resources/styles/sapSplAddEditDeregisterHubDialog","css");this.byId("SubscriptionPackage").attachBrowserEvent("click",jQuery.proxy(this.fnToCatchCurrentSubscription,this));var s={},c=[],S={},p=[],a=[];this.oSapSplHubListModel=new sap.ui.model.json.JSONModel();s["Name"]="Select";s["Name.description"]=oSapSplUtils.getBundle().getText("PLEASE_SELECT_PLACEHOLDER");this.getView().setModel(this.oSapSplHubListModel);function g(){var o={};var b=[];o["OwnerID"]="Select";o["OwnerName"]=oSapSplUtils.getBundle().getText("PLEASE_SELECT_PLACEHOLDER");b[0]=o;oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getServiceMetadata(SapSplEnums.RootApp,true)+"/PossibleOwnerList?$format=json&$filter=isConnected eq 0",async:false,method:"Get",success:function(r){if(r.d.results.length>0){r.d.results.unshift(o);b=r.d.results;}}});return b;}if(this.getView().getViewData()&&this.getView().getViewData().Text==="Create"){this.byId("SelectedHubName").setVisible(false);this.byId("SelectOneOfAlreadyConnectedHubsToDeregister").setVisible(false);this.byId("DeregistrationHorizontalLayout").setVisible(false);p=g();}else if(this.getView().getViewData()&&this.getView().getViewData().Text==="Edit"){this.byId("HubText").setVisible(false);this.byId("SelectNewHub").setVisible(false);this.byId("AgreeDisagreeClause").setVisible(false);this.byId("SelectOneOfAlreadyConnectedHubsToDeregister").setVisible(false);this.byId("DeregistrationHorizontalLayout").setVisible(false);S=this.getView().getViewData().SelectedHubForEdit;if(S.isVisibleOnSearch==="1"){this.byId("BuPaIsVisibleCheckBox").setSelected(true);}else if(S.isVisibleOnSearch==="0"){this.byId("BuPaIsVisibleCheckBox").setSelected(false);}a=this.fnToGetSubscriptionProductForSelectedHub(S.OwnerID);if(a.length===1){this.byId("SubscriptionPackage").setVisible(false);}else{this.byId("SingleSubscriptionPackage").setVisible(false);}}else if(this.getView().getViewData()&&this.getView().getViewData().Text==="Deregister"){this.byId("SelectNewHub").setVisible(false);this.byId("SelectedHubName").setVisible(false);this.byId("SubscriptionPackageText").setVisible(false);this.byId("SubscriptionPackage").setVisible(false);this.byId("SingleSubscriptionPackage").setVisible(false);this.byId("BuPaIsVisibleCheckBox").setVisible(false);this.byId("AgreeDisagreeClause").setVisible(false);c=oSapSplUtils.getCompanyDetails().MyOwnerList;}this.oSapSplHubListModel.setData({possibleOwners:p,subscription:a,connectedHubs:c,SelectedHub:S});this.byId("SubscriptionPackage").addEventDelegate({onAfterRendering:function(e){if(t.byId("SubscriptionPackage").getSelectedItem()){t.byId("SubscriptionPackage").fireChange({selectedItem:t.byId("SubscriptionPackage").getSelectedItem()});}e.srcControl.$().on("focusout",function(e){e.stopPropagation();});}});},fnToCatchCurrentSubscription:function(e){this.previousSelectedKeyForSubscription=sap.ui.getCore().byId(e.target.parentNode.id).getSelectedKey();this.previousSelectedItemForSubscription=sap.ui.getCore().byId(e.target.parentNode.id).getSelectedItem();},handleHubSelectionChange:function(e){var s=e.getParameter("selectedItem").getKey();var S=[];var m=this.oSapSplHubListModel.getData();var t=this;if(s!=="Select"){this.fnToCaptureLiveChangeToSetFlag();this.byId("SingleSubscriptionPackage").setVisible(false);S=this.fnToGetSubscriptionProductForSelectedHub(s);if(S.length===1){this.byId("SubscriptionPackage").setVisible(false);this.byId("SubscriptionPackageText").setVisible(false);}m.subscription=S;this.oSapSplHubListModel.setData(m);}},handleAgreeDisagreeSelect:function(e){this.fnToCaptureLiveChangeToSetFlag();if(e.getParameters().selected){this.getView().getParent().getBeginButton().setEnabled(true);}else if(!(e.getParameters().selected)){this.getView().getParent().getBeginButton().setEnabled(false);}},fnToGetSubscriptionProductForSelectedHub:function(s){var S=[];oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getServiceMetadata(SapSplEnums.RootApp,true)+"/PossibleOwnerList?$format=json&$filter=OwnerID eq X\'"+oSapSplUtils.base64ToHex(s)+"\'&$expand=SubscriptionProductList",async:false,method:"Get",success:function(r){if(r.d.results.length>0){if(r.d.results[0]&&r.d.results[0].SubscriptionProductList.results){S=r.d.results[0].SubscriptionProductList.results;}}}});return S;},fnToCaptureLiveChangeToSetFlag:function(){if(!oSapSplUtils.getIsDirty()){oSapSplUtils.setIsDirty(true);if(this.getView().getViewData()&&this.getView().getViewData().Text==="Edit"){this.getView().getParent().getBeginButton().setEnabled(true);}}},fnToSetSaveButtonEnablement:function(e){function c(p,P){return((p||P)&&!(p&&P));}if(this.getView().getViewData()&&this.getView().getViewData().Text==="Edit"){if(c(parseInt(this.getView().getViewData().SelectedHubForEdit.isVisibleOnSearch),e.getParameters().selected)){this.getView().getParent().getBeginButton().setEnabled(true);oSapSplUtils.setIsDirty(true);}else{this.getView().getParent().getBeginButton().setEnabled(false);oSapSplUtils.setIsDirty(false);}}},fnCaptureNoChangeOnSubscription:function(){if(oSapSplUtils.getIsDirty()){oSapSplUtils.setIsDirty(false);}if(this.getView().getViewData()&&this.getView().getViewData().Text==="Edit"){this.getView().getParent().getBeginButton().setEnabled(false);}},setSubscriptionItem:function(i){if(this.getView().getViewData().HubMode==="Edit"){this.oPreviouslySelectedItem=i;}else{this.oPreviouslySelectedItem=null;}},handleProductChange:function(e){if(e.mParameters.data===undefined){var p=null;function h(i,s,o,c){p=new sap.m.Dialog({contentHeight:"280px",contentWidth:"670px",state:sap.ui.core.ValueState.Warning,title:"{splI18NModel>CONFIRMATION_DIALOG_HEADER_TITLE}",buttons:[new sap.m.Button({text:"{splI18NModel>OK}",enabled:{path:"splSearchVisibilityModel>/subScriptionAccepted"},press:[function(e){o(e);},i]}),new sap.m.Button({text:"{splI18NModel>CANCEL}",press:[function(e){c(e);},i]})],content:sap.ui.view({viewName:"splView.dialogs.SplChangeSubScriptionPromptDialog",id:"splView.dialogs.SplChangeSubScriptionPromptDialog",type:sap.ui.core.mvc.ViewType.XML,viewData:{data:e.getParameter("selectedItem")}}),afterClose:[function(){p.destroy();},i]});p.addStyleClass("sapSplProductChangeAgreementDialog");p.open();};if(((this.byId("SubscriptionPackage").getSelectedKey()!==this.getView().getViewData().SelectedHubDetails.SubscriptionProductName))){var t=this;h(this,e,function(e){t.bProfileIsModified=true;t.fnToCaptureLiveChangeToSetFlag();$.sap.log.info("SAP SCL Event","Event fired "+e,"SAPSCL");oSapSplUtils.getStorageInstance("session").put("spl-change-prompt-subscr","x");e.getSource().getParent().getParent().destroy();oSapSplUtils.setIsDirty(false);},function(e){var f=false;t.byId("SubscriptionPackage").setSelectedItem(t.oPreviouslySelectedItem);$.sap.log.info("SAP SCL Event","Event fired "+e,"SAPSCL");if(oSapSplUtils.getStorageInstance("session").get("spl-change-prompt-subscr")){oSapSplUtils.getStorageInstance("session").remove("spl-change-prompt-subscr");}e.getSource().getParent().getParent().destroy();});}else{this.fnCaptureNoChangeOnSubscription();}}}});
