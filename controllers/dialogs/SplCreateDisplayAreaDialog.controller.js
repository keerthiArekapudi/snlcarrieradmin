/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.controller("splController.dialogs.SplCreateDisplayAreaDialog",{onInit:function(){var t=this;this.fnDefineControlLabelsFromLocalizationBundle();this.oViewData=this.getView().getViewData();this.liveAppControllerInstance=this.oViewData.oPageInstance.getParent().getParent();if(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["isIncidentEditable"]===0){this.byId("SapSplDisplayAreaIsPublicCheckBox").setVisible(false);}else{this.byId("SapSplDisplayAreaIsPublicCheckBox").setVisible(true);}oSapSplUtils.setIsDirty(true);this.getView().getViewData().parentControllerInstance.fnShowHideLiveAppDisplayAreaBorder("show");this.getView().addEventDelegate({onAfterRendering:function(e){window.setTimeout(function(){t.getView().byId("SapSplDisplayAreaNameInput").focus();},100);}});},fnDefineControlLabelsFromLocalizationBundle:function(){this.byId("SapSplCreateDisplayAreaPageInfo").setText(oSapSplUtils.getBundle().getText("CREATE_DISPLAY_AREA_PAGE_INFO"));this.byId("SapSplDisplayAreaNameLabel").setText(oSapSplUtils.getBundle().getText("NAME"));this.byId("SapSplDisplayAreaMakeDefaultCheckBox").setText(oSapSplUtils.getBundle().getText("MAKE_DEFAULT_VIEW"));this.byId("SapSplDisplayAreaIsPublicCheckBox").setText(oSapSplUtils.getBundle().getText("PUBLIC"));},onAfterRendering:function(){},setParentDialogInstance:function(p){this.oParentDialogInstance=p;this.setButtonsForDialog();},setButtonsForDialog:function(){this.oSapSplCreateDisplayAreaSaveButton=new sap.m.Button({press:jQuery.proxy(this.fnHandlePressOfCreateDisplayAreaSaveButton,this),enabled:false});this.oSapSplCreateDisplayAreaCancelButton=new sap.m.Button({press:jQuery.proxy(this.fnHandlePressOfCreateDisplayAreaCancelButton,this)});this.oSapSplCreateDisplayAreaSaveButton.setText(oSapSplUtils.getBundle().getText("NEW_CONTACT_SAVE"));this.oSapSplCreateDisplayAreaCancelButton.setText(oSapSplUtils.getBundle().getText("CANCEL"));this.oParentDialogInstance.setBeginButton(this.oSapSplCreateDisplayAreaSaveButton);this.oParentDialogInstance.setEndButton(this.oSapSplCreateDisplayAreaCancelButton);},fnHandlePressOfCreateDisplayAreaCancelButton:function(){var t=this;if(oSapSplUtils.getIsDirty()){sap.m.MessageBox.show(oSapSplUtils.getBundle().getText("DATA_LOSS_WARNING_TEXT"),sap.m.MessageBox.Icon.WARNING,oSapSplUtils.getBundle().getText("WARNING"),[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.CANCEL],function(s){if(s==="YES"){t.getView().getParent().close();oSapSplUtils.setIsDirty(false);}});}else{t.getView().getParent().close();oSapSplUtils.setIsDirty(false);}},fnHandlePressOfCreateDisplayAreaSaveButton:function(){var p=this.fnPreparePayloadToCreateDisplayArea();var t=this;var s=oSapSplUtils.getServiceMetadata("newLocation",true);oSapSplBusyDialog.getBusyDialogInstance({title:oSapSplUtils.getBundle().getText("BUSY_DIALOG_MESSAGE")}).open();oSapSplAjaxFactory.fireAjaxCall({url:s,method:"PUT",data:JSON.stringify(p),success:function(d,a,m){if(d.constructor===String){d=JSON.parse(d);}if(m["status"]===200&&d["Error"].length===0){t.oParentDialogInstance.close();oSapSplBusyDialog.getBusyDialogInstance().close();sap.ca.ui.message.showMessageToast(oSapSplUtils.getBundle().getText("CREATE_DISPLAY_AREA_SUCCESS_MSG",d.Header[0].Name));oSapSplUtils.setIsDirty(false);if(d.Personalization.DisplayArea[0].isDefault==="1"){t.oViewData.oMapInstance.defaultDisplayArea=d.Header[0];}}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["ufErrorObject"]});oSapSplBusyDialog.getBusyDialogInstance().close();}},error:function(e){if(e&&e["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+" "+e.statusText,details:e.responseText});}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["ufErrorObject"]});}oSapSplBusyDialog.getBusyDialogInstance().close();jQuery.sap.log.error(e["status"],e.statusText,"CreateDisplayAreaDialog.controller.js");},complete:function(){}});},fnPreparePayloadToCreateDisplayArea:function(){var l=oSapSplUtils.getUUID();var i="0",I=null,d=null,r=null;if(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["isIncidentEditable"]!==0){if(this.byId("SapSplDisplayAreaIsPublicCheckBox").getSelected()){i="1";}}if(this.byId("SapSplDisplayAreaMakeDefaultCheckBox").getSelected()){I="1";if(this.oViewData.oMapInstance.defaultDisplayArea!==null&&this.oViewData.oMapInstance.defaultDisplayArea!==undefined){d={};d.UUID=sap.ui.getCore().getModel("loggedOnUserModel").getData().profile.UUID;d.LocationID=this.oViewData.oMapInstance.defaultDisplayArea.LocationID;d.Favourite="1";d.isDefault="0";d.ChangeMode="U";}}else{I="0";}r={"Header":[{"LocationID":l,"Name":this.byId("SapSplDisplayAreaNameInput").getValue(),"OwnerID":oSapSplUtils.getCompanyDetails()["BasicInfo_CompanyID"],"Type":"L00002","Geometry":oSapSplMapsDataMarshal.convertStringToGeoJSON(this.oViewData.oMapInstance.boundingRectangle),"Stacked":"0","isPublic":i,"ParentLocationID":null,"ImageUrl":null,"Website":null,"PhoneNumber":null,"DisplayArea.ZoomLevel":this.oViewData.oMapInstance.zoom,"DisplayArea.Center":oSapSplMapsDataMarshal.convertStringToGeoJSON(this.oViewData.oMapInstance.centerpoint),"ChangeMode":"I"}],"Texts":[{"LocationID":l,"Type":"T","Text":"LC0006","ObjectUUID":l,"LocaleLanguage":null,"Language":"E","ChangeMode":"I"}],"Personalization":{"DisplayArea":[{"UUID":sap.ui.getCore().getModel("loggedOnUserModel").getData().profile.UUID,"LocationID":l,"Favourite":"1","isDefault":I,"ChangeMode":"I"}]},"inputHasChangeMode":true};if(d!==null){r.Personalization.DisplayArea.push(d);return r;}else{return r;}},fnToCaptureLiveChangeNameInput:function(e){if(e.getSource().getValue().length>0){this.oParentDialogInstance.getBeginButton().setEnabled(true);}else{this.oParentDialogInstance.getBeginButton().setEnabled(false);}this.fnToCaptureLiveChangeToSetFlag();},fnToCaptureLiveChangeToSetFlag:function(){if(!oSapSplUtils.getIsDirty()){oSapSplUtils.setIsDirty(true);}}});
