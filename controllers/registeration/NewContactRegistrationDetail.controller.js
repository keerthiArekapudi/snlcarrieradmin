/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
jQuery.sap.require("sap.ca.ui.message.message");jQuery.sap.require("sap.m.MessageBox");sap.ui.controller("splController.registeration.NewContactRegistrationDetail",{onInit:function(){this.unifiedShell=null;var m=new sap.ui.model.json.JSONModel({});sap.ui.getCore().setModel(m,"myContactsRegisterEditModel");this.bindRoles();this.getView().setModel(sap.ui.getCore().getModel("myContactsRegisterEditModel"));this.fnDefineControlLabelsFromLocalizationBundle();},bindRoles:function(){if(!sap.ui.getCore().getModel("splNewContactRegistrationRoles")){var r=new sap.ui.model.json.JSONModel();sap.ui.getCore().setModel(r,"splNewContactRegistrationRoles");}this.getView().byId("splNewContactRegistrationRoles").setModel(sap.ui.getCore().getModel("splNewContactRegistrationRoles"));},fnDefineControlLabelsFromLocalizationBundle:function(){this.byId("NewContactRegistrationDetailPage").setTitle(oSapSplUtils.getBundle().getText("NEW_CONTACT_TITLE",oSapSplUtils.getCompanyDetails()["Organization_Name"]));this.byId("newContactCancel").setText(oSapSplUtils.getBundle().getText("MY_COLLEAGUES_CANCEL_BUTTON"));this.byId("sapSplMyUserEditFirstName").setText(oSapSplUtils.getBundle().getText("FIRST_NAME"));this.byId("sapSplMyUserEditLastName").setText(oSapSplUtils.getBundle().getText("LAST_NAME"));this.byId("sapSplMyUserEditRole").setText(oSapSplUtils.getBundle().getText("ROLE"));this.byId("sapSplMyUserEditEmail").setText(oSapSplUtils.getBundle().getText("EMAIL"));this.byId("sapSplMyUserEditPhone").setText(oSapSplUtils.getBundle().getText("PHONE"));},onBeforeShow:function(e){if(e.data.sMode&&e.data.sMode==="edit"){this.byId("NewContactRegistrationDetailPage").setTitle(oSapSplUtils.getBundle().getText("EDIT_CONTACT_TITLE",[":",e.data.context["PersonName_GivenName"]]));this.isEditMyUser=1;this.byId("sapSplMyUserEditEmailInput").setEnabled(false);}else{this.byId("NewContactRegistrationDetailPage").setTitle(oSapSplUtils.getBundle().getText("NEW_CONTACT_TITLE",oSapSplUtils.getCompanyDetails()["Organization_Name"]));this.isEditMyUser=0;this.sRole=e.data.context["MainUserRoles_Role1"];this.byId("sapSplMyUserEditEmailInput").setEnabled(true);}if(e.data.selectEnabled&&e.data.selectEnabled===true){this.getView().byId("splNewContactRegistrationRoles").setEnabled(true);}else{this.getView().byId("splNewContactRegistrationRoles").setEnabled(false);}oSapSplUtils.setIsDirty(false);sap.ui.getCore().getModel("myContactsRegisterEditModel").setData(e.data.context);},fireInviteAction:function(){function _(){sap.ui.getCore().getModel("myContactListODataModel").refresh();}var p,t=this,u=oSapSplUtils.getFQServiceUrl("/sap/spl/xs/app/services/businessPartnerRegistration.xsjs");oSapSplBusyDialog.getBusyDialogInstance({title:oSapSplUtils.getBundle().getText("BUSY_DIALOG_MESSAGE")}).open();if(this.isEditMyUser===0){if(this.sRole==="Driver"){u=oSapSplUtils.getFQServiceUrl("/sap/spl/xs/app/services/businessPartner.xsjs");}p=this.preparePayLoadForPost();oSapSplAjaxFactory.fireAjaxCall({url:u,method:"POST",data:JSON.stringify(p),success:function(d,s,m){oSapSplBusyDialog.getBusyDialogInstance().close();oSapSplUtils.setIsDirty(false);if(d.constructor===String){d=JSON.parse(d);}if(m["status"]===200&&d["Error"].length===0){var c=new sap.ui.core.CustomData({key:"bRefreshTile",value:true});oSplBaseApplication.getAppInstance().getCurrentPage().destroyCustomData();oSplBaseApplication.getAppInstance().getCurrentPage().addCustomData(c);if(d.RoleAssignment&&d.RoleAssignment.length>0&&d.RoleAssignment[0].Role==="DRIVER"){sap.ca.ui.message.showMessageToast(oSapSplUtils.getBundle().getText("DRIVER_ADDED_SUCCESSFULLY_MSG"));}else{sap.ca.ui.message.showMessageToast(oSapSplUtils.getBundle().getText("INVITATION_SENT_SUCCESSFULLY_MSG"));}}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["ufErrorObject"]});}oSapSplUtils.getCurrentMasterPage().byId("SapSplMyContactsList").addCustomData(new sap.ui.core.CustomData({key:d.Header[0]["UUID"]}));_();},error:function(e){oSapSplBusyDialog.getBusyDialogInstance().close();oSapSplUtils.setIsDirty(true);if(e&&e["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+"\t"+e.statusText,details:e.responseText});}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["ufErrorObject"]});}}});}else{if(this.isEditMyUser===1){if(!oSapSplUtils.getIsDirty()){sap.ui.getCore().getModel("myContactListODataModel").refresh();return;}p=this.preparePayLoadForPost();oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/app/services/businessPartner.xsjs"),method:"PUT",data:JSON.stringify(p),success:function(d,s,m){oSapSplBusyDialog.getBusyDialogInstance().close();if(d.constructor===String){d=JSON.parse(d);}if(m["status"]===200&&d["Error"].length===0){var c=new sap.ui.core.CustomData({key:"bRefreshTile",value:true});oSplBaseApplication.getAppInstance().getCurrentPage().destroyCustomData();oSplBaseApplication.getAppInstance().getCurrentPage().addCustomData(c);oSapSplUtils.setIsDirty(false);sap.ca.ui.message.showMessageToast(oSapSplUtils.getBundle().getText("SUCCESSFUL_EDIT",d.Header[0]["PersonName.Surname"]+" ,"+d.Header[0]["PersonName.GivenName"]));t.fireCancelAction();}else{var e=oSapSplUtils.getErrorMessagesfromErrorPayload(d)["ufErrorObject"],a=oSapSplUtils.getErrorMessagesfromErrorPayload(d)["errorWarningString"];if(a.split(" errors")[0]<1&&a.split(" warnings")[0].split("and ")[1]>0){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:a,details:e});}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:a,details:e});}}oSapSplUtils.getCurrentMasterPage().byId("SapSplMyContactsList").addCustomData(new sap.ui.core.CustomData({key:d.Header[0]["UUID"]}));_();},error:function(e){oSapSplBusyDialog.getBusyDialogInstance().close();oSapSplUtils.setIsDirty(true);if(e&&e["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+" "+e.statusText,details:e.responseText});}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["ufErrorObject"]});}}});}}},fireCancelAction:function(){var t=this,s;s=jQuery.extend(true,{},sap.ui.getCore().getModel("myContactDetailModel").getData());if(oSapSplUtils.getIsDirty()){sap.m.MessageBox.show(oSapSplUtils.getBundle().getText("DATA_LOSS_WARNING_TEXT"),sap.m.MessageBox.Icon.WARNING,oSapSplUtils.getBundle().getText("WARNING"),[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.CANCEL],function(a){if(a==="YES"){jQuery.proxy(t.callToNavInDetail(s),t);t.selectMasterListItemOnBackNavigation("myContactDetailModel");oSapSplUtils.setIsDirty(false);}});}else{this.callToNavInDetail(s);this.selectMasterListItemOnBackNavigation("myContactDetailModel");}},callToNavInDetail:function(m){var b=sap.ui.getCore().getEventBus();b.publish("navInDetail","to",{from:this.getView(),data:{context:m}});},selectMasterListItemOnBackNavigation:function(m){var i,c,a;c=sap.ui.getCore().getModel(m).getData();a=oSapSplUtils.getCurrentMasterPage().byId("SapSplMyContactsList");for(i=0;i<a.getItems().length;i++){if(a.getItems()[i].sId.indexOf("SapSplMyContactsListItem")!==-1){if(a.getItems()[i].getBindingContext().getProperty().UUID===c.UUID){a.setSelectedItem(a.getItems()[i]);break;}}}},preparePayLoadForPost:function(){var a=[],p={},r=[],d={},i,U,b=[];d=sap.ui.getCore().getModel("myContactsRegisterEditModel").getData();d=this.getDataInPostFormat(d);a[0]={};if(this.isEditMyUser===0){b[0]={};U=oSapSplUtils.getUUID();a[0]["UUID"]=U;a[0]["BasicInfo.ID"]=null;a[0]["BasicInfo.CompanyID"]=oSapSplUtils.getCompanyDetails()["UUID"];a[0]["BasicInfo.Type"]="P";a[0]["Organization.Name"]=null;a[0]["Organization.RegistrationNumber"]=null;a[0]["Organization.Registry"]=null;a[0]["PersonName.GivenName"]=d["PersonName.GivenName"];a[0]["PersonName.JobFunction"]=d["PersonName.JobFunction"];a[0]["PersonName.Surname"]=d["PersonName.Surname"];a[0]["PersonName.SurnamePrefix"]=d["PersonName.SurnamePrefix"];a[0]["PersonName.Title"]=d["PersonName.Title"];a[0]["PostalAddress.Street"]=d["PostalAddress.Street"];a[0]["PostalAddress.StreetName"]=d["PostalAddress.StreetName"];a[0]["PostalAddress.Town"]=d["PostalAddress.Town"];a[0]["PostalAddress.District"]=d["PostalAddress.District"];a[0]["PostalAddress.PostalCode"]=d["PostalAddress.PostalCode"];a[0]["PostalAddress.Country"]=d["PostalAddress.Country"];a[0]["CommunicationInfo.EmailAddress"]=d["CommunicationInfo.EmailAddress"];a[0]["CommunicationInfo.Fax"]=d["CommunicationInfo.Fax"];a[0]["CommunicationInfo.Phone"]=d["CommunicationInfo.Phone"];a[0]["CommunicationInfo.Website"]=d["CommunicationInfo.Website"];if(this.sRole!=="Driver"){a[0]["Owner"]=null;a[0]["InvitedByOrganization"]=oSapSplUtils.getCompanyDetails()["UUID"];a[0]["RequestType"]="1";a[0]["RequestStatus"]="0";a[0]["isDeleted"]="0";}if(this.sRole==="Driver"){b[0]["Partner"]=U;}else{b[0]["Request"]=U;}b[0]["UUID"]=oSapSplUtils.getUUID();for(i=0;i<sap.ui.getCore().getModel("splNewContactRegistrationRoles").getData().results.length;i++){if(sap.ui.getCore().getModel("splNewContactRegistrationRoles").getData().results[i]["GrantableRole.description"]===d["MainUserRoles.Role1"]){b[0]["Role"]=sap.ui.getCore().getModel("splNewContactRegistrationRoles").getData().results[i].GrantableRole;break;}}p["Header"]=a;if(this.sRole==="Driver"){p["RoleAssignment"]=b;}else{p["Roles"]=b;}return p;}else{if(this.isEditMyUser===1){a[0]["UUID"]=d["UUID"];a[0]["BasicInfo.CompanyID"]=d["BasicInfo.CompanyID"];a[0]["BasicInfo.Type"]=d["BasicInfo.Type"];a[0]["BasicInfo.ID"]=null;a[0]["Organization.Name"]=d["Organization.Name"];a[0]["Organization.RegistrationNumber"]=d["Organization.RegistrationNumber"];a[0]["Organization.Registry"]=d["Organization.Registry"];a[0]["PersonName.GivenName"]=d["PersonName.GivenName"];a[0]["PersonName.JobFunction"]=d["PersonName.JobFunction"];a[0]["PersonName.Surname"]=d["PersonName.Surname"];a[0]["PersonName.SurnamePrefix"]=d["PersonName.SurnamePrefix"];a[0]["PersonName.Title"]=d["PersonName.Title"];a[0]["PostalAddress.Street"]=d["PostalAddress.Street"];a[0]["PostalAddress.StreetName"]=d["PostalAddress.StreetName"];a[0]["PostalAddress.Town"]=d["PostalAddress.Town"];a[0]["PostalAddress.District"]=d["PostalAddress.District"];a[0]["PostalAddress.PostalCode"]=d["PostalAddress.PostalCode"];a[0]["PostalAddress.Country"]=d["PostalAddress.Country"];a[0]["CommunicationInfo.EmailAddress"]=d["CommunicationInfo.EmailAddress"];a[0]["CommunicationInfo.Fax"]=d["CommunicationInfo.Fax"];a[0]["CommunicationInfo.Phone"]=d["CommunicationInfo.Phone"];a[0]["CommunicationInfo.Website"]=d["CommunicationInfo.Website"];a[0]["UserID"]=d["UserID"];a[0]["RegistrationRequest"]=d["RegistrationRequest"];a[0]["ImageUrl"]=d["ImageUrl"];a[0]["InvitedByOrganization"]=d["InvitedByOrganization"];p.inputHasChangeMode=false;if(d["MainUserRoles.Role1"]!==sap.ui.getCore().getModel("myContactDetailModel").getData()["Role.description"]){a[0]["ChangeMode"]="U";p.inputHasChangeMode=true;r[0]={};r[1]={};r[0].UUID=sap.ui.getCore().getModel("myContactDetailModel").getData().RoleUUID;r[1].UUID=oSapSplUtils.getUUID();r[0].Partner=d["UUID"];r[1].Partner=d["UUID"];r[0].Role=sap.ui.getCore().getModel("myContactDetailModel").getData().Role;for(i=0;i<sap.ui.getCore().getModel("splNewContactRegistrationRoles").getData().results.length;i++){if(sap.ui.getCore().getModel("splNewContactRegistrationRoles").getData().results[i]["GrantableRole.description"]===d["MainUserRoles.Role1"]){r[1].Role=sap.ui.getCore().getModel("splNewContactRegistrationRoles").getData().results[i].GrantableRole;}}r[0].Role=sap.ui.getCore().getModel("myContactDetailModel").getData().Role;r[0].ChangeMode="D";r[1].ChangeMode="I";p["RoleAssignment"]=r;}p["Header"]=a;return p;}}},getDataInPostFormat:function(d){var _={};$.each(d,function(k,v){_[k.replace("_",".")]=v;});return _;},getUnifiedShellInstance:function(){return this.unifiedShell;},setUnifiedShellInstance:function(u){this.unifiedShell=u;},fnToCaptureLiveChangeToSetFlag:function(){if(!oSapSplUtils.getIsDirty()){oSapSplUtils.setIsDirty(true);}}});
