/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
jQuery.sap.require("sap.ca.ui.message.message");jQuery.sap.require("sap.m.MessageBox");sap.ui.controller("splController.registeration.NewBusinessPartnerRegistrationDetail",{fnDefineControlLabelsFromLocalizationBundle:function(){this.byId("NewBusinessPartnerRegistrationDetailPage").setTitle(oSapSplUtils.getBundle().getText("NEW_BUSINESS_PARTNER_TITLE"));this.byId("newBusinessPartnerCancel").setText(oSapSplUtils.getBundle().getText("MY_COLLEAGUES_CANCEL_BUTTON"));this.byId("MainContactInfoTitle").setText(oSapSplUtils.getBundle().getText("MAIN_CONTACT_INFO_TITLE"));this.byId("sapSplBusinessPartnerEditCompanyName").setText(oSapSplUtils.getBundle().getText("COMPANY_NAME"));this.byId("sapSplBusinessPartnerEditStreet").setText(oSapSplUtils.getBundle().getText("STREET"));this.byId("sapSplBusinessPartnerEditTown").setText(oSapSplUtils.getBundle().getText("TOWN"));this.byId("sapSplBusinessPartnerEditDistrict").setText(oSapSplUtils.getBundle().getText("DISTRICT"));this.byId("sapSplBusinessPartnerEditCountry").setText(oSapSplUtils.getBundle().getText("COUNTRY"));this.byId("sapSplBusinessPartnerEditPhone").setText(oSapSplUtils.getBundle().getText("PHONE"));this.byId("sapSplBusinessPartnerEditFirstName").setText(oSapSplUtils.getBundle().getText("FIRST_NAME"));this.byId("sapSplBusinessPartnerEditLastName").setText(oSapSplUtils.getBundle().getText("LAST_NAME"));this.byId("sapSplBusinessPartnerEditEmail").setText(oSapSplUtils.getBundle().getText("EMAIL"));this.byId("sapSplBusinessPartnerEditDesignation").setText(oSapSplUtils.getBundle().getText("DESIGNATION"));this.byId("newBusinessPartnerCancel").setTooltip(oSapSplUtils.getBundle().getText("MY_COLLEAGUES_CANCEL_BUTTON"));this.byId("newBusinessPartnerInvite").setTooltip(oSapSplUtils.getBundle().getText("NEW_CONTACT_INVITE"));},onInit:function(){this.unifiedShell=null;var m=new sap.ui.model.json.JSONModel();sap.ui.getCore().setModel(m,"myBusinessPartnerRegisterEditModel");this.getView().setModel(sap.ui.getCore().getModel("myBusinessPartnerRegisterEditModel"));this.fnDefineControlLabelsFromLocalizationBundle();},onBeforeShow:function(e){this.getView().byId("newBusinessPartnerInvite").setText(oSapSplUtils.getBundle().getText("NEW_CONTACT_INVITE"));oSapSplUtils.setIsDirty(false);e.data.context["isCancel"]=false;sap.ui.getCore().getModel("myBusinessPartnerRegisterEditModel").setData(e.data.context);if(oSapSplUtils.getCurrentDetailPageBP().sId==="MyBusinessPartnerDetail"){this.byId("NewBusinessPartnerRegistrationDetailPage").setShowNavButton();}},getUnifiedShellInstance:function(){return this.unifiedShell;},setUnifiedShellInstance:function(u){this.unifiedShell=u;},getDataInPostFormat:function(d){var _={};$.each(d,function(k,v){_[k.replace("_",".")]=v;});return _;},preparePayLoad:function(d){var h=[],U,r=[],p={};h[0]={};r[0]={};d["POC"]=this.getDataInPostFormat(d["POC"]);U=oSapSplUtils.getUUID();h[0]["UUID"]=U;h[0]["BasicInfo.ID"]=null;h[0]["BasicInfo.CompanyID"]=null;h[0]["BasicInfo.Type"]="O";h[0]["Organization.Name"]=d["Organization.Name"];h[0]["Organization.RegistrationNumber"]=d["Organization.RegistrationNumber"];h[0]["Organization.Registry"]=d["Organization.Registry"];h[0]["PersonName.GivenName"]=d["POC"]["PersonName.GivenName"];h[0]["PersonName.JobFunction"]=d["POC"]["PersonName.JobFunction"];h[0]["PersonName.Surname"]=d["POC"]["PersonName.Surname"];h[0]["PersonName.SurnamePrefix"]=d["PersonName.SurnamePrefix"];h[0]["PersonName.Title"]=d["PersonName.Title"];h[0]["PostalAddress.Street"]=d["PostalAddress.Street"];h[0]["PostalAddress.StreetName"]=d["PostalAddress.StreetName"];h[0]["PostalAddress.Town"]=d["PostalAddress.Town"];h[0]["PostalAddress.District"]=d["PostalAddress.District"];h[0]["PostalAddress.PostalCode"]=d["PostalAddress.PostalCode"];h[0]["PostalAddress.Country"]=d["PostalAddress.Country"];h[0]["CommunicationInfo.EmailAddress"]=d["POC"]["CommunicationInfo.EmailAddress"];h[0]["CommunicationInfo.Fax"]=d["CommunicationInfo.Fax"];h[0]["CommunicationInfo.Phone"]=d["CommunicationInfo.Phone"];h[0]["CommunicationInfo.Website"]=d["CommunicationInfo.Website"];h[0]["Owner"]=oSapSplUtils.getCompanyDetails().Owner.results[0].Owner;h[0]["InvitedByOrganization"]=oSapSplUtils.getCompanyDetails()["UUID"];h[0]["RequestType"]="1";h[0]["RequestStatus"]="0";h[0]["isDeleted"]="0";r[0]["UUID"]=oSapSplUtils.getUUID();r[0]["Request"]=U;r[0]["Role"]=d["Role"];r[0]["isDeleted"]="0";p["Header"]=h;p["Roles"]=r;return p;},fireInvite:function(){var p;oSapSplBusyDialog.getBusyDialogInstance({title:oSapSplUtils.getBundle().getText("BUSY_DIALOG_MESSAGE")}).open();p=this.preparePayLoad(this.getDataInPostFormat(sap.ui.getCore().getModel("myBusinessPartnerRegisterEditModel").getData()));if(p.Header[0].Owner!==null){window.setTimeout(function(){oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/app/services/businessPartnerRegistration.xsjs"),method:"POST",async:false,data:JSON.stringify(p),success:function(d,s,m){oSapSplBusyDialog.getBusyDialogInstance().close();if(d.constructor===String){d=JSON.parse(d);}if(m["status"]===200&&d["Error"].length===0){var c=new sap.ui.core.CustomData({key:"bRefreshTile",value:true});oSplBaseApplication.getAppInstance().getCurrentPage().destroyCustomData();oSplBaseApplication.getAppInstance().getCurrentPage().addCustomData(c);sap.ca.ui.message.showMessageToast(oSapSplUtils.getBundle().getText("INVITATION_SENT_SUCCESSFULLY_MSG"));}else{sap.ca.ui.message.showMessageBox({type:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["messageTitle"],message:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["ufErrorObject"]});}oSapSplUtils.getCurrentMasterPageBP().byId("myBusinessPartnerList").addCustomData(new sap.ui.core.CustomData({key:d.Header[0]["UUID"]}));sap.ui.getCore().getModel("myBusinessPartnerListODataModel").refresh();oSapSplUtils.setIsDirty(false);},error:function(e){oSapSplBusyDialog.getBusyDialogInstance().close();if(e&&e["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+" "+e.statusText,details:e.responseText});}else{sap.ca.ui.message.showMessageBox({type:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["messageTitle"],message:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["ufErrorObject"]});}oSapSplUtils.setIsDirty(true);},complete:function(){}});},20);}else{oSapSplBusyDialog.getBusyDialogInstance().close();}},navigationToDetailPage:function(){var t=this,s,m;m=sap.ui.getCore().getModel("myBusinessPartnerRegisterEditModel").getData();m["isCancel"]=true;sap.ui.getCore().getModel("myBusinessPartnerRegisterEditModel").setData(m);s=jQuery.extend(true,{},sap.ui.getCore().getModel("myBusinessPartnerDetailModel").getData());if(oSapSplUtils.getIsDirty()){sap.m.MessageBox.show(oSapSplUtils.getBundle().getText("DATA_LOSS_WARNING_TEXT"),sap.m.MessageBox.Icon.WARNING,oSapSplUtils.getBundle().getText("WARNING"),[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.CANCEL],function(a){if(a==="YES"){jQuery.proxy(t.callToNavInDetailBP(s),t);t.selectMasterListItemOnBackNavigation("myBusinessPartnerDetailModel");oSapSplUtils.setIsDirty(false);}},null,oSapSplUtils.fnSyncStyleClass("messageBox"));}else{s=jQuery.extend(true,{},sap.ui.getCore().getModel("myBusinessPartnerDetailModel").getData());this.callToNavInDetailBP(s);this.selectMasterListItemOnBackNavigation("myBusinessPartnerDetailModel");}},callToNavInDetailBP:function(m){var b=sap.ui.getCore().getEventBus();b.publish("navInDetailBP","to",{from:this.getView(),data:{context:m}});},selectMasterListItemOnBackNavigation:function(m){var i,c,a;c=sap.ui.getCore().getModel(m).getData();a=oSapSplUtils.getCurrentMasterPageBP().byId("myBusinessPartnerList");for(i=0;i<a.getItems().length;i++){if(a.getItems()[i].sId.indexOf("myBusinessPartnerListItem")!==-1){if(a.getItems()[i].getBindingContext().getProperty().UUID===c.UUID){a.setSelectedItem(a.getItems()[i]);break;}}}},fnToCaptureLiveChangeToSetFlag:function(){if(!oSapSplUtils.getIsDirty()){oSapSplUtils.setIsDirty(true);}},fnHandlePressOfBackButton:function(){var b=sap.ui.getCore().getEventBus(),t=this;if(oSapSplUtils.getIsDirty()){sap.m.MessageBox.show(oSapSplUtils.getBundle().getText("DATA_LOSS_WARNING_TEXT"),sap.m.MessageBox.Icon.WARNING,oSapSplUtils.getBundle().getText("WARNING"),[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.CANCEL],function(s){if(s==="YES"){b.publish("navInDetailBP","back",{from:t.getView()});}},null,oSapSplUtils.fnSyncStyleClass("messageBox"));}else{b.publish("navInDetailBP","back",{from:t.getView()});}}});
