/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.controller("splController.registeration.FreelancerConnectDetail",{splitAppBaseInstance:null,onInit:function(){this.unifiedShell=null;splReusable.libs.SapSplStyleSheetLoader.loadStyle("./resources/styles/splFreelancer");var f=new sap.ui.model.json.JSONModel({});this.bDirtySearchState=null;sap.ui.getCore().setModel(f,"sapSplFreelancerConnectDetailModel");this.getView().setModel(sap.ui.getCore().getModel("sapSplFreelancerConnectDetailModel"));this.fnDefineControlLabelsFromLocalizationBundle();this.byId("SapSplFreelancerTable").addStyleClass("freelancerTable");},setSplitAppInstance:function(i){this.splitAppBaseInstance=i;},fnDefineControlLabelsFromLocalizationBundle:function(){this.byId("FreelancerConnectDetailPage").setTitle(oSapSplUtils.getBundle().getText("NEW_BUSINESS_PARTNER_TITLE"));this.byId("sapSplBusinessPartnerSearchField").setProperty("placeholder",oSapSplUtils.getBundle().getText("GLOBAL_SEARCH",["..."]));this.byId("sapSplBusinessPartnerConnect").setText(oSapSplUtils.getBundle().getText("MY_COLLEAGUES_CONNECT_BUTTON"));this.byId("sapSplBusinessPartnerConnect").setTooltip(oSapSplUtils.getBundle().getText("MY_COLLEAGUES_CONNECT_BUTTON"));this.byId("freelancerCancel").setText(oSapSplUtils.getBundle().getText("MY_COLLEAGUES_CANCEL_BUTTON"));this.byId("freelancerCancel").setTooltip(oSapSplUtils.getBundle().getText("MY_COLLEAGUES_CANCEL_BUTTON"));this.byId("SapSplFreelancerTableColumnHeader_CompanyName").setText(oSapSplUtils.getBundle().getText("COMPANY_NAME"));this.byId("SapSplFreelancerTableColumnHeader_Email").setText(oSapSplUtils.getBundle().getText("EMAIL"));this.byId("SapSplFreelancerInviteLink").setText(oSapSplUtils.getBundle().getText("INVITE_TEXT"));this.byId("sapSplNewBuPaLabel").setText(oSapSplUtils.getBundle().getText("ADD_NEW_BUSINESS_PARTNER_INFO"));this.byId("sapSplNewBuPaLink").setText(oSapSplUtils.getBundle().getText("INVITE_TEXT"));this.byId("sapSplBusinessPartnerSearchFieldTitle").setText(oSapSplUtils.getBundle().getText("NEW_BUSINESS_PARTNER_SEARCH_FIELD_TITLE"));this.byId("sapSplBusinessPartnerSearchField").setTooltip(oSapSplUtils.getBundle().getText("SEARCH"));},getUnifiedShellInstance:function(){return this.unifiedShell;},setUnifiedShellInstance:function(u){this.unifiedShell=u;},fireCancel:function(){var s,m,b;s=jQuery.extend(true,{},sap.ui.getCore().getModel("myBusinessPartnerDetailModel").getData());m=sap.ui.getCore().getModel("sapSplFreelancerConnectDetailModel").getData();m["isCancel"]=true;sap.ui.getCore().getModel("sapSplFreelancerConnectDetailModel").setData(m);b=sap.ui.getCore().getEventBus();b.publish("navInDetailBP","to",{from:this.getView(),data:{context:s}});},fnHandleClickOfSearch:function(){var t=this,m={},p={};this.bDirtySearchState=1;var s=this.byId("sapSplBusinessPartnerSearchField").getValue();this.byId("sapSplBusinessPartnerConnect").setEnabled(false);this.byId("SapSplFreelancerTable").removeSelections();if(s.length>2){oSapSplBusyDialog.getBusyDialogInstance({title:oSapSplUtils.getBundle().getText("BUSY_DIALOG_MESSAGE")}).open();m=sap.ui.getCore().getModel("sapSplFreelancerConnectDetailModel").getData();m["BusinessPartners"]=[];sap.ui.getCore().getModel("sapSplFreelancerConnectDetailModel").setData(m);p=this.prepareSearchPayload(s);window.setTimeout(function(){oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/app/services/ConnectSearch.xsjs"),method:"POST",async:false,dataType:"json",cache:false,data:JSON.stringify(p),success:function(d,a,b){oSapSplBusyDialog.getBusyDialogInstance().close();if(b["status"]===200){t.byId("SapSplFreelancerTable").setHeaderText(oSapSplUtils.getBundle().getText("BUSINESS_PARTNER_CONNECT_TABEL_LABEL",d.length.toString()));if(d.length>0){t.byId("SapSplFreelancerTable").setVisible(true);m=sap.ui.getCore().getModel("sapSplFreelancerConnectDetailModel").getData();m["BusinessPartners"]=d;m["showNewBuPaLink"]=false;m["showConnectButton"]=true;sap.ui.getCore().getModel("sapSplFreelancerConnectDetailModel").setData(m);t.byId("SapSplFreelancerTable").removeStyleClass("freelancerTable");}else{m=sap.ui.getCore().getModel("sapSplFreelancerConnectDetailModel").getData();m["BusinessPartners"]=[];m["showNewBuPaLink"]=true;m["showConnectButton"]=false;sap.ui.getCore().getModel("sapSplFreelancerConnectDetailModel").setData(m);t.byId("SapSplFreelancerTable").setVisible(true);t.byId("SapSplFreelancerTable").addStyleClass("freelancerTable");}}else{m=sap.ui.getCore().getModel("sapSplFreelancerConnectDetailModel").getData();m["BusinessPartners"]=[];m["showNewBuPaLink"]=true;m["showConnectButton"]=false;sap.ui.getCore().getModel("sapSplFreelancerConnectDetailModel").setData(m);t.byId("SapSplFreelancerTable").addStyleClass("freelancerTable");t.byId("SapSplFreelancerTable").setVisible(true);}},error:function(e){oSapSplBusyDialog.getBusyDialogInstance().close();if(e&&e["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+"\t"+e.statusText,details:e.responseText});}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["ufErrorObject"]});}m=sap.ui.getCore().getModel("sapSplFreelancerConnectDetailModel").getData();m["BusinessPartners"]=[];m["showNewBuPaLink"]=true;m["showConnectButton"]=false;sap.ui.getCore().getModel("sapSplFreelancerConnectDetailModel").setData(m);t.byId("SapSplFreelancerTable").addStyleClass("freelancerTable");t.byId("SapSplFreelancerTable").setVisible(true);},complete:function(){}});},30);}else{m=sap.ui.getCore().getModel("sapSplFreelancerConnectDetailModel").getData();m["BusinessPartners"]=[];m["showNewBuPaLink"]=false;m["showConnectButton"]=false;sap.ui.getCore().getModel("sapSplFreelancerConnectDetailModel").setData(m);t.byId("SapSplFreelancerTable").addStyleClass("freelancerTable");t.byId("SapSplFreelancerTable").setVisible(false);}},prepareSearchPayload:function(s){var p={};p["SearchTerm"]=s;p["Role"]=sap.ui.getCore().getModel("sapSplFreelancerConnectDetailModel").getData().Role;return p;},onBeforeShow:function(e){var m=e.data.context;m.isCancel=false;m["BusinessPartners"]=[];m["showNewBuPaLink"]=false;m["showConnectButton"]=false;sap.ui.getCore().getModel("sapSplFreelancerConnectDetailModel").setData(m);this.byId("sapSplBusinessPartnerSearchField").setValue("");this.byId("SapSplFreelancerTable").setVisible(false);this.byId("SapSplFreelancerConnectRequestLabel").setText(oSapSplUtils.getBundle().getText("NO_RECORDS_AVAILABLE_MSG",m["Role.Description"]));this.bDirtySearchState=null;},fnHandleSelectOfBusinessPartner:function(e){if(e.getSource().getSelectedItems()&&e.getSource().getSelectedItems().length>0){this.byId("sapSplBusinessPartnerConnect").setEnabled(true);}else{this.byId("sapSplBusinessPartnerConnect").setEnabled(false);}},fnHandleClickOfConnect:function(){var p={},t=this,s=this.byId("SapSplFreelancerTable").getSelectedItems(),i,a=[];oSapSplBusyDialog.getBusyDialogInstance({title:oSapSplUtils.getBundle().getText("BUSY_DIALOG_MESSAGE")}).open();window.setTimeout(function(){t.getRelation();for(i=0;i<s.length;i++){a.push(t.preparePayload(s[i].getBindingContext().getProperty()));}p["Relation"]=a;oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("sap/spl/xs/app/services/businessPartner.xsjs"),method:"POST",async:false,data:JSON.stringify(p),success:function(d,b,m){var c=new sap.ui.core.CustomData({key:"bRefreshTile",value:true});oSplBaseApplication.getAppInstance().getCurrentPage().destroyCustomData();oSplBaseApplication.getAppInstance().getCurrentPage().addCustomData(c);oSapSplBusyDialog.getBusyDialogInstance().close();if(d.constructor===String){d=JSON.parse(d);}if(m["status"]===200&&d["Error"].length===0){sap.ca.ui.message.showMessageToast(oSapSplUtils.getBundle().getText("CONNECTION_REQUEST_SENT_SUCCESSFULLY_MSG"));sap.ui.getCore().getModel("myBusinessPartnerListODataModel").refresh();}else if(d["Error"].length>0){var e=oSapSplUtils.getErrorMessagesfromErrorPayload(d)["ufErrorObject"];sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["errorWarningString"],details:e});}},error:function(e){oSapSplBusyDialog.getBusyDialogInstance().close();if(e&&e["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+" "+e.statusText,details:e.responseText});}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["ufErrorObject"]});}},complete:function(){}});},10);},preparePayload:function(t){var p={};p["UUID"]=oSapSplUtils.getUUID();p["FromPartner"]=oSapSplUtils.getCompanyDetails().UUID;p["ToPartner"]=t["UUID"];p["Relation"]=this.Relation[0].Name;p["Text"]="";p["Status"]="0";p["ObjectType"]="BuPa-O";p["InstanceUUID"]=null;return p;},fnHandleClickOfInvite:function(){var b=sap.ui.getCore().getEventBus(),n;var v=$.extend(true,{},this.getView());if(!this.splitAppBaseInstance.getDetailPage("NewBusinessPartnerRegistrationDetail")){n=sap.ui.view({id:"NewBusinessPartnerRegistrationDetail",viewName:"splView.registeration.NewBusinessPartnerRegistrationDetail",type:sap.ui.core.mvc.ViewType.XML});n.addEventDelegate({onBeforeShow:jQuery.proxy(n.getController().onBeforeShow,n.getController())});n.getController().setUnifiedShellInstance(this.getUnifiedShellInstance());this.splitAppBaseInstance.addDetailPage(n);}v.sId="FreelancerActionSheetInvite";b.publish("navInDetailBP","to",{from:v,data:{context:this.getEmptyBusinessPartnerRegistrationData(sap.ui.getCore().getModel("sapSplFreelancerConnectDetailModel").getData()["Role"],sap.ui.getCore().getModel("sapSplFreelancerConnectDetailModel").getData()["Role.Description"],this.byId("sapSplBusinessPartnerSearchField").getValue(),this.bDirtySearchState)}});},successOfRolesOdata:function(r){this.Relation=r.results;},errorOfRolesOdata:function(){},getRelation:function(){var m=sap.ui.getCore().getModel("myConfigODataModel");var d=null,D="$filter=FromRole eq '"+oSapSplUtils.getCompanyDetails().Role+"' and ToRole eq '"+sap.ui.getCore().getModel("sapSplFreelancerConnectDetailModel").getData()["Role"]+"' and Scope eq 'PARTNER'",i=false;var u="/BusinessPartnerRoleRelation";if(m){m.read(u,d,D,i,jQuery.proxy(this.successOfRolesOdata,this),jQuery.proxy(this.errorOfRolesOdata,this));}},getEmptyBusinessPartnerRegistrationData:function(r,R,e,d){var E={};E["POC"]={};E["UUID"]="";E["OrgUUID"]="";E["BasicInfo.ID"]="";E["BasicInfo.CompanyID"]="";E["BasicInfo.Type"]="";E["Organization.Name"]="";E["Organization.RegistrationNumber"]="";E["Organization.Registry"]="";E["PersonName.Title"]="";E["PersonName.Surname"]="";E["PersonName.GivenName"]="";E["PersonName.JobFunction"]="";E["PersonName.SurnamePrefix"]="";E["PostalAddress_Country"]="";E["PostalAddress_District"]="";E["PostalAddress_PostalCode"]="";E["PostalAddress_Street"]="";E["PostalAddress_StreetName"]="";E["PostalAddress_Town"]="";E["CommunicationInfo.EmailAddress"]="";E["CommunicationInfo.Fax"]="";E["CommunicationInfo_Phone"]="";E["CommunicationInfo.Website"]="";E["Validity.StartTime"]="";E["Validity.EndTime"]="";E["Owner"]="";E["InvitedByOrganization"]="";E["OrganizationRoles.Role1"]="";E["OrganizationRoles.Role2"]="";E["OrganizationRoles.Role3"]="";E["OrganizationRoles.Role4"]="";E["MainUserRoles.Role1"]="";E["MainUserRoles.Role2"]="";E["MainUserRoles.Role3"]="";E["MainUserRoles.Role4"]="";E["RequestType"]="";E["POC"]["PersonName_Surname"]="";E["POC"]["PersonName_GivenName"]="";E["POC"]["CommunicationInfo_Phone"]="";E["POC"]["PersonName_JobFunction"]="";if(r){E["Role"]=r;}else{E["Role"]="";}if(e&&d){E["POC"]["CommunicationInfo_EmailAddress"]=e;}else{E["POC"]["CommunicationInfo_EmailAddress"]="";}if(R){E["Role_description"]=R;}else{E["Role_description"]="";}return E;}});
