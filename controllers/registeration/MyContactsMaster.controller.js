/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.controller("splController.registeration.MyContactsMaster",{onInit:function(){this.unifiedShell=null;var s=sap.ui.getCore().getModel("myContactListODataModel"),S=null,o=null,a=null,b=null;s.setCountSupported(false);s.attachRequestCompleted(jQuery.proxy(this.ODataModelRequestCompleted,this));s.attachRequestFailed(function(){oSapSplBusyDialog.getBusyDialogInstance().close();});S=new sap.ui.model.Sorter("Role.description",false,function(c){var k=c.getProperty("Role.description").toLowerCase();return{key:k,text:k};});o=new sap.ui.model.Filter("BasicInfo_Type",sap.ui.model.FilterOperator.EQ,"P");a=new sap.ui.model.Filter("isMyself",sap.ui.model.FilterOperator.NE,1);this.getView().byId("SapSplMyContactsList").setModel(sap.ui.getCore().getModel("myContactListODataModel"));b=this.getView().byId("SapSplMyContactsList").getBinding("items");b.sort(S);b.filter([o,a]);this.fnDefineControlLabelsFromLocalizationBundle();this.getRolesForRelation();},ODataModelRequestCompleted:function(){this.afterRenderingOfMyContactList();},fnHandleBackNavigation:function(){var b=null;b=oSplBaseApplication.getAppInstance();if(b.getPreviousPage()){b.back();}else{b.to("splView.tileContainer.MasterTileContainer");}},onAfterRendering:function(){oSapSplQuerySelectors.getInstance().setBackButtonTooltip();},afterRenderingOfMyContactList:function(){oSapSplBusyDialog.getBusyDialogInstance().close();var s=null,S=0,a=[],o=null;var m=sap.ui.getCore().getModel("myContactDetailModel").getData();if(m){m["noData"]=true;m["isClicked"]=false;m["showFooterButtons"]=false;sap.ui.getCore().getModel("myContactDetailModel").setData(m);}var l=(this.byId("SapSplMyContactsList").getCustomData().length>0)?this.byId("SapSplMyContactsList").getCustomData()[this.byId("SapSplMyContactsList").getCustomData().length-1].getKey():null,_=1;try{o=this.getView().byId("SapSplMyContactsList");if(o){a=o.getItems();if(a.length){S=a.length;this.byId("MyContactsMasterPage").setTitle(oSapSplUtils.getBundle().getText("MY_COLLEAGUES_MASTER_TITLE",[oSapSplUtils.getCompanyDetails()["Organization_Name"],splReusable.libs.Utils.prototype.getListCount(this.getView().byId("SapSplMyContactsList"))]));if(oSapSplUtils.getCurrentDetailPage().byId("MyContactsDetailPage")){oSapSplUtils.getCurrentDetailPage().byId("MyContactsDetailPage").setTitle(oSapSplUtils.getBundle().getText("MY_COLLEAGUES_DETAIL_TITLE",oSapSplUtils.getCompanyDetails()["Organization_Name"]));}for(var c=0;c<a.length;c++){if(a[c].constructor!==sap.m.GroupHeaderListItem){if(l===a[c].getBindingContext().getProperty("UUID")){_=c;break;}}}}if(S&&S>0){if(a[0].constructor===sap.m.StandardListItem){s=a[0].getBindingContext().getProperty();}else{s=a[1].getBindingContext().getProperty();}this.selectFirstItem(_);m=sap.ui.getCore().getModel("myContactDetailModel").getData();m["noData"]=false;m["isClicked"]=true;m["showFooterButtons"]=true;sap.ui.getCore().getModel("myContactDetailModel").setData(m);}}else{throw new Error();}}catch(e){if(e.constructor===Error()){jQuery.sap.log.error(e.message,"Number of items in the list is 0, cannot select the first item.",this.getView().getControllerName());}}finally{sap.ui.getCore().byId("MyContactsMaster--sapSplSearchMyUsersMasterList").focus();}},openActionSheet:function(e){sap.ui.getCore().byId("MyContactsMaster--sapSplSearchMyUsersMasterList").$().find("input").val("").trigger("search");this.oActionSheet.openBy(e.getSource());},createActionSheet:function(){if(!this.oActionSheet){this.oActionSheet=new sap.m.ActionSheet({id:"MyContactsActionSheet",showCancelButton:true,placement:sap.m.PlacementType.Top});var r=new sap.m.Button({text:{parts:[{path:"GrantableRole"},{path:"GrantableRole.description"}],formatter:function(R,d){if(R==="DRIVER"){return oSapSplUtils.getBundle().getText("ADD_GRANTABLE_ROLE",[d]);}else if(R==="FREIGHTFWD_ADMN"){return oSapSplUtils.getBundle().getText("INVITE_GRANTABLE_ROLE",[d]);}else if(R==="FREIGHTFWD_DISP"){return oSapSplUtils.getBundle().getText("INVITE_GRANTABLE_ROLE",[d]);}else{return d;}}},press:jQuery.proxy(this.fireSelectionOfRoleForCreate,this)});this.oActionSheet.bindAggregation("buttons","/results",r);this.oActionSheet.setModel(new sap.ui.model.json.JSONModel(this.aRolesForTargetRelation));}},fireSelectionOfRoleForCreate:function(e){var t=this;var a=jQuery.extend(true,{},e);if(oSapSplUtils.getCurrentDetailPage().sId==="NewContactRegistrationDetail"){if(oSapSplUtils.getIsDirty()){sap.m.MessageBox.show(oSapSplUtils.getBundle().getText("DATA_LOSS_WARNING_TEXT"),sap.m.MessageBox.Icon.WARNING,oSapSplUtils.getBundle().getText("WARNING"),[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.CANCEL],function(s){if(s==="YES"){t.navigateToNewUserInvite(a);oSapSplUtils.setIsDirty(false);}});}else{this.navigateToNewUserInvite(e);}}else{this.navigateToNewUserInvite(e);}},navigateToNewUserInvite:function(e){oSapSplUtils.getCurrentMasterPage().byId("SapSplMyContactsList").removeSelections();if(oSapSplUtils.getCurrentDetailPage().sId==="NewContactRegistrationDetail"){sap.ui.getCore().getModel("myContactsRegisterEditModel").setData(this.getEmptyRegistrationData(e.getSource().getBindingContext().getObject()["GrantableRole.description"],"create"));oSapSplUtils.getCurrentDetailPage().getController().isEditMyUser=0;if(sap.ui.getCore().getModel("myContactsRegisterEditModel").getData()["Mode"]==="Create"||e.getSource().getBindingContext().getObject()["GrantableRole.description"]==="Driver"){oSapSplUtils.getCurrentDetailPage().getController().byId("splNewContactRegistrationRoles").setEnabled(false);}else{oSapSplUtils.getCurrentDetailPage().getController().byId("splNewContactRegistrationRoles").setEnabled(true);}}else{var b=sap.ui.getCore().getEventBus();b.publish("navInDetail","to",{from:this.oActionSheet,data:{context:this.getEmptyRegistrationData(e.getSource().getBindingContext().getObject()["GrantableRole.description"],"create")}});}if(oSapSplUtils.getCurrentDetailPage().byId("sapSplMyUserEditEmailInput").getEnabled()===false){oSapSplUtils.getCurrentDetailPage().byId("sapSplMyUserEditEmailInput").setEnabled(true);}oSapSplUtils.getCurrentDetailPage().byId("NewContactRegistrationDetailPage").setTitle(oSapSplUtils.getBundle().getText("NEW_CONTACT_TITLE",oSapSplUtils.getCompanyDetails()["Organization_Name"]));},fnDefineControlLabelsFromLocalizationBundle:function(){this.byId("MyContactsMasterPage").setTitle(oSapSplUtils.getBundle().getText("MY_COLLEAGUES_MASTER_TITLE",[oSapSplUtils.getCompanyDetails()["Organization_Name"],"0"]));this.byId("SapSplMyContactsList").setNoDataText(oSapSplUtils.getBundle().getText("NO_USERS_TEXT"));this.byId("sapSplAddBusinessPartnerUserButton").setTooltip(oSapSplUtils.getBundle().getText("NEW_CONTACT_ADD"));this.byId("sapSplSearchMyUsersMasterList").setTooltip(oSapSplUtils.getBundle().getText("SEARCH"));},getRolesForRelation:function(){var m=sap.ui.getCore().getModel("myColleaguesODataModel");var d=null,D=[],i=true;var u="/GrantableRolesForPerson";if(m){m.read(u,d,D,i,jQuery.proxy(this.successOfRolesOdata,this),jQuery.proxy(this.errorOfRolesOdata,this));}},successOfRolesOdata:function(r){if(r.results.length>0){this.aRolesForTargetRelation=r;this.createActionSheet();this.updateNewRegistrationModel();}else{this.byId("sapSplAddBusinessPartnerUserButton").setVisible(false);}},errorOfRolesOdata:function(e){var a=JSON.parse(e.response.body).error.message.value;sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getBundle().getText("READ_ENTITY_ERROR_MESSAGE",["Roles(My Users)"]),details:a});},updateNewRegistrationModel:function(){try{if(sap.ui.getCore().getModel("splNewContactRegistrationRoles")){sap.ui.getCore().getModel("splNewContactRegistrationRoles").setData(this.aRolesForTargetRelation);}else{sap.ui.getCore().setModel(new sap.ui.model.json.JSONModel(this.aRolesForTargetRelation),"splNewContactRegistrationRoles");}}catch(e){if(e.constructor===Error()){jQuery.sap.log.error(e.message,"No model is set for NewContactRegistration view , cannot set data",this.getView().getControllerName());}}},onSelectOfContact:function(e){this.handleMyContactSelect(e.getParameter("listItem").getBindingContext().getProperty());},handleMyContactSelect:function(s){var t=this,m,c,i;if(oSapSplUtils.getCurrentDetailPage().sId==="NewContactRegistrationDetail"){if(oSapSplUtils.getIsDirty()){sap.m.MessageBox.show(oSapSplUtils.getBundle().getText("DATA_LOSS_WARNING_TEXT"),sap.m.MessageBox.Icon.WARNING,oSapSplUtils.getBundle().getText("WARNING"),[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.CANCEL],function(a){if(a==="YES"){t.updateMyContactsDetailPage(s);oSapSplUtils.setIsDirty(false);}else{c=sap.ui.getCore().getModel("myContactsRegisterEditModel").getData();m=oSapSplUtils.getCurrentMasterPage().byId("SapSplMyContactsList");if(c.UUID){for(i=0;i<m.getItems().length;i++){if(m.getItems()[i].sId.indexOf("SapSplMyContactsListItem")!==-1){if(m.getItems()[i].getBindingContext().getProperty().UUID===c.UUID){m.setSelectedItem(m.getItems()[i]);break;}}}}else{m.removeSelections();}}});}else{t.updateMyContactsDetailPage(s);}}else{this.updateMyContactsDetailPage(s);}},updateMyContactsDetailPage:function(s){try{if(s.RequestStatus!==undefined&&s.RequestStatus==="0"){s.isEnableEdit=false;}else{s.isEnableEdit=true;}if(s.isEditable!==undefined&&(s.isEditable===0||s.isEditable===false)){s.isEditable=false;}else{s.isEditable=true;}s["noData"]=false;s["isClicked"]=true;s["showFooterButtons"]=true;if(s["Role"]==="DRIVER"){s["showEmail"]=false;}else{s["showEmail"]=true;}if(oSapSplUtils.getCurrentDetailPage()){if(oSapSplUtils.getCurrentDetailPage().sId==="MyContactDetails"){sap.ui.getCore().getModel("myContactDetailModel").setData(s);}else{var b=sap.ui.getCore().getEventBus();b.publish("navInDetail","to",{from:this.getView(),data:{context:s}});}}else{throw new Error();}}catch(e){if(e.constructor===Error()){jQuery.sap.log.error(e.message,"There is no current Detail Page in MyContacts SplitApp.",this.getView().getControllerName());}}},onBeforeShow:function(){var n="",g="",m=null;n=jQuery.sap.getUriParameters().get("navToHome");g=jQuery.sap.getUriParameters().get("goto");m=this.byId("MyContactsMasterPage");if(g){if(n&&n==="false"){m.setShowNavButton(false);}else if(n&&n==="true"){m.setShowNavButton(true);}else{m.setShowNavButton(false);}}else{m.setShowNavButton(true);}},getUnifiedShellInstance:function(){return this.unifiedShell;},setUnifiedShellInstance:function(u){this.unifiedShell=u;},selectFirstItem:function(c){var s=null,a;try{var b=this.getView().byId("SapSplMyContactsList");if(b.getItems()[c].constructor===sap.m.StandardListItem){this.getView().byId("SapSplMyContactsList").setSelectedItem(b.getItems()[c]);s=b.getItems()[c].getBindingContext().getProperty();if(c===0||c===1){document.getElementById(this.getView().byId("sapSplSearchMyUsersMasterList").getId()).scrollIntoView(true);}else{a=b.getItems()[c].getId();window.setTimeout(function(){document.getElementById(a).scrollIntoView(true);},0);}}else{b.getItems()[c+1].setSelected(true);s=b.getItems()[c+1].getBindingContext().getProperty();}this.updateMyContactsDetailPage(s);}catch(e){if(e.constructor===Error()){jQuery.sap.log.error(e.message,"Cannot select first item of MyContactsList",this.getView().getControllerName());}}},getEmptyRegistrationData:function(r,m){var e={};e["PersonName_Title"]="";e["PersonName_GivenName"]="";e["PersonName_JobFunction"]="";e["PersonName_Surname"]="";e["PersonName_SurnamePrefix"]="";e["PostalAddress_Country"]="";e["PostalAddress_District"]="";e["PostalAddress_PostalCode"]="";e["PostalAddress_Street"]="";e["PostalAddress_StreetName"]="";e["PostalAddress_Town"]="";e["CommunicationInfo_Fax"]="";e["CommunicationInfo_Phone"]="";e["CommunicationInfo_Website"]="";e["Validity_StartTime"]=null;e["Validity_EndTime"]=null;e["OrganizationRoles_Role1"]="";e["OrganizationRoles_Role2"]="";e["OrganizationRoles_Role3"]="";e["OrganizationRoles_Role4"]="";e["MainUserRoles_Role2"]="";e["MainUserRoles_Role3"]="";e["MainUserRoles_Role4"]="";e["UUID"]="";e["BasicInfo_ID"]="";e["BasicInfo_Type"]="P";e["PersonName_GivenName"]="";e["PersonName_Surname"]="";if(r){e["MainUserRoles_Role1"]=r;}else{e["MainUserRoles_Role1"]="";}e["CommunicationInfo_EmailAddress"]="";e["AuditTrail_CreationTime"]="";e["CommunicationInfo_Phone"]="";e["PostalAddress_Country"]="";e["RequestType"]="1";e["OrgUUID"]=null;if(m&&m==="create"){e["isClicked"]=true;e["noData"]=false;e["showFooterButtons"]=true;e["Mode"]="Create";}else{e["isClicked"]=false;e["noData"]=true;e["showFooterButtons"]=false;}if(r==="Driver"){e["ActionName"]=oSapSplUtils.getBundle().getText("NEW_CONTACT_ADD");e["EmailVisible"]=false;}else{e["ActionName"]=oSapSplUtils.getBundle().getText("NEW_CONTACT_INVITE");e["EmailVisible"]=true;}return e;},fnToHandleSearchOfMyUsers:function(e){var s=e.getParameters().query;var S,o,a,b;var p,t=this,m;b=this.getView().byId("SapSplMyContactsList");if(s.length>2){p=this.prepareSearchPayload(s);this.callSearchService(p);}else if(b.getBinding("items")===undefined||b.getBinding("items").aFilters.length>2||e.getParameters().refreshButtonPressed===true){if(oSapSplUtils.getCurrentDetailPage().getId()==="MyContactDetails"){oSapSplUtils.getCurrentDetailPage().byId("MyContactDetailsEditButton").setEnabled(false);sap.ui.getCore().getModel("myContactDetailModel").setData(this.getEmptyRegistrationData());}S=new sap.ui.model.Filter("BasicInfo_Type",sap.ui.model.FilterOperator.EQ,"P");o=new sap.ui.model.Filter("isMyself",sap.ui.model.FilterOperator.NE,1);a=new sap.ui.model.Sorter("Role.description",false,function(c){var k=c.getProperty("Role.description").toLowerCase();return{key:k,text:k};});b.unbindAggregation("items");b.bindItems({path:"/MyUsers",template:t.getView().byId("SapSplMyContactsListItem")});b.getBinding("items").filter([S,o]);b.getBinding("items").sort(a);m=sap.ui.getCore().getModel("myContactDetailModel").getData();m["noData"]=true;m["isClicked"]=false;m["showFooterButtons"]=false;sap.ui.getCore().getModel("myContactDetailModel").setData(m);}},prepareSearchPayload:function(s){var p={};p.UserID=oSapSplUtils.getLoggedOnUserDetails().usreID;p.ObjectType="BusinessPartner";p.SearchTerm=s;p.FuzzinessThershold=SapSplEnums.fuzzyThreshold;p.MaximumNumberOfRecords=50;p.ProvideDetails=false;p.SearchInNetwork=true;p.AdditionalCriteria={};p.AdditionalCriteria.BusinessPartnerType="P";p.AdditionalCriteria.SearchPending=true;return p;},callSearchService:function(p){var s,S=[],o,a;var t=this,m;oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/app/services/Search.xsjs"),method:"POST",async:false,dataType:"json",data:JSON.stringify(p),success:function(d,b,c){oSapSplBusyDialog.getBusyDialogInstance().close();if(c["status"]===200){a=t.getView().byId("SapSplMyContactsList");sap.ui.getCore().getModel("myContactDetailModel").setData(t.getEmptyRegistrationData());S.push(new sap.ui.model.Filter("BasicInfo_Type",sap.ui.model.FilterOperator.EQ,"P"));S.push(new sap.ui.model.Filter("isMyself",sap.ui.model.FilterOperator.NE,1));o=new sap.ui.model.Sorter("Role.description",false,function(C){var k=C.getProperty("Role.description").toLowerCase();return{key:k,text:k};});a.unbindAggregation("items");if(d.length>0){s=oSapSplUtils.getSearchItemFilters(d);if(s.aFilters.length>0){S.push(s);}a.bindItems({path:"/MyUsers",template:t.getView().byId("SapSplMyContactsListItem")});a.getBinding("items").sort(o);a.getBinding("items").filter(S);m=sap.ui.getCore().getModel("myContactDetailModel").getData();m["noData"]=false;m["isClicked"]=true;m["showFooterButtons"]=true;sap.ui.getCore().getModel("myContactDetailModel").setData(m);}else{m=sap.ui.getCore().getModel("myContactDetailModel").getData();m["noData"]=true;m["isClicked"]=false;m["showFooterButtons"]=false;m["isEditable"]=0;sap.ui.getCore().getModel("myContactDetailModel").setData(m);t.byId("MyContactsMasterPage").setTitle(oSapSplUtils.getBundle().getText("MY_COLLEAGUES_MASTER_TITLE",[oSapSplUtils.getCompanyDetails()["Organization_Name"],"0"]));}}else if(d["Error"]&&d["Error"].length>0){var e=oSapSplUtils.getErrorMessagesfromErrorPayload(d)["ufErrorObject"];sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["errorWarningString"],details:e});}},error:function(e){oSapSplBusyDialog.getBusyDialogInstance().close();m=sap.ui.getCore().getModel("myContactDetailModel").getData();m["noData"]=true;m["isClicked"]=false;m["showFooterButtons"]=false;sap.ui.getCore().getModel("myContactDetailModel").setData(m);if(e&&e["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+"\t"+e.statusText,details:e.responseText});}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["ufErrorObject"]});}},complete:function(){}});}});
