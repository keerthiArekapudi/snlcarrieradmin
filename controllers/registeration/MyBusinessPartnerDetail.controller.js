/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
splReusable.libs.SapSplStyleSheetLoader.loadStyle("./resources/styles/splBusinessPartner");sap.ui.controller("splController.registeration.MyBusinessPartnerDetail",{splitAppInstance:null,fnDefineControlLabelsFromLocalizationBundle:function(){this.byId("MyBusinessPartnerDetailPage").setTitle(oSapSplUtils.getBundle().getText("MY_BUSINESS_PARTNER_DETAIL_TITLE"));this.byId("sapSplBusinessPartnerDetailStreet").setText(oSapSplUtils.getBundle().getText("STREET"));this.byId("sapSplBusinessPartnerDetailTown").setText(oSapSplUtils.getBundle().getText("TOWN"));this.byId("sapSplBusinessPartnerDetailDistrict").setText(oSapSplUtils.getBundle().getText("DISTRICT"));this.byId("sapSplBusinessPartnerDetailCountry").setText(oSapSplUtils.getBundle().getText("COUNTRY"));this.byId("sapSplBusinessPartnerDetailOrgPhone").setText(oSapSplUtils.getBundle().getText("PHONE"));this.byId("sapSplBusinessPartnerDetailMainContact").setText(oSapSplUtils.getBundle().getText("MAIN_CONTACT"));this.byId("sapSplBusinessPartnerDetailExternalId").setText(oSapSplUtils.getBundle().getText("EXTERNAL_ID"));this.byId("sapSplBusinessPartnerDetailEmail").setText(oSapSplUtils.getBundle().getText("EMAIL"));this.byId("SapSplVehiclesDetailRegistrationNumber").setText(oSapSplUtils.getBundle().getText("LICENCE_PLATE"));this.byId("sapSplBupaDetailNoDataLabel").setText(oSapSplUtils.getBundle().getText("NO_BUPAS_TEXT"));this.byId("MyBuPaDeleteButton").setText(oSapSplUtils.getBundle().getText("TERMINATE_CONNECTION"));this.byId("MyBuPaDetailsEditButton").setText(oSapSplUtils.getBundle().getText("EDIT_BUPA"));this.byId("MyBupaEditCancel").setText(oSapSplUtils.getBundle().getText("CANCEL_EDITBUPA"));this.byId("sapSplBusinessPartnerVehicleSharePermissionsTable").setNoDataText(oSapSplUtils.getBundle().getText("NO_RECORDS_AVAILABLE_MSG",oSapSplUtils.getBundle().getText("DETAILS_MSG")));},setSplitAppInstance:function(i){this.splitAppInstance=i;},fnhandleIconTabBarSelect:function(e){var k=e.getParameter("key");var d=sap.ui.getCore().getModel("myBusinessPartnerDetailModel").getData();if(k==="info"){this.byId("MyBuPaDetailsEditButton").setVisible(splReusable.libs.SapSplModelFormatters.fnCanEditBupaDetails(d.canTerminate,d.showFooterOptions));}else{this.byId("MyBuPaDetailsEditButton").setVisible(false);}},onInit:function(){this.unifiedShell=null;var m=new sap.ui.model.json.JSONModel({noData:true,isClicked:false,showFooterOptions:false});sap.ui.getCore().setModel(m,"myBusinessPartnerDetailModel");this.getView().setModel(sap.ui.getCore().getModel("myBusinessPartnerDetailModel"));this.fnDefineControlLabelsFromLocalizationBundle();},onBeforeShow:function(e){var i,m=oSapSplUtils.getCurrentMasterPageBP().byId("myBusinessPartnerList"),d,a;if(oSapSplUtils.getCurrentDetailPageBP().sId!=="MyBusinessPartnerDetail"){if(oSapSplUtils.getCurrentDetailPageBP().sId==="NewBusinessPartnerRegistrationDetail"){if(sap.ui.getCore().getModel("myBusinessPartnerRegisterEditModel").getData()["isCancel"]){sap.ui.getCore().getModel("myBusinessPartnerDetailModel").setData(sap.ui.getCore().getModel("myBusinessPartnerDetailModel").getData());}else{sap.ui.getCore().getModel("myBusinessPartnerDetailModel").setData(e.data.context);}}else{if(oSapSplUtils.getCurrentDetailPageBP().sId==="FreelancerConnectDetail"){a="sapSplFreelancerConnectDetailModel";}else{a="SapSplBusinessPartnerConnectDetailModel";}if(sap.ui.getCore().getModel(a).getData().isCancel){d=sap.ui.getCore().getModel("myBusinessPartnerDetailModel").getData();}else{d=e.data.context;}sap.ui.getCore().getModel("myBusinessPartnerDetailModel").setData(d);for(i=0;i<m.getItems().length;i++){if(m.getItems()[i].sId.indexOf("myBusinessPartnerListItem")!==-1){if(m.getItems()[i].getBindingContext().getProperty().UUID===d.UUID){m.setSelectedItem(m.getItems()[i]);break;}}}}}},fnTerminateRelationServiceCall:function(){var s=jQuery.extend(true,{},sap.ui.getCore().getModel("myBusinessPartnerDetailModel").getData());var f={"inputHasChangeMode":true,"Relation":[{"UUID":s["RelationUUID"],"ChangeMode":"D"}]};var e=oSapSplUtils.getServiceMetadata("bupa",true);oSapSplBusyDialog.getBusyDialogInstance().open();oSapSplAjaxFactory.fireAjaxCall({method:"PUT",url:e,data:JSON.stringify(f),success:function(r,t,x){if(r.constructor===String){r=JSON.parse(r);}if(x.status===200){if(r["Error"].length>0){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(r)["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(r)["ufErrorObject"]});oSapSplBusyDialog.getBusyDialogInstance().close();}else{oSapSplBusyDialog.getBusyDialogInstance().close();sap.ca.ui.message.showMessageToast(oSapSplUtils.getBundle().getText("CONNECTION_TERMINATED"));sap.ui.getCore().getModel("myBusinessPartnerListODataModel").refresh();}}},error:function(x,t,a){if(x){sap.ca.ui.message.showMessageBox({type:oSapSplUtils.getErrorMessagesfromErrorPayload(x.responseJSON)["messageTitle"],message:oSapSplUtils.getErrorMessagesfromErrorPayload(x.responseJSON)["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(x.responseJSON)["ufErrorObject"]});}oSapSplBusyDialog.getBusyDialogInstance().close();jQuery.sap.log.error(a,t,"MyBusinessPartnerDetail.controller.js");},complete:function(){oSapSplBusyDialog.getBusyDialogInstance().close();}});},fnGetSelectedBuPaDetails:function(b){var m=sap.ui.getCore().getModel("myBusinessPartnerListODataModel");var f="$filter=isShared eq 1";var r;function s(d){r=d.results;}function e(){}if(m){m.read("/MyBusinessPartners(X"+"\'"+oSapSplUtils.base64ToHex(b["UUID"])+"\')/SharedVehicleList",null,[f],false,jQuery.proxy(s,this),jQuery.proxy(e,this));}return r;},fnGetDialogContent:function(b){var d=new sap.ui.layout.VerticalLayout();var B=this.fnGetSelectedBuPaDetails(b);var m=new sap.ui.model.json.JSONModel(B);if(b["isVehicleSharable"]===1){if(B.length===0){d.addContent(new sap.m.Label({text:oSapSplUtils.getBundle().getText("PERMANENTLY_DISCONNECT",b["Organization_Name"])}));return d;}else{d.hasTrucks=true;var f=new sap.m.Label({text:oSapSplUtils.getBundle().getText("PERMANENTLY_DISCONNECTING_AFFECTS_THE_FOLLOWING_ASSOCIATIONS",b["Organization_Name"]),design:"Bold"}).addStyleClass("relationTerminatorTruckDialogLabel");var t=new sap.m.Label({text:oSapSplUtils.getBundle().getText("CONTINUE"),design:"Bold"}).addStyleClass("relationTerminatorTruckDialogLabel");var T=new sap.m.Table({items:{path:"/",template:new sap.m.ColumnListItem({cells:[new sap.m.Label({text:{path:"RegistrationNumber"},tooltip:{path:"RegistrationNumber"}}),new sap.m.Label({text:{parts:[{path:"TourName"},{path:"ShareDirection"},{path:"TourActive"}],formatter:function(s,S,a){if(S==="O"){return"-";}else{if(a===null){return"-";}else if(a===0){return s;}else{return s;}}}},tooltip:{parts:[{path:"TourName"},{path:"ShareDirection"},{path:"TourActive"}],formatter:function(s,S,a){if(S==="O"){return"-";}else{if(a===null){return"-";}else if(a===0){return s;}else{return s;}}}}}),new sap.m.Label({text:{parts:[{path:"TourActive"},{path:"ShareDirection"}],formatter:function(s,S){if(S==="O"){return"-";}else{if(s===null){return oSapSplUtils.getBundle().getText("NOT_IN_USE");}else if(s===0){return oSapSplUtils.getBundle().getText("FUTURE_TOUR");}else{this.addStyleClass("greenActiveLabel");return oSapSplUtils.getBundle().getText("FILTER_LABEL_ACTIVE");}}}},tooltip:{parts:[{path:"TourActive"},{path:"ShareDirection"}],formatter:function(s,S){if(S==="O"){return"-";}else{if(s===null){return oSapSplUtils.getBundle().getText("NOT_IN_USE");}else if(s===0){return oSapSplUtils.getBundle().getText("FUTURE_TOUR");}else{this.addStyleClass("greenActiveLabel");return oSapSplUtils.getBundle().getText("FILTER_LABEL_ACTIVE");}}}}}),new sap.m.Label({text:{parts:[{path:"TourDate"},{path:"ShareDirection"},{path:"TourActive"}],formatter:function(s,S,a){if(S==="O"){return"-";}else{if(a===null){return"-";}else if(a===0){return s;}else{return s;}}}},tooltip:{parts:[{path:"TourDate"},{path:"ShareDirection"},{path:"TourActive"}],formatter:function(s,S,a){if(S==="O"){return"-";}else{if(a===null){return"-";}else if(a===0){return s;}else{return s;}}}}}),new sap.m.Label({text:{parts:[{path:"TourActive"},{path:"ShareDirection"},{path:"TourActive"}],formatter:function(s,S,a){if(S==="O"){return oSapSplUtils.getBundle().getText("TRUCK_WILL_BE_UNSHARED");}else{if(a===null){return oSapSplUtils.getBundle().getText("TRUCK_WILL_BE_UNSHARED");}else if(a===0){return oSapSplUtils.getBundle().getText("TRUCK_WILL_BE_UNSHARED_ON_TOUR_COMPLETION");}else{return oSapSplUtils.getBundle().getText("TRUCK_WILL_BE_UNSHARED");}}}},tooltip:{parts:[{path:"TourActive"},{path:"ShareDirection"},{path:"TourActive"}],formatter:function(s,S,a){if(S==="O"){return oSapSplUtils.getBundle().getText("TRUCK_WILL_BE_UNSHARED");}else{if(a===null){return oSapSplUtils.getBundle().getText("TRUCK_WILL_BE_UNSHARED");}else if(a===0){return oSapSplUtils.getBundle().getText("TRUCK_WILL_BE_UNSHARED_ON_TOUR_COMPLETION");}else{return oSapSplUtils.getBundle().getText("TRUCK_WILL_BE_UNSHARED");}}}}})]})},columns:[new sap.m.Column({header:new sap.m.Text({text:oSapSplUtils.getBundle().getText("TRUCK_S")})}),new sap.m.Column({header:new sap.m.Text({text:oSapSplUtils.getBundle().getText("TOUR_NAME")})}),new sap.m.Column({header:new sap.m.Text({text:oSapSplUtils.getBundle().getText("TOUR_STATUS")})}),new sap.m.Column({header:new sap.m.Text({text:oSapSplUtils.getBundle().getText("TOUR_DATE")})}),new sap.m.Column({header:new sap.m.Text({text:oSapSplUtils.getBundle().getText("RESULT_OF_TERMINATION")})})]}).setModel(m).addStyleClass("relationTerminatorTruckDialogTable");d.addContent(f).addContent(T).addContent(t);return d;}}else{d.addContent(new sap.m.Label({text:oSapSplUtils.getBundle().getText("PERMANENTLY_DISCONNECT",b["Organization_Name"])}));return d;}},fnRelationTerminator:function(){var t=this;var s=sap.ui.getCore().getModel("myBusinessPartnerDetailModel").getData();if(oSapSplUtils.getIsDirty()){sap.m.MessageBox.show(oSapSplUtils.getBundle().getText("DATA_LOSS_WARNING_TEXT"),sap.m.MessageBox.Icon.WARNING,oSapSplUtils.getBundle().getText("WARNING"),[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.CANCEL],function(a){if(a==="YES"){oSapSplUtils.setIsDirty(false);t.byId("MyBuPaDetailsEditButton").setText(oSapSplUtils.getBundle().getText("EDIT_BUPA"));t.byId("MyBupaEditCancel").setVisible(false);s["Editable"]=false;s["ExternalInstanceID"]=s["ExternalInstanceIDInitial"];sap.ui.getCore().getModel("myBusinessPartnerDetailModel").setData(s);t.fnHandleRelationTerminate();}});}else{s["Editable"]=false;sap.ui.getCore().getModel("myBusinessPartnerDetailModel").setData(s);this.byId("MyBupaEditCancel").setVisible(false);this.byId("MyBuPaDetailsEditButton").setText(oSapSplUtils.getBundle().getText("EDIT_BUPA"));this.fnHandleRelationTerminate();}},fnHandleRelationTerminate:function(){var t=this,d;var s=jQuery.extend(true,{},sap.ui.getCore().getModel("myBusinessPartnerDetailModel").getData());oSapSplBusyDialog.getBusyDialogInstance().open();setTimeout(function(){d=t.fnGetDialogContent(s);t.oTerminateConnectionDetailsDialog=new sap.m.Dialog({title:oSapSplUtils.getBundle().getText("TERMINATE_CONNECTION"),beginButton:new sap.m.Button({text:oSapSplUtils.getBundle().getText("OK"),press:function(){t.fnTerminateRelationServiceCall();this.getParent().close();}}),endButton:new sap.m.Button({text:oSapSplUtils.getBundle().getText("CANCEL"),press:function(){this.getParent().close();}}),content:d});if(d.hasTrucks===true){t.oTerminateConnectionDetailsDialog.setContentWidth("50%");}oSapSplBusyDialog.getBusyDialogInstance().close();t.oTerminateConnectionDetailsDialog.open().attachAfterOpen(function(){oSapSplUtils.fnSyncStyleClass(t.oTerminateConnectionDetailsDialog);});},100);},getUnifiedShellInstance:function(){return this.unifiedShell;},setUnifiedShellInstance:function(u){this.unifiedShell=u;},preparePayload:function(S){var p={};var R=[];var t={};if(S["ExternalInstanceID"]===""){S["ExternalInstanceID"]=null;}t["UUID"]=S["RelationUUID"];t["ExternalInstanceID"]=S["ExternalInstanceID"];t["Status"]=S["Status"];R.push(t);p["inputHasChangeMode"]=true;p["Relation"]=R;return p;},fnEditBupaDetails:function(e){var s=sap.ui.getCore().getModel("myBusinessPartnerDetailModel").getData();this.byId("sapSplBusinessPartnerExternalIdInput").removeStyleClass("SapSplBusinessPartnerExternalIDInputViewMode");this.byId("sapSplBusinessPartnerDetailExternalIdMessage").setText(oSapSplUtils.getBundle().getText("EXTERNALID_MESSAGE",[s["Organization_Name"]]));if(e.getSource().getText()==oSapSplUtils.getBundle().getText("EDIT_BUPA")){s["Editable"]=true;sap.ui.getCore().getModel("myBusinessPartnerDetailModel").setData(s);this.byId("MyBuPaDetailsEditButton").setText(oSapSplUtils.getBundle().getText("SAVE_BUPADETAILS"));this.byId("MyBupaEditCancel").setVisible(true);setTimeout(function(){sap.ui.getCore().byId("MyBusinessPartnerDetail--sapSplBusinessPartnerExternalIdInput").focus();},1000);}else if(e.getSource().getText()==oSapSplUtils.getBundle().getText("SAVE_BUPADETAILS")){var t=this;var b=oSapSplUtils.getServiceMetadata("bupa",true);var p=t.preparePayload(s);oSapSplAjaxFactory.fireAjaxCall({method:"PUT",url:b,data:JSON.stringify(p),success:function(){t.byId("MyBupaEditCancel").setVisible(false);t.byId("MyBuPaDetailsEditButton").setText(oSapSplUtils.getBundle().getText("EDIT_BUPA"));s["Editable"]=false;t.byId("MyBusinessPartnerDetail--sapSplBusinessPartnerExternalIdInput").addStyleClass("SapSplBusinessPartnerExternalIDInputViewMode");sap.ui.getCore().getModel("myBusinessPartnerDetailModel").setData(s);},error:function(x,a,c){if(x){oSapSplAppErrorHandler.show(x,true,function(){},function(){},function(){},function(){});}oSapSplBusyDialog.getBusyDialogInstance().close();jQuery.sap.log.error(c,a,"MyBusinessPartnerDetail.controller.js");},complete:function(){oSapSplBusyDialog.getBusyDialogInstance().close();}});}},fnCancelEditBupaDetails:function(){var t=this;var s=sap.ui.getCore().getModel("myBusinessPartnerDetailModel").getData();if(oSapSplUtils.getIsDirty()){sap.m.MessageBox.show(oSapSplUtils.getBundle().getText("DATA_LOSS_WARNING_TEXT"),sap.m.MessageBox.Icon.WARNING,oSapSplUtils.getBundle().getText("WARNING"),[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.CANCEL],function(a){if(a==="YES"){t.byId("sapSplBusinessPartnerExternalIdInput").addStyleClass("SapSplBusinessPartnerExternalIDInputViewMode");t.byId("sapSplBusinessPartnerExternalIdInput").setValue(s.ExternalInstanceID);oSapSplUtils.setIsDirty(false);t.byId("MyBuPaDetailsEditButton").setText(oSapSplUtils.getBundle().getText("EDIT_BUPA"));t.byId("MyBupaEditCancel").setVisible(false);s["Editable"]=false;s["ExternalInstanceID"]=s["ExternalInstanceIDInitial"];sap.ui.getCore().getModel("myBusinessPartnerDetailModel").setData(s);}});}else{s["Editable"]=false;sap.ui.getCore().getModel("myBusinessPartnerDetailModel").setData(s);this.byId("MyBupaEditCancel").setVisible(false);this.byId("MyBuPaDetailsEditButton").setText(oSapSplUtils.getBundle().getText("EDIT_BUPA"));}setTimeout(function(){sap.ui.getCore().byId("MyBusinessPartnerMaster--sapSplSearchBusinessPartnerMasterList").focus();},1000);},fnToCaptureLiveChangeToSetFlag:function(){var s=sap.ui.getCore().getModel("myBusinessPartnerDetailModel").getData();if(this.byId("sapSplBusinessPartnerExternalIdInput").getValue()!=s["ExternalInstanceIDInitial"]){oSapSplUtils.setIsDirty(true);}else{oSapSplUtils.setIsDirty(false);}}});
