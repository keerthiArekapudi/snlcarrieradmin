/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
jQuery.sap.require("splReusable.libs.SapSplMapToolbar");$.sap.require("sap.ui.thirdparty.jqueryui.jquery-ui-core");$.sap.require("sap.ui.thirdparty.jqueryui.jquery-ui-widget");$.sap.require("sap.ui.thirdparty.jqueryui.jquery-ui-mouse");$.sap.require("sap.ui.thirdparty.jqueryui.jquery-ui-draggable");$.sap.require("sap.ui.thirdparty.jqueryui.jquery-ui-sortable");$.sap.require("sap.ui.thirdparty.jqueryui.jquery-ui-droppable");sap.ui.controller("splController.liveApp.liveApp",{getLocationDetailsFromLocationID:function(l,L,s,e,d,E,a,b){var c="",A=(a===undefined?false:true);b=(b===undefined?"MyLocations":b);if(L==="LC0004"&&d!==false){c="&$expand=Incidents,GeofenceGates";}else if(L==="Truck"&&d!==false){c="&$expand=StopItemAssignment";}else{c="";}oSapSplBusyDialog.getBusyDialogInstance().open();if(E!==undefined){this.oSapSplApplModel.read("/"+b+encodeURIComponent("(X"+"\'"+oSapSplUtils.base64ToHex(l)+"\')/")+E,null,[""],A,jQuery.proxy(s,this),jQuery.proxy(e,this));}else{var f="$filter=("+encodeURIComponent("LocationID eq "+"X"+"\'"+oSapSplUtils.base64ToHex(l)+"\'")+")"+c;this.oSapSplApplModel.read("/"+b,null,[f],A,jQuery.proxy(s,this),jQuery.proxy(e,this));}oSapSplBusyDialog.getBusyDialogInstance().close();jQuery(".sapUiBLy").css("z-index","0");},fnHandleClickOnVisualObjects:function(){this.oMapToolbar.getSearchFieldLayoutInstance().fnExpandCollapseSearchField("Collapse");},getTruckDetailsFromDeviceUUIDProxy:{that:this,readArray:function(i,d){var t={Data:[]};for(var c=0;c<i.aTruckArray.length;c++){for(var C=0;C<d.length;C++){if(i.aTruckArray[c]["DeviceUUID"]===d[C]){t.Data.push(i.aTruckArray[c]);break;}}}return t;},read:function(i,d,s,e){var t=new Array();var a={results:[]};for(var c=0;c<i.aTruckArray.length;c++){if(i.aTruckArray[c]["DeviceUUID"]===d){a.results.push(i.aTruckArray[c]);}}s(a);}},getTruckDetailsFromDeviceUUID:function(d,s,e){var f="$filter=("+encodeURIComponent("DeviceUUID eq "+"X"+"\'"+oSapSplUtils.base64ToHex(d)+"\'")+")";oSapSplBusyDialog.getBusyDialogInstance().open();this.oSapSplApplModel.read("/VehiclePositions",null,[f],false,jQuery.proxy(s,this),jQuery.proxy(e,this));oSapSplBusyDialog.getBusyDialogInstance().close();jQuery(".sapUiBLy").css("z-index","0");},getIncidentDetailsFromUUID:function(i,s,e){var f="$filter=("+encodeURIComponent("UUID eq "+"X"+"\'"+oSapSplUtils.base64ToHex(i)+"\'")+")";oSapSplBusyDialog.getBusyDialogInstance().open();this.oSapSplApplModel.read("/OccurredIncidents",null,[f],false,jQuery.proxy(s,this),jQuery.proxy(e,this));oSapSplBusyDialog.getBusyDialogInstance().close();jQuery(".sapUiBLy").css("z-index","0");},getTruckMetadata:function(){var t=this;function s(d){t.aTruckArray=d.results;t.showTrucksOnMap();}function f(){jQuery.sap.log.error("Truck position","read failed","liveApp.controller.js");}if(this.isTruckDataPollingEnabled===true){oSapSplBusyDialog.getBusyDialogInstance().open();this.oSapSplApplModel.read("/VehiclePositions",null,null,true,jQuery.proxy(s,this),jQuery.proxy(f,this));oSapSplBusyDialog.getBusyDialogInstance().close();jQuery(".sapUiBLy").css("z-index","0");}},getIncidenceOccurencesMetadata:function(){var t=this;function s(d){t.aIncidenceOccuranceData=d.results;t.showIncidenceOccurrencesOnMap();}function e(){jQuery.sap.log.error("Incidence occurrence","read failed","liveApp.controller.js");}if(this.isIncidenceOccurrenceDataPollingEnabled===true){oSapSplBusyDialog.getBusyDialogInstance().open();this.oSapSplApplModel.read("/OccurredIncidents",null,["$filter=isLocationNull eq 0"],true,jQuery.proxy(s,this),jQuery.proxy(e,this));oSapSplBusyDialog.getBusyDialogInstance().close();jQuery(".sapUiBLy").css("z-index","0");}},onInit:function(){var t=this;this.allowSelectAllGroupLevel=true;this.allowSelectAllListLevel=true;this.sDisplayAreaText=oSapSplUtils.getBundle().getText("SELECT_DISPLAY_AREA");this.selectedLocationKey="Geofences";this.getView().addEventDelegate({onAfterShow:function(){if(!t.bFirstTime){t.oMapToolbar.getLiveFeedInstance().startPolling("firstTime");t.bFirstTime=true;$(".splMapTollbarBar").next().addClass("setSectionWidthForMapBorder");t.fetchAndSetDefaultDisplayArea(true);}t.fetchAndSetDefaultDisplayArea(false);var f=sap.ui.getCore().byId($(".sapSplFeedFilterLayout").attr("id"));$(".sapSplFeedFilterLayoutButton").css("width",f.$().width()/f.getItems().length+"px");sap.ui.getCore().byId($(".sapSplTrafficStatusFooter").attr("id")).rerender();}});this.appID="liveApp";sap.ui.getCore().getModel("sapSplAppConfigDataModel").setData(oSapSplUtils.getAppConfigObjectFromAllowedTiles(this.appID)[0]);this.fnInitialiseControllerInstanceVariables();this.fnInstatiateMap();this.fnInstantiateToolbar();this.fnSetTextBundles();this.fnCreateBusinessSuiteIcons();jQuery(window).resize(jQuery.proxy(this.fnRenderStyle,this));this.getLocationViewEnum();jQuery(document).keydown(function(e){var c=e.keyCode?e.keyCode:e.which;if(c===27){t.fnHandleLocationCreationCancelOnTheMap();}});this.bindLeftPanelList();this.fnHandleLeftPaneActions();if(splReusable.libs.SapSplModelFormatters.sapSplGetVisibilityBasedOnSubscriptionModel(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["isTrucksLabelVisible"])){this.byId("sapSplTrafficStatusContainerPage").addStyleClass("showLabelsSegment");}},fnHandleClickOfRadarGeofenceApprovalIcons:function(l,a,c){function _(l,a){var p={},R=null;p["Relation"]=[];if(l.RadarRelationUUID){R=l.RadarRelationUUID;}else{R=oSapSplUtils.getUUID();}var r={UUID:R,ToPartner:l.OwnerID,FromPartner:oSapSplUtils.getCompanyDetails()["BasicInfo_CompanyID"],Relation:"FREIGHTFWD_CONTAINERTRMNL_RADR",Text:"",Status:a,ObjectType:"ObservationGeofence",InstanceUUID:l.LocationID};p["Relation"].push(r);oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("sap/spl/xs/app/services/businessPartner.xsjs"),method:"PUT",async:false,cache:false,data:JSON.stringify(p),success:function(d,s,m){oSapSplBusyDialog.getBusyDialogInstance().close();if(d.constructor===String){d=JSON.parse(d);}if(m["status"]===200&&d["Error"].length===0){if(r.Status==="1"){sap.ca.ui.message.showMessageToast(oSapSplUtils.getBundle().getText("GEOFENCE_ACCEPTED"));}else{sap.ca.ui.message.showMessageToast(oSapSplUtils.getBundle().getText("GEOFENCE_REJECTED"));}c.call(r);}else if(d["Error"].length>0){var e=oSapSplUtils.getErrorMessagesfromErrorPayload(d)["ufErrorObject"];sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["errorWarningString"],details:e});}},error:function(e){oSapSplBusyDialog.getBusyDialogInstance().close();if(e&&e["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+" "+e.statusText,details:e.responseText});}},complete:function(x){if(x.responseText.constructor===String){x.responseText=JSON.parse(x.responseText);}var e=oSapSplUtils.getErrorMessagesfromErrorPayload(x.responseText);if(x.status===400){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["errorWarningString"],details:e["ufErrorObject"]});}}});}if(a==="2"){sap.m.MessageBox.show(oSapSplUtils.getBundle().getText("REJECT_RADAR_GEOFENCE_CONFIRMATION"),sap.m.MessageBox.Icon.NONE,oSapSplUtils.getBundle().getText("CONFIRMATION_DIALOG_HEADER_TITLE"),[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],function(s){if(s==="OK"){_(l,a,c);}});}else{_(l,a,c);}},sapSplHandleClickOfSelectAllLocations:function(e){this.oGroupHeaderCheckBoxObject[this.selectedLocationKey]["All"]=e.getSource().getSelected();var t=this;jQuery.each(this.oGroupHeaderCheckBoxObject[this.selectedLocationKey],function(k,v){if(k!=="All"){if(v["control"].$().length>0){v["control"].setSelected(e.getSource().getSelected());v["selected"]=e.getSource().getSelected();if(t.allowSelectAllListLevel===true){v["control"].fireSelect({selected:e.getSource().getSelected()});}}else{v["selected"]=false;}}});},sapSplHandleSelectOfTruckVisibility:function(e){var o={Trucks:((e.getSource().getSelectedItems().length>0)?true:false)};this.fnLabelToggleControlToMapInterface(o);oSapSplMapsDataMarshal.fnHandleDetailWindowVisibility(((e.getSource().getSelectedItems().length>0)?"Show":"Hide"),"Trucks");},bindLeftPanelList:function(){this.oGroupHeaderCheckBoxObject={};if(!this.oGroupHeaderCheckBoxObject[this.selectedLocationKey]){this.oGroupHeaderCheckBoxObject[this.selectedLocationKey]={};}var t=this;function h(e){var o=t.oGroupHeaderCheckBoxObject;var T=sap.ui.getCore().byId(e.getSource().$().parent().parent().prop("id")).getTitle();var I=o[t.selectedLocationKey][T]["items"];o[t.selectedLocationKey][T]["selected"]=e.getParameters().selected;for(var i=0;i<I.length;i++){I[i].setSelected(e.getParameters().selected);t.selectedItems[I[i].getBindingContext().getObject().LocationID]=e.getParameters().selected;if(i===I.length-1&&this.allowSelectAllGroupLevel===true){I[i].getParent().fireSelect({listItem:I[i]});}}this.allowSelectAllListLevel=false;if(e.getParameters().selected===false){this.byId("sapSplSelectAllLocationsCheckBox").setSelected(false);}this.allowSelectAllListLevel=true;}this.byId("SapSplLeftPanelList").addEventDelegate({onAfterRendering:function(e){var g="";for(var i=0;i<e.srcControl.getItems().length;i++){if(e.srcControl.getItems()[i].constructor!==sap.m.StandardListItem&&e.srcControl.getItems()[i].constructor!==sap.m.ObjectListItem){e.srcControl.getItems()[i].$().prepend("<div title="+oSapSplUtils.getBundle().getText("SELECT_ALL")+" class='selectAllCheckBox' id='checkBox"+e.srcControl.getItems()[i].sId+"'></div>");var s=new sap.m.CheckBox({select:h.bind(t)}).placeAt("checkBox"+e.srcControl.getItems()[i].sId);g=e.srcControl.getItems()[i].getTitle();if(g===undefined||g===null){g="0";}if(!t.oGroupHeaderCheckBoxObject[t.selectedLocationKey][g]){t.oGroupHeaderCheckBoxObject[t.selectedLocationKey][g]={};}if(t.oGroupHeaderCheckBoxObject[t.selectedLocationKey][g]["selected"]===undefined){t.oGroupHeaderCheckBoxObject[t.selectedLocationKey][g]["selected"]=false;}else{s.setSelected(t.oGroupHeaderCheckBoxObject[t.selectedLocationKey][g]["selected"]);}t.oGroupHeaderCheckBoxObject[t.selectedLocationKey][g]["control"]=s;t.oGroupHeaderCheckBoxObject[t.selectedLocationKey][g]["items"]=[];}else{if(t.oGroupHeaderCheckBoxObject[t.selectedLocationKey][g]){e.srcControl.getItems()[i].sGroupHeaderTitle=g;t.oGroupHeaderCheckBoxObject[t.selectedLocationKey][g]["items"].push(e.srcControl.getItems()[i]);}}}}});this.fnHandleSuccessOfAcceptOrRejectRadarGeofenceFromLeftPanel=function(){this.fnShowAllVisualObjectsOnMap("plotSelectedGeofences");};this.byId("SapSplLeftPanelList").bindAggregation("items","/",function(i,c){var T=null;if(c.getObject().isRadar==="0"||(c.getObject().isRadar==="1"&&c.getObject().isMyOrgObject==="1"&&sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["canViewRulesWithoutTour"]===1)){T=new sap.m.StandardListItem({title:"{Name}",selected:"{isSelected}",press:t.fnHandleLeftPanelItemPress.bind(t),type:"Active"});if(c.getObject().isRadar==="1"){T.addStyleClass("leftPanelListItemHeight3");}}else{if(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["canViewRulesWithoutTour"]===1){T=new sap.m.ObjectListItem({title:"{Name}",attributes:[new sap.m.ObjectAttribute({text:"{OwnerName}"}),new sap.m.ObjectAttribute({text:{path:"RelationStatus",formatter:function(s){if(s==="0"){return oSapSplUtils.getBundle().getText("RADAR_GEOFENCE_PENDING");}else{return"";}}}}).addStyleClass("radarStatus")],selected:"{isSelected}",press:t.fnHandleLeftPanelItemPress.bind(t),type:"Active"}).addStyleClass("radarGeofence");if(c.getObject().RelationStatus==="0"){T.addStyleClass("leftPanelListItemHeight1");}else{T.addStyleClass("leftPanelListItemHeight2");}}else{T=new sap.m.ObjectListItem({title:"{Name}",selected:"{isSelected}",press:t.fnHandleLeftPanelItemPress.bind(t),type:"Active"}).addStyleClass("radarGeofence").addStyleClass("leftPanelListItemHeight2");}}return T.addStyleClass("leftPanelListItem").addEventDelegate({onAfterRendering:function(E){if(E.srcControl.getBindingContext().getObject().isRadar==="1"){var s=E.srcControl.getBindingContext().getObject().RelationStatus;$("#approvalLayout"+E.srcControl.sId).empty();$("#approvalLayout"+E.srcControl.sId).remove();$("#radarIcon"+E.srcControl.sId).empty();$("#radarIcon"+E.srcControl.sId).remove();E.srcControl.$().append("<div class='radarApprovalLayout' id='approvalLayout"+E.srcControl.sId+"'></div>");E.srcControl.$().append("<div class='radarIcon' id='radarIcon"+E.srcControl.sId+"'></div>");new sap.ui.core.Icon({src:"sap-icon://feed",color:"#959595"}).placeAt("radarIcon"+E.srcControl.sId);if((s==="0"||s==="2")&&E.srcControl.getBindingContext().getObject().canActOnRadar==="1"){new sap.ui.core.Icon({tooltip:oSapSplUtils.getBundle().getText("APPROVE"),src:"sap-icon://accept",press:function(e){if(e.getSource().getCustomData().length===1){e.getSource().addCustomData(new sap.ui.core.CustomData({key:"actionHandled",value:true}));t.fnHandleClickOfRadarGeofenceApprovalIcons(e.getSource().getCustomData()[0].getValue(),"1",t.fnHandleSuccessOfAcceptOrRejectRadarGeofenceFromLeftPanel.bind(t));}}}).addStyleClass("radarApprovalAccept").placeAt("approvalLayout"+E.srcControl.sId).addCustomData(new sap.ui.core.CustomData({key:"context",value:E.srcControl.getBindingContext().getObject()}));}if((s==="0"||s==="1")&&E.srcControl.getBindingContext().getObject().canActOnRadar==="1"){new sap.ui.core.Icon({tooltip:oSapSplUtils.getBundle().getText("REJECT"),src:"sap-icon://decline",press:function(e){if(e.getSource().getCustomData().length===1){e.getSource().addCustomData(new sap.ui.core.CustomData({key:"actionHandled",value:true}));t.fnHandleClickOfRadarGeofenceApprovalIcons(e.getSource().getCustomData()[0].getValue(),"2",t.fnHandleSuccessOfAcceptOrRejectRadarGeofenceFromLeftPanel.bind(t));}}}).addStyleClass("radarApprovalReject").placeAt("approvalLayout"+E.srcControl.sId).addCustomData(new sap.ui.core.CustomData({key:"context",value:E.srcControl.getBindingContext().getObject()}));}}if(E.srcControl.$().find(".sapMLIBContent").height()>80){E.srcControl.removeStyleClass("leftPanelListItemHeight1");E.srcControl.$().css("height",E.srcControl.$().find(".sapMLIBContent").height()+8+"px");}}});});},fnToAddSIsSharedFieldToLeftPanelModel:function(d){for(var i=0;i<d.results.length;i++){var I=d.results[i]["isPublic"];var s=d.results[i]["isRadar"];var a=d.results[i]["isMyOrgObject"];var b=(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["canViewRulesWithoutTour"]===1)?"1":"0";var x=I+s+b+a;if(x==="1010"){d.results[i].sIsShared="2";}else if(x==="1000"){d.results[i].sIsShared="2";}else if(x==="0111"){d.results[i].sIsShared="0";}else if(x==="0011"){d.results[i].sIsShared="0";}else if(x==="0110"){d.results[i].sIsShared="1";}else if(x==="0001"){d.results[i].sIsShared="0";}else if(x==="0101"){d.results[i].sIsShared="1";}else if(x==="1001"){d.results[i].sIsShared="1";}else{d.results[i].sIsShared="1";}}return d;},fnHandleLeftPaneActions:function(){var t=this;this.byId("sapSplLeftPanelTitle").setText(oSapSplUtils.getBundle().getText("ENTITIES"));if(!sap.ui.getCore().getModel("SapSplLeftPanelListModel")){var m=new sap.ui.model.json.JSONModel();sap.ui.getCore().setModel(m,"SapSplLeftPanelListModel");this.byId("SapSplLeftPanelList").setModel(sap.ui.getCore().getModel("SapSplLeftPanelListModel"));}this.oSapSplApplModel.read("MyLocations",null,null,false,function(d){for(var i=0;i<d.results.length;i++){d.results[i].isSelected=false;}sap.ui.getCore().getModel("SapSplLeftPanelListModel").setSizeLimit(d.results.length+1);d=t.fnToAddSIsSharedFieldToLeftPanelModel(d);sap.ui.getCore().getModel("SapSplLeftPanelListModel").setData(d.results);},function(){});var s=new sap.ui.model.Sorter("sIsShared",false,this.handleGroupingOfLocations);var n=new sap.ui.model.Sorter("Name",false);this.byId("SapSplLeftPanelList").getBinding("items").sort([s,n]);var f=new sap.ui.model.Filter("Tag",sap.ui.model.FilterOperator.EQ,"LC0004");this.byId("SapSplLeftPanelList").getBinding("items").filter([f,new sap.ui.model.Filter("Tag",sap.ui.model.FilterOperator.EQ,"LC0008")]);this.byId("sapSnlhGroupTitlelabelInfoToolBar").setText(oSapSplUtils.getBundle().getText("GROUPED_BY_SHARING"));this.byId("SapSplLeftPanelList").attachBrowserEvent("mouseover",function(e){if(sap.ui.getCore().byId(e.target.id)&&(sap.ui.getCore().byId(e.target.id).constructor===sap.m.StandardListItem||sap.ui.getCore().byId(e.target.id).constructor===sap.m.ObjectListItem)&&sap.ui.getCore().byId(e.target.id).getSelected()===true){if(sap.ui.getCore().byId(e.target.id)&&sap.ui.getCore().byId(e.target.id).getBindingContext().getProperty().Tag==="LC0004"||sap.ui.getCore().byId(e.target.id)&&sap.ui.getCore().byId(e.target.id).getBindingContext().getProperty().Tag==="LC0008"){if(sap.ui.getCore().byId(e.target.id).getBindingContext().getProperty().Geometry){oSapSplMapsDataMarshal.fnShowFences(sap.ui.getCore().byId(e.target.id).getBindingContext().getProperty(),sap.ui.getCore().byId("splView.liveApp.liveApp").getController().byId("oSapSplLiveAppMap"),"onFocus");}}else{if(sap.ui.getCore().byId(e.target.id).getBindingContext().getProperty().Geometry){if(sap.ui.getCore().byId(e.target.id).getBindingContext().getProperty().Geometry){oSapSplMapsDataMarshal.fnShowPointOfInterestFlags(sap.ui.getCore().byId(e.target.id).getBindingContext().getProperty(),sap.ui.getCore().byId("splView.liveApp.liveApp").getController().byId("oSapSplLiveAppMap"),"onFocus");}}}if(sap.ui.getCore().byId("splView.liveApp.liveApp").getController().previousFocused){if(sap.ui.getCore().byId(e.target.id)&&sap.ui.getCore().byId(e.target.id).getBindingContext()&&(sap.ui.getCore().byId("splView.liveApp.liveApp").getController().previousFocused!==sap.ui.getCore().byId(e.target.id).getBindingContext().getProperty())){if(sap.ui.getCore().byId("splView.liveApp.liveApp").getController().previousFocused.Tag==="LC0004"||sap.ui.getCore().byId("splView.liveApp.liveApp").getController().previousFocused.Tag==="LC0008"){if(sap.ui.getCore().byId("splView.liveApp.liveApp").getController().previousFocused.Geometry){oSapSplMapsDataMarshal.fnShowFences(sap.ui.getCore().byId("splView.liveApp.liveApp").getController().previousFocused,sap.ui.getCore().byId("splView.liveApp.liveApp").getController().byId("oSapSplLiveAppMap"));oSapSplMapsDataMarshal.fnHandleDetailWindowVisibility("Hide","Geofence");}}else{if(sap.ui.getCore().byId("splView.liveApp.liveApp").getController().previousFocused.Geometry){oSapSplMapsDataMarshal.fnShowPointOfInterestFlags(sap.ui.getCore().byId("splView.liveApp.liveApp").getController().previousFocused,sap.ui.getCore().byId("splView.liveApp.liveApp").getController().byId("oSapSplLiveAppMap"));}}}}if(sap.ui.getCore().byId(e.target.id)&&sap.ui.getCore().byId(e.target.id).getSelected()&&sap.ui.getCore().byId(e.target.id).getBindingContext()){sap.ui.getCore().byId("splView.liveApp.liveApp").getController().previousFocused=sap.ui.getCore().byId(e.target.id).getBindingContext().getProperty();}}if(sap.ui.getCore().byId(e.target.id)&&sap.ui.getCore().byId(e.target.id).getBindingContext()&&sap.ui.getCore().byId(e.target.id).getBindingContext().getObject().isRadar==="1"){if(sap.ui.getCore().byId(e.target.id).constructor===sap.m.StandardListItem||sap.ui.getCore().byId(e.target.id).constructor===sap.m.ObjectListItem){$(".leftPanelListItem").removeClass("leftPanelListItemHovered");sap.ui.getCore().byId(e.target.id).$().addClass("leftPanelListItemHovered");}}else if(sap.ui.getCore().byId(e.target.id)&&sap.ui.getCore().byId(e.target.id).getBindingContext()&&sap.ui.getCore().byId(e.target.id).getBindingContext().getObject().isRadar==="0"){if(sap.ui.getCore().byId(e.target.id).constructor===sap.m.StandardListItem||sap.ui.getCore().byId(e.target.id).constructor===sap.m.ObjectListItem){$(".leftPanelListItem").removeClass("leftPanelListItemHovered");}}});this.byId("SapSplLeftPanelList").attachBrowserEvent("mouseout",function(){});},fnHandleLeftPanelItemPress:function(e){if(e.getSource().getSelected()===true){this.fnLeftPaneToMapInterface(e.getSource().getBindingContext().getObject());}},fnLeftPaneToMapInterface:function(d,m,h){var t=this,e=d;this.getLocationDetailsFromLocationID(d["LocationID"],d["Tag"],function(r){d=r.results[0];var p=null;p=t.fnGetPopoverOffsets("fromMap");var c;if(d["Tag"]==="LC0004"||d["Tag"]==="LC0008"){c=oSapSplMapsDataMarshal.convertGeoJSONToString(JSON.parse(d["Geometry"]));c=oSapSplMapsDataMarshal.fnGetPointFromPolygon(c);}else{c=oSapSplMapsDataMarshal.convertGeoJSONToString(JSON.parse(d["Geometry"]));}var l=c.split(";")[1];var L=c.split(";")[0];if(m!=="Cluster"){if(d["Tag"]==="LC0004"||d["Tag"]==="LC0008"){if(d.Geometry&&JSON.parse(d.Geometry).coordinates.length>0){t.byId("oSapSplLiveAppMap").zoomToAreas(JSON.parse(d.Geometry).coordinates[0],true);}}else{t.byId("oSapSplLiveAppMap").zoomToGeoPosition(parseFloat(L,10),parseFloat(l,10),15);}var C=oSapSplMapsDataMarshal.convertGeoCoordToScreenCoord(c,t.byId("oSapSplLiveAppMap"));var a=t.getPopoverOpeningDirection(C["left"],C["top"]);d.x=parseInt(a.x+p["x"],10);d.y=parseInt(a.y+p["y"],10);d.placement=a.placement;}else{d.x=e["x"];d.y=e["y"];d.placement=e["placement"];d.introduceFooterZoomInButton=true;d.zoomInButtonHandler=h;}if(d["Tag"]==="LC0002"&&d["Geometry"]){t.parkingSpaceDisplayHandler(d);}else if((d["Tag"]==="LC0003"||d["Tag"]==="LC0007")&&d["Geometry"]){t.fnContainerTerminalDisplayHandler(d);}else{if(d["Geometry"]){t.fnHandleDisplayOflocations(d);}}},function(){jQuery.sap.log.error("fnHandleLocationDetailsDisplay","Failure of function call","liveApp.controller.js");});},fnHandleLeftPanelIconTabBarSelect:function(e){var s=this.byId("SapSplLeftPanelList").getBinding("items");var f,a;this.selectedLocationKey=e.getParameters().selectedKey;if(!this.oGroupHeaderCheckBoxObject[this.selectedLocationKey]){this.oGroupHeaderCheckBoxObject[this.selectedLocationKey]={};}this.byId("sapSplSelectAllLocationsCheckBox").setSelected((this.oGroupHeaderCheckBoxObject[this.selectedLocationKey]["All"]===undefined)?false:this.oGroupHeaderCheckBoxObject[this.selectedLocationKey]["All"]);if(e.getParameters().selectedKey==="Geofences"){f=new sap.ui.model.Filter("Tag",sap.ui.model.FilterOperator.EQ,"LC0004");a=0;e.getSource().getItems()[0].setIcon("./resources/icons/tab_geofence_focus.png");this.byId("SapSplLeftPanelList").setNoDataText(oSapSplUtils.getBundle().getText("NO_DATA_TEXT_GEOFENCE"));this.byId("sapSplSelectAllLocationsCheckBox").setText(oSapSplUtils.getBundle().getText("SELECT_ALL_GEOFENCES"));s.filter([f,new sap.ui.model.Filter("Tag",sap.ui.model.FilterOperator.EQ,"LC0008")]);this.byId("sapSplLeftPanelGroupButton").setVisible(true);this.byId("sapSplLeftPanelFilterButton").setVisible(true);}else if(e.getParameters().selectedKey==="Bridge"){f=new sap.ui.model.Filter("Tag",sap.ui.model.FilterOperator.EQ,"LC0001");a=4;e.getSource().getItems()[4].setIcon("./resources/icons/tab_bridge_focus.png");this.byId("SapSplLeftPanelList").setNoDataText(oSapSplUtils.getBundle().getText("NO_BRIDGES_TEXT"));this.byId("sapSplSelectAllLocationsCheckBox").setText(oSapSplUtils.getBundle().getText("SELECT_ALL_BRIDGES"));s.filter([f]);this.byId("sapSplLeftPanelGroupButton").setVisible(false);this.byId("sapSplLeftPanelFilterButton").setVisible(false);}else if(e.getParameters().selectedKey==="ParkingSpace"){f=new sap.ui.model.Filter("Tag",sap.ui.model.FilterOperator.EQ,"LC0002");a=2;e.getSource().getItems()[2].setIcon("./resources/icons/tab_parking_focus.png");this.byId("SapSplLeftPanelList").setNoDataText(oSapSplUtils.getBundle().getText("NO_PARKING_SPACES_TEXT"));this.byId("sapSplSelectAllLocationsCheckBox").setText(oSapSplUtils.getBundle().getText("SELECT_ALL_PARKINGSPACES"));s.filter([f]);this.byId("sapSplLeftPanelGroupButton").setVisible(false);this.byId("sapSplLeftPanelFilterButton").setVisible(false);}else if(e.getParameters().selectedKey==="ContainerTerminals"){f=new sap.ui.model.Filter("Tag",sap.ui.model.FilterOperator.EQ,"LC0003");a=6;e.getSource().getItems()[6].setIcon("./resources/icons/tab_container_terminal_focus.png");this.byId("SapSplLeftPanelList").setNoDataText(oSapSplUtils.getBundle().getText("NO_CONTAINER_TERMINALS_TEXT"));this.byId("sapSplSelectAllLocationsCheckBox").setText(oSapSplUtils.getBundle().getText("SELECT_ALL_CONTAINERTERMINALS"));s.filter([f]);this.byId("sapSplLeftPanelGroupButton").setVisible(false);this.byId("sapSplLeftPanelFilterButton").setVisible(false);}else{f=new sap.ui.model.Filter("Tag",sap.ui.model.FilterOperator.EQ,"LC0007");a=8;e.getSource().getItems()[8].setIcon("./resources/icons/tab_container_depot_focus.png");this.byId("SapSplLeftPanelList").setNoDataText(oSapSplUtils.getBundle().getText("NO_CONTAINER_DEPOTS_TEXT"));this.byId("sapSplSelectAllLocationsCheckBox").setText(oSapSplUtils.getBundle().getText("SELECT_ALL_CONTAINERDEPOTS"));s.filter([f]);this.byId("sapSplLeftPanelGroupButton").setVisible(false);this.byId("sapSplLeftPanelFilterButton").setVisible(false);}for(var i=0;i<e.getSource().getItems().length;i++){if(i!==a){if(i===0){e.getSource().getItems()[i].setIcon("./resources/icons/tab_geofence_normal.png");}else if(i===2){e.getSource().getItems()[i].setIcon("./resources/icons/tab_parking_normal.png");}else if(i===4){e.getSource().getItems()[i].setIcon("./resources/icons/tab_bridge_normal.png");}else if(i===6){e.getSource().getItems()[i].setIcon("./resources/icons/tab_container_terminal_normal.png");}else{e.getSource().getItems()[i].setIcon("./resources/icons/tab_container_depot_normal.png");}}i++;}},handleGroupingOfLocations:function(c){var k=c.getProperty("Tag");var t=c.getProperty("isPublic");if(k==="LC0001"){if(t==="1"){return{key:"PublicBridge",text:oSapSplUtils.getBundle().getText("PUBLIC_BRIDGES")};}else{return{key:"PrivateBridge",text:oSapSplUtils.getBundle().getText("PRIVATE_BRIDGES")};}}if(k==="LC0002"){if(t==="1"){return{key:"PublicParkingSpace",text:oSapSplUtils.getBundle().getText("PUBLIC_PARKING_SPACES")};}else{return{key:"PrivateParkingSpace",text:oSapSplUtils.getBundle().getText("PRIVATE_PARKING_SPACES")};}}if(k==="LC0003"){if(t==="1"){return{key:"PublicContainerTerminals",text:oSapSplUtils.getBundle().getText("PUBLIC_CONTAINER_TERMINALS")};}else{return{key:"PrivateContainerTerminals",text:oSapSplUtils.getBundle().getText("PRIVATE_CONTAINER_TERMINALS")};}}if(k==="LC0004"||k==="LC0008"){var i=c.getProperty("sIsShared");if(this.sPath==="sIsShared"){if(i==="1"){return{key:"SharedGeofences",text:oSapSplUtils.getBundle().getText("SHARED_GEOFENCES")};}else if(i==="0"){return{key:"PrivateGeofences",text:oSapSplUtils.getBundle().getText("PRIVATE_GEOFENCES")};}else if(i==="2"){return{key:"PublicGeofences",text:oSapSplUtils.getBundle().getText("PUBLIC_GEOFENCES")};}}else if(this.sPath==="OwnerName"){t=c.getProperty("isMyOrgObject");if(t==="1"){return{key:"MyCompany",text:oSapSplUtils.getBundle().getText("MY_COMPANY_GEOFENCES")};}else{return{key:c.getProperty("OwnerName"),text:c.getProperty("OwnerName")};}}}if(k==="LC0007"){if(t==="1"){return{key:"PublicContainerDepots",text:oSapSplUtils.getBundle().getText("PUBLIC_CONTAINER_DEPOTS")};}else{return{key:"PrivateContainerDepots",text:oSapSplUtils.getBundle().getText("PRIVATE_CONTAINER_DEPOTS")};}}},fnHandleSapSplLeftPanelListItemSelect:function(e){var s=[];if(e.getParameters().listItem.getSelected()===false){this.previousFocused=null;this.selectedItems[e.getParameters().listItem.getBindingContext().getProperty().LocationID]=false;oSapSplMapsDataMarshal.fnHandleDetailWindowVisibility("Hide","Geofence");var g="";if(e.getParameters().listItem.sGroupHeaderTitle!==undefined){this.allowSelectAllGroupLevel=false;g=e.getParameters().listItem.sGroupHeaderTitle;this.oGroupHeaderCheckBoxObject[this.selectedLocationKey][g]["control"].setSelected(false);this.allowSelectAllGroupLevel=true;this.allowSelectAllListLevel=false;this.byId("sapSplSelectAllLocationsCheckBox").setSelected(false);this.allowSelectAllListLevel=true;}}else{this.selectedItems[e.getParameters().listItem.getBindingContext().getProperty().LocationID]=true;}for(var i=0;i<sap.ui.getCore().getModel("SapSplLeftPanelListModel").getData().length;i++){if(sap.ui.getCore().getModel("SapSplLeftPanelListModel").getData()[i].isSelected){if(sap.ui.getCore().getModel("SapSplLeftPanelListModel").getData()[i].Geometry){s.push(sap.ui.getCore().getModel("SapSplLeftPanelListModel").getData()[i]);}}}oSapSplMapsDataMarshal.fnShowVOsOnMap(s,this.byId("oSapSplLiveAppMap"));this.aSelectedLocationObjectsFromLeftPanel=s;this.showTrucksOnMap();this.showIncidenceOccurrencesOnMap();},fnCreateBusinessSuiteIcons:function(){jQuery.sap.require("sap.ui.core.IconPool");sap.ui.core.IconPool.addIcon("icon-traffic-cone","bussiness-suite","businessSuiteIcons","e06f;");sap.ui.core.IconPool.addIcon("icon-traffic-lights","bussiness-suite","businessSuiteIcons","e06e;");sap.ui.core.IconPool.addIcon("icon-container","bussiness-suite","businessSuiteIcons","e070;");sap.ui.core.IconPool.addIcon("icon-container-loading","bussiness-suite","businessSuiteIcons","e071;");sap.ui.core.IconPool.addIcon("icon-traffic-jam","bussiness-suite","businessSuiteIcons","e072;");sap.ui.core.IconPool.addIcon("icon-truck-driver","bussiness-suite","businessSuiteIcons","e076;");},fnFetchDefaultDisplay:function(){var d=[];oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/utils/services/utils.xsodata/")+"Enumeration('FacilityAvailabilityStatus')/Values?$format=json",method:"GET",success:function(a){d=a.d.results;},error:function(){},async:false,json:true});return d;},onBeforeShow:function(e){this.fnRenderStyle();this.startPollingOfAllComponents();this.setCurrentAppInfo(e);if(e&&e.data&&e.data.showBackButton){this.oMapToolbar.getContentLeft()[0].setVisible(true);}if(e.data&&e.data["FromApp"]==="tours"){if(e.data["TruckInfo"]){this.bZoomToTruck=true;this.oZoomToTruckData=e.data["TruckInfo"];}}this.fnFetchDefaultDisplay();sap.ui.getCore().getModel("sapSplAppConfigDataModel").setData(oSapSplUtils.getAppConfigObjectFromAllowedTiles(this.appID)[0]);},setCurrentAppInfo:function(e){oSapSplHelpHandler.setAppHelpInfo({iUrl:"./help/SCLApp.pdf",eUrl:"//help.sap.com/saphelp_scl10/helpdata/en/52/02e3537a0e9438e10000000a44176d/content.htm?frameset=/en/c9/50e853c0bb9438e10000000a44176d/frameset.htm&current_toc=/en/b7/8ee25341d61e4ee10000000a423f68/plain.htm&node_id=8"},e);},startPollingOfAllComponents:function(){var t=this;var g;var a;this.oMapToolbar.getLiveFeedInstance().startPolling();var l=this.oMapToolbar.getLiveFeedInstance().getChatBoxInstances();jQuery.each(l,function(k,v){v.startPolling();});if(g){window.clearInterval(g);}g=window.setInterval(function(){t.getTruckMetadata();},SapSplEnums.VehiclePositionsPollingTime);oSapSplUtils.setIntervalId(g);if(a){window.clearInterval(a);}a=window.setInterval(function(){t.getIncidenceOccurencesMetadata();},SapSplEnums.IncidentOccurencePollingTime);oSapSplUtils.setIntervalId(a);},fetchAndSetDefaultDisplayArea:function(f){var t=this;var z={};function s(d){if(d.results&&d.results.length>0){t.byId("oSapSplLiveAppMap").defaultDisplayArea=d.results[0];var c=oSapSplMapsDataMarshal.convertGeoJSONToString(JSON.parse(d.results[0].DisplayArea_Center)).split(";");z.lon=parseFloat(c[0],10);z.lat=parseFloat(c[1],10);z.zoomLevel=parseFloat(d.results[0].DisplayArea_ZoomLevel,10);oSapSplMapsDataMarshal.fnSetZoomAndCenter(t.byId("oSapSplLiveAppMap"),z);if(d.results[0].isDefault===1){t.oMapToolbar.getContentLeft()[2].setText(d.results[0].Name+" *");}else{t.oMapToolbar.getContentLeft()[2].setText(d.results[0].Name);}}else{t.byId("oSapSplLiveAppMap").defaultDisplayArea=null;}}function F(){jQuery.sap.log.error("Default Display Area","read failed","liveApp.controller.js");}if(f){oSapSplBusyDialog.getBusyDialogInstance().open();this.oSapSplApplModel.read("/ViewList",null,["$filter=isDefault eq 1"],true,jQuery.proxy(s,this),jQuery.proxy(F,this));oSapSplBusyDialog.getBusyDialogInstance().close();jQuery(".sapUiBLy").css("z-index","0");}else{this.oMapToolbar.getContentLeft()[2].setText(this.sDisplayAreaText);}},onAfterRendering:function(){this.fnRenderStyle();this.getTruckMetadata();this.getIncidenceOccurencesMetadata();this.getView().$().append("<div id='chatBoxConsoleContainerDiv'></div>");this.oMapToolbar.getLiveFeedInstance().placeChatBoxControl();splReusable.libs.SapSplStyleSheetLoader.loadStyle("./resources/styles/sapSplLiveApp","css");splReusable.libs.SapSplStyleSheetLoader.loadStyle("./resources/styles/sapSplMapToolbar","css");},fnInstatiateMap:function(){this.oVBIModel=new sap.ui.model.json.JSONModel();this.oVBIModel.setData(oSapSplMapsDataMarshal.getMapsModelJSON(SapSplEnums.configJSON));sap.ui.getCore().setModel(this.oVBIModel,"oSapSplVBModelLiveApp");this.getView().byId("oSapSplLiveAppMap").bindProperty("config","oSapSplVBModelLiveApp>/");this.getView().byId("oSapSplLiveAppMap").setModel(sap.ui.getCore().getModel("oSapSplVBModelLiveApp"));},fnGetPopoverOffsets:function(c){var s=jQuery(".sapUiUfdShellHead").height();var a=jQuery(".splMapTollbarBar").height();var A=jQuery(".oPopoverAnchorButton").height();var i=jQuery(".oPopoverAnchorButton").width();var m=jQuery(".sapSplLeftPanelMasterPage").width();var p={};if(c==="fromMap"){if(jQuery(".sapSplTrafficStatusContainer").hasClass("sapMSplitContainerHideMode")===true){p.x=-i;p.y=-A;}else{p.x=-i;p.y=-A;}}else{if(jQuery(".sapSplTrafficStatusContainer").hasClass("sapMSplitContainerHideMode")===true){p.x=-i;p.y=s+a-(A/2);}else{p.x=-i+m;p.y=s+a-(A/2);}}return p;},fnShowHideLiveAppDisplayAreaBorder:function(m){if(m==="show"){jQuery(".sapSplLiveAppDisplayAreaBorder").show();jQuery(".splMapTollbarBar").addClass("sapSplLiveAppDisplayAreaBorderTop");jQuery(".sapSplTrafficStatusFooter").addClass("sapSplLiveAppDisplayAreaBorderBottom");}else if(m==="hide"){jQuery(".sapSplLiveAppDisplayAreaBorder").hide();jQuery(".splMapTollbarBar").removeClass("sapSplLiveAppDisplayAreaBorderTop");jQuery(".sapSplTrafficStatusFooter").removeClass("sapSplLiveAppDisplayAreaBorderBottom");}},fnRenderStyle:function(){this.iWindowWidth=jQuery(window).width();this.iWindowHeight=jQuery(window).height();var l=this.iWindowHeight-$(".sapUiUfdShellHead").height()-$(".splMapTollbarBar").height()-$(".sapMFooter-CTX").height();$(".sapSplLeftPanelMasterPage").css("height",l-5+"px");$(".sapSplLeftPanelMasterPage").parent().css("height",l-5+"px");jQuery(".oSapSplLiveAppMap").css("height",l-7+"px");jQuery(".oSapSplLiveAppMap").css("width",this.iWindowWidth-2+"px");},fnHandleDialogMove:function(d){if(!oSapSplUtils.bIsInternetExplorer()){var q=d.$();q.find(".sapMBarPH").css("cursor","move");q.draggable({"drag":function(){if($(window).width()<$(this).offset().left+$(this).width()){$(this).css("left",($(window).width()-$(this).width())+"px");}},"containment":"window"});}},fnHandleDialogPositioning:function(d){window.setTimeout(function(){d.removeStyleClass("sapSplHideDialog");var v=$("#"+d.sId+" section");var h=jQuery("#sapSplBaseUnifiedShell-hdr").height();if(d.$().hasClass("SplParkingSpaceCreateEditDialog")===false){if((d.$().hasClass("SplLocationCreateEditDialog")===true)&&((d.getContent()[0].getContent()[0].getModel().getData()["Tag"]==="LC0004")||(d.getContent()[0].getContent()[0].getModel().getData()["Tag"]==="LC0008"))){$("#"+d.sId+" .sapUiView").css("height",($("#"+v[1].children[0].id).height()<250?250:$("#"+v[1].children[0].id).height())+5*$(".sapMIBar").height()+"px");$("#"+d.sId+" .sapUiView").css("max-height",(jQuery(window).height()-5*h)+"px");}else{$("#"+d.sId+" .sapUiView").css("height",$("#"+v[0].children[0].id).height()+1*$(".sapMIBar").height()+"px");$("#"+d.sId+" .sapUiView").css("max-height",(jQuery(window).height()-5*h)+"px");}}else{$("#"+d.sId+" .sapUiView").css("height",$("#"+v[0].children[0].id).height()+2*$(".sapMIBar").height()+"px");$("#"+d.sId+" .sapUiView").css("max-height",(jQuery(window).height()-5*h)+"px");}},50);},fnInitialiseControllerInstanceVariables:function(){this.aTruckArray=[];this.aIncidenceOccuranceData=[];this.aSelectedLocationObjects=[];this.aSelectedLocationObjectsFromLeftPanel=[];this.selectedItems={};this.aRenderedDialogs=[];this.oSapSplApplModel=sap.ui.getCore().getModel("LiveAppODataModel");this.sLocationType=null;this.oSapSplLocationCreateEditDialogInstance=null;this.oLocationViewEnum=null;this.isIncidenceOccurrenceClickEnabled=true;this.isTruckClickEnabled=true;this.isGeofenceClickEnabled=true;this.isPOIclickEnabled=true;this.isSelectMultipleTrucksEnabled=false;this.isSelectMultipleGeofencesEnabled=false;this.isTruckDataPollingEnabled=true;this.isIncidenceOccurrenceDataPollingEnabled=true;this.isGeofenceLabelVisible=true;this.isTruckLabelVisible=null;},fnSetTextBundles:function(){this.byId("addGeofenceButton").setText(oSapSplUtils.getBundle().getText("ADD_GEOFENCE"));this.byId("addPointOfInterestButton").setText(oSapSplUtils.getBundle().getText("ADD_POI"));this.byId("oContactBusinessPartnerButton").setText(oSapSplUtils.getBundle().getText("CONTACT_BUSINESS_PARTNER"));this.byId("oSendMessageToTruckButton").setText(oSapSplUtils.getBundle().getText("SEND_MESSAGE_TO_TRUCKS"));this.byId("sapSplLocationCreateCancelButton").setText(oSapSplUtils.getBundle().getText("CANCEL"));},fnShowAllVisualObjectsOnMap:function(f){if(f==="PlotLocally"){var s=[];for(var i=0;i<sap.ui.getCore().getModel("SapSplLeftPanelListModel").getData().length;i++){if(sap.ui.getCore().getModel("SapSplLeftPanelListModel").getData()[i].isSelected){if(sap.ui.getCore().getModel("SapSplLeftPanelListModel").getData()[i].Geometry){s.push(sap.ui.getCore().getModel("SapSplLeftPanelListModel").getData()[i]);}}}oSapSplMapsDataMarshal.fnShowVOsOnMap(s,this.byId("oSapSplLiveAppMap"));this.showTrucksOnMap();this.showIncidenceOccurrencesOnMap();}else{this.oMapToolbar.refreshMap(f);this.showTrucksOnMap();this.showIncidenceOccurrencesOnMap();}},fnHandleLocationCreationCancelOnTheMap:function(e){var t=this;var h=function(){t.byId("sapSplLocationCreateCancelButton").setVisible(false);t.byId("sapSplTrafficStatusFooter").removeStyleClass("sapSplHiddenBar");if(t.sLocationType!==null&&t.sLocationType!==undefined){t.fnShowAllVisualObjectsOnMap("PlotLocally");t.sLocationType=null;oSapSplMapsDataMarshal.isMapClickEabled=false;t.fnPreventEnableMapRefresh("Enable");oSapSplMapsDataMarshal.fnChangeCursor("normal");oSapSplMapsDataMarshal.fnResetValues(t.byId("oSapSplLiveAppMap"));t.fnBlockUnblockLiveAppUI("Unblock");oSapSplUtils.setIsDirty(false);}};if(oSapSplUtils.getIsDirty()===true){sap.m.MessageBox.show(oSapSplUtils.getBundle().getText("DATA_LOSS_WARNING_TEXT"),sap.m.MessageBox.Icon.WARNING,oSapSplUtils.getBundle().getText("WARNING"),[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.CANCEL],function(s){if(s==="YES"){h();}});}else{h();}},fnBlockUnblockLiveAppUI:function(a,c){if(a==="Block"){this.oMapToolbar.setEnabled(false);window.clearInterval(this.oMapToolbar.getMapFilterInstance().oPSInterval);this.oMapToolbar.getMapFilterInstance().oPSInterval=null;jQuery(".sapUiBLy").css("z-index","0");this.byId("addGeofenceButton").setEnabled(false);this.byId("addPointOfInterestButton").setEnabled(false);this.byId("oContactBusinessPartnerButton").setEnabled(false);this.byId("oSendMessageToTruckButton").setEnabled(false);this.oMapToolbar.getContentLeft()[1].setEnabled(false);this.oMapToolbar.getContentLeft()[3].setEnabled(false);if(this.byId("sapSplTrafficStatusContainer").getMode()==="ShowHideMode"){this.byId("sapSplTrafficStatusContainer").setMode("HideMode");this.fnRenderStyle();}if(c==="addGeofence"){oSapSplMapsDataMarshal.fnHandleDetailWindowVisibility("Hide","All");this.isIncidenceOccurrenceClickEnabled=false;this.isTruckClickEnabled=false;this.isPOIclickEnabled=false;this.isGeofenceClickEnabled=false;}else if(c==="addPOI"){oSapSplMapsDataMarshal.fnHandleDetailWindowVisibility("Hide","All");this.isIncidenceOccurrenceClickEnabled=false;this.isTruckClickEnabled=false;this.isPOIclickEnabled=false;this.isGeofenceClickEnabled=false;}else if(c==="contactBuPa"){oSapSplMapsDataMarshal.fnHandleDetailWindowVisibility("Hide","All");this.isIncidenceOccurrenceClickEnabled=false;this.isTruckClickEnabled=false;this.isGeofenceClickEnabled=false;this.isPOIclickEnabled=false;}else if(c==="sendMessageToTruckOnMap"){oSapSplMapsDataMarshal.fnHandleDetailWindowVisibility("Hide","All");this.isIncidenceOccurrenceClickEnabled=false;this.isGeofenceClickEnabled=false;this.isPOIclickEnabled=false;}else if(c==="sendMessageToTruckViaGeofence"){oSapSplMapsDataMarshal.fnHandleDetailWindowVisibility("Hide","All");this.isIncidenceOccurrenceClickEnabled=false;this.isTruckClickEnabled=false;this.isPOIclickEnabled=false;}else if(c==="sendMessage"){oSapSplMapsDataMarshal.fnHandleDetailWindowVisibility("Hide","Geofence");this.isIncidenceOccurrenceClickEnabled=false;this.isPOIclickEnabled=false;this.isIncidenceOccurrenceClickEnabled=false;}else if(c==="sendMessageToSingleTruck"){oSapSplMapsDataMarshal.fnHandleDetailWindowVisibility("Hide","Geofence");this.isIncidenceOccurrenceClickEnabled=false;this.isTruckClickEnabled=false;this.isPOIclickEnabled=false;this.isGeofenceClickEnabled=false;}}else if(a==="Unblock"){this.oMapToolbar.setEnabled(true);oSapSplMapsDataMarshal.fnChangeCursor("normal");startStopPollingOfParkingSpace("start",this.oMapToolbar.getMapFilterInstance().getMapFilterControlInstance());this.oMapToolbar.getContentLeft()[1].setEnabled(true);this.oMapToolbar.getContentLeft()[3].setEnabled(true);this.isIncidenceOccurrenceClickEnabled=true;this.isTruckClickEnabled=true;this.isGeofenceClickEnabled=true;this.isPOIclickEnabled=true;this.isSelectMultipleTrucksEnabled=false;this.isSelectMultipleGeofencesEnabled=false;this.byId("addGeofenceButton").setEnabled(true);this.byId("addPointOfInterestButton").setEnabled(true);this.byId("oContactBusinessPartnerButton").setEnabled(true);this.byId("oSendMessageToTruckButton").setEnabled(true);}else{jQuery.sap.log.error("Block-Unblock","invalid arguments","liveApp.controller.js");}},fnPreventEnableMapRefresh:function(m){if(m==="Prevent"){this.isTruckDataPollingEnabled=false;this.isIncidenceOccurrenceDataPollingEnabled=false;}else if(m==="Enable"){this.isTruckDataPollingEnabled=true;this.isIncidenceOccurrenceDataPollingEnabled=true;}},getPopoverOpeningDirection:function(c,C){var p={};var w=jQuery(window).width();if(c>w*0.5){p.placement="Left";p.x=c+jQuery(".oPopoverAnchorButton").width();p.y=C;}else{p.placement="Right";p.x=c;p.y=C;}return p;},fnGetScreenCoordinateFromEventObject:function(e){var a=JSON.parse(e.getParameter("data")).Action;var A=a.AddActionProperties.AddActionProperty;var p=a.Params.Param;var c={},i;var P=p.length;var o=A.length;for(i=0;i<P;i++){if(p[i]["name"]==="x"){c["x"]=parseInt(p[i]["#"],10);}else if(p[i]["name"]==="y"){c["y"]=parseInt(p[i]["#"],10);}else if(p[i]["name"]==="handle"){c["handle"]=p[i]["#"];}else if(p[i]["name"]==="edge"){c["edge"]=p[i]["#"];}}for(i=0;i<o;i++){if(A[i]["name"]==="pos"){c["position"]=A[i]["#"];}}return c;},fnHandleDeleteOfGateAndUpdateModel:function(g,s){var m=sap.ui.getCore().getModel("sapSplLocationCreateEditDialogModel").getData(),G=[],i;if(m["GeofenceGates"]["results"].length>0){G=m["GeofenceGates"]["results"];for(i=0;i<G.length;i++){if(G[i]["GateUUID"]===g){G[i]["deleted"]=true;var S=G[i]["GateUUID"].split("+").join("").split("/").join("").split("?").join("").split("%").join("").split("#").join("").split("&").join("").split("=").join("");jQuery("."+S).hide();if(this.oSapSplLocationCreateEditDialogInstance){this.oSapSplLocationCreateEditDialogInstance.getContent()[0].getContent()[0].getController().handleDeletionOfGateOnTheMap(G.splice(i,1)[0]);}}}}sap.ui.getCore().getModel("sapSplLocationCreateEditDialogModel").setData(m);},fnInsertPointInsideEdge:function(p){var t=this;var g;var l=sap.ui.getCore().getModel("sapSplLocationCreateEditDialogModel").getData();var L=l["locationGeoCoords"];var e=parseInt(p["edge"],10)+1;var w=oSapSplMapsDataMarshal.fnCheckPointWithinGate(l["GeofenceGates"].results,L[e%L.length]);var W=oSapSplMapsDataMarshal.fnCheckPointWithinGate(l["GeofenceGates"].results,L[e-1]);var I=false;for(var i=0;i<w.length;i++){for(var j=0;j<W.length;j++){if(w[i]["GateUUID"]===W[j]["GateUUID"]){I=true;g=w[i]["GateUUID"];break;}}}if(I){var c=oSapSplUtils.getBundle().getText("LOCATION_POINT_INSERT_CONFIRMATION");sap.m.MessageBox.show(c,sap.m.MessageBox.Icon.WARNING,oSapSplUtils.getBundle().getText("WARNING"),[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],function(b){jQuery(".sapUiBLy").css("z-index","0");if(b==="OK"){t.fnHandleDeleteOfGateAndUpdateModel(g,false);var C=p["position"].split(";");var o={"long":parseFloat(C[0],10),"lat":parseFloat(C[1],10),"alt":parseFloat(C[2],10)};l.locationGeoCoords.splice(e,0,o);if(l.isRadar==="1"&&(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["canViewRulesWithoutTour"]!==1)&&this._bMessageStripInsertedToLocationEditDialog===false&&sap.ui.getCore().byId($(".SplCreateEditLocationDialogNavContainer").attr("id")).getCurrentPage().sId.search("Home")!==-1){this._bMessageStripInsertedToLocationEditDialog=true;sap.ui.getCore().byId($(".SplCreateEditLocationDialogNavContainer").attr("id")).getCurrentPage().insertContent(new sap.m.MessageStrip({text:"{splI18NModel>EDIT_GEOFENCE_SHAPE_WARNING}",showCloseButton:false,showIcon:true,type:"Warning"}).addStyleClass("sapUiSmallMarginTopBottom").addStyleClass("sapUiSmallMarginBeginEnd"),"0");l.shapeChanged=true;}sap.ui.getCore().getModel("sapSplLocationCreateEditDialogModel").setData(l);var s=t.fnCordinateArrayToCordinateString(l.locationGeoCoords);var a=oSapSplMapsDataMarshal.convertStringToGeoJSON(s);l.Geometry=JSON.stringify(a);oSapSplMapsDataMarshal.fnEditFences(l,t.byId("oSapSplLiveAppMap"));sap.ui.getCore().byId($(".sapSplValueHelpForGates").attr("id")).setValue(splReusable.libs.SapSplModelFormatters.getGatesName(l["GeofenceGates"]["results"]));}});}else{var C=p["position"].split(";");var o={"long":parseFloat(C[0],10),"lat":parseFloat(C[1],10),"alt":parseFloat(C[2],10)};l.locationGeoCoords.splice(e,0,o);if(l.isRadar==="1"&&(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["canViewRulesWithoutTour"]!==1)&&this._bMessageStripInsertedToLocationEditDialog===false&&sap.ui.getCore().byId($(".SplCreateEditLocationDialogNavContainer").attr("id")).getCurrentPage().sId.search("Home")!==-1){this._bMessageStripInsertedToLocationEditDialog=true;sap.ui.getCore().byId($(".SplCreateEditLocationDialogNavContainer").attr("id")).getCurrentPage().insertContent(new sap.m.MessageStrip({text:"{splI18NModel>EDIT_GEOFENCE_SHAPE_WARNING}",showCloseButton:false,showIcon:true,type:"Warning"}).addStyleClass("sapUiSmallMarginTopBottom").addStyleClass("sapUiSmallMarginBeginEnd"),"0");l.shapeChanged=true;}sap.ui.getCore().getModel("sapSplLocationCreateEditDialogModel").setData(l);var s=this.fnCordinateArrayToCordinateString(l.locationGeoCoords);var a=oSapSplMapsDataMarshal.convertStringToGeoJSON(s);l.Geometry=JSON.stringify(a);oSapSplMapsDataMarshal.fnEditFences(l,this.byId("oSapSplLiveAppMap"));}},fnRemovePointFromArea:function(p){var t=this,c="";var l=sap.ui.getCore().getModel("sapSplLocationCreateEditDialogModel");var m=l.getData();var L=m["locationGeoCoords"];var I=parseInt(p["handle"],10);var w=oSapSplMapsDataMarshal.fnCheckPointWithinGate(m["GeofenceGates"].results,L[I]);if(w.length>0){c=oSapSplUtils.getBundle().getText("LOCATION_POINT_DELETE_CONFIRMATION");sap.m.MessageBox.show(c,sap.m.MessageBox.Icon.WARNING,oSapSplUtils.getBundle().getText("WARNING"),[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],function(s){jQuery(".sapUiBLy").css("z-index","0");if(s==="OK"){for(var i=0;i<w.length;i++){t.fnHandleDeleteOfGateAndUpdateModel(w[i]["GateUUID"],false);}L.splice(I,1);m["locationGeoCoords"]=L;m["Geometry"]=JSON.stringify(oSapSplMapsDataMarshal.convertStringToGeoJSON(t.fnCordinateArrayToCordinateString(L)));if(m.isRadar==="1"&&(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["canViewRulesWithoutTour"]!==1)&&this._bMessageStripInsertedToLocationEditDialog===false&&sap.ui.getCore().byId($(".SplCreateEditLocationDialogNavContainer").attr("id")).getCurrentPage().sId.search("Home")!==-1){this._bMessageStripInsertedToLocationEditDialog=true;sap.ui.getCore().byId($(".SplCreateEditLocationDialogNavContainer").attr("id")).getCurrentPage().insertContent(new sap.m.MessageStrip({text:"{splI18NModel>EDIT_GEOFENCE_SHAPE_WARNING}",showCloseButton:false,showIcon:true,type:"Warning"}).addStyleClass("sapUiSmallMarginTopBottom").addStyleClass("sapUiSmallMarginBeginEnd"),"0");m.shapeChanged=true;}l.setData(m);oSapSplMapsDataMarshal.fnEditFences(m,t.byId("oSapSplLiveAppMap"));sap.ui.getCore().byId($(".sapSplValueHelpForGates").attr("id")).setValue(splReusable.libs.SapSplModelFormatters.getGatesName(m["GeofenceGates"]["results"]));}});}else{L.splice(I,1);m["locationGeoCoords"]=L;if(L.length===0){m["Geometry"]=JSON.stringify({type:"Polygon",coordinates:[[]]});}else{m["Geometry"]=JSON.stringify(oSapSplMapsDataMarshal.convertStringToGeoJSON(t.fnCordinateArrayToCordinateString(L)));}if(m.isRadar==="1"&&(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["canViewRulesWithoutTour"]!==1)&&this._bMessageStripInsertedToLocationEditDialog===false&&sap.ui.getCore().byId($(".SplCreateEditLocationDialogNavContainer").attr("id")).getCurrentPage().sId.search("Home")!==-1){this._bMessageStripInsertedToLocationEditDialog=true;sap.ui.getCore().byId($(".SplCreateEditLocationDialogNavContainer").attr("id")).getCurrentPage().insertContent(new sap.m.MessageStrip({text:"{splI18NModel>EDIT_GEOFENCE_SHAPE_WARNING}",showCloseButton:false,showIcon:true,type:"Warning"}).addStyleClass("sapUiSmallMarginTopBottom").addStyleClass("sapUiSmallMarginBeginEnd"),"0");m.shapeChanged=true;}l.setData(m);oSapSplMapsDataMarshal.fnEditFences(m,t.byId("oSapSplLiveAppMap"));}sap.ui.getCore().byId($(".sapSplValueHelpForGates").attr("id")).setValue(splReusable.libs.SapSplModelFormatters.getGatesName(m["GeofenceGates"]["results"]));},fnOpenContextMenu:function(p,c){var t=this;var C;var P=this.fnGetPopoverOffsets();var o=new sap.m.ResponsivePopover({offsetX:parseInt(p["x"]+P["x"],10),offsetY:parseInt(p["y"]+P["y"],10),showHeader:false,modal:false}).addStyleClass("mapContextMenu");if(c["contextName"]==="AreaEdgeClick"){C=new sap.m.Button({text:oSapSplUtils.getBundle().getText("ADD_POINT"),icon:"sap-icon://add",iconDensityAware:true,press:function(){c["fnCallback"].call(t,p);this.getParent().close();}}).addStyleClass("contextMenuButton").addStyleClass("contextMenuButtonAdd");o.addStyleClass("mapContextMenuAdd");}else if(c["contextName"]==="AreaHandlerClick"){C=new sap.m.Button({text:oSapSplUtils.getBundle().getText("DELETE_POINT"),icon:"sap-icon://delete",iconDensityAware:true,press:function(){c["fnCallback"].call(t,p);this.getParent().close();}}).addStyleClass("contextMenuButton").addStyleClass("contextMenuButtonDelete");o.addStyleClass("mapContextMenuDelete");}o.addContent(C);o.openBy(this.byId("oPopoverAnchorButton"));},fnHandleContextMenu:function(e){var E=JSON.parse(e.getParameter("data")),c=null;if(E.Action.name==="EDGE_RIGHT_CLICK_GEOFENCE_AREA"){c={"contextName":"AreaEdgeClick","fnCallback":this.fnInsertPointInsideEdge};this.fnOpenContextMenu(this.fnGetScreenCoordinateFromEventObject(e),c);}else if(E.Action.name==="RIGHT_CLICK_GEOFENCE_AREA_HANDLER"){c={"contextName":"AreaHandlerClick","fnCallback":this.fnRemovePointFromArea};this.fnOpenContextMenu(this.fnGetScreenCoordinateFromEventObject(e),c);}},fnHandleZoomEventOnTheMap:function(e){this.iPrevZoom=this.byId("oSapSplLiveAppMap").zoom;oSapSplMapsDataMarshal.fnGetMapZoom(this.byId("oSapSplLiveAppMap"),e);this.iCurZoom=this.byId("oSapSplLiveAppMap").zoom;if(this.bCanChangeVOIcon("Truck")===true){for(var t=0;t<this.aTruckArray.length;t++){if(this.aTruckArray[t]){oSapSplMapsDataMarshal.fnShowTruckFlags(this.aTruckArray[t],this.byId("oSapSplLiveAppMap"),this.isTruckLabelVisible);}}}if(this.bCanChangeVOIcon("Other")===true){for(var i=0;i<this.aIncidenceOccuranceData.length;i++){if(this.aIncidenceOccuranceData[i]){oSapSplMapsDataMarshal.fnShowIncidenceFlags(this.aIncidenceOccuranceData[i],this.byId("oSapSplLiveAppMap"));}}for(var l=0;l<this.aSelectedLocationObjectsFromLeftPanel.length;l++){if(this.aSelectedLocationObjectsFromLeftPanel[l]&&(this.aSelectedLocationObjectsFromLeftPanel[l]["Tag"]!=="LC0004"&&this.aSelectedLocationObjectsFromLeftPanel[l]["Tag"]!=="LC0008")){oSapSplMapsDataMarshal.fnShowPointOfInterestFlags(this.aSelectedLocationObjectsFromLeftPanel[l],this.byId("oSapSplLiveAppMap"));}}}},fnLiveAppMapZoomPanEvent:function(e){jQuery.sap.log.info("zoom object",e,"liveApp.controller.js");if(this.oMapToolbar.getContentLeft()[2].getText()!==oSapSplUtils.getBundle().getText("SELECT_DISPLAY_AREA")){this.sDisplayAreaText=this.oMapToolbar.getContentLeft()[2].getText();}if(JSON.parse(e.getParameters().data).Data!==undefined){this.oMapToolbar.getContentLeft()[2].setText(oSapSplUtils.getBundle().getText("SELECT_DISPLAY_AREA"));}},fnGetBoundingRectangle:function(){var t=this.byId("oSapSplLiveAppMap").min;var b=this.byId("oSapSplLiveAppMap").max;var a=t.split(";")[0]+";"+b.split(";")[1]+";0";var c=b.split(";")[0]+";"+t.split(";")[1]+";0";var d=t+";"+a+";"+b+";"+c;return d;},fnHandleClickOfClusterVO:function(e,c){var b=[],I=null,l=[],f=null,t=this,x=0,y=0,p=null,o={};I=JSON.parse(e.getParameter("data")).Action.instance;l=e.getSource().getInfoForCluster(I,1);e=jQuery.extend(true,{},e);f="/MyLocations?$select=LocationID,Name,Tag,Geometry,ReportedStatus&$filter=";if(c==="POI"){for(var i=0;i<l.length;i++){f+="("+encodeURIComponent("LocationID eq "+"X"+"\'"+oSapSplUtils.base64ToHex(l[i].split(".")[1])+"\'")+")";if(i!==l.length-1){f+="or";}}b.push(this.oSapSplApplModel.createBatchOperation(f,"GET"));this.oSapSplApplModel.addBatchReadOperations(b);sap.ui.getCore().byId("splView.liveApp.liveApp--oSapSplLiveAppPage").setBusy(true);this.oSapSplApplModel.submitBatch(function(d){sap.ui.getCore().byId("splView.liveApp.liveApp--oSapSplLiveAppPage").setBusy(false);p=t.fnGetPopoverOffsets();if(JSON.parse(e.getParameter("data")).Action.Params.Param[0].name==="x"){x=parseInt(JSON.parse(e.getParameter("data")).Action.Params.Param[0]["#"],10);x+=p["x"];x=parseInt(x,10);}else{jQuery.sap.log.error("fnHandleClickOfClusterVO","Failure of function call","liveApp.controller.js");}if(JSON.parse(e.getParameter("data")).Action.Params.Param[1].name==="y"){y=parseInt(JSON.parse(e.getParameter("data")).Action.Params.Param[1]["#"],10);y+=p["y"];y=parseInt(y,10);}else{jQuery.sap.log.error("fnHandleClickOfClusterVO","Failure of function call","liveApp.controller.js");}o["PositionObject"]=t.getPopoverOpeningDirection(x,y);o["Data"]=d.__batchResponses[0].data.results;o["Title"]=oSapSplUtils.getBundle().getText("POI_CLUSTER_POPOVER_TITLE",d.__batchResponses[0].data.results.length);this.oClusterObjectsPopOver=sap.ui.xmlfragment("clusterObjectsFragment","splReusable.fragments.ClusterObjectsList",t).addStyleClass("clusterObjectsFragmentClass");this.oClusterObjectsPopOver.setModel(new sap.ui.model.json.JSONModel(o)).openBy(t.byId("oPopoverAnchorButton")).attachAfterClose(function(e){e.getSource().destroy();}).attachAfterOpen(function(){if(parseInt(this.$().find(".sapMPopoverCont").css("height"),10)>400){this.setContentHeight("400px");}});},function(){sap.ui.getCore().byId("splView.liveApp.liveApp--oSapSplLiveAppPage").setBusy(false);});}else if(c==="Truck"){var a=[],_=[];f="/VehiclePositions?$select=DeviceUUID,RegistrationNumber,TourName,Position,ReportedTime,isTruckRunningLate&$filter=";if(oSapSplUtils.getFromQueryParameterMap("xx-sap-spl-fallback")==="true"){f="/VehiclePositions?$select=DeviceUUID,RegistrationNumber,TourName,Position,ReportedTime,isTruckRunningLate&$filter=";for(i=0;i<l.length;i++){f+="("+encodeURIComponent("DeviceUUID eq "+"X"+"\'"+oSapSplUtils.base64ToHex(l[i].split(".")[1])+"\'")+")";if(i!==l.length-1){f+="or";}}b.push(this.oSapSplApplModel.createBatchOperation(f,"GET"));this.oSapSplApplModel.addBatchReadOperations(b);sap.ui.getCore().byId("splView.liveApp.liveApp--oSapSplLiveAppPage").setBusy(true);this.oSapSplApplModel.submitBatch(function(d){sap.ui.getCore().byId("splView.liveApp.liveApp--oSapSplLiveAppPage").setBusy(false);p=t.fnGetPopoverOffsets();if(JSON.parse(e.getParameter("data")).Action.Params.Param[0].name==="x"){x=parseInt(JSON.parse(e.getParameter("data")).Action.Params.Param[0]["#"],10);x+=p["x"];x=parseInt(x,10);}else{jQuery.sap.log.error("fnHandleClickOfClusterVO","Failure of function call","liveApp.controller.js");}if(JSON.parse(e.getParameter("data")).Action.Params.Param[1].name==="y"){y=parseInt(JSON.parse(e.getParameter("data")).Action.Params.Param[1]["#"],10);y+=p["y"];y=parseInt(y,10);}else{jQuery.sap.log.error("fnHandleClickOfClusterVO","Failure of function call","liveApp.controller.js");}o["PositionObject"]=t.getPopoverOpeningDirection(x,y);o["Data"]=d.__batchResponses[0].data.results;o["Title"]=oSapSplUtils.getBundle().getText("TRUCK_CLUSTER_POPOVER_TITLE",d.__batchResponses[0].data.results.length);this.oClusterObjectsPopOver=sap.ui.xmlfragment("clusterObjectsTrucksFragment","splReusable.fragments.ClusterObjectsListForTrucks",t).addStyleClass("clusterObjectsFragmentClass");this.oClusterObjectsPopOver.setModel(new sap.ui.model.json.JSONModel(o)).openBy(t.byId("oPopoverAnchorButton")).attachAfterClose(function(e){e.getSource().destroy();}).attachAfterOpen(function(){if(parseInt(this.$().find(".sapMPopoverCont").css("height"),10)>400){this.setContentHeight("400px");}});},function(){sap.ui.getCore().byId("splView.liveApp.liveApp--oSapSplLiveAppPage").setBusy(false);});}else{for(i=0;i<l.length;i++){a.push(l[i].split(".")[1]);}sap.ui.getCore().byId("splView.liveApp.liveApp--oSapSplLiveAppPage").setBusy(true);(function(d){_=d.getTruckDetailsFromDeviceUUIDProxy.readArray(d,a);sap.ui.getCore().byId("splView.liveApp.liveApp--oSapSplLiveAppPage").setBusy(false);p=t.fnGetPopoverOffsets();if(JSON.parse(e.getParameter("data")).Action.Params.Param[0].name==="x"){x=parseInt(JSON.parse(e.getParameter("data")).Action.Params.Param[0]["#"],10);x+=p["x"];x=parseInt(x,10);}else{jQuery.sap.log.error("fnHandleClickOfClusterVO","Failure of function call","liveApp.controller.js");}if(JSON.parse(e.getParameter("data")).Action.Params.Param[1].name==="y"){y=parseInt(JSON.parse(e.getParameter("data")).Action.Params.Param[1]["#"],10);y+=p["y"];y=parseInt(y,10);}else{jQuery.sap.log.error("fnHandleClickOfClusterVO","Failure of function call","liveApp.controller.js");}o["PositionObject"]=t.getPopoverOpeningDirection(x,y);o["Data"]=_["Data"];o["Title"]=oSapSplUtils.getBundle().getText("TRUCK_CLUSTER_POPOVER_TITLE",_["Data"].length);this.oClusterObjectsPopOver=sap.ui.xmlfragment("clusterObjectsTrucksFragment","splReusable.fragments.ClusterObjectsListForTrucks",t).addStyleClass("clusterObjectsFragmentClass");this.oClusterObjectsPopOver.setModel(new sap.ui.model.json.JSONModel(o)).openBy(t.byId("oPopoverAnchorButton")).attachAfterClose(function(e){e.getSource().destroy();}).attachAfterOpen(function(){if(parseInt(this.$().find(".sapMPopoverCont").css("height"),10)>400){this.setContentHeight("400px");}});sap.ui.getCore().byId("splView.liveApp.liveApp--oSapSplLiveAppPage").setBusy(false);}(this));}}},fnHandleClickOfClusterObjectTruckListItem:function(e){var d=e.getParameters().listItem.getBindingContext().getObject();var p=e.getSource().getModel().getData().PositionObject;e.getParameters().listItem.getParent().getParent().close();var t=this;if(oSapSplUtils.getFromQueryParameterMap("xx-sap-spl-fallback")==="true"){this.getTruckDetailsFromDeviceUUID(d["DeviceUUID"],function(d){var T=d.results[0];T.x=p["x"];T.y=p["y"];T.placement=p["placement"];T.introduceFooterZoomInButton=true;T.zoomInButtonHandler=jQuery.proxy(this.fnHandleZoomIntoCLusterObject,this);T.fromLabel=true;this.showTruckDetailsPopover(T);},function(){jQuery.sap.log.error("SAP SPL Live App Controller","Error while fetching truck details from UUID","SAPSPL");});}else{this.getTruckDetailsFromDeviceUUIDProxy.read(this,d["DeviceUUID"],function(d){var T=d.results[0];T.x=p["x"];T.y=p["y"];T.placement=p["placement"];T.introduceFooterZoomInButton=true;T.zoomInButtonHandler=jQuery.proxy(t.fnHandleZoomIntoCLusterObject,t);T.fromLabel=true;t.showTruckDetailsPopover(T);},function(){});}},fnHandleClickOfClusterObjectListItem:function(e){var d=e.getParameters().listItem.getBindingContext().getObject();var p=e.getSource().getModel().getData().PositionObject;d["x"]=p["x"];d["y"]=p["y"];d["placement"]=p["placement"];e.getParameters().listItem.getParent().getParent().close();this.fnLeftPaneToMapInterface(d,"Cluster",jQuery.proxy(this.fnHandleZoomIntoCLusterObject,this));},fnHandleZoomIntoCLusterObject:function(d,p,P){var z=17;var c=d[P].split(";");if(d[P].length===c[0].length){c=oSapSplMapsDataMarshal.convertGeoJSONToString(JSON.parse(d[P])).split(";");}this.byId("oSapSplLiveAppMap").zoomToGeoPosition(parseFloat(c[0],10),parseFloat(c[1],10),z);p.close();},fnEventHandler:function(e){if(this.oTruckDetailsPopOver){this.oTruckDetailsPopOver.destroy();}if(this.oIncidenceOccurrenceDetailsPopOver){this.oIncidenceOccurrenceDetailsPopOver.destroy();}if(this.oLocationDetailsPopOver){this.oLocationDetailsPopOver.destroy();}if(JSON.parse(e.getParameter("data")).Action.object==="Map"){this.fnHandleLocationCreationOnMap(e,"mapClick");}else if(JSON.parse(e.getParameter("data")).Action.object==="FLAG"){this.fnHandleLocationCreationOnMap(e,"flagClick");}else if(JSON.parse(e.getParameter("data")).Action.object==="GeoFenceArea"&&this.isGeofenceClickEnabled){this.fnHandleClickOnVisualObjects();this.fnHandleGeofenceAreaClick(e);}else if(JSON.parse(e.getParameter("data")).Action.object==="PoIFlag"&&this.isPOIclickEnabled){this.fnHandleClickOnVisualObjects();this.fnHandleLocationDetailsDisplay(e);}else if(JSON.parse(e.getParameter("data")).Action.object==="TruckFlag"&&this.isTruckClickEnabled){this.fnHandleClickOnVisualObjects();this.fnHandleTruckFlagClick(e);}else if(JSON.parse(e.getParameter("data")).Action.object==="IncidentFlag"&&this.isIncidenceOccurrenceClickEnabled){this.fnHandleClickOnVisualObjects();this.handleIncidenceOccurrencePopover(e);}else if(JSON.parse(e.getParameter("data")).Action.name==="ZOOM_EVENT"){this.fnLiveAppMapZoomPanEvent(e);this.fnHandleZoomEventOnTheMap(e);}else if(JSON.parse(e.getParameter("data")).Action.name==="CENTERCHANGED_EVENT"){this.fnLiveAppMapZoomPanEvent(e);oSapSplMapsDataMarshal.fnGetMapCenter(this.byId("oSapSplLiveAppMap"),e);}else if(JSON.parse(e.getParameter("data")).Action.name==="CLICK_POINT_GEOFENCE_TEMP_GATE"){this.fnHandleGeofenceGateClick(e);}else if(JSON.parse(e.getParameter("data")).Action.name==="ATTRIBUTE_CHANGED"){this.fnHandleLocationEditOnMap(e);}else if(JSON.parse(e.getParameter("data")).Action.name==="EDGE_RIGHT_CLICK_GEOFENCE_AREA"){this.fnHandleContextMenu(e);}else if(JSON.parse(e.getParameter("data")).Action.name==="RIGHT_CLICK_GEOFENCE_AREA_HANDLER"){this.fnHandleContextMenu(e);}else if(JSON.parse(e.getParameter("data")).Action.name==="CLICK_POI_CLUSTER"){this.fnHandleClickOfClusterVO(e,"POI");}else if(JSON.parse(e.getParameter("data")).Action.name==="CLICK_TRUCK_NORMAL_CLUSTER"||JSON.parse(e.getParameter("data")).Action.name==="CLICK_TRUCK_ORDER_CLUSTER"||JSON.parse(e.getParameter("data")).Action.name==="CLICK_TRUCK_ISSUE_CLUSTER"){this.fnHandleClickOfClusterVO(e,"Truck");}},bCanChangeVOIcon:function(t){function g(z){if(z<=6){return 1;}else if(z<=12){return 2;}else{return 3;}}function a(z){if(z<=10){return 1;}else{return 2;}}if(t==="Truck"){if(a(this.iCurZoom)===a(this.iPrevZoom)){return false;}else{return true;}}else{if(g(this.iCurZoom)===g(this.iPrevZoom)){return false;}else{return true;}}},fnRefreshLabels:function(){if(this.isGeofenceLabelVisible){oSapSplMapsDataMarshal.fnHandleDetailWindowVisibility("Show","Geofence");}else{oSapSplMapsDataMarshal.fnHandleDetailWindowVisibility("Hide","Geofence");}},fnLabelToggleControlToMapInterface:function(l){if(l["Trucks"]===true){this.isTruckLabelVisible=null;oSapSplMapsDataMarshal.fnHandleDetailWindowVisibility("Show","Trucks");}else{this.isTruckLabelVisible="noLabel";oSapSplMapsDataMarshal.fnHandleDetailWindowVisibility("Hide","Trucks");}for(var i=0;i<this.aTruckArray.length;i++){if(this.aTruckArray[i]){oSapSplMapsDataMarshal.fnShowTruckFlags(this.aTruckArray[i],this.byId("oSapSplLiveAppMap"),this.isTruckLabelVisible);}}if(l["Geofence"]!==undefined){if(l["Geofence"]===true){this.isGeofenceLabelVisible=true;oSapSplMapsDataMarshal.fnHandleDetailWindowVisibility("Show","Geofence");}else{this.isGeofenceLabelVisible=false;oSapSplMapsDataMarshal.fnHandleDetailWindowVisibility("Hide","Geofence");}}},openDetailWindow:function(e){var t=this;if(JSON.parse(e.getParameter("id"))["isTypeTruck"]){oSapSplMapsDataMarshal.fnAddTruckDetailWindowContent(e,function(d){d["fromLabel"]=true;t.fnHandleTruckFlagClick(d);t.fnHandleClickOnVisualObjects();},t.byId("oSapSplLiveAppMap"),this.isTruckLabelVisible);}else if(JSON.parse(e.getParameter("id"))["isTypeGate"]){oSapSplMapsDataMarshal.fnAddGateDetailWindowContent(e,function(){},t.byId("oSapSplLiveAppMap"));}else{oSapSplMapsDataMarshal.fnAddDetailWindowContent(e,function(d){t.getLocationDetailsFromLocationID(d["LocationID"],d["Tag"],function(r){var D=oSapSplMapsDataMarshal.fnGetPointFromPolygon(oSapSplMapsDataMarshal.convertGeoJSONToString(JSON.parse(r.results[0]["Geometry"])));r.results[0]["sDetailWindowPosition"]=D;t.fnHandleLocationDetailsDisplay(r.results[0]);},function(){});},t.byId("oSapSplLiveAppMap"),t.isGeofenceLabelVisible);}},fnInstantiateToolbar:function(){var t=this;var T={searchFieldVisible:false,advancedSearchVisible:false,parentControllerInstance:this,feedlistVisible:true,toolbarEventHandler:jQuery.proxy(this.fnToolbarEventHandler,this),mapFilters:[{name:"Layers",icon:"sap-icon://dimension",visible:false},{name:"Others",icon:"sap-icon://map",visible:false},{name:"Map",icon:"sap-icon://map-2",visible:false}],parkingSpaceFilters:[{name:oSapSplUtils.getBundle().getText("CARDS_PARKING_SPACE_LABEL"),visible:true},{name:oSapSplUtils.getBundle().getText("FUEL_PARKING_SPACE_LABEL"),visible:true},{name:oSapSplUtils.getBundle().getText("SERVICES_PARKING_SPACE_LABEL"),visible:true}],feedFilters:[{name:"All",icon:"All",visible:true},{name:"HPA",icon:"sap-icon://action",visible:true},{name:"Traffic",icon:"sap-icon://badge",visible:true},{name:"Truck",icon:"sap-icon://shipping-status",visible:true},{name:"Orders",icon:"sap-icon://database",visible:true},{name:"Bupa",icon:"sap-icon://org-chart",visible:true}],mapInstance:this.byId("oSapSplLiveAppMap"),pageInstance:this.byId("oSapSplLiveAppPage")};if(this.oMapToolbar){this.oMapToolbar.destroy();}else{this.oMapToolbar=new splReusable.libs.SapSplMapToolbar(T);this.oMapToolbar.addFeedlistControl();this.byId("oSapSplLiveAppPage").setCustomHeader(this.oMapToolbar);}this.oMapToolbar.setMapFilterCallback(function(s){t.showTrucksOnMap();t.showIncidenceOccurrencesOnMap();if(s){t.aSelectedLocationObjectsFromLeftPanel=s;}});},fnGetDataForLiveAppSearch:function(I,e,s,E){var f="";if(e==="MyLocations"){f="$filter=("+encodeURIComponent(I)+")";}else{f="$filter=("+encodeURIComponent(I)+")";}oSapSplBusyDialog.getBusyDialogInstance().open();this.oSapSplApplModel.read("/"+e,null,[f],false,jQuery.proxy(s,this),jQuery.proxy(E,this));oSapSplBusyDialog.getBusyDialogInstance().close();jQuery(".sapUiBLy").css("z-index","0");},fnSearchToMapInterface:function(m,s){var l="";var t="";var I="";var L="";if(m==="clear"){this.fnPreventEnableMapRefresh("Prevent");oSapSplMapsDataMarshal.fnRemoveVOsOnMap("All",this.byId("oSapSplLiveAppMap"));oSapSplMapsDataMarshal.fnHandleDetailWindowVisibility("Hide","All");}else if(m==="show"){oSapSplMapsDataMarshal.fnRemoveVOsOnMap("All",this.byId("oSapSplLiveAppMap"));oSapSplMapsDataMarshal.fnHandleDetailWindowVisibility("Hide","All");for(var i=0;i<s.length;i++){if(s[i]["ObjectInfo"]["ObjectType"]==="Location"){l+="LocationID eq "+"X"+"\'"+oSapSplUtils.base64ToHex(s[i]["ObjectInfo"]["ObjectKey"])+"\' or ";}else if(s[i]["ObjectInfo"]["ObjectType"]==="Message"){I+="UUID eq "+"X"+"\'"+oSapSplUtils.base64ToHex(s[i]["ObjectInfo"]["ObjectKey"])+"\' or ";}else if(s[i]["ObjectInfo"]["ObjectType"]==="TrackableObject"){t+="DeviceUUID eq "+"X"+"\'"+oSapSplUtils.base64ToHex(s[i]["ObjectInfo"]["DeviceUUID"])+"\' or ";}}if(l!==""){L=l.slice(-3);if(L==="or "){l=l.substring(0,l.length-4);}this.fnGetDataForLiveAppSearch(l,"MyLocations",function(r){var a=[];for(var i=0;i<r.results.length;i++){if(r.results[i].Geometry){a.push(r.results[i]);}}oSapSplMapsDataMarshal.fnShowVOsOnMap(a,this.byId("oSapSplLiveAppMap"));if(r.results.length===1){oSapSplMapsDataMarshal.fnPanToEntity(this.byId("oSapSplLiveAppMap"),r.results[0]);}},function(){jQuery.sap.log.error("getLocationDetailsFromLocationID","read failed","liveApp.controller.js");});}if(t!==""){L=t.slice(-3);if(L==="or "){t=t.substring(0,t.length-4);}this.fnGetDataForLiveAppSearch(t,"VehiclePositions",function(r){for(var i=0;i<r.results.length;i++){if(r.results[i]){oSapSplMapsDataMarshal.fnShowTruckFlags(r.results[i],this.byId("oSapSplLiveAppMap"),null);}}if(r.results.length===1){oSapSplMapsDataMarshal.fnPanToEntity(this.byId("oSapSplLiveAppMap"),r.results[0]);}},function(){jQuery.sap.log.error("getTruckDetailsFromDeviceUUID","read failed","liveApp.controller.js");});}if(I!==""){L=I.slice(-3);if(L==="or "){I=I.substring(0,I.length-4);}this.fnGetDataForLiveAppSearch(I,"OccurredIncidents",function(r){for(var i=0;i<r.results.length;i++){oSapSplMapsDataMarshal.fnShowIncidenceFlags(r.results[i],this.byId("oSapSplLiveAppMap"));}if(r.results.length===1){oSapSplMapsDataMarshal.fnPanToEntity(this.byId("oSapSplLiveAppMap"),r.results[0]);}},function(){jQuery.sap.log.error("getIncidentDetailsFromUUID","read failed","liveApp.controller.js");});}}else if(m==="reset"){this.fnPreventEnableMapRefresh("Enable");this.fnShowAllVisualObjectsOnMap("PlotLocally");this.fnRefreshLabels();}else{jQuery.sap.log.error("fnSearchToMapInterface","invalid argument","liveApp.controller.js");}},feedlistToMapInterface:function(U,e){var t=this;function i(r){var c=oSapSplMapsDataMarshal.convertGeoJSONToString(JSON.parse(r.results[0]["SourceLocation"]));oSapSplMapsDataMarshal.fnPanTo(t.byId("oSapSplLiveAppMap"),c);var C=oSapSplMapsDataMarshal.convertGeoCoordToScreenCoord(c,t.byId("oSapSplLiveAppMap"));var p=t.fnGetPopoverOffsets("fromMap");r.results[0].x=parseInt(C["left"]+p["x"],10);r.results[0].y=parseInt(C["top"]+p["y"],10);r.results[0].fromFeedlist=true;t.handleIncidenceOccurrencePopover(r.results[0]);}function I(){jQuery.sap.log.error("Incident data","read failed","liveApp.controller.js");}function T(r){var c=oSapSplMapsDataMarshal.convertGeoJSONToString(JSON.parse(r.results[0]["Position"]));oSapSplMapsDataMarshal.fnPanTo(t.byId("oSapSplLiveAppMap"),c);var C=oSapSplMapsDataMarshal.convertGeoCoordToScreenCoord(c,t.byId("oSapSplLiveAppMap"));var p=t.fnGetPopoverOffsets("fromMap");r.results[0].x=parseInt(C["left"]+p["x"],10);r.results[0].y=parseInt(C["top"]+p["y"],10);r.results[0].placement="Auto";r.results[0].fromFeedlist=true;t.showTruckDetailsPopover(r.results[0]);}function f(){jQuery.sap.log.error("Truck position","read failed","liveApp.controller.js");}if(this.oTruckDetailsPopOver){this.oTruckDetailsPopOver.destroy();}if(this.oIncidenceOccurrenceDetailsPopOver){this.oIncidenceOccurrenceDetailsPopOver.destroy();}if(e==="Incidents"){this.getIncidentDetailsFromUUID(U,i,I);}else if(e==="Trucks"){this.getTruckDetailsFromDeviceUUID(U,T,f);}},fnCordinateStringToCordinateArray:function(c){var C=c.split(";");var a=[];var o={};for(var i=0;i<C.length;i++){if(i%3===0){o={};o["long"]=parseFloat(C[i],10);}else if(i%3===1){o["lat"]=parseFloat(C[i],10);}else if(i%3===2){o["alt"]=parseFloat(C[i],10);a.push(o);}}return a;},fnCordinateArrayToCordinateString:function(c){var C="";for(var i=0;i<c.length;i++){C+=c[i]["long"]+";"+c[i]["lat"]+";"+c[i]["alt"]+";";}var l=C.slice(-1);if(l===";"){C=C.substring(0,C.length-1);}return C;},fnHandleLocationEdit:function(e){var t=this;this.fnPreventEnableMapRefresh("Prevent");oSapSplMapsDataMarshal.fnChangeCursor("pencil");var l=e.getSource().getParent().getParent().getModel().getData();l["locationGeoCoords"]=this.fnCordinateStringToCordinateArray(oSapSplMapsDataMarshal.convertGeoJSONToString(JSON.parse(l["Geometry"])));l["showGates"]=true;oSapSplMapsDataMarshal.fnHandleDetailWindowVisibility("Hide","Geofence");e.getSource().getParent().getParent().close();splReusable.libs.SapSplStyleSheetLoader.loadStyle("./resources/styles/sapSplCreateEditLocationDialog");if(!this.oSapSplLocationCreateEditDialogInstance){sap.ui.getCore().setModel(new sap.ui.model.json.JSONModel(),"sapSplLocationCreateEditDialogModel");var s=sap.ui.view({viewName:"splView.dialogs.SplCreateEditLocationDialog",type:sap.ui.core.mvc.ViewType.XML,viewData:[l["Tag"],"Edit",jQuery.extend(true,{},l),t]}).setModel(sap.ui.getCore().getModel("sapSplLocationCreateEditDialogModel")).addStyleClass("sapSplLocationCreateDialogContainerView");var L=new sap.m.Button({text:oSapSplUtils.getBundle().getText("OK"),press:jQuery.proxy(s.getController().handlePressOfDialogOK,s.getController())});var r=new sap.m.Button({text:oSapSplUtils.getBundle().getText("CANCEL"),press:jQuery.proxy(s.getController().handlePressOfDialogCancel,s.getController())});s.getController().setLiveAppControllerInstance(this);this.oSapSplLocationCreateEditDialogInstance=new sap.m.Dialog({beginButton:L,endButton:r,showHeader:false,content:new sap.ui.commons.layout.VerticalLayout().addStyleClass("viewHolderLayout").addContent(s)}).addStyleClass("SplLocationCreateEditDialog").addStyleClass("sapSplHideDialog");this.oSapSplLocationCreateEditDialogInstance.attachAfterClose(function(){t.fnShowAllVisualObjectsOnMap("plotSelected");t.fnPreventEnableMapRefresh("Enable");t.fnBlockUnblockLiveAppUI("Unblock");t.oSapSplLocationCreateEditDialogInstance=null;t._bMessageStripInsertedToLocationEditDialog=false;});this.oSapSplLocationCreateEditDialogInstance.attachAfterOpen(function(){oSapSplUtils.fnSyncStyleClass(t.oSapSplLocationCreateEditDialogInstance);t._bMessageStripInsertedToLocationEditDialog=false;});this.oSapSplLocationCreateEditDialogInstance.addEventDelegate({onAfterRendering:function(e){t.fnHandleDialogMove(e.srcControl);t.fnHandleDialogPositioning(e.srcControl);}});}l["edgeToGateMap"]=this.fnGetEdgeToGateMap(l);sap.ui.getCore().getModel("sapSplLocationCreateEditDialogModel").setData(l);this.oSapSplLocationCreateEditDialogInstance.open();$(".sapUiBliLy").addClass('splReduceDivHeight');this.aRenderedDialogs.push("viewHolderLayout");this.fnBlockUnblockLiveAppUI("Block","addGeofence");oSapSplMapsDataMarshal.fnHandleDetailWindowVisibility("Show","Gates");},fnUpdateGatesDataInLocationEditMode:function(){var m=null,e=[],E=[],g=[];function o(a,G){G["GateGeometry"]=a["GateGeometry"];return G;}m=sap.ui.getCore().getModel("sapSplLocationCreateEditDialogModel").getData();e=m["edgeToGateMap"];E=oSapSplMapsDataMarshal.getEdgesFromGeofence(m,this.byId("oSapSplLiveAppMap"));g=m["GeofenceGates"]["results"];for(var i=0;i<g.length;i++){for(var j=0;j<e.length;j++){if(e[j]["resultsIndex"]===i){var c=e[j]["index"];g[i]=o(E[c],g[i]);}}}m["GeofenceGates"]["results"]=g;if(m.isRadar==="1"&&(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["canViewRulesWithoutTour"]!==1)&&this._bMessageStripInsertedToLocationEditDialog===false&&sap.ui.getCore().byId($(".SplCreateEditLocationDialogNavContainer").attr("id")).getCurrentPage().sId.search("Home")!==-1){this._bMessageStripInsertedToLocationEditDialog=true;sap.ui.getCore().byId($(".SplCreateEditLocationDialogNavContainer").attr("id")).getCurrentPage().insertContent(new sap.m.MessageStrip({text:"{splI18NModel>EDIT_GEOFENCE_SHAPE_WARNING}",showCloseButton:false,showIcon:true,type:"Warning"}).addStyleClass("sapUiSmallMarginTopBottom").addStyleClass("sapUiSmallMarginBeginEnd"),"0");m.shapeChanged=true;}sap.ui.getCore().getModel("sapSplLocationCreateEditDialogModel").setData(m);},fnHandleLocationEditOnMap:function(e){var i=0;var j=0;var m={};for(j=0;j<JSON.parse(e.getParameter("data")).Data.Merge.N.length;j++){if(JSON.parse(e.getParameter("data")).Data.Merge.N[j].name==="GeoFenceAreas"){for(i=0;i<JSON.parse(e.getParameter("data")).Data.Merge.N[j].E.length;i++){if(JSON.parse(e.getParameter("data")).Data.Merge.N[j].E[i]["H"]){m=sap.ui.getCore().getModel("sapSplLocationCreateEditDialogModel").getData();m["locationGeoCoords"]=this.fnCordinateStringToCordinateArray(JSON.parse(e.getParameter("data")).Data.Merge.N[j].E[i]["H"]);m["Geometry"]=JSON.stringify(oSapSplMapsDataMarshal.convertStringToGeoJSON(JSON.parse(e.getParameter("data")).Data.Merge.N[j].E[i]["H"]));sap.ui.getCore().getModel("sapSplLocationCreateEditDialogModel").setData(m);this.fnUpdateGatesDataInLocationEditMode();}}}else if(JSON.parse(e.getParameter("data")).Data.Merge.N[j].name==="PointOfInterestFlags"){for(i=0;i<JSON.parse(e.getParameter("data")).Data.Merge.N[j].E.length;i++){if(JSON.parse(e.getParameter("data")).Data.Merge.N[j].E[i]["VB:s"]&&JSON.parse(e.getParameter("data")).Data.Merge.N[j].E[i]["VB:s"]==="true"){if(sap.ui.getCore().getModel("sapSplLocationCreateEditDialogModel")){m=sap.ui.getCore().getModel("sapSplLocationCreateEditDialogModel").getData();m["locationGeoCoords"]=this.fnCordinateStringToCordinateArray(JSON.parse(e.getParameter("data")).Data.Merge.N[j].E[i]["position"]);sap.ui.getCore().getModel("sapSplLocationCreateEditDialogModel").setData(m);}if(sap.ui.getCore().getModel("sapSplCreateParkingSpaceModel")){m=sap.ui.getCore().getModel("sapSplCreateParkingSpaceModel").getData();m["Longitude"]=JSON.parse(e.getParameter("data")).Data.Merge.N[j].E[i]["position"].split(";")[0];m["Latitude"]=JSON.parse(e.getParameter("data")).Data.Merge.N[j].E[i]["position"].split(";")[1];sap.ui.getCore().getModel("sapSplCreateParkingSpaceModel").setData(m);}}}}}},fnHandleLocationCreationOnMap:function(e,m){var t=this;if(m==="mapClick"){for(var i=0;i<JSON.parse(e.getParameter("data")).Action.AddActionProperties.AddActionProperty.length;i++){if(JSON.parse(e.getParameter("data")).Action.AddActionProperties.AddActionProperty[i].name==="pos"){var c=JSON.parse(e.getParameter("data")).Action.AddActionProperties.AddActionProperty[i]["#"];if(this.sLocationType==="LC0004"||this.sLocationType==="LC0008"){oSapSplUtils.setIsDirty(true);oSapSplMapsDataMarshal.fnCreateLine(c,e,this.getView().byId("oSapSplLiveAppMap"));}else if(this.sLocationType==="LC0002"||this.sLocationType==="LC0003"||this.sLocationType==="LC0007"){oSapSplUtils.setIsDirty(true);oSapSplMapsDataMarshal.fnChangeCursor("normal");this.fnPreventEnableMapRefresh("Enable");this.byId("sapSplLocationCreateCancelButton").setVisible(false);this.byId("sapSplTrafficStatusFooter").removeStyleClass("sapSplHiddenBar");oSapSplMapsDataMarshal.fnCreatePointOfInterestFlag(c,this.getView().byId("oSapSplLiveAppMap"),function(d){t.handleCreateParkingDialog(d);},this.sLocationType);oSapSplMapsDataMarshal.fnResetValues(this.getView().byId("oSapSplLiveAppMap"));}else{oSapSplMapsDataMarshal.fnChangeCursor("normal");this.fnPreventEnableMapRefresh("Enable");this.byId("sapSplLocationCreateCancelButton").setVisible(false);this.byId("sapSplTrafficStatusFooter").removeStyleClass("sapSplHiddenBar");oSapSplMapsDataMarshal.fnCreatePointOfInterestFlag(c,this.getView().byId("oSapSplLiveAppMap"),function(d){t.fnInstantiateAndOpenCreateLocationDialog(d);},this.sLocationType);oSapSplMapsDataMarshal.fnResetValues(this.getView().byId("oSapSplLiveAppMap"));}}}}else if(m==="flagClick"){if(JSON.parse(e.getParameter("data")).Action.instance==="Flags.0"){oSapSplMapsDataMarshal.fnChangeCursor("normal");this.fnPreventEnableMapRefresh("Enable");this.byId("sapSplLocationCreateCancelButton").setVisible(false);this.byId("sapSplTrafficStatusFooter").removeStyleClass("sapSplHiddenBar");oSapSplMapsDataMarshal.fnCreatePolygon(this.getView().byId("oSapSplLiveAppMap"),function(d){t.fnInstantiateAndOpenCreateLocationDialog(d);});oSapSplMapsDataMarshal.fnResetValues(this.getView().byId("oSapSplLiveAppMap"));}}else{jQuery.sap.log.error("Invalid argument","sMode","liveApp.controller.js");}},fnCompareLineStrings:function(t,f){var i,T,F,a,b;T=oSapSplMapsDataMarshal.convertGeoJSONToString(JSON.parse(t["GateGeometry"]));F=oSapSplMapsDataMarshal.convertGeoJSONToString(JSON.parse(f["GateGeometry"]));a=T.split(";");b=F.split(";");if(((a[0]===b[0])&&(a[1]===b[1])&&(a[3]===b[3])&&(a[4]===b[4]))||((a[0]===b[3])&&(a[1]===b[4])&&(a[3]===b[0])&&(a[4]===b[1]))){i=true;}return i;},fnGetEdgeToGateMap:function(l){var g=[];if(l["Tag"]==="LC0001"){return g;}var f=oSapSplMapsDataMarshal.getEdgesFromGeofence(l,this.byId("oSapSplLiveAppMap"));var G=l["GeofenceGates"]["results"];for(var i=0;i<f.length;i++){for(var j=0;j<G.length;j++){var a=this.fnCompareLineStrings(f[i],G[j]);if(a){var I={};I["index"]=i;I["resultsIndex"]=j;g.push(I);}}}return g;},fnHandleGeofenceGateSelectionMode:function(t){var g=[];var I={};var i;var j;oSapSplMapsDataMarshal.fnShowFences(t,this.byId("oSapSplLiveAppMap"),"onFocus");if(t["GeofenceGates"]!==undefined&&t["GeofenceGates"]!==null){for(i=0;i<t["GeofenceGates"]["results"].length;i++){oSapSplMapsDataMarshal.fnShowGates(t["GeofenceGates"]["results"][i],this.byId("oSapSplLiveAppMap"));}}var f=oSapSplMapsDataMarshal.getEdgesFromGeofence(t,this.byId("oSapSplLiveAppMap"));for(i=0;i<f.length;i++){for(j=0;j<t["GeofenceGates"]["results"].length;j++){var a=this.fnCompareLineStrings(f[i],t["GeofenceGates"]["results"][j]);if(a){I["index"]=i;I["resultsIndex"]=j;g.push(I);}}}for(i=0;i<f.length;i++){oSapSplMapsDataMarshal.fnShowGates(f[i],this.byId("oSapSplLiveAppMap"),"tempGate");}},fnHandleGeofenceGateClick:function(e){var E=JSON.parse(e.getParameter("data"));var g=parseInt(E.Action.instance.split(".")[2],10);var m=sap.ui.getCore().getModel("sapSplLocationCreateEditDialogModel").getData();var G=oSapSplMapsDataMarshal.convertGeoJSONToString(JSON.parse(m["Geometry"]));var a=G.split(";0.0;");a.push(a[0]);var s=a[g];var b=a[g+1];var S=parseFloat(s.split(";")[0],10);var f=parseFloat(s.split(";")[1],10);var c=parseFloat(b.split(";")[0],10);var d=parseFloat(b.split(";")[1],10);var h=S+";"+f+";0.0;"+c+";"+d+";0.0";var F={};F["Name"]="";F["GateGeometry"]=JSON.stringify(oSapSplMapsDataMarshal.convertStringToGeoJSON(h));F["GateUUID"]=E.Action.instance.split(".")[1]+"."+E.Action.instance.split(".")[2];this.fnHandleGeofenceGateSelectionMode(m);oSapSplMapsDataMarshal.fnShowGates(F,this.byId("oSapSplLiveAppMap"),"tempGate","selected");if(this.oSapSplLocationCreateEditDialogInstance){this.oSapSplLocationCreateEditDialogInstance.getContent()[0].getContent()[0].getController().handleClickOfGateOnTheMap(F["GateGeometry"]);}},fnHandleTruckFlagClick:function(e){var t=this;var s=[];var T={};if(e["fromLabel"]===true){if(this.isSelectMultipleTrucksEnabled){if(oSapSplUtils.getFromQueryParameterMap("xx-sap-spl-fallback")==="true"){this.getTruckDetailsFromDeviceUUID(e["DeviceUUID"],function(r){oSapSplBusyDialog.getBusyDialogInstance().close();T=r.results[0];},function(){jQuery.sap.log.error("fnHandleTruckFlagClick","Failure of function call","liveApp.controller.js");});}else{this.getTruckDetailsFromDeviceUUIDProxy.read(this,e["DeviceUUID"],function(r){oSapSplBusyDialog.getBusyDialogInstance().close();T=r.results[0];},function(a){});}oSapSplMapsDataMarshal.fnSelectDeselectTrucks(T,this.byId("oSapSplLiveAppMap"),function(r){s.length=0;for(var i=0;i<r.length;i++){var o={};o["ID"]=r[i]["DeviceUUID"];o["Position"]=r[i]["Position"];o["TourName"]=r[i]["TourName"];if(r[i]["RegistrationNumber"]===null){o["Reg"]=oSapSplUtils.getBundle().getText("TRUCK");}else{o["Reg"]=r[i]["RegistrationNumber"];}s.push(o);}t.oSendMessageDialogView.getController().fnHandleClickOfTrucksOnTheMap(s);});}else{if(oSapSplUtils.getFromQueryParameterMap("xx-sap-spl-fallback")==="true"){this.getTruckDetailsFromDeviceUUID(e["DeviceUUID"],function(r){oSapSplBusyDialog.getBusyDialogInstance().close();T=r.results[0];},function(a){jQuery.sap.log.error("fnHandleTruckFlagClick","Failure of function call","liveApp.controller.js");});this.getTruckDetailsFromDeviceUUID(e["DeviceUUID"],function(r){oSapSplBusyDialog.getBusyDialogInstance().close();var c=oSapSplMapsDataMarshal.convertGeoJSONToString(JSON.parse(r.results[0]["Position"]));var C=oSapSplMapsDataMarshal.convertGeoCoordToScreenCoord(c,t.byId("oSapSplLiveAppMap"));var p=t.fnGetPopoverOffsets("fromMap");r.results[0].x=parseInt(C["left"]+p["x"],10);r.results[0].y=parseInt(C["top"]+p["y"],10);r.results[0].fromLabel=true;this.showTruckDetailsPopover(r.results[0]);},function(){jQuery.sap.log.error("fnHandleTruckFlagClick","Failure of function call","liveApp.controller.js");});}else{this.getTruckDetailsFromDeviceUUIDProxy.read(this,e["DeviceUUID"],function(r){oSapSplBusyDialog.getBusyDialogInstance().close();T=r.results[0];},function(a){});this.getTruckDetailsFromDeviceUUIDProxy.read(this,e["DeviceUUID"],function(r){oSapSplBusyDialog.getBusyDialogInstance().close();var c=oSapSplMapsDataMarshal.convertGeoJSONToString(JSON.parse(r.results[0]["Position"]));var C=oSapSplMapsDataMarshal.convertGeoCoordToScreenCoord(c,t.byId("oSapSplLiveAppMap"));var p=t.fnGetPopoverOffsets("fromMap");r.results[0].x=parseInt(C["left"]+p["x"],10);r.results[0].y=parseInt(C["top"]+p["y"],10);r.results[0].fromLabel=true;this.showTruckDetailsPopover(r.results[0]);},function(){jQuery.sap.log.error("fnHandleTruckFlagClick","Failure of function call","liveApp.controller.js");});}}}else{if(this.isSelectMultipleTrucksEnabled){s=[];T={};if(oSapSplUtils.getFromQueryParameterMap("xx-sap-spl-fallback")==="true"){this.getTruckDetailsFromDeviceUUID(JSON.parse(e.getParameter("data")).Action.instance.split(".")[1],function(r){oSapSplBusyDialog.getBusyDialogInstance().close();T=r.results[0];},function(){jQuery.sap.log.error("fnHandleTruckFlagClick","Failure of function call","liveApp.controller.js");});}else{this.getTruckDetailsFromDeviceUUIDProxy.read(this,JSON.parse(e.getParameter("data")).Action.instance.split(".")[1],function(r){oSapSplBusyDialog.getBusyDialogInstance().close();T=r.results[0];},function(){jQuery.sap.log.error("fnHandleTruckFlagClick","Failure of function call","liveApp.controller.js");});}oSapSplMapsDataMarshal.fnSelectDeselectTrucks(T,this.byId("oSapSplLiveAppMap"),function(r){s.length=0;for(var i=0;i<r.length;i++){var o={};o["ID"]=r[i]["DeviceUUID"];o["Position"]=r[i]["Position"];o["TourName"]=r[i]["TourName"];if(r[i]["RegistrationNumber"]===null){o["Reg"]=oSapSplUtils.getBundle().getText("TRUCK");}else{o["Reg"]=r[i]["RegistrationNumber"];}s.push(o);}t.oSendMessageDialogView.getController().fnHandleClickOfTrucksOnTheMap(s);});}else{this.showTruckDetailsPopover(e);}}},fnHandleGeofenceAreaClick:function(e){if(this.isSelectMultipleGeofencesEnabled){this.getLocationDetailsFromLocationID(JSON.parse(e.getParameter("data")).Action.instance.split(".")[1],"LC0004",function(r){this.handleSelectDeselectFence(r.results[0]);},function(){jQuery.sap.log.error("fnHandleGeofenceAreaClick","Failure of function call","liveApp.controller.js");},false);}else{this.fnHandleLocationDetailsDisplay(e);}},fnHandleNavigationToManageToursApp:function(v){var n="splView.managetours.ManageToursContainer";var N=null;if(!sap.ui.getCore().byId("sapSplBaseApplication").getPage(n)){N=sap.ui.view({viewName:n,id:n,type:sap.ui.core.mvc.ViewType.XML});N.addEventDelegate({onBeforeShow:jQuery.proxy(N.getController().onBeforeShow,N.getController())});sap.ui.getCore().byId("sapSplBaseApplication").addPage(N);}var o={};o["FromApp"]="liveApp";o["VehicleUUID"]=v;oSplBaseApplication.getAppInstance().to(n,"slide",o);},fnHandleNavigationToReportingApp:function(){var n="splView.reporting.ReportingSpl";var N=null;if(!sap.ui.getCore().byId("sapSplBaseApplication").getPage(n)){N=sap.ui.view({viewName:n,id:n,type:sap.ui.core.mvc.ViewType.XML});N.addEventDelegate({onBeforeShow:jQuery.proxy(N.getController().onBeforeShow,N.getController())});sap.ui.getCore().byId("sapSplBaseApplication").addPage(N);}var o=sap.ui.getCore().getModel("splViewEditLocationModel").getData();o["fromApp"]="liveApp";oSplBaseApplication.getAppInstance().to(n,"slide",o);},fnHandleFetchOfIncidentsAssigned:function(e){var l=e.getSource().getModel().getData();if(l.bFetchedIncidents!==true){sap.ui.core.Fragment.byId("locationFragment","sapSplIncidentsAssignedToTheLocationPanel").setBusy(true);this.getLocationDetailsFromLocationID(l.LocationID,l.Tag,function(d){sap.ui.core.Fragment.byId("locationFragment","sapSplIncidentsAssignedToTheLocationPanel").setBusy(false);var D=this.getSource().getModel().getData();D.bFetchedIncidents=true;D["Incidents"]=d;this.getSource().getModel().setData(D);}.bind(jQuery.extend(true,{},e)),function(){jQuery.sap.log.error("fnHandleLocationDetailsDisplay","Failure of function call","liveApp.controller.js");},false,"Incidents",true);}},fnHandleFetchOfGatesAssigned:function(e){var l=e.getSource().getModel().getData();if(l.bFetchedgates!==true){sap.ui.core.Fragment.byId("locationFragment","sapSplLocationGatesPanel").setBusy(true);this.getLocationDetailsFromLocationID(l.LocationID,l.Tag,function(d){sap.ui.core.Fragment.byId("locationFragment","sapSplLocationGatesPanel").setBusy(false);var D=this.getSource().getModel().getData();D.bFetchedgates=true;D["GeofenceGates"]=d;this.getSource().getModel().setData(D);}.bind(jQuery.extend(true,{},e)),function(){jQuery.sap.log.error("fnHandleLocationDetailsDisplay","Failure of function call","liveApp.controller.js");},false,"GeofenceGates",true);}},fnHandleFetchOfItemsToTour:function(e){var t=e.getSource().getModel().getData();if(t.bFetchedItems!==true){sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplTruckDetailWindowTourItemsPanel").setBusy(true);this.getLocationDetailsFromLocationID(t.UUID,"Truck",function(d){sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplTruckDetailWindowTourItemsPanel").setBusy(false);var D=this.getSource().getModel().getData();D.bFetchedItems=true;D["Items"]=d.results;this.getSource().getModel().setData(D);}.bind(jQuery.extend(true,{},e)),function(){jQuery.sap.log.error("fnHandleLocationDetailsDisplay","Failure of function call","liveApp.controller.js");},false,"StopItemAssignment",true,"VehiclePositions");}},fnHandleNavigationIntoItemDetails:function(e){var n=sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplTruckDetailsNavContainer"),m=null,d=null;n.to(n.getPages()[1].sId);m=e.getSource().getModel();d=m.getData();d["stopItemDetails"]=e.getSource().getBindingContext().getObject();m.setData(d);},fnHandleBackNavigationFromTruckItemsPage:function(e){sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplTruckDetailsNavContainer").back();},fnHandleDisplayOflocations:function(l){if(this.oPopOver){this.oPopOver.destroy();}var t=this;this.oPopOver=sap.ui.xmlfragment("locationFragment","splReusable.fragments.ViewEditLocation",this).addStyleClass("locationFragmentClass");var L=new sap.ui.model.json.JSONModel(l);l["GeofenceGates"]={results:[]};l["Incidents"]={results:[]};sap.ui.getCore().setModel(L,"splViewEditLocationModel");this.oPopOver.setModel(sap.ui.getCore().getModel("splViewEditLocationModel"));sap.ui.core.Fragment.byId("locationFragment","splLocationCreatedOn").setText(oSapSplUtils.getBundle().getText("LOCATION_CREATED_ON_LABEL"));sap.ui.core.Fragment.byId("locationFragment","splLocationGeoCoords").setText(oSapSplUtils.getBundle().getText("LOCATION_GEO_COORDINATES_LABEL"));sap.ui.core.Fragment.byId("locationFragment","splLocationAddressLabel").setText(oSapSplUtils.getBundle().getText("ADDRESS_LABEL"));sap.ui.core.Fragment.byId("locationFragment","splBtnEdit").setText(oSapSplUtils.getBundle().getText("MY_COLLEAGUES_EDIT_BUTTON"));sap.ui.core.Fragment.byId("locationFragment","splBtnDelete").setText(oSapSplUtils.getBundle().getText("INCIDENTS_FOOTER_DELETE"));if(l["isEditable"]===0){sap.ui.core.Fragment.byId("locationFragment","splBtnEdit").setEnabled(false);sap.ui.core.Fragment.byId("locationFragment","splBtnDelete").setEnabled(false);}else{sap.ui.core.Fragment.byId("locationFragment","splBtnEdit").setEnabled(true);sap.ui.core.Fragment.byId("locationFragment","splBtnDelete").setEnabled(true);}if(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["isIncidentEditable"]===0){sap.ui.core.Fragment.byId("locationFragment","sapSplIncidentsAssignedToTheLocationPanel").setVisible(false);}else{if(splReusable.libs.SapSplModelFormatters.getVisibilityBasedOnType(l["Type"])){sap.ui.core.Fragment.byId("locationFragment","sapSplIncidentsAssignedToTheLocationPanel").setVisible(true);}else{sap.ui.core.Fragment.byId("locationFragment","sapSplIncidentsAssignedToTheLocationPanel").setVisible(false);}}this.oPopOver.attachAfterClose(function(e){e.getSource().destroy();if(l["Tag"]==="LC0001"){oSapSplMapsDataMarshal.fnShowPointOfInterestFlags(l,t.byId("oSapSplLiveAppMap"));}});this.oPopOver.attachAfterOpen(function(){if(l["introduceFooterZoomInButton"]===true){sap.ui.getCore().byId(jQuery("#"+this.sId+"-popover footer").attr("id")).insertContent(new sap.m.ToolbarSpacer(),0).insertContent(new sap.m.Button({text:oSapSplUtils.getBundle().getText("ZOOM_IN_CLUSTER"),press:function(e){l["zoomInButtonHandler"](l,e.getSource().getParent().getParent().getParent(),"Geometry");}},0));}if(l["isEditable"]===0){this.focus();}});setTimeout(function(){t.oPopOver.openBy(t.byId("oPopoverAnchorButton"));},500);},fnHandlePressOfViewTrackingStatusLink:function(e){var n=sap.ui.core.Fragment.byId("locationFragment","sapSplLocationDetailsNavContainer"),m=null;n.to(n.getPages()[1].sId);m=e.getSource().getModel();sap.ui.core.Fragment.byId("locationFragment","sapSplTrackingStatusTable").setBusy(true);this.getLocationDetailsFromLocationID(m.getData()["LocationID"],m.getData()["Tag"],function(r){sap.ui.core.Fragment.byId("locationFragment","sapSplTrackingStatusTable").setBusy(false);var M=m.getData();M["status"]=r.results;m.setData(M);},function(E){jQuery.sap.log.error("fnHandleLocationDetailsDisplay","Failure of function call","liveApp.controller.js");},false,"StatusOfRadars",true);},fnHandleBackNavigationFromTrackingPage:function(){sap.ui.core.Fragment.byId("locationFragment","sapSplLocationDetailsNavContainer").back();},fnHandleChangeOfContainerTerminalStatus:function(){},fnHandleChangeOfParkingSpaceStatus:function(e){var t=this;var k=e.getParameters().selectedItem.getKey();var E=e.getSource();var p={"FacilityAvailability":[{"FacilityUUID":sap.ui.getCore().getModel("splParkingSpaceDetailsPopOverModel").getData()["FacilityUUID"],"ReportedStatus":k,"ModeOfStatusUpdate":sap.ui.getCore().getModel("splParkingSpaceDetailsPopOverModel").getData()["ModeOfStatusUpdate"],"StatusProvider":sap.ui.getCore().getModel("splParkingSpaceDetailsPopOverModel").getData()["StatusProvider"]}]};oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getServiceMetadata("parkingSpaceStatus",true),method:"PUT",data:JSON.stringify(p),success:function(){E.removeStyleClass("parkingAvailable");E.removeStyleClass("parkingFastFilling");E.removeStyleClass("parkingFull");E.removeStyleClass("containerTerminalServiceNotPossible");E.removeStyleClass("containerTerminalServiceWithDelay");E.removeStyleClass("containerTerminalServicing");E.removeStyleClass("containerTerminalOutsideWorkHours");var a={};var m=sap.ui.getCore().getModel("splParkingSpaceDetailsPopOverModel").getData();a=jQuery.extend({},m);a["Geometry"]=JSON.stringify(oSapSplMapsDataMarshal.convertStringToGeoJSON(m["Geometry"]));a["ReportedStatus"]=k;oSapSplMapsDataMarshal.fnShowPointOfInterestFlags(a,t.byId("oSapSplLiveAppMap"));if(k==="1"){E.addStyleClass("parkingAvailable");}else if(k==="2"){E.addStyleClass("parkingFastFilling");}else if(k==="3"){E.addStyleClass("parkingFull");}else if(k==="4"){E.addStyleClass("containerTerminalServiceNotPossible");}else if(k==="5"){E.addStyleClass("containerTerminalServiceWithDelay");}else if(k==="6"){E.addStyleClass("containerTerminalServicing");}else if(k==="7"){E.addStyleClass("containerTerminalOutsideWorkHours");}for(var i=0;i<t.aSelectedLocationObjectsFromLeftPanel.length;i++){if(t.aSelectedLocationObjectsFromLeftPanel[i]["LocationID"]===m["LocationID"]){t.aSelectedLocationObjectsFromLeftPanel[i]["ReportedStatus"]=k;break;}}},error:function(){jQuery.sap.log.error("fnHandleChangeOfParkingSpaceStatus","Failure of function call","liveApp.controller.js");}});},getParkingSpaceStatusEnum:function(){var p=[];oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/utils/services/utils.xsodata/")+"Enumeration('FacilityAvailabilityStatus')/Values?$format=json",method:"GET",async:false,json:true,success:function(d){p=d.d.results;},error:function(){}});return p;},getContainerTerminalStatusEnum:function(m){var c=[],u;if(m==="M"){u=oSapSplUtils.getFQServiceUrl("/sap/spl/xs/utils/services/utils.xsodata/")+"Enumeration('ContainerTerminalAvailabilityStatus')/Values?$format=json&$filter=(Value ne '8')";}else{u=oSapSplUtils.getFQServiceUrl("/sap/spl/xs/utils/services/utils.xsodata/")+"Enumeration('ContainerTerminalAvailabilityStatus')/Values?$format=json";}oSapSplAjaxFactory.fireAjaxCall({url:u,method:"GET",async:false,json:true,success:function(d){c=d.d.results;},error:function(){}});return c;},getContainerTerminalStatusListEnum:function(){var c=[];oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/utils/services/utils.xsodata/")+"Enumeration('ModeOfStatusUpdate')/Values?$format=json",method:"GET",async:false,json:true,success:function(d){c=d.d.results;},error:function(){}});return c;},parkingSpaceDisplayHandler:function(p){splReusable.libs.SapSplStyleSheetLoader.loadStyle("./resources/styles/sapSplParkingSpaceDetailsPopOver");var t=this;if(!this.aParkingSpaceStatusEnum){this.aParkingSpaceStatusEnum=this.getParkingSpaceStatusEnum();}if(p["ImageUrl"]===""){p["ImageUrl"]="./resources/icons/parking_default_image_placeholder.png";p["bDefaultImage"]=true;}p["Geometry"]=oSapSplMapsDataMarshal.convertGeoJSONToString(JSON.parse(p["Geometry"]));p["texts"]={cards_text:oSapSplUtils.getBundle().getText("CARDS_PARKING_SPACE_LABEL"),services_text:oSapSplUtils.getBundle().getText("SERVICES_PARKING_SPACE_LABEL"),fuel_text:oSapSplUtils.getBundle().getText("FUEL_PARKING_SPACE_LABEL"),address:oSapSplUtils.getBundle().getText("ADDRESS_LABEL"),phone:oSapSplUtils.getBundle().getText("TELEPHONE"),website:oSapSplUtils.getBundle().getText("WEBSITE_PARKING_SPACE_LABEL"),total_space:oSapSplUtils.getBundle().getText("TOTAL_SPACES_PARKING_SPACE_LABEL"),availability:oSapSplUtils.getBundle().getText("PARKING_AVAILABILITY_STATUS"),timings:oSapSplUtils.getBundle().getText("TIMINGS_PARKING_SPACE_LABEL")};p["ParkingSpaceStatusData"]=this.aParkingSpaceStatusEnum;if(!sap.ui.getCore().getModel("splParkingSpaceDetailsPopOverModel")){sap.ui.getCore().setModel(new sap.ui.model.json.JSONModel(p),"splParkingSpaceDetailsPopOverModel");}else{sap.ui.getCore().getModel("splParkingSpaceDetailsPopOverModel").setData(p);}if(this.oPopOver){this.oPopOver.destroy();}this.oPopOver=sap.ui.xmlfragment("parkingSpaceDetailsFragment","splReusable.fragments.ParkingSpaceDetails",this);this.oPopOver.setModel(sap.ui.getCore().getModel("splParkingSpaceDetailsPopOverModel"));sap.ui.core.Fragment.byId("parkingSpaceDetailsFragment","sapSplPointOfInterestOccupancyLayout").setWidths(["70px"]);if(p["introduceFooterZoomInButton"]===true){this.oPopOver.getContent()[0].getFooter().addContentLeft(new sap.m.Button({text:oSapSplUtils.getBundle().getText("ZOOM_IN_CLUSTER"),press:function(e){p["zoomInButtonHandler"](p,e.getSource().getParent().getParent().getParent(),"Geometry");}}));}if(p["isEditable"]===0){sap.ui.core.Fragment.byId("parkingSpaceDetailsFragment","splBtnEdit").setEnabled(false);sap.ui.core.Fragment.byId("parkingSpaceDetailsFragment","splBtnDelete").setEnabled(false);sap.ui.core.Fragment.byId("parkingSpaceDetailsFragment","sapSplParkingSpaceStatusSelect").setEnabled(false);}sap.ui.core.Fragment.byId("parkingSpaceDetailsFragment","sapSplOccupancyContainerTerminal").setVisible(false);sap.ui.core.Fragment.byId("parkingSpaceDetailsFragment","sapSplParkingSpaceStatusSelect").addEventDelegate({onAfterRendering:function(e){e.srcControl.removeStyleClass("parkingAvailable");e.srcControl.removeStyleClass("parkingFastFilling");e.srcControl.removeStyleClass("parkingFull");var k=e.srcControl.getSelectedKey();if(k==="1"){e.srcControl.addStyleClass("parkingAvailable");}else if(k==="2"){e.srcControl.addStyleClass("parkingFastFilling");}else{e.srcControl.addStyleClass("parkingFull");}}});this.oPopOver.attachAfterClose(function(e){e.getSource().destroy();p["Geometry"]=JSON.stringify(oSapSplMapsDataMarshal.convertStringToGeoJSON(p["Geometry"]));oSapSplMapsDataMarshal.fnShowPointOfInterestFlags(p,t.byId("oSapSplLiveAppMap"));});setTimeout(function(){t.oPopOver.openBy(t.byId("oPopoverAnchorButton"));},500);},fnContainerTerminalDisplayHandler:function(c){splReusable.libs.SapSplStyleSheetLoader.loadStyle("./resources/styles/sapSplParkingSpaceDetailsPopOver");var t=this;if(c.ModeOfStatusUpdate==="A"){if(!this.aContainerTerminalStatusAutomaticEnum){this.aContainerTerminalStatusAutomaticEnum=this.getContainerTerminalStatusEnum(c.ModeOfStatusUpdate);}this.aContainerTerminalStatusEnum=this.aContainerTerminalStatusAutomaticEnum;}else{if(!this.aContainerTerminalStatusManualEnum){this.aContainerTerminalStatusManualEnum=this.getContainerTerminalStatusEnum(c.ModeOfStatusUpdate);}this.aContainerTerminalStatusEnum=this.aContainerTerminalStatusManualEnum;}if(!this.aContainerTerminalStatusListEnum){this.aContainerTerminalStatusListEnum=this.getContainerTerminalStatusListEnum();}if(c["ImageUrl"]===""){c["bDefaultImage"]=true;if(c["Tag"]==="LC0007"){c["ImageUrl"]="./resources/icons/container_depot_image_placeholder.png";}else{c["ImageUrl"]="./resources/icons/container_terminal_image_placeholder.png";}}c["Geometry"]=oSapSplMapsDataMarshal.convertGeoJSONToString(JSON.parse(c["Geometry"]));c["texts"]={cards_text:oSapSplUtils.getBundle().getText("CARDS_PARKING_SPACE_LABEL"),services_text:oSapSplUtils.getBundle().getText("SERVICES_PARKING_SPACE_LABEL"),fuel_text:oSapSplUtils.getBundle().getText("FUEL_PARKING_SPACE_LABEL"),source:oSapSplUtils.getBundle().getText("CONTAINER_TERMINAL_DEPOT_SOURCE"),status:oSapSplUtils.getBundle().getText("STATUS"),address:oSapSplUtils.getBundle().getText("ADDRESS_LABEL"),phone:oSapSplUtils.getBundle().getText("TELEPHONE"),website:oSapSplUtils.getBundle().getText("WEBSITE_PARKING_SPACE_LABEL"),total_space:oSapSplUtils.getBundle().getText("TOTAL_CONTAINER_TERMINAL_CAPACITY"),availability:oSapSplUtils.getBundle().getText("CONTAINER_AVAILABILITY_STATUS"),timings:oSapSplUtils.getBundle().getText("TIMINGS_PARKING_SPACE_LABEL")};c["ParkingSpaceStatusData"]=this.aContainerTerminalStatusEnum;c["ParkingSpaceStatusListData"]=this.aContainerTerminalStatusListEnum;if(!sap.ui.getCore().getModel("splParkingSpaceDetailsPopOverModel")){sap.ui.getCore().setModel(new sap.ui.model.json.JSONModel(c),"splParkingSpaceDetailsPopOverModel");}else{sap.ui.getCore().getModel("splParkingSpaceDetailsPopOverModel").setData(c);}if(this.oPopOver){this.oPopOver.destroy();}this.oPopOver=sap.ui.xmlfragment("parkingSpaceDetailsFragment","splReusable.fragments.ParkingSpaceDetails",this);this.oPopOver.setModel(sap.ui.getCore().getModel("splParkingSpaceDetailsPopOverModel"));sap.ui.core.Fragment.byId("parkingSpaceDetailsFragment","sapSplPointOfInterestOccupancyLayout").setWidths(["70px"]);if(c["introduceFooterZoomInButton"]===true){this.oPopOver.getContent()[0].getFooter().addContentLeft(new sap.m.Button({text:oSapSplUtils.getBundle().getText("ZOOM_IN_CLUSTER"),press:function(e){c["zoomInButtonHandler"](c,e.getSource().getParent().getParent().getParent(),"Geometry");}}));}if(c["isEditable"]===0){sap.ui.core.Fragment.byId("parkingSpaceDetailsFragment","splBtnEdit").setEnabled(false);sap.ui.core.Fragment.byId("parkingSpaceDetailsFragment","splBtnDelete").setEnabled(false);}sap.ui.core.Fragment.byId("parkingSpaceDetailsFragment","sapSplOccupancyContainer").setVisible(false);sap.ui.core.Fragment.byId("parkingSpaceDetailsFragment","sapSplOccupancyContainerAvailabilityLabel").setVisible(false);sap.ui.core.Fragment.byId("parkingSpaceDetailsFragment","sapSplOccupancyContainerAvailabilityText").setVisible(false);sap.ui.core.Fragment.byId("parkingSpaceDetailsFragment","sapSplContainerTerminalStatusSelect").addEventDelegate({onAfterRendering:function(e){e.srcControl.removeStyleClass("containerTerminalServiceNotPossible");e.srcControl.removeStyleClass("containerTerminalServiceWithDelay");e.srcControl.removeStyleClass("containerTerminalServicing");e.srcControl.removeStyleClass("containerTerminalOutsideWorkHours");if(e.srcControl.getModel().getData().ReportedStatus===null){e.srcControl.setSelectedKey("6");}var k=e.srcControl.getSelectedKey();if(k==="4"){e.srcControl.addStyleClass("containerTerminalServiceNotPossible");}else if(k==="5"){e.srcControl.addStyleClass("containerTerminalServiceWithDelay");}else if(k==="6"){e.srcControl.addStyleClass("containerTerminalServicing");}else if(k==="7"){e.srcControl.addStyleClass("containerTerminalOutsideWorkHours");}}});this.oPopOver.attachAfterClose(function(e){e.getSource().destroy();c["Geometry"]=JSON.stringify(oSapSplMapsDataMarshal.convertStringToGeoJSON(c["Geometry"]));oSapSplMapsDataMarshal.fnShowPointOfInterestFlags(c,t.byId("oSapSplLiveAppMap"));});this.oPopOver.attachAfterOpen(function(){});setTimeout(function(){t.oPopOver.openBy(t.byId("oPopoverAnchorButton"));},500);},fnHandleLocationDetailsDisplay:function(e){var p=null;if(e.sDetailWindowPosition){var c=oSapSplMapsDataMarshal.convertGeoCoordToScreenCoord(e.sDetailWindowPosition,this.byId("oSapSplLiveAppMap"));var a=this.getPopoverOpeningDirection(c["left"],c["top"]);p=this.fnGetPopoverOffsets("fromMap");e.x=parseInt(a.x+p["x"],10);e.y=parseInt(a.y+p["y"],10);e.placement=a.placement;if(this.byId("oSapSplLiveAppMap").zoom<=6){oSapSplMapsDataMarshal.fnShowPointOfInterestFlags(e,this.byId("oSapSplLiveAppMap"),"onEnlarge");}if(e["Tag"]==="LC0002"){this.parkingSpaceDisplayHandler(e);}else if(e["Tag"]==="LC0003"||e["Tag"]==="LC0007"){this.fnContainerTerminalDisplayHandler(e);}else{this.fnHandleDisplayOflocations(e);}}else{var x=0;var y=0;var t=this,E="POI";var l=JSON.parse(e.getParameter("data")).Action.instance.split(".")[1];p=this.fnGetPopoverOffsets();if(JSON.parse(e.getParameter("data")).Action.Params.Param[0].name==="x"){x=parseInt(JSON.parse(e.getParameter("data")).Action.Params.Param[0]["#"],10);x+=p["x"];x=parseInt(x,10);}else{jQuery.sap.log.error("fnHandleLocationDetailsDisplay","Failure of function call","liveApp.controller.js");}if(JSON.parse(e.getParameter("data")).Action.Params.Param[1].name==="y"){y=parseInt(JSON.parse(e.getParameter("data")).Action.Params.Param[1]["#"],10);y+=p["y"];y=parseInt(y,10);}else{jQuery.sap.log.error("fnHandleLocationDetailsDisplay","Failure of function call","liveApp.controller.js");}if(JSON.parse(e.getParameter("data")).Action.object==="GeoFenceArea"){E="LC0004";}this.getLocationDetailsFromLocationID(l,E,function(r){var a=t.getPopoverOpeningDirection(x,y);r.results[0].x=a.x;r.results[0].y=a.y;r.results[0].placement=a.placement;if((r.results[0]["Tag"]!=="LC0004"&&r.results[0]["Tag"]!=="LC0008")&&this.byId("oSapSplLiveAppMap").zoom<=6){oSapSplMapsDataMarshal.fnShowPointOfInterestFlags(r.results[0],this.byId("oSapSplLiveAppMap"),"onEnlarge");}if(r.results[0]["Tag"]==="LC0002"){this.parkingSpaceDisplayHandler(r.results[0]);}else if(r.results[0]["Tag"]==="LC0003"||r.results[0]["Tag"]==="LC0007"){this.fnContainerTerminalDisplayHandler(r.results[0]);}else{this.fnHandleDisplayOflocations(r.results[0]);}},function(){jQuery.sap.log.error("fnHandleLocationDetailsDisplay","Failure of function call","liveApp.controller.js");},false);}},fnOpenDeleteLocationConfirmationDialog:function(e){var t=this,l="",L="";l=e.getSource().getModel().getData()["Name"];if(e.getSource().getModel().getData()["Tag"]==="LC0002"||e.getSource().getModel().getData()["Tag"]==="LC0003"||e.getSource().getModel().getData()["Tag"]==="LC0007"){L="Parking Space";}else{L="Other";}this.oPopOver.close();var d=new sap.m.Dialog({showHeader:true,title:oSapSplUtils.getBundle().getText("CONFIRMATION"),beginButton:new sap.m.Button({text:oSapSplUtils.getBundle().getText("OK"),press:function(){this.getParent().close();}}),endButton:new sap.m.Button({text:oSapSplUtils.getBundle().getText("CANCEL"),press:function(){this.getParent().close();}}),type:sap.m.DialogType.Message,content:new sap.m.Text({text:oSapSplUtils.getBundle().getText("DELETE_LOCATION_CONFIRMATION",l)})});d.addCustomData(new sap.ui.core.CustomData({key:"locationType",value:L}));if((e.getSource().getModel().getData()["Tag"]==="LC0004"||e.getSource().getModel().getData()["Tag"]==="LC0008")&&e.getSource().getModel().getData().IncidentCount>0){sap.m.MessageBox.show(oSapSplUtils.getBundle().getText("MESSAGE_FOR_GEOFENCE_DELETE_WARNING"),sap.m.MessageBox.Icon.WARNING,oSapSplUtils.getBundle().getText("SPL_ERROR_WARNING_DIALOG_HEADER"),[sap.m.MessageBox.Action.OK],function(){});}else{d.open();d.attachAfterClose(function(e){if(e.getParameter("origin").getText()===oSapSplUtils.getBundle().getText("OK")){t.handleDeleteLocation(e);}});}},handleDeleteLocation:function(e){var t=this,m={},f={},a="";if(e.getSource().getCustomData()[0].getValue()==="Parking Space"){m=sap.ui.getCore().getModel("splParkingSpaceDetailsPopOverModel");}else{m=sap.ui.getCore().getModel("splViewEditLocationModel");}f=this.returnDataForDelete(m.getData());a=oSapSplUtils.getServiceMetadata("newLocation",true);oSapSplBusyDialog.getBusyDialogInstance({title:oSapSplUtils.getBundle().getText("BUSY_DIALOG_MESSAGE")}).open();oSapSplAjaxFactory.fireAjaxCall({url:a,method:"POST",data:JSON.stringify(f),success:function(r,b,x){if(r.constructor===String){r=JSON.parse(r);}if(x.status===200){if(r["Error"].length>0){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(r)["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(r)["ufErrorObject"]},function(){t.oMapToolbar.refreshMap(" ");});if(r.Header&&r.Header[0]&&r.Header[0].LocationID){delete t.selectedItems[r.Header[0].LocationID];if(t.previousFocused&&t.previousFocused.LocationID===r.Header[0].LocationID){t.previousFocused=null;}}oSapSplBusyDialog.getBusyDialogInstance().close();}else{oSapSplBusyDialog.getBusyDialogInstance().close();sap.ca.ui.message.showMessageToast(oSapSplUtils.getBundle().getText("LOCATION_DELETED_SUCCESSFULLY"));t.oMapToolbar.refreshMap(" ");}}},error:function(x,b,c){if(x){sap.ca.ui.message.showMessageBox({type:oSapSplUtils.getErrorMessagesfromErrorPayload(x.responseJSON)["messageTitle"],message:oSapSplUtils.getErrorMessagesfromErrorPayload(x.responseJSON)["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(x.responseJSON)["ufErrorObject"]});}oSapSplBusyDialog.getBusyDialogInstance().close();jQuery.sap.log.error(c,b,"MapsDetailView.controller.js");},complete:function(){oSapSplMapsDataMarshal.fnClearMap(t.byId("oSapSplLiveAppMap"));t.fnShowAllVisualObjectsOnMap();t.fnRefreshLabels();}});},returnDataForDelete:function(d){var c={"inputHasChangeMode":true,"Header":[{"LocationID":d["LocationID"],"ChangeMode":"D"}]};return c;},getChildInstance:function(){return this.getView();},onCleanUp:function(){if(this.oSendMessageBusinessPartnerParentDialog){this.oSendMessageBusinessPartnerParentDialog.destroy();}if(this.oSendMessageParentDialog){this.oSendMessageParentDialog.destroy();}if(this.oSapSplLocationCreateEditDialogInstance){this.oSapSplLocationCreateEditDialogInstance.destroy();this.oSapSplLocationCreateEditDialogInstance=null;}if(this.oSendMessageToTruckParentDialog){this.oSendMessageToTruckParentDialog.destroy();}if(this.oParkingEditDialog){this.oParkingEditDialog.destroy();}this.fnShowAllVisualObjectsOnMap();oSapSplMapsDataMarshal.fnResetValues(this.byId("oSapSplLiveAppMap"));oSapSplMapsDataMarshal.fnChangeCursor("Normal");this.fnBlockUnblockLiveAppUI("Unblock");this.byId("sapSplLocationCreateCancelButton").setVisible(false);this.byId("sapSplTrafficStatusFooter").removeStyleClass("sapSplHiddenBar");},handleSendMessageAction:function(){var t=this;var p=this.oTruckDetailsPopOver.getModel().getData();var v={Reg:p["RegistrationNumber"],ID:p["DeviceUUID"],mode:"Trucks",bAllowDelete:false};this.oTruckDetailsPopOver.close();splReusable.libs.SapSplStyleSheetLoader.loadStyle("./resources/styles/sapSplSendMessageDialog");this.oSendMessageToTruckDialogView=sap.ui.view({viewName:"splView.dialogs.SplSendMessageDialog",type:sap.ui.core.mvc.ViewType.XML,viewData:v}).addStyleClass("sendMessageDialogContainerView");this.oSendMessageToTruckParentDialog=new sap.m.Dialog({showHeader:false,content:new sap.ui.commons.layout.VerticalLayout().addStyleClass("viewHolderLayout").addContent(this.oSendMessageToTruckDialogView)}).addStyleClass("splSendMessageDialog").addStyleClass("sapSplHideDialog").open();this.aRenderedDialogs.push("viewHolderLayout");this.oSendMessageToTruckParentDialog.attachAfterOpen(function(){oSapSplUtils.fnSyncStyleClass(t.oSendMessageToTruckParentDialog);t.fnBlockUnblockLiveAppUI("Block","sendMessageToSingleTruck");t.fnPreventEnableMapRefresh("Prevent");});this.oSendMessageToTruckParentDialog.attachAfterClose(function(){t.isSelectMultipleTrucksEnabled=false;t.isSelectMultipleGeofencesEnabled=false;t.fnBlockUnblockLiveAppUI("Unblock");t.fnPreventEnableMapRefresh("Enable");oSapSplMapsDataMarshal.fnResetValues(t.byId("oSapSplLiveAppMap"));t.fnShowAllVisualObjectsOnMap("PlotLocally");});this.oSendMessageToTruckParentDialog.addEventDelegate({onAfterRendering:function(e){t.fnHandleDialogMove(e.srcControl);t.fnHandleDialogPositioning(e.srcControl);}});this.oSendMessageToTruckDialogView.getController().setParentDialogInstance(this.oSendMessageToTruckParentDialog,this);$(".sapMDialogBlockLayerInit").css("z-index","0");},fnHandleSelectOfTourForTruckAssignment:function(e){var t=this;var p={};p["Header"]=[];p["Text"]=[];p["Stop"]=[];p["Item"]=[];p["StopItemAssignment"]=[];function f(p,d){oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/app/services/tour.xsjs"),method:"PUT",async:false,data:JSON.stringify(p),success:function(a,b,m){oSapSplBusyDialog.getBusyDialogInstance().close();if(a.constructor===String){a=JSON.parse(a);}if(m["status"]===200&&a["Error"].length===0){sap.ca.ui.message.showMessageToast(oSapSplUtils.getBundle().getText("SUCCESSFUL_TOUR_ASSIGNMENT"));d.close();t.getTruckMetadata();}else{var c=oSapSplUtils.getErrorMessagesfromErrorPayload(a)["ufErrorObject"];sap.ca.ui.message.showMessageBox({type:oSapSplUtils.getErrorMessagesfromErrorPayload(a)["messageTitle"],message:oSapSplUtils.getErrorMessagesfromErrorPayload(a)["errorWarningString"],details:c});}},error:function(a){oSapSplBusyDialog.getBusyDialogInstance().close();if(a&&a["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:a["status"]+" "+a.statusText,details:a.responseText});}else{if(a.responseText.constructor===String){a.responseText=JSON.parse(a.responseText);}sap.ca.ui.message.showMessageBox({type:oSapSplUtils.getErrorMessagesfromErrorPayload(a.responseText)["messageTitle"],message:oSapSplUtils.getErrorMessagesfromErrorPayload(a.responseText)["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(a.responseText)["ufErrorObject"]});}},complete:function(){}});}function P(d,t,D){var h={};h["UUID"]=d["UUID"];h["TourID"]=d["TourID"];h["VehicleUUID"]=t.sClickedVehicleUUID;h["Status"]="S";h["OwnerID"]=oSapSplUtils.getCompanyDetails()["BasicInfo_CompanyID"];h["Name"]=d["Name"];h["EventSchema"]="default";h["Planned.StartTime"]=(d["Planned_StartTime"]===null)?null:d["Planned_StartTime"].toJSON();h["Planned.EndTime"]=(d["Planned_EndTime"]===null)?null:d["Planned_EndTime"].toJSON();h["Actual.StartTime"]=(d["Actual_StartTime"]===null)?null:d["Actual_StartTime"].toJSON();h["Actual.EndTime"]=(d["Actual_EndTime"]===null)?null:d["Actual_EndTime"].toJSON();h["isDeleted"]=d["isDeleted"];h["AuditTrail.CreatedBy"]=null;h["AuditTrail.ChangedBy"]=null;h["AuditTrail.CreationTime"]=null;h["AuditTrail.ChangeTime"]=null;p["Header"].push(h);p["Text"].push({UUID:d["UUID"],Text:d["Text"]});var T={};for(var i=0;i<d["Items"].results.length;i++){T={};T["UUID"]=d["Items"].results[i]["ItemUUID"];T["ItemID"]=d["Items"].results[i]["ItemID"];T["TourUUID"]=d["Items"].results[i]["TourUUID"];T["Type"]=d["Items"].results[i]["Type"];T["Detail1"]=d["Items"].results[i]["Detail1"];T["Detail2"]=d["Items"].results[i]["Detail2"];T["Detail3"]=d["Items"].results[i]["Detail3"];T["DangerGoodsClass"]=d["Items"].results[i]["DangerGoodsClass"];T["isDeleted"]=d["Items"].results[i]["isDeleted"];p["Item"].push(T);}for(var j=0;j<d["Stops"].results.length;j++){T={};T["UUID"]=d["Stops"].results[j]["UUID"];T["TourUUID"]=d["Stops"].results[j]["TourUUID"];T["Sequence"]=d["Stops"].results[j]["Sequence"];T["Name"]=d["Stops"].results[j]["Name"];T["Description"]=d["Stops"].results[j]["Description"];T["Geocordinate"]=null;T["Status"]=d["Stops"].results[j]["Status"];T["LastReportedEvent"]=d["Stops"].results[j]["LastReportedEvent"];T["LocationUUID"]=d["Stops"].results[j]["LocationID"];T["isDeleted"]=d["Stops"].results[j]["isDeleted"];T["Planned.ArrivalTime"]=(d["Stops"].results[j]["Planned_ArrivalTime"]===null)?null:d["Stops"].results[j]["Planned_ArrivalTime"].toJSON();T["Planned.DepartureTime"]=(d["Stops"].results[j]["Planned_DepartureTime"]===null)?null:d["Stops"].results[j]["Planned_DepartureTime"].toJSON();T["Actual.ArrivalTime"]=(d["Stops"].results[j]["Actual_ArrivalTime"]===null)?null:d["Stops"].results[j]["Actual_ArrivalTime"].toJSON();T["Actual.DepartureTime"]=(d["Stops"].results[j]["Actual_DepartureTime"]===null)?null:d["Stops"].results[j]["Actual_DepartureTime"].toJSON();p["Stop"].push(T);var a=d["Stops"].results[j]["AssignedItems"].results;for(var k=0;k<a.length;k++){var o={};o["UUID"]=oSapSplUtils.getUUID();o["TourUUID"]=a[k]["TourUUID"];o["StopUUID"]=a[k]["StopUUID"];o["ItemUUID"]=a[k]["ItemUUID"];o["Type"]=a[k]["AssignmentType"];o["isDeleted"]=a[k]["isDeleted"];p["StopItemAssignment"].push(o);}}f(p,D);}var s=e.getSource().getSelectedItem().getBindingContext().getPath();this.oSapSplApplModel.read(s,null,["$expand=Items,Stops/AssignedItems"],false,function(r){P(r,t,e.getSource().getParent());},function(){});},fnHandleSearch:function(e){var s=e.mParameters.query;var p;if(s.length>2){p=this.prepareSearchPayload(s);this.callSearchService(p);}else{if(s.length===0){var f=[],b=null;b=this.oListOfUnassignedTours.getBinding("items");b.filter([]);b.filter(f);}}},prepareSearchPayload:function(s){var p={};p.UserID=oSapSplUtils.getLoggedOnUserDetails().usreID;p.ObjectType="Tour";p.SearchTerm=s;p.FuzzinessThershold=SapSplEnums.fuzzyThreshold;p.MaximumNumberOfRecords=SapSplEnums.numberOfRecords;p.ProvideDetails=false;p.SearchInNetwork=true;p.AdditionalCriteria={};p.AdditionalCriteria.Columns="Name";return p;},fnApplySearchFilters:function(d){var f=[],b=null;b=this.oListOfUnassignedTours.getBinding("items");f=oSapSplUtils.getSearchItemFilters(d).aFilters;b.filter([]);b.filter(f);},callSearchService:function(p){var t=this;oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/app/services/Search.xsjs"),method:"POST",async:false,data:JSON.stringify(p),success:function(d,s,m){oSapSplBusyDialog.getBusyDialogInstance().close();if(d.constructor===String){d=JSON.parse(d);}if(m["status"]===200){t.fnApplySearchFilters(d);}},error:function(e){oSapSplBusyDialog.getBusyDialogInstance().close();if(e&&e["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+"\t"+e.statusText,details:e.responseText});}else{var r={};if(e.responseText.constructor===String){r=JSON.parse(e.responseText);}else{r=e.responseText;}sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(r)["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(r)["ufErrorObject"]});}},complete:function(){}});},handleAssigTourAction:function(e){if(e.getSource().getText()===oSapSplUtils.getBundle().getText("ASSIGN_TOUR")){var t=this;this.sClickedVehicleUUID=e.getSource().getModel().getData()["UUID"];this.oTourStatusFilter=new sap.ui.model.Filter("TourStatus",sap.ui.model.FilterOperator.EQ,"U");this.oListOfUnassignedTours=new sap.m.List({mode:"SingleSelectMaster",growing:true,growingThreshold:20,growingScrollToLoad:true,select:jQuery.proxy(t.fnHandleSelectOfTourForTruckAssignment,t),items:{path:"/Tours",filters:[this.oTourStatusFilter],template:new sap.m.StandardListItem({title:"{Name}",description:"{TourID}"})}});new sap.m.Dialog({contentHeight:"40%",title:oSapSplUtils.getBundle().getText("ASSIGN_TOUR"),beginButton:new sap.m.Button({text:oSapSplUtils.getBundle().getText("CANCEL"),press:function(){e.getSource().getParent().close();}}),subHeader:new sap.m.Toolbar({content:new sap.m.SearchField({search:jQuery.proxy(t.fnHandleSearch,t)})}),content:[this.oListOfUnassignedTours]}).open().addStyleClass("sapSplAssignTourToTruckDialog").setModel(this.oSapSplApplModel).attachAfterClose(function(c){c.getSource().destroy();});this.aRenderedDialogs.push("sapSplAssignTourToTruckDialog");}else{this.fnHandleNavigationToManageToursApp(e.getSource().getModel().getData()["RegistrationNumber"]);}},showTruckDetailsPopover:function(e){if((sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["canClickTruck"]!==null)&&(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["canClickTruck"]===1)){var x=0;var y=0;var v={};var t={};var E={};this.oTruckDetailsPopOver=sap.ui.xmlfragment("viewTruckDetailsFragment","splReusable.fragments.ViewTruckDetails",this);sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplPhoneLabel").setText(oSapSplUtils.getBundle().getText("TELEPHONE"));sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplTruckLabel").setText(oSapSplUtils.getBundle().getText("TRUCK"));sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplTourLabel").setText(oSapSplUtils.getBundle().getText("TRUCK_DETAIL_TOUR_FIELD"));sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplNextStopLabel").setText(oSapSplUtils.getBundle().getText("TRUCK_DETAIL_NEXT_STOP"));sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplTruckDetailsViewPageBeginButton").setText(oSapSplUtils.getBundle().getText("SEND_MESSAGE_ACTION_BUTTON"));sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplTruckDetailsViewPageEndButton").setText(oSapSplUtils.getBundle().getText("ASSIGN_TOUR"));if(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["canSendMessageToTruckFromMap"]===1){sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplTruckDetailsViewPageBeginButton").setVisible(true);}else{sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplTruckDetailsViewPageBeginButton").setVisible(false);}if(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["canAssignTour"]===1){sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplTruckDetailsViewPageEndButton").setVisible(true);}else{sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplTruckDetailsViewPageEndButton").setVisible(false);}if(e.fromFeedlist||e.fromLabel){t=e;}else{E=JSON.parse(e.getParameter("data"));v["LocationID"]=E.Action.instance.split(".")[1];v["viewMode"]="E";var p=this.fnGetPopoverOffsets();if(E.Action.Params.Param[0].name==="x"){x=parseInt(E.Action.Params.Param[0]["#"],10);x+=p["x"];x=parseInt(x,10);}if(E.Action.Params.Param[1].name==="y"){y=parseInt(E.Action.Params.Param[1]["#"],10);y+=p["y"];y=parseInt(y,10);}var d=E.Action.instance.split(".")[1];if(oSapSplUtils.getFromQueryParameterMap("xx-sap-spl-fallback")==="true"){this.getTruckDetailsFromDeviceUUID(d,function(r){oSapSplBusyDialog.getBusyDialogInstance().close();t=r.results[0];},function(){jQuery.sap.log.error("Truck details","read failed","liveApp.controller.js");});}else{this.getTruckDetailsFromDeviceUUIDProxy.read(this,d,function(r){oSapSplBusyDialog.getBusyDialogInstance().close();t=r.results[0];},function(){});}var P=this.getPopoverOpeningDirection(x,y);t.x=P.x;t.y=P.y;t.placement=P.placement;}if(t["TourName"]===null&&t["NextTourName"]===null){sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplTourtext").setText(oSapSplUtils.getBundle().getText("NO_TOURS_ASSIGNED_FOR_TRUCK"));sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplNextStopLabel").setVisible(false);sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplNextStopText").setVisible(false);this.oTruckDetailsPopOver.setContentHeight("160px");if(t["isTerminated"]!==undefined&&t["isTerminated"]!==null&&t["isTerminated"]===1){sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplTruckDetailsViewPageEndButton").setVisible(false);}}else{if(t["TourName"]!==null){sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplTourtext").setText(t["TourName"]);if(t["TourNextStop"]!==null){sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplNextStopLabel").setVisible(true);sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplNextStopText").setVisible(true);}else{sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplNextStopLabel").setVisible(false);sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplNextStopText").setVisible(false);}sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplTruckDetailsViewPageEndButton").setText(oSapSplUtils.getBundle().getText("SHOW_TOURS"));}else{sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplTourtext").setText(oSapSplUtils.getBundle().getText("NO_TOURS_ASSIGNED_FOR_TRUCK_UNTIL",[t["NextTourStartTime"].toLocaleDateString(),t["NextTourStartTime"].toLocaleTimeString()]));sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplNextStopLabel").setVisible(false);sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplNextStopText").setVisible(false);if(t["isTerminated"]!==undefined&&t["isTerminated"]!==null&&t["isTerminated"]===1){sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplTruckDetailsViewPageEndButton").setVisible(false);}}}if(t["RegistrationNumber"]===null){t.showHeaderAndContent=false;t["RegistrationNumber"]="Truck";this.oTruckDetailsPopOver.setContentHeight("0px");}else{t.showHeaderAndContent=true;}if(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["canViewAssignedItems"]===1){sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplNextStopLabel").setVisible(false);sap.ui.core.Fragment.byId("viewTruckDetailsFragment","sapSplNextStopText").setVisible(false);this.oTruckDetailsPopOver.setContentHeight("300px");}else{if(t["RegistrationNumber"]==="Truck"){this.oTruckDetailsPopOver.setContentHeight("0px");}else{this.oTruckDetailsPopOver.setContentHeight("180px");}}var T=new sap.ui.model.json.JSONModel();T.setData(t);sap.ui.getCore().setModel(T,"splTruckDetailsPopOverModel");this.oTruckDetailsPopOver.setModel(sap.ui.getCore().getModel("splTruckDetailsPopOverModel"));this.oTruckDetailsPopOver.attachAfterClose(function(e){e.getSource().destroy();});this.oTruckDetailsPopOver.attachAfterOpen(function(){if(t["introduceFooterZoomInButton"]===true){sap.ui.getCore().byId(jQuery("#"+this.sId+"-popover footer").attr("id")).insertContent(new sap.m.ToolbarSpacer(),0).insertContent(new sap.m.Button({text:oSapSplUtils.getBundle().getText("ZOOM_IN_CLUSTER"),press:function(e){t["zoomInButtonHandler"](t,e.getSource().getParent().getParent().getParent(),"Position");}},0));}if(parseInt(this.$().find(".sapMPopoverCont").css("height"),10)>400){this.setContentHeight("400px");}});this.oTruckDetailsPopOver.openBy(this.byId("oPopoverAnchorButton"));}},showTrucksOnMap:function(){var l=jQuery(".vbi-detail");var i;for(i=0;i<l.length;i++){if(jQuery(l[i]).find(".truckDetailWindowLayout").length>0){jQuery(l[i]).remove();}}oSapSplMapsDataMarshal.fnRemoveVOsOnMap("Truck",this.byId("oSapSplLiveAppMap"));for(i=0;i<this.aTruckArray.length;i++){if(this.aTruckArray[i]){oSapSplMapsDataMarshal.fnShowTruckFlags(this.aTruckArray[i],this.byId("oSapSplLiveAppMap"),this.isTruckLabelVisible);}}if(this.bZoomToTruck!==undefined&&this.bZoomToTruck===true){var c=oSapSplMapsDataMarshal.convertGeoJSONToString(JSON.parse(this.oZoomToTruckData.Position.results[0].Position)).split(";");this.byId("oSapSplLiveAppMap").zoomToGeoPosition(parseFloat(c[0],10),parseFloat(c[1],10),parseFloat(this.byId("oSapSplLiveAppMap").zoom,10));}},handleIncidenceOccurrencePopover:function(e){var x=0;var y=0;var t={};var E={};if(e.fromFeedlist){t=e;x=e.x;y=e.y;}else{E=JSON.parse(e.getParameter("data"));var p=this.fnGetPopoverOffsets();if(E.Action.Params.Param[0].name==="x"){x=parseInt(E.Action.Params.Param[0]["#"],10);x+=p["x"];x=parseInt(x,10);}if(E.Action.Params.Param[1].name==="y"){y=parseInt(E.Action.Params.Param[1]["#"],10);y+=p["y"];y=parseInt(y,10);}var i=E.Action.instance.split(".")[1];this.getIncidentDetailsFromUUID(i,function(r){oSapSplBusyDialog.getBusyDialogInstance().close();t=r.results[0];},function(){jQuery.sap.log.error("Incidence Occurrence details","read failed","liveApp.controller.js");});}this.oIncidenceOccurrenceDetailsPopOver=new sap.m.ResponsivePopover({showHeader:false,offsetX:x,offsetY:y,modal:false,content:new sap.ui.commons.layout.VerticalLayout().addStyleClass("oIncidenceOccurrenceDetailsPopOverContetnLayout").addContent(new sap.m.Label({text:"Incident"}).addStyleClass("oIncidenceOccurrenceDetailsPopOverIncident")).addContent(new sap.m.Label({text:t["LongText"]}).addStyleClass("oIncidenceOccurrenceDetailsPopOverIncidentShortText")).addContent(new sap.m.Image({src:"resources/icons/redArrow.png.png"}).addStyleClass("oIncidenceOccurrenceDetailsPopOverArrowImage"))}).addStyleClass("oIncidenceOccurrenceDetailsPopOver");this.oIncidenceOccurrenceDetailsPopOver.attachAfterClose(function(e){e.getSource().destroy();});this.oIncidenceOccurrenceDetailsPopOver.openBy(this.byId("oPopoverAnchorButton"));},showIncidenceOccurrencesOnMap:function(){oSapSplMapsDataMarshal.fnRemoveVOsOnMap("Incident",this.byId("oSapSplLiveAppMap"));for(var i=0;i<this.aIncidenceOccuranceData.length;i++){oSapSplMapsDataMarshal.fnShowIncidenceFlags(this.aIncidenceOccuranceData[i],this.byId("oSapSplLiveAppMap"));}},fnGetEmptyLocationObjectForCreate:function(c,l){var r={};r["Name"]="";r["GeofenceGates"]={results:[]};r["Incidents"]={results:[]};r["locationGeoCoords"]=this.fnCordinateStringToCordinateArray(c);if(l==="Geofence"){r["showGates"]=true;r["Type"]="L00002";r["isPublic"]="0";}else{r["showGates"]=false;r["Type"]="L00001";r["isPublic"]="1";}r["ImageUrl"]="";r["Website"]="";r["Tag"]=this.sLocationType;return r;},fnHandleEditDialogOfParkingSpace:function(e){var t=this;var l=[];oSapSplMapsDataMarshal.fnChangeCursor("pencil");e.getSource().getParent().getParent().getParent().close();splReusable.libs.SapSplStyleSheetLoader.loadStyle("./resources/styles/sapSplParkingSpaceCreateDialog");var p={};p=e.getSource().getModel().getData();var P=oSapSplMapsDataMarshal.convertStringToGeoJSON(p["Geometry"]);p["Geometry"]=JSON.stringify(P);oSapSplMapsDataMarshal.fnEditFences(p,this.byId("oSapSplLiveAppMap"));l=P.coordinates;p["Latitude"]=l[1];p["Longitude"]=l[0];p["mode"]="Edit";p["Parking"].results=[];p["sDialogType"]=p["Tag"];this.oCreateParkingSpaceEditDialogView=sap.ui.view({viewName:"splView.dialogs.SplParkingSpaceCreateEditDialog",type:sap.ui.core.mvc.ViewType.XML,viewData:p}).addStyleClass("sapSplParkingSpaceCreateDialogContainerView");this.oCreateParkingSpaceEditDialogView.byId("sapSplCreateEditParkingSpaceLatitude").attachLiveChange(function(e){e["isParkingSpace"]=true;t.splChangeCordinateInEditDialog(e);});this.oCreateParkingSpaceEditDialogView.byId("sapSplCreateEditParkingSpaceLongitude").attachLiveChange(function(e){e["isParkingSpace"]=true;t.splChangeCordinateInEditDialog(e);});this.aRenderedDialogs.push("sapSplParkingSpaceCreateDialogContainerView");var L=new sap.m.Button({text:oSapSplUtils.getBundle().getText("NEW_CONTACT_SAVE")});var r=new sap.m.Button({text:oSapSplUtils.getBundle().getText("CANCEL")});this.oCreateParkingSpaceEditDialogView.getController().setToolbarInstance(this.oMapToolbar);this.oCreateParkingSpaceEditDialogView.getController().setLeftButton(L);this.oCreateParkingSpaceEditDialogView.getController().setRightButton(r);this.oParkingEditDialog=new sap.m.Dialog({showHeader:false,content:new sap.ui.commons.layout.VerticalLayout().addStyleClass("viewHolderLayout").addContent(this.oCreateParkingSpaceEditDialogView),leftButton:L,rightButton:r}).addStyleClass("SplParkingSpaceCreateEditDialog").addStyleClass("sapSplHideDialog").open().attachAfterClose(function(e){t.fnShowAllVisualObjectsOnMap("plotSelected");t.fnBlockUnblockLiveAppUI("Unblock");e.getSource().destroy();}).attachAfterOpen(function(){oSapSplUtils.fnSyncStyleClass(t.oParkingEditDialog);t.fnBlockUnblockLiveAppUI("Block");jQuery.proxy(t.fnRenderStyle(),t);});$(".sapMDialogBlockLayerInit").css("z-index","0");this.oParkingEditDialog.addEventDelegate({onAfterRendering:function(e){t.fnHandleDialogMove(e.srcControl);t.fnHandleDialogPositioning(e.srcControl);}});},fnGetDataForParkingFacilityEdit:function(s){var f,U;var a={},S=[],A=[];a=this.fnGetParkingSpaceFacilityData();S=s["Parking"].results;A=a.results;for(var k=0;k<S.length;k++){if(S[k]["Category"]==="P"){A.push(S[k]);}}for(var i=0;i<A.length;i++){f=false;U="";for(var j=0;j<S.length;j++){if(S[j]["Name"]===A[i]["Name"]){f=true;U=S[j]["FacilityUUID"];break;}}if(f){A[i]["checked"]=true;A[i]["UUID"]=U;}}s["Parking"].results=A;return s;},fnGetParkingSpaceFacilityData:function(){var f=null;new splModels.odata.ODataModel({url:oSapSplUtils.getServiceMetadata("config",true),json:true,user:undefined,password:undefined,headers:{"Cache-Control":"max-age=0"},tokenHandling:true,withCredentials:false,loadMetadataAsync:true,handleTimeOut:true,numberOfSecondsBeforeTimeOut:10000}).read("/LocationFacility",null,null,false,function(d){for(var i=0;i<d.results.length;i++){d.results[i].checked=false;d.results[i].all=false;}f=d;},function(){});return f;},handleCreateParkingDialog:function(v){splReusable.libs.SapSplStyleSheetLoader.loadStyle("./resources/styles/sapSplParkingSpaceCreateDialog");var t=this;v["Latitude"]=v["locationGeoCoords"][0]["lat"];v["Longitude"]=v["locationGeoCoords"][0]["long"];v["Parking"]={};v["mode"]="Create";v["sDialogType"]=this.sLocationType;this.oCreateParkingSpaceDialogView=sap.ui.view({viewName:"splView.dialogs.SplParkingSpaceCreateEditDialog",type:sap.ui.core.mvc.ViewType.XML,viewData:v}).addStyleClass("sapSplParkingSpaceCreateDialogContainerView");var l=new sap.m.Button({text:oSapSplUtils.getBundle().getText("NEW_CONTACT_SAVE")});var r=new sap.m.Button({text:oSapSplUtils.getBundle().getText("CANCEL")});this.oCreateParkingSpaceDialogView.getController().setToolbarInstance(this.oMapToolbar);this.oCreateParkingSpaceDialogView.getController().setLeftButton(l);this.oCreateParkingSpaceDialogView.getController().setRightButton(r);this.oParkingEditDialog=new sap.m.Dialog({showHeader:false,content:new sap.ui.commons.layout.VerticalLayout().addStyleClass("viewHolderLayout").addContent(this.oCreateParkingSpaceDialogView),leftButton:l,rightButton:r}).addStyleClass("SplParkingSpaceCreateEditDialog").addStyleClass("sapSplHideDialog").attachAfterClose(function(e){t.fnShowAllVisualObjectsOnMap("plotSelected");t.fnBlockUnblockLiveAppUI("Unblock");e.getSource().destroy();}).attachAfterOpen(function(){oSapSplUtils.fnSyncStyleClass(t.oParkingEditDialog);t.fnBlockUnblockLiveAppUI("Block");jQuery.proxy(t.fnRenderStyle(),t);});this.oParkingEditDialog.addEventDelegate({onAfterRendering:function(e){t.fnHandleDialogMove(e.srcControl);t.fnHandleDialogPositioning(e.srcControl);}});this.oParkingEditDialog.open();this.aRenderedDialogs.push("sapSplParkingSpaceCreateDialogContainerView");},fnInstantiateAndOpenCreateLocationDialog:function(c){var t=this;var l;if(this.sLocationType==="LC0004"||this.sLocationType==="LC0008"){l=this.fnGetEmptyLocationObjectForCreate(c,"Geofence");}else{var C=c["locationGeoCoords"][0]["long"]+";"+c["locationGeoCoords"][0]["lat"]+";"+c["locationGeoCoords"][0]["alt"];l=this.fnGetEmptyLocationObjectForCreate(C,"POI");}this.fnPreventEnableMapRefresh("Prevent");splReusable.libs.SapSplStyleSheetLoader.loadStyle("./resources/styles/sapSplCreateEditLocationDialog");this.oSapSplLocationCreateEditDialogInstance=null;if(!this.oSapSplLocationCreateEditDialogInstance){sap.ui.getCore().setModel(new sap.ui.model.json.JSONModel(),"sapSplLocationCreateEditDialogModel");var s=sap.ui.view({viewName:"splView.dialogs.SplCreateEditLocationDialog",type:sap.ui.core.mvc.ViewType.XML,viewData:[t.sLocationType,"Create"]}).setModel(sap.ui.getCore().getModel("sapSplLocationCreateEditDialogModel")).addStyleClass("sapSplLocationCreateDialogContainerView");var L=new sap.m.Button({text:oSapSplUtils.getBundle().getText("OK"),press:jQuery.proxy(s.getController().handlePressOfDialogOK,s.getController())});var r=new sap.m.Button({text:oSapSplUtils.getBundle().getText("CANCEL"),press:jQuery.proxy(s.getController().handlePressOfDialogCancel,s.getController())});s.getController().setLiveAppControllerInstance(this);this.oSapSplLocationCreateEditDialogInstance=new sap.m.Dialog({beginButton:L,endButton:r,showHeader:false,content:new sap.ui.commons.layout.VerticalLayout().addStyleClass("viewHolderLayout").addContent(s)}).addStyleClass("SplLocationCreateEditDialog");this.oSapSplLocationCreateEditDialogInstance.attachAfterClose(function(){t.fnShowAllVisualObjectsOnMap("plotSelected");t.fnPreventEnableMapRefresh("Enable");t.fnBlockUnblockLiveAppUI("Unblock");t.oSapSplLocationCreateEditDialogInstance=null;$(".sapUiBliLy").removeClass('splReduceDivHeight');});this.oSapSplLocationCreateEditDialogInstance.attachAfterOpen(function(e){oSapSplUtils.fnSyncStyleClass(t.oSapSplLocationCreateEditDialogInstance);});this.oSapSplLocationCreateEditDialogInstance.addEventDelegate({onAfterRendering:function(e){t.fnHandleDialogMove(e.srcControl);t.fnHandleDialogPositioning(e.srcControl);}});s.addEventDelegate({onAfterRendering:function(e){t.fnHandleDialogMove(e.srcControl.getParent().getParent());t.fnHandleDialogPositioning(e.srcControl.getParent().getParent());}});}this.oSapSplLocationCreateEditDialogInstance.open();$(".sapUiBliLy").addClass('splReduceDivHeight');sap.ui.getCore().getModel("sapSplLocationCreateEditDialogModel").setData(l);this.aRenderedDialogs.push("sapSplLocationCreateDialogContainerView");this.fnBlockUnblockLiveAppUI("Block","addGeofence");},fnAddGeofence:function(){this.sLocationType="LC0004";oSapSplMapsDataMarshal.isMapClickEabled=true;this.fnPreventEnableMapRefresh("Prevent");oSapSplMapsDataMarshal.fnChangeCursor("pencil");this.fnBlockUnblockLiveAppUI("Block","addGeofence");this.byId("sapSplLocationCreateCancelButton").setVisible(true);this.byId("sapSplTrafficStatusFooter").addStyleClass("sapSplHiddenBar");},getLocationViewEnum:function(){function s(d){this.oLocationViewEnum=[];for(var i=0;i<d.results.length;i++){if(d.results[i]["Value"]!=="LC0004"&&d.results[i]["Value"]!=="LC0008"){this.oLocationViewEnum.push(d.results[i]);this.byId("addPointOfInterestButton").setVisible(true);}else{this.byId("addGeofenceButton").setVisible(true);}}}function e(){jQuery.sap.log.error("getLocationViewEnum","read failed","liveApp.controller.js");throw new Error("getLocationViewEnum function failed");}oSapSplBusyDialog.getBusyDialogInstance().open();this.oSapSplApplModel.read("/LocationCreateEnum",null,null,true,jQuery.proxy(s,this),jQuery.proxy(e,this));oSapSplBusyDialog.getBusyDialogInstance().close();jQuery(".sapUiBLy").css("z-index","0");},fnAddPointOfInterest:function(){var t=null;var a=this;t=new sap.m.Button({text:"{Value.description}",press:function(e){a.sLocationType=e.getSource().getBindingContext().getProperty("Value");oSapSplMapsDataMarshal.isMapClickEabled=true;a.fnPreventEnableMapRefresh("Prevent");oSapSplMapsDataMarshal.fnChangeCursor("pencil");a.fnBlockUnblockLiveAppUI("Block","addPOI");a.byId("sapSplLocationCreateCancelButton").setVisible(true);a.byId("sapSplTrafficStatusFooter").addStyleClass("sapSplHiddenBar");}});if(!this.oGeoFenceTypeDataJSONModel){var p={};p["results"]=this.oLocationViewEnum;this.oGeoFenceTypeDataJSONModel=new sap.ui.model.json.JSONModel(p);}var A=new sap.m.ActionSheet({buttons:{path:"/results",template:t},placement:sap.m.PlacementType.Top}).setModel(this.oGeoFenceTypeDataJSONModel);A.openBy(this.byId("addPointOfInterestButton"));},fnOpenBusinessPartnerMessageDialog:function(){var t=this;splReusable.libs.SapSplStyleSheetLoader.loadStyle("./resources/styles/sapSplSendMessageBusinessPartnerDialog");splReusable.libs.SapSplStyleSheetLoader.loadStyle("./resources/styles/sapSplSendMessageDialog");var d=sap.ui.view({viewName:"splView.dialogs.SplSendMessageBusinessPartnerDialog",type:sap.ui.core.mvc.ViewType.XML}).addStyleClass("sendMessageBusinessPartnerDialogContainerView");this.oSendMessageBusinessPartnerParentDialog=new sap.m.Dialog({showHeader:false,content:new sap.ui.commons.layout.VerticalLayout().addStyleClass("viewHolderLayout").addContent(d)}).addStyleClass("splSendMessageBusinessPartnerDialog").open();this.oSendMessageBusinessPartnerParentDialog.attachAfterOpen(function(){oSapSplUtils.fnSyncStyleClass(t.oSendMessageBusinessPartnerParentDialog);t.fnPreventEnableMapRefresh("Prevent");});this.oSendMessageBusinessPartnerParentDialog.attachAfterClose(function(){t.fnPreventEnableMapRefresh("Enable");});this.aRenderedDialogs.push("viewHolderLayout");d.getController().setParentDialogInstance(this.oSendMessageBusinessPartnerParentDialog);},handleSelectDeselectFence:function(r){oSapSplMapsDataMarshal.fnSelectDeselectFences(r,this.byId("oSapSplLiveAppMap"),jQuery.proxy(this.oSendMessageDialogView.getController().fnHandleClickOfGeofenceOnTheMap,this.oSendMessageDialogView.getController()));},fnHandleSelectOfActionSheetItem:function(e){var t=this,v={},o={};this.sEventText=jQuery.extend(true,{},e);splReusable.libs.SapSplStyleSheetLoader.loadStyle("./resources/styles/sapSplSendMessageDialog");if(e.getSource().getText()===oSapSplUtils.getBundle().getText("SELECT_TRUCKS_VIA_DISPLAY_AREA")){v={mode:"Views",liveAppInstance:this.byId("oSapSplLiveAppMap"),sSelectedDisplayArea:this.oMapToolbar.getContentLeft()[2].getText()};o={mode:"View"};this.isSelectMultipleTrucksEnabled=true;this.isGeofenceClickEnabled=false;}else if(e.getSource().getText()===oSapSplUtils.getBundle().getText("SELECT_VIA_GEOFENCE")){o={mode:"Geofence"};this.isSelectMultipleGeofencesEnabled=true;this.isTruckClickEnabled=false;}else if(e.getSource().getText()===oSapSplUtils.getBundle().getText("SELECT_TRUCK_ON_MAP")){o={mode:"TruckOnMap"};v={mode:"Trucks"};this.isSelectMultipleTrucksEnabled=true;this.isGeofenceClickEnabled=false;}else if(e.getSource().getText()===oSapSplUtils.getBundle().getText("SELECT_ALL_MY_TRUCKS_ON_MAP")||e.getSource().getText()===oSapSplUtils.getBundle().getText("SELECT_ALL_TRUCKS_ON_MAP")){o={mode:"AllTrucksOnMap"};v={mode:"All_Trucks",trucks:this.aTruckArray,liveAppInstance:this.byId("oSapSplLiveAppMap")};this.isSelectMultipleTrucksEnabled=true;this.isGeofenceClickEnabled=false;}this.oSendMessageDialogView=sap.ui.view({viewName:"splView.dialogs.SplSendMessageDialog",type:sap.ui.core.mvc.ViewType.XML,viewData:v}).addStyleClass("sendMessageDialogContainerView");this.oSendMessageParentDialog=new sap.m.Dialog({showHeader:false,content:new sap.ui.commons.layout.VerticalLayout().addStyleClass("viewHolderLayout").addContent(this.oSendMessageDialogView)}).addStyleClass("splSendMessageDialog").addStyleClass("sapSplHideDialog").open();this.aRenderedDialogs.push("viewHolderLayout");this.oSendMessageParentDialog.attachAfterOpen(function(){oSapSplUtils.fnSyncStyleClass(t.oSendMessageParentDialog);setTimeout(function(){if(sap.ui.getCore().byId($(".sapSplMessageToRecipientTextArea").attr("id"))){sap.ui.getCore().byId($(".sapSplMessageToRecipientTextArea").attr("id")).focus();}},100);t.fnBlockUnblockLiveAppUI("Block","sendMessage");t.fnPreventEnableMapRefresh("Prevent");});this.oSendMessageParentDialog.attachAfterClose(function(){t.isSelectMultipleTrucksEnabled=false;t.isSelectMultipleGeofencesEnabled=false;t.fnBlockUnblockLiveAppUI("Unblock");t.fnPreventEnableMapRefresh("Enable");oSapSplMapsDataMarshal.fnResetValues(t.byId("oSapSplLiveAppMap"));if(this.mode==="Geofence"){t.fnShowAllVisualObjectsOnMap("PlotLocally");}}.bind(o));this.oSendMessageDialogView.getController().setParentDialogInstance(this.oSendMessageParentDialog,this);this.oSendMessageParentDialog.addEventDelegate({onAfterRendering:function(e){t.fnHandleDialogMove(e.srcControl);t.fnHandleDialogPositioning(e.srcControl);}});},fnOpenSendMessageToTruckActionSheet:function(){var t=this;var T;if(!oSapSplUtils.getCompanyDetails().canChangeSearch){T=oSapSplUtils.getBundle().getText("SELECT_ALL_TRUCKS_ON_MAP");}else{T=oSapSplUtils.getBundle().getText("SELECT_ALL_MY_TRUCKS_ON_MAP");}var a={results:[{"Value":T,"visible":splReusable.libs.SapSplModelFormatters.sapSplGetVisibilityBasedOnSubscriptionModel(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["canSendMessageToTruck"])},{"Value":oSapSplUtils.getBundle().getText("SELECT_TRUCKS_VIA_DISPLAY_AREA"),"visible":splReusable.libs.SapSplModelFormatters.sapSplGetVisibilityBasedOnSubscriptionModel(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["canSendMessageToTruck"])},{"Value":oSapSplUtils.getBundle().getText("SELECT_TRUCK_ON_MAP"),"visible":splReusable.libs.SapSplModelFormatters.sapSplGetVisibilityBasedOnSubscriptionModel(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["canSendMessageToTruck"])},{"Value":oSapSplUtils.getBundle().getText("SELECT_VIA_GEOFENCE"),"visible":splReusable.libs.SapSplModelFormatters.sapSplGetVisibilityBasedOnSubscriptionModel(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["canSendMessageToGeofence"])}]};if(!this.oActionSheetJSONModel){this.oActionSheetJSONModel=new sap.ui.model.json.JSONModel(a);}var o=new sap.m.Button({text:"{Value}",visible:"{visible}",press:function(e){t.fnHandleSelectOfActionSheetItem(e);}});var A=new sap.m.ActionSheet({buttons:{path:"/results",template:o},placement:sap.m.PlacementType.Top}).setModel(this.oActionSheetJSONModel);A.attachAfterClose(function(e){e.getSource().destroy();});A.openBy(this.byId("oSendMessageToTruckButton"));},fnHandleOpenOfLeftPanelSortDialog:function(){var v={},i;v.groupList=[{GroupName:oSapSplUtils.getBundle().getText("SHARING"),FieldName:"isPublic"},{GroupName:oSapSplUtils.getBundle().getText("COMPANY"),FieldName:"OwnerName"},{GroupName:oSapSplUtils.getBundle().getText("TYPE"),FieldName:"isRadar"}];v.sorterField="";var s=this.byId("SapSplLeftPanelList").getBinding("items").aSorters;for(i=0;i<s.length;i++){if(s[i].fnGroup){v.sorterField=this.byId("SapSplLeftPanelList").getBinding("items").aSorters[0].sPath;}}var l=sap.ui.view({viewName:"splView.dialogs.SplLeftPanelGroupByDialog",type:sap.ui.core.mvc.ViewType.XML,viewData:v});var a=new sap.m.Dialog({title:oSapSplUtils.getBundle().getText("GROUP_BY"),content:l}).addStyleClass("sapSnlhleftPanelGroupByDialog").open();a.attachAfterOpen(function(){oSapSplUtils.fnSyncStyleClass(a);});l.getController().setParentDialogInstance(a);},fnHandleConfirmOfViewSettingsDialog:function(e){var t=this,p,v;var g=null,f=[],I=[];var s={};var n=new sap.ui.model.Sorter("Name",false);var P=e.getParameters();var b=sap.ui.getCore().byId("splView.liveApp.liveApp--SapSplLeftPanelList").getBinding("items");if(P.groupItem){g=P.groupItem.getKey();s=new sap.ui.model.Sorter(g,P.groupDescending,this.handleGroupingOfLocations);sap.ui.getCore().byId("splView.liveApp.liveApp--SapSplLeftPanelList").getBinding("items").sort([]);sap.ui.getCore().byId("splView.liveApp.liveApp--SapSplLeftPanelList").getBinding("items").sort([s,n]);}if(P.filterItems.length>0){f.push(new sap.ui.model.Filter("Tag",sap.ui.model.FilterOperator.EQ,"LC0004"));f.push(new sap.ui.model.Filter("Tag",sap.ui.model.FilterOperator.EQ,"LC0008"));jQuery.each(P.filterItems,function(i,o){if(o.getKey()!=="None"){I=o.getKey().split("_");p=I[0];v=I[2];f.push(new sap.ui.model.Filter(p,sap.ui.model.FilterOperator.EQ,v));t.byId("sapSnlhGroupFilterInfoToolbar").removeStyleClass("sapSnlhInfoToolbarHeight");if(v==="0"){t.byId("sapSnlhGroupTitlelabelInfoToolBar").setText(oSapSplUtils.getBundle().getText("FILTER_BY_GEOFENCE"));}else if(v==="1"){t.byId("sapSnlhGroupTitlelabelInfoToolBar").setText(oSapSplUtils.getBundle().getText("FILTER_BY_RADAR"));}}else{t.byId("sapSnlhGroupFilterInfoToolbar").addStyleClass("sapSnlhInfoToolbarHeight");}});b.filter(f);}this.byId("sapSplSelectAllLocationsCheckBox").setSelected(false);},fnHandleResetOfFiltersInDialog:function(e){if(e.getSource().getFilterItems()&&e.getSource().getFilterItems()[0].getItems()[2]){e.getSource().getFilterItems()[0].getItems()[2].setSelected(true);}},fnHandleOpenOfLeftPanelGroupFilterDialog:function(e){var t=this;if(!this.oGroupFilterGeofencesViewSettingDialog){this.oGroupFilterGeofencesViewSettingDialog=new sap.m.ViewSettingsDialog({confirm:t.fnHandleConfirmOfViewSettingsDialog.bind(t),resetFilters:t.fnHandleResetOfFiltersInDialog.bind(t),filterItems:[new sap.m.ViewSettingsFilterItem({multiSelect:false,key:"Type",text:oSapSplUtils.getBundle().getText("TYPE"),items:{path:"/filters",template:new sap.m.ViewSettingsItem({key:"{value}",text:"{text}",selected:"{selectValue}"})}})],groupItems:{path:"/groups",template:new sap.m.ViewSettingsItem({key:"{FieldName}",text:"{GroupName}",selected:"{SelectValue}"})}}).setModel(new sap.ui.model.json.JSONModel({groups:[{GroupName:oSapSplUtils.getBundle().getText("SHARING"),FieldName:"sIsShared",SelectValue:true},{GroupName:oSapSplUtils.getBundle().getText("COMPANY"),FieldName:"OwnerName",SelectValue:false}],filters:[{text:oSapSplUtils.getBundle().getText("GEOFENCE_UNIDIRECTIONAL"),value:"isRadar_eq_0",selectValue:false},{text:oSapSplUtils.getBundle().getText("GEOFENCE_BIDIRECTIONAL"),value:"isRadar_eq_1",selectValue:false},{text:oSapSplUtils.getBundle().getText("FILTER_LABEL_NONE"),value:"None",selectValue:true}]}));}if(e.getSource().getId()==="splView.liveApp.liveApp--sapSplLeftPanelGroupButton"){this.oGroupFilterGeofencesViewSettingDialog.setTitle(oSapSplUtils.getBundle().getText("GROUP_BY"));this.oGroupFilterGeofencesViewSettingDialog.open("group");}else{this.oGroupFilterGeofencesViewSettingDialog.setTitle(oSapSplUtils.getBundle().getText("FILTER_BY"));this.oGroupFilterGeofencesViewSettingDialog.open("group");}this.oGroupFilterGeofencesViewSettingDialog._dialog.attachAfterOpen(function(e){if(e.getSource().getContent()[0].getPages()[0].getContent()[1].getItems()[2]){e.getSource().getContent()[0].getPages()[0].getContent()[1].getItems()[2].setVisible(false);}if(e.getSource().getContent()[0].getPages()[0].getContent()[1].indexOfItem(e.getSource().getContent()[0].getPages()[0].getContent()[1].getSelectedItem())===2){if(e.getSource().getContent()[0].getPages()[0].getContent()[1].getItems()[0]){e.getSource().getContent()[0].getPages()[0].getContent()[1].getItems()[0].setSelected(true);}}if(t.oGroupFilterGeofencesViewSettingDialog.getTitle()===oSapSplUtils.getBundle().getText("FILTER_BY")){for(var i=0;i<$(".sapMSegBBtn").length;i++){if($($(".sapMSegBBtn")[i]).attr("id")&&$($(".sapMSegBBtn")[i]).attr("id").search("filterbutton")!==-1){sap.ui.getCore().byId($($(".sapMSegBBtn")[i]).attr("id")).firePress();break;}}}});}});
