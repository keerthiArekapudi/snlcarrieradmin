/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.controller("splController.vehicles.MyVehiclesDetail",{onInit:function(){var s=null;s=new sap.ui.model.json.JSONModel({noData:true,isClicked:false,showFooterButtons:false});sap.ui.getCore().setModel(s,"SapSplMyVehicleDetailModel");this.getView().setModel(sap.ui.getCore().getModel("SapSplMyVehicleDetailModel"));this.byId("vehicleDetailEdit").setEnabled(false);this.byId("vehicleDetailDeRegister").setEnabled(false);this.byId("vehicleDetailActivate_DeActicate").setEnabled(false);this.byId("sapSplSharePermissionsLayout").getBinding("content").filter(new sap.ui.model.Filter("showBupa",sap.ui.model.FilterOperator.EQ,true));this.byId("sapSplSharePermissionsLayout").addEventDelegate({onAfterRendering:jQuery.proxy(this.fnHandleOnAfterRenderingOfSharedPermissionsLayout,this)});this.fnDefineControlLabelsFromLocalizationBundle();},fnHandleSelectOfIconTabBar:function(e){if(e.getParameters().key!=="info"){if(this.byId("vehicleDetailEdit").getEnabled()===false){this.byId("sapSplAddBupaSectionTitle").setText(oSapSplUtils.getBundle().getText("NOT_SHARED_YET_MESSAGE_DEREGISTERED"));}}},fnHandleOnAfterRenderingOfSharedPermissionsLayout:function(e){if(e.srcControl.getBinding("content")&&e.srcControl.getContent().length>0){this.byId("sapSplAddBupaSectionTitle").setText(oSapSplUtils.getBundle().getText("SHARED_WITH"));}else{if(sap.ui.getCore().getModel("SapSplMyVehicleDetailModel").getData()["isEdit"]){this.byId("sapSplAddBupaSectionTitle").setText(oSapSplUtils.getBundle().getText("NOT_SHARED_YET_MESSAGE_IN_EDIT_MODE"));}else{this.byId("sapSplAddBupaSectionTitle").setText(oSapSplUtils.getBundle().getText("NOT_SHARED_YET_MESSAGE"));}}},fnDefineControlLabelsFromLocalizationBundle:function(){this.byId("SapSplVehicleRegistrationNumberLabel").setText(oSapSplUtils.getBundle().getText("VEHICLE_REGISTRATION_NUMBER"));this.byId("SapSplVehicleVehicleTypeLabel").setText(oSapSplUtils.getBundle().getText("VEHICLE_TYPE"));this.byId("SapSplVehiclePublicName").setText(oSapSplUtils.getBundle().getText("VEHICLE_PUBLIC_NAME"));this.byId("SapSplVehicleDeviceType").setText(oSapSplUtils.getBundle().getText("DEVICE_TYPE"));this.byId("SapSplVehicleDeviceID").setText(oSapSplUtils.getBundle().getText("DEVICE_ID"));this.byId("MyVehiclesDetailTruckTitle").setText(oSapSplUtils.getBundle().getText("TRUCK_DETAILS_TITLE"));this.byId("MyVehiclesDetailDeviceTitle").setText(oSapSplUtils.getBundle().getText("DEVICE_DETAILS_TITLE"));this.byId("vehicleDetailEdit").setText(oSapSplUtils.getBundle().getText("MY_COLLEAGUES_EDIT_BUTTON"));this.byId("vehicleDetailActivate_DeActicate").setText(oSapSplUtils.getBundle().getText("MY_VEHICLES_ACTIVATE"));this.byId("vehicleDetailDeRegister").setText(oSapSplUtils.getBundle().getText("MY_VEHICLES_DEREGISTER"));this.byId("SapSplVehicleDriver").setText(oSapSplUtils.getBundle().getText("DRIVER_NAME"));this.byId("sapSplVehicleDetailNoDataLabel").setText(oSapSplUtils.getBundle().getText("NO_TRUCKS_TEXT"));this.byId("sapSplAddBupaForSharingButton").setText(oSapSplUtils.getBundle().getText("ADD_BUSINESS_PARTNER"));this.byId("vehicleSharePermissionsEditSave").setText(oSapSplUtils.getBundle().getText("NEW_CONTACT_SAVE"));this.byId("vehicleSharedPermissionEditCancel").setText(oSapSplUtils.getBundle().getText("MY_COLLEAGUES_CANCEL_BUTTON"));this.byId("MyVehiclesDetailPage").setTitle(oSapSplUtils.getBundle().getText("TRUCK"));this.byId("sapSplRemoveSharePermissionLink").setText(oSapSplUtils.getBundle().getText("VEHICLE_BUPA_PERMISSION_UNSHARE"));},handlePressOfAddBupaForSharing:function(){var s=[];this.aSharedBupaDetails=[];if(!this.oAddBupaForSharingDialog){this.oAddBupaForSharingDialog=new sap.m.Dialog({title:oSapSplUtils.getBundle().getText("ADD_BUSINESS_PARTNER_DIALOG_TITLE"),content:new sap.m.List({mode:"MultiSelect",items:{path:"/",template:new sap.m.StandardListItem("sapSplSelectBuPaListItem",{title:"{Partner_Name}",selected:"{showBupa}"})},select:jQuery.proxy(this.fnHandleSelectOfListItemOfSharedPermissions,this)}),beginButton:new sap.m.Button({text:oSapSplUtils.getBundle().getText("OK"),press:jQuery.proxy(this.fnHandleOKOfAddBupaDialog,this)}),endButton:new sap.m.Button({text:oSapSplUtils.getBundle().getText("CANCEL"),press:jQuery.proxy(this.fnHandleCancelOfAddBupaDialog,this)})}).addStyleClass("SapSplFilterDialog");}this.oAddBupaForSharingDialog.attachAfterOpen(function(e){oSapSplUtils.fnSyncStyleClass(e.getSource());});if(sap.ui.getCore().getModel("SapSplMyVehicleDetailModel").getData()["BupaPermissions"]){s=sap.ui.getCore().getModel("SapSplMyVehicleDetailModel").getData()["BupaPermissions"];}for(var i=0;i<s.length;i++){this.aSharedBupaDetails.push(jQuery.extend(true,{},s[i]));}var m=new sap.ui.model.json.JSONModel(this.getDataForDialog(this.aSharedBupaDetails,this.byId("sapSplSharePermissionsLayout")));this.oAddBupaForSharingDialog.setModel(m);this.oAddBupaForSharingDialog.open();},fnHandleSelectOfListItemOfSharedPermissions:function(e){oSapSplUtils.setIsDirty(true);var b=null,s=null,m=null;b=e.getParameters().listItem.getBindingContext().getObject();if(!e.getParameters().listItem.getSelected()){m=sap.ui.getCore().getModel("SapSplMyVehicleDetailModel").getData();s=m["oSharedPermissionInfo"];if(b["RelationUUID"]){s[b["Partner"]]=this.getSharePermissionsPayLoad(b,"D");}else{if(s[b["Partner"]]){delete s[b["Partner"]];}}m["oSharedPermissionInfo"]=s;sap.ui.getCore().getModel("SapSplMyVehicleDetailModel").setData(m);}},getSharePermissionsPayLoad:function(b,c){var p={};p["FromPartner"]=oSapSplUtils.getCompanyDetails()["UUID"];p["ToPartner"]=b["Partner"];p["Relation"]=this.getRelationValue(oSapSplUtils.getCompanyDetails()["Role"],b["Role"]);p["Text"]="";p["ObjectType"]="Vehicle";p["InstanceUUID"]=b["UUID"];if(!b["RelationUUID"]){p["UUID"]=oSapSplUtils.getUUID();}else{p["UUID"]=b["RelationUUID"];}if(c==="I"){p["Status"]="1";}else{p["Status"]="0";}p["ChangeMode"]=c;return p;},getRelationValue:function(f,t){var m=sap.ui.getCore().getModel("myConfigODataModel"),r="";var d=null,D="$filter=FromRole eq '"+f+"' and ToRole eq '"+t+"' and Scope eq 'SHARE_VEHICLE'",i=false;var u="/BusinessPartnerRoleRelation";if(m){m.read(u,d,D,i,function(a){if(a.results.length>0){r=a.results[0]["Name"];}else{r="";}},jQuery.proxy(this.errorOfRolesOdata,this));}return r;},getDataForDialog:function(S,g){this.aSharedBupaDetailsPreviouslySelected=[];for(var k=0;k<S.length;k++){S[k]["showBupa"]=false;}for(var i=0;i<g.getContent().length;i++){for(var j=0;j<S.length;j++){if(g.getContent()[i].getBindingContext().getObject()["Partner"]===S[j]["Partner"]){S[j]["showBupa"]=true;}}}for(var s=0;s<S.length;s++){this.aSharedBupaDetailsPreviouslySelected.push(jQuery.extend(true,{},S[s]));}return S;},fnHandleOKOfAddBupaDialog:function(){this.oAddBupaForSharingDialog.close();var m=sap.ui.getCore().getModel("SapSplMyVehicleDetailModel").getData();m["BupaPermissions"]=this.oAddBupaForSharingDialog.getModel().getData();sap.ui.getCore().getModel("SapSplMyVehicleDetailModel").setData(m);this.byId("sapSplSharePermissionsLayout").getBinding("content").filter(new sap.ui.model.Filter("showBupa",sap.ui.model.FilterOperator.EQ,true));},fnHandleCancelOfAddBupaDialog:function(){this.oAddBupaForSharingDialog.close();var m=sap.ui.getCore().getModel("SapSplMyVehicleDetailModel").getData();m["BupaPermissions"]=this.aSharedBupaDetailsPreviouslySelected;sap.ui.getCore().getModel("SapSplMyVehicleDetailModel").setData(m);this.byId("sapSplSharePermissionsLayout").getBinding("content").filter(new sap.ui.model.Filter("showBupa",sap.ui.model.FilterOperator.EQ,true));},handlePressOfRemoveSharePermissionButton:function(e){var t=this;function h(b,t){oSapSplUtils.setIsDirty(true);var s=[],S=null,d="";d=b["Partner"];var m=sap.ui.getCore().getModel("SapSplMyVehicleDetailModel").getData();s=m["BupaPermissions"];S=m["oSharedPermissionInfo"];for(var i=0;i<s.length;i++){if(s[i]["Partner"]===d){s[i]["showBupa"]=false;break;}}m["BupaPermissions"]=s;if(b["RelationUUID"]){S[b["Partner"]]=t.getSharePermissionsPayLoad(b,"D");}else{if(S[b["Partner"]]){delete S[b["Partner"]];}}m["oSharedPermissionInfo"]=S;sap.ui.getCore().getModel("SapSplMyVehicleDetailModel").setData(jQuery.extend(true,{},m));t.byId("sapSplSharePermissionsLayout").getBinding("content").filter(new sap.ui.model.Filter("showBupa",sap.ui.model.FilterOperator.EQ,true));}var b=e.getSource().getBindingContext().getObject();if(b["TourCount"]!==null){sap.m.MessageBox.show(oSapSplUtils.getBundle().getText("TRUCK_UNSHARE_CONFIRMATION_MESSAGE"),sap.m.MessageBox.Icon.WARNING,oSapSplUtils.getBundle().getText("PROMPT_FOR_DELETION_DIALOG_TITLE"),[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],function(s){if(s==="YES"){h(b,t);}},null,oSapSplUtils.fnSyncStyleClass("messageBox"));}else{h(b,t);}},fireEditAction:function(){if(this.byId("sapSplVehiclesDetailViewIconTabBar").getSelectedKey()==="info"){var c=null;c=sap.ui.getCore().getModel("SapSplMyVehicleDetailModel").getData();var b=sap.ui.getCore().getEventBus();b.publish("navInDetailVehicle","to",{from:this.getView(),data:{context:jQuery.extend({},c),mode:"Edit"}});}else{this.aSharedBupaDetailsBeforeEdit=[];this.byId("sapSplVehiclesDetailViewIconTabBar").getItems()[0].setEnabled(false);var m=sap.ui.getCore().getModel("SapSplMyVehicleDetailModel").getData();m["isEdit"]=true;if(m["BupaPermissions"]){for(var i=0;i<m["BupaPermissions"].length;i++){this.aSharedBupaDetailsBeforeEdit.push(jQuery.extend(true,{},m["BupaPermissions"][i]));}}sap.ui.getCore().getModel("SapSplMyVehicleDetailModel").setData(m);this.byId("sapSplAddBupaForSharingButton").rerender();this.byId("vehicleDetailEdit").setVisible(false);this.byId("vehicleDetailActivate_DeActicate").setVisible(false);this.byId("vehicleDetailDeRegister").setVisible(false);this.byId("vehicleSharePermissionsEditSave").setVisible(true);this.byId("vehicleSharedPermissionEditCancel").setVisible(true);if(m["BupaPermissions"]&&m["BupaPermissions"].length>0){this.byId("sapSplAddBupaSectionTitle").setText(oSapSplUtils.getBundle().getText("SHARED_WITH"));}else{this.byId("sapSplAddBupaSectionTitle").setText(oSapSplUtils.getBundle().getText("NOT_SHARED_YET_MESSAGE_IN_EDIT_MODE"));}}},fireSaveOfSharedPermissionsEdit:function(){var m=null,s=null,b=null,S=[];var t=this;m=sap.ui.getCore().getModel("SapSplMyVehicleDetailModel").getData();s=m["oSharedPermissionInfo"];b=m["BupaPermissions"];for(var i=0;i<b.length;i++){if(!b[i]["RelationUUID"]&&b[i]["showBupa"]===true){s[b[i]["Partner"]]=this.getSharePermissionsPayLoad(b[i],"I");}}jQuery.each(s,function(k,v){S.push(v);});if(S.length>0){var u=oSapSplUtils.getServiceMetadata("bupa",true);var d=JSON.stringify({Relation:S,inputHasChangeMode:true});var a={url:u,method:"PUT",contentType:"json; charset=UTF-8",data:d,success:jQuery.proxy(t.successFuncSharedPerm,t),error:jQuery.proxy(t.errorFuncSharedPerm,t)};oSapSplAjaxFactory.fireAjaxCall(a);}else{this.fireCancelOfSharedPermissionsEdit();}},successFuncSharedPerm:function(d,s,m){var M=sap.ui.getCore().getModel("SapSplMyVehicleDetailModel").getData();if(d.constructor===String){d=JSON.parse(d);}oSapSplBusyDialog.getBusyDialogInstance().close();if(m["status"]===200){sap.ca.ui.message.showMessageToast(oSapSplUtils.getBundle().getText("SUCCESSFUL_EDIT",M.RegistrationNumber));sap.ui.getCore().getModel("myVehiclesListODataModel").refresh();oSapSplUtils.setIsDirty(false);M["oSharedPermissionInfo"]={};sap.ui.getCore().getModel("SapSplMyVehicleDetailModel").setData(M);}else{if(d["Error"].length!==0){var e=oSapSplUtils.getErrorMessagesfromErrorPayload(d)["ufErrorObject"];sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["errorWarningString"],details:e});}}},errorFuncSharedPerm:function(e){jQuery.sap.log.error("fireSaveOfSharedPermissionsEdit","ajax failed","MyVehiclesDetail.controller.js");oSapSplBusyDialog.getBusyDialogInstance().close();if(e&&e["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+" "+e.statusText,details:e.responseText});}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["ufErrorObject"]});}},fireCancelOfSharedPermissionsEdit:function(){var t=this;if(oSapSplUtils.getIsDirty()){sap.m.MessageBox.show(oSapSplUtils.getBundle().getText("DATA_LOSS_WARNING_TEXT"),sap.m.MessageBox.Icon.WARNING,oSapSplUtils.getBundle().getText("WARNING"),[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.CANCEL],function(s){if(s==="YES"){t.byId("sapSplVehiclesDetailViewIconTabBar").getItems()[0].setEnabled(true);var m=sap.ui.getCore().getModel("SapSplMyVehicleDetailModel").getData();m["isEdit"]=false;m["BupaPermissions"]=t.aSharedBupaDetailsBeforeEdit;m["oSharedPermissionInfo"]={};sap.ui.getCore().getModel("SapSplMyVehicleDetailModel").setData(m);t.byId("vehicleDetailEdit").setVisible(true);t.byId("vehicleDetailActivate_DeActicate").setVisible(true);t.byId("vehicleDetailDeRegister").setVisible(true);t.byId("vehicleSharePermissionsEditSave").setVisible(false);t.byId("vehicleSharedPermissionEditCancel").setVisible(false);if(t.byId("sapSplSharePermissionsLayout").getBinding("content")&&t.byId("sapSplSharePermissionsLayout").getContent().length>0){t.byId("sapSplAddBupaSectionTitle").setText(oSapSplUtils.getBundle().getText("SHARED_WITH"));}else{t.byId("sapSplAddBupaSectionTitle").setText(oSapSplUtils.getBundle().getText("NOT_SHARED_YET_MESSAGE"));}oSapSplUtils.setIsDirty(false);}},null,oSapSplUtils.fnSyncStyleClass("messageBox"));}else{this.byId("sapSplVehiclesDetailViewIconTabBar").getItems()[0].setEnabled(true);var m=sap.ui.getCore().getModel("SapSplMyVehicleDetailModel").getData();m["isEdit"]=false;m["BupaPermissions"]=this.aSharedBupaDetailsBeforeEdit;m["oSharedPermissionInfo"]={};sap.ui.getCore().getModel("SapSplMyVehicleDetailModel").setData(m);this.byId("sapSplAddBupaForSharingButton").rerender();this.byId("vehicleDetailEdit").setVisible(true);this.byId("vehicleDetailActivate_DeActicate").setVisible(true);this.byId("vehicleDetailDeRegister").setVisible(true);this.byId("vehicleSharePermissionsEditSave").setVisible(false);this.byId("vehicleSharedPermissionEditCancel").setVisible(false);if(this.byId("sapSplSharePermissionsLayout").getBinding("content")&&this.byId("sapSplSharePermissionsLayout").getContent().length>0){this.byId("sapSplAddBupaSectionTitle").setText(oSapSplUtils.getBundle().getText("SHARED_WITH"));}else{this.byId("sapSplAddBupaSectionTitle").setText(oSapSplUtils.getBundle().getText("NOT_SHARED_YET_MESSAGE"));}}},fireActivate_DeactiveAction:function(e){var v=null,V=null,d=null;v=sap.ui.getCore().getModel("SapSplMyVehicleDetailModel").getData();if(e.getSource().getText()===oSapSplUtils.getBundle().getText("MY_VEHICLES_ACTIVATE")){oSapSplBusyDialog.getBusyDialogInstance({title:oSapSplUtils.getBundle().getText("BUSY_DIALOG_MESSAGE")}).open();V={"mode":"Activate Truck","data":v};d=new sap.ui.view({viewData:V,viewName:"splView.dialogs.SplTruckDeviceStatusDialog",type:sap.ui.core.mvc.ViewType.XML});d.getController().fnPerformActionBasedOnMode();}else if(e.getSource().getText()===oSapSplUtils.getBundle().getText("MY_VEHICLES_DEACTIVATE")){V={"mode":"Deactivate Truck","data":v,"Title":oSapSplUtils.getBundle().getText("VEHICLE_DEACTIVATE_CONFIRMATION")};d=new sap.ui.view({viewData:V,id:"DialogContent",viewName:"splView.dialogs.SplTruckDeviceStatusDialog",type:sap.ui.core.mvc.ViewType.XML});this.oDialog=new sap.m.Dialog({title:oSapSplUtils.getBundle().getText("DEACTIVATE_TRUCK"),leftButton:new sap.m.Button({text:oSapSplUtils.getBundle().getText("YES"),press:function(){d.getController().fnPerformActionBasedOnMode();this.getParent().close();}}),rightButton:new sap.m.Button({text:oSapSplUtils.getBundle().getText("NO"),press:function(){this.getParent().close();}}),horizontalScrolling:false}).attachAfterClose(function(){this.destroy();}).attachAfterOpen(function(e){oSapSplUtils.fnSyncStyleClass(e.getSource());});this.oDialog.addContent(d);this.oDialog.open();}},fireDeregisterAction:function(){var v=null;v=sap.ui.getCore().getModel("SapSplMyVehicleDetailModel").getData();var V={"mode":"Deregister Truck","data":v,"Title":oSapSplUtils.getBundle().getText("VEHICLE_DEREGISTER_CONFIRMATION")};var d=new sap.ui.view({viewData:V,id:"DialogContent",viewName:"splView.dialogs.SplTruckDeviceStatusDialog",type:sap.ui.core.mvc.ViewType.XML});this.oDialog=new sap.m.Dialog({title:oSapSplUtils.getBundle().getText("DEREGISTER_TRUCK"),leftButton:new sap.m.Button({text:oSapSplUtils.getBundle().getText("YES"),press:function(){d.getController().fnPerformActionBasedOnMode();this.getParent().close();}}),rightButton:new sap.m.Button({text:oSapSplUtils.getBundle().getText("NO"),press:function(){this.getParent().close();}}),horizontalScrolling:false}).attachAfterClose(function(){this.destroy();}).attachAfterOpen(function(e){oSapSplUtils.fnSyncStyleClass(e.getSource());});this.oDialog.addContent(d);this.oDialog.open();},onBeforeShow:function(e){if(e.data.context){sap.ui.getCore().getModel("SapSplMyVehicleDetailModel").setData(e.data.context);this.getView().getContent()[0].getFooter().getContentRight()[0].setVisible(true);this.getView().getContent()[0].getFooter().getContentRight()[1].setVisible(true);this.getView().getContent()[0].getFooter().getContentRight()[2].setVisible(true);this.getView().getContent()[0].getFooter().getContentRight()[3].setVisible(false);this.getView().getContent()[0].getFooter().getContentRight()[4].setVisible(false);if(e.data.context["Status"]==="A"){this.getView().getContent()[0].getFooter().getContentRight()[1].setText(oSapSplUtils.getBundle().getText("MY_VEHICLES_DEACTIVATE"));}else if(e.data.context["Status"]==="I"){this.getView().getContent()[0].getFooter().getContentRight()[1].setText(oSapSplUtils.getBundle().getText("MY_VEHICLES_ACTIVATE"));}}}});
