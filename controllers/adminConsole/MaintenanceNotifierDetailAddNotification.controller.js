/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.controller("splController.adminConsole.MaintenanceNotifierDetailAddNotification",{onInit:function(){var s=null;s=new sap.ui.model.json.JSONModel({});sap.ui.getCore().setModel(s,"SapSplMaintenanceNotifierAddNotificationModel");this.getView().setModel(sap.ui.getCore().getModel("SapSplMaintenanceNotifierAddNotificationModel"));this.getEnumerations();this.fnDefineControlLabelsFromLocalizationBundle();},fnDefineControlLabelsFromLocalizationBundle:function(){this.byId("AddNotificationFormTitle_Content").setText(oSapSplUtils.getBundle().getText("CONTENT"));this.byId("AddNotificationFormTitle_Validity").setText(oSapSplUtils.getBundle().getText("VALIDITY"));this.byId("SapSplAddNotificationMessageLabel").setText(oSapSplUtils.getBundle().getText("MESSAGE"));this.byId("SapSplAddNotificationTypeLabel").setText(oSapSplUtils.getBundle().getText("TYPE"));this.byId("SapSplAddNotificationStartTimeLabel").setText(oSapSplUtils.getBundle().getText("STARTS"));this.byId("SapSplAddNotificationExpiryTimeLabel").setText(oSapSplUtils.getBundle().getText("EXPIRES"));this.byId("sapSplAddNotificationSave").setText(oSapSplUtils.getBundle().getText("NEW_CONTACT_SAVE"));this.byId("sapSplAddNotificationCancel").setText(oSapSplUtils.getBundle().getText("CANCEL"));},fnHandlePressOfAddNotificationCancel:function(){var t=this;var m=$.extend(true,{},sap.ui.getCore().getModel("SapSplMaintenanceNotifierDetailModel").getData());var v={context:m};if(oSapSplUtils.getIsDirty()){sap.m.MessageBox.show(oSapSplUtils.getBundle().getText("DATA_LOSS_WARNING_TEXT"),sap.m.MessageBox.Icon.WARNING,oSapSplUtils.getBundle().getText("WARNING"),[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.CANCEL],function(s){if(s==="YES"){var v={context:m};t.getView().getParent().to("MaintenanceNotifierDetail","",v);t.selectMasterListItemOnBackNavigation("SapSplMaintenanceNotifierDetailModel");oSapSplUtils.setIsDirty(false);}},null,oSapSplUtils.fnSyncStyleClass("messageBox"));}else{this.getView().getParent().to("MaintenanceNotifierDetail","",v);this.selectMasterListItemOnBackNavigation("SapSplMaintenanceNotifierDetailModel");this.getView().getParent().getParent().getCurrentMasterPage().byId("sapSplMaintenanceNotifierMasterSearch").focus();}},selectMasterListItemOnBackNavigation:function(m){var i,c,a;c=sap.ui.getCore().getModel(m).getData();a=this.getView().getParent().getParent().getCurrentMasterPage().byId("SapSplMaintenanceNotifierList");for(i=0;i<a.getItems().length;i++){if(a.getItems()[i].sId.indexOf("oSapSplNotificationListItem")!==-1){if(a.getItems()[i].getBindingContext().getProperty().MessageUUID===c.MessageUUID){a.setSelectedItem(a.getItems()[i]);break;}}}},fnHandlePressOfAddNotificationSave:function(){if(this.compareDates()){var p=this.preparePayload(),t=this;oSapSplBusyDialog.getBusyDialogInstance({title:oSapSplUtils.getBundle().getText("BUSY_DIALOG_MESSAGE")}).open();window.setTimeout(function(){oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getServiceMetadata("message",true),method:"PUT",async:false,data:JSON.stringify(p),success:function(d,s,m){oSapSplBusyDialog.getBusyDialogInstance().close();if(d.constructor===String){d=JSON.parse(d);}if(m["status"]===200&&d["Error"].length===0){var a=sap.ui.getCore().getModel("SapSplMaintenanceNotifierAddNotificationModel").getData();if(a.Type==="new"){sap.ca.ui.message.showMessageToast(oSapSplUtils.getBundle().getText("NOTIFICATION_CREATED_SUCCESSFULLY"));}else{sap.ca.ui.message.showMessageToast(oSapSplUtils.getBundle().getText("NOTIFICATION_EDITED_SUCCESSFULLY"));}t.getView().getParent().getParent().getCurrentMasterPage().byId("SapSplMaintenanceNotifierList").addCustomData(new sap.ui.core.CustomData({key:d.Header[0]["UUID"]}));sap.ui.getCore().getModel("UserNotificationListODataModel").refresh();oSapSplUtils.setIsDirty(false);}},error:function(e){jQuery.sap.log.error("fnHandlePressOfAddNotificationSave","ajax failed","MaintenanceNotifierDetailAddNotification.controller.js");oSapSplBusyDialog.getBusyDialogInstance().close();if(e&&e["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+" "+e.statusText,details:e.responseText});}else{if(e.responseText.constructor===String){e.responseText=JSON.parse(e.responseText);}var d=e.responseText;sap.ca.ui.message.showMessageBox({type:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["messageTitle"],message:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["ufErrorObject"]});}},complete:function(){}});},20);}},preparePayload:function(){var m=sap.ui.getCore().getModel("SapSplMaintenanceNotifierAddNotificationModel").getData();var u=oSapSplUtils.getUUID(),t=oSapSplUtils.getUUID();var h={},T={};if(m.Type==="new"){h["UUID"]=u;h["Priority"]="1";h["OwnerID"]=oSapSplUtils.getCompanyDetails()["BasicInfo_CompanyID"];h["SenderID"]=oSapSplUtils.getCompanyDetails()["BasicInfo_CompanyID"];h["ThreadUUID"]=t;T["UUID"]=u;}else{h["UUID"]=m.MessageUUID;h["Priority"]=m.Priority;h["OwnerID"]=m.OwnerID;h["SenderID"]=m.SenderID;h["ThreadUUID"]=m.ThreadUUID;T["UUID"]=m.MessageUUID;}h["TemplateUUID"]="";m["Validity_StartTime"].setHours(m["Validity_StartTime1"].getHours());m["Validity_StartTime"].setMinutes(m["Validity_StartTime1"].getMinutes());m["Validity_StartTime"].setSeconds(0);m["Validity_EndTime"].setHours(m["Validity_EndTime1"].getHours());m["Validity_EndTime"].setMinutes(m["Validity_EndTime1"].getMinutes());m["Validity_EndTime"].setSeconds(0);h["Validity.StartTime"]=m["Validity_StartTime"];h["Validity.EndTime"]=m["Validity_EndTime"];h["AuditTrail.CreatedBy"]=null;h["AuditTrail.ChangedBy"]=null;h["AuditTrail.CreationTime"]=null;h["AuditTrail.ChangeTime"]=null;h["Type"]=this.byId("sapSplAddNotificationType").getSelectedItem().getBindingContext().getProperty()["Value"];h["isNotification"]="1";T["ShortText"]=m["Text1"];T["LongText"]=m["Text1"];return{Header:[h],Recipient:[],Text:[T],Object:"MessageOccurrence"};},onBeforeShow:function(e){var m=$.extend(true,{},sap.ui.getCore().getModel("SapSplMaintenanceNotifierAddNotificationModel").getData());var E=m["enum"];if(e.data.context&&e.data.context.type==="new"){m={};m["enum"]=E;this.byId("sapSplMaintenanceNotifierDetailAddNotificationPage").setTitle(oSapSplUtils.getBundle().getText("NEW_NOTIFICATION"));m.Validity_StartTime=new Date();m.Validity_EndTime=new Date();m.Validity_StartTime1=new Date();m.Validity_EndTime1=new Date();m.Text1="";m.Type="new";m.MessageType="Select";sap.ui.getCore().getModel("SapSplMaintenanceNotifierAddNotificationModel").setData(m);}else{this.byId("sapSplMaintenanceNotifierDetailAddNotificationPage").setTitle(oSapSplUtils.getBundle().getText("EDIT_NOTIFICATION"));e.data.context["enum"]=m["enum"];m=e.data.context;m.Type="edit";m.Validity_StartTime1=m.Validity_StartTime;m.Validity_EndTime1=m.Validity_EndTime;sap.ui.getCore().getModel("SapSplMaintenanceNotifierAddNotificationModel").setData(m);}},fnHandleChangeOfStartTime:function(){this.compareDates();this.fnToCaptureLiveChangeToSetFlag();},fnHandleChangeOfExpiryTime:function(){this.compareDates();this.fnToCaptureLiveChangeToSetFlag();},fnHandleChangeOfStartDate:function(){this.compareDates();this.fnToCaptureLiveChangeToSetFlag();},fnHandleChangeOfExpiryDate:function(){this.compareDates();this.fnToCaptureLiveChangeToSetFlag();},compareDates:function(){var m=sap.ui.getCore().getModel("SapSplMaintenanceNotifierAddNotificationModel").getData();var e=new Date(m.Validity_EndTime);var s=new Date(m.Validity_StartTime);var E=new Date(m.Validity_EndTime1);var S=new Date(m.Validity_StartTime1);if(e.toLocaleDateString()===s.toLocaleDateString()){this.byId("SapSplAddNotificationStartTime").setValueState("None");this.byId("SapSplAddNotificationExpiryTime").setValueState("None");if(E.getHours()>S.getHours()){this.byId("SapSplAddNotificationStartTimeValue").setValueState("None");this.byId("SapSplAddNotificationExpiryTimeValue").setValueState("None");this.byId("SapSplAddNotificationStartTime").setValueState("None");this.byId("SapSplAddNotificationExpiryTime").setValueState("None");return true;}else{if(E.getHours()===S.getHours()){if(E.getMinutes()>S.getMinutes()){this.byId("SapSplAddNotificationStartTimeValue").setValueState("None");this.byId("SapSplAddNotificationExpiryTimeValue").setValueState("None");return true;}else{this.byId("SapSplAddNotificationStartTimeValue").setValueState("Error");this.byId("SapSplAddNotificationExpiryTimeValue").setValueState("Error");return false;}}this.byId("SapSplAddNotificationStartTimeValue").setValueState("Error");this.byId("SapSplAddNotificationExpiryTimeValue").setValueState("Error");return false;}}else{if(e.getTime()>s.getTime()){this.byId("SapSplAddNotificationStartTime").setValueState("None");this.byId("SapSplAddNotificationExpiryTime").setValueState("None");this.byId("SapSplAddNotificationStartTimeValue").setValueState("None");this.byId("SapSplAddNotificationExpiryTimeValue").setValueState("None");return true;}else{this.byId("SapSplAddNotificationStartTime").setValueState("Error");this.byId("SapSplAddNotificationExpiryTime").setValueState("Error");return false;}}},getEnumerations:function(){var t=this;oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/utils/services/utils.xsodata/")+"Enumeration('NotificationType')/Values?$format=json",async:true,json:true,method:"GET",success:jQuery.proxy(t.updateEnumData,t),failure:jQuery.proxy(t.failureEnumData,t)});},updateEnumData:function(d){var r=[],s={},m=sap.ui.getCore().getModel("SapSplMaintenanceNotifierAddNotificationModel").getData();if(d.d.results){r=d.d.results;}if(r.length>0){s["Value"]="Select";s["Value.description"]=oSapSplUtils.getBundle().getText("PLEASE_SELECT_PLACEHOLDER");r.unshift(s);m["enum"]=r;sap.ui.getCore().getModel("SapSplMaintenanceNotifierAddNotificationModel").setData(m);}},failureEnumData:function(){},fnToHandleSelectNotificationType:function(e){e.getSource().setSelectedKey(e.getSource().getSelectedKey());this.fnToCaptureLiveChangeToSetFlag();},fnToCaptureLiveChangeToSetFlag:function(){var m=sap.ui.getCore().getModel("SapSplMaintenanceNotifierAddNotificationModel").getData();if(!oSapSplUtils.getIsDirty()){oSapSplUtils.setIsDirty(true);}if(this.byId("SapSplAddNotificationExpiryTime").getValueState()==="Error"){this.byId("sapSplAddNotificationSave").setEnabled(false);}else{this.byId("sapSplAddNotificationSave").setEnabled(splReusable.libs.SapSplModelFormatters.getNotificationSaveButtonEnabled(m));}}});
