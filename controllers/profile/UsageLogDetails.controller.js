/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.controller("splController.profile.UsageLogDetails",{onInit:function(){this.fnSetTextBundles();},fnSetTextBundles:function(){this.byId("sapSplUsageLogDetailsPage").setTitle(oSapSplUtils.getBundle().getText("USAGE_LOG"));this.byId("sapSplUsageLogDetailsObjectHeader").setNumberUnit(oSapSplUtils.getBundle().getText("BILLABLE_DAYS"));this.byId("sapSplUsageLogDetailsTrucksTableTitle").setText(oSapSplUtils.getBundle().getText("ACTIVE_TRUCK"));this.byId("sapSplUsageLogDetailsTrucksRegNumber").setText(oSapSplUtils.getBundle().getText("REGISTRATION_NUMBER"));this.byId("sapSplUsageLogDetailsTrucksDeviceId").setText(oSapSplUtils.getBundle().getText("DEVICE_ID"));this.byId("sapSplUsageLogDetailsTrucksDevicetype").setText(oSapSplUtils.getBundle().getText("DEVICE_TYPE"));this.byId("sapSplUsageLogDetailsTrucksFrom").setText(oSapSplUtils.getBundle().getText("FROM"));this.byId("sapSplUsageLogDetailsTrucksTo").setText(oSapSplUtils.getBundle().getText("TO"));this.byId("sapSplUsageLogDetailsUsersTableTitle").setText(oSapSplUtils.getBundle().getText("TOTAL_USERS"));this.byId("sapSplUsageLogDetailsUsersName").setText(oSapSplUtils.getBundle().getText("NAME"));this.byId("sapSplUsageLogDetailsUsersRole").setText(oSapSplUtils.getBundle().getText("ROLE"));this.byId("sapSplUsageLogDetailsUsersTableGroupBy").setTooltip(oSapSplUtils.getBundle().getText("GROUPBY_BUTTON_TOOLTIP"));this.byId("sapSplUsageLogDetailsTrucksTableGroupBy").setTooltip(oSapSplUtils.getBundle().getText("GROUPBY_BUTTON_TOOLTIP"));},onBeforeShow:function(e){this.fnSetHeaderModel(e.data.data);this.getUsageLogData(e.data.data);},fnHandleBackNavigation:function(e){$.sap.log.info("SAP SCL Usage Log","Back Navigation Event"+e.toString(),"SAPSCL");oSplBaseApplication.getAppInstance().back();},getUsageLogData:function(e){var t=this;var d={"CompanyID":oSapSplUtils.getCompanyDetails()["UUID"],"StartTime":e["StartTime"],"EndTime":e["EndTime"]};oSapSplAjaxFactory.fireAjaxCall({method:"POST",data:JSON.stringify(d),url:oSapSplUtils.getServiceMetadata("usageLogDetails",true),success:function(d){if(d.constructor===String){d=JSON.parse(d);}d.ActiveTrucks=d.ActiveTrucks.sort(function(a,b){if(a.RegistrationNumber<b.RegistrationNumber){return-1;}if(a.RegistrationNumber>b.RegistrationNumber){return 1;}return 0;});t.fnSetTableModel(d);},error:function(){throw new Error("Usage log service failed");}});},fnSetHeaderModel:function(h){h["Title"]=h["Name_Description"];h["TimeFilter"]=h["Filter"]+" ("+splReusable.libs.SapSplModelFormatters.showFormattedDateForUsageLog(h["StartTime"],h["EndTime"])+")";var H=new sap.ui.model.json.JSONModel(h);this.byId("sapSplUsageLogDetailsObjectHeader").setModel(H);},fnSetTableModel:function(t){var T=null;if(this.getView().getModel()){T=this.getView().getModel();}else{T=new sap.ui.model.json.JSONModel().setDefaultBindingMode("OneWay");}T.setData(t);this.getView().setModel(T);this.byId("sapSplUsageLogDetailsUsersTableTitle").setText(oSapSplUtils.getBundle().getText("TOTAL_USERS",this.getView().getViewData()[0].toString()));this.byId("sapSplUsageLogDetailsTrucksTableTitle").setText(oSapSplUtils.getBundle().getText("ACTIVE_TRUCK",this.getView().getViewData()[1].toString()));},fnHandleGrouping:function(e){var t=this;if(!this.oList){this.oList=new sap.m.List({mode:"SingleSelectLeft",select:function(E){E.getSource().getParent().close();t.fnHandleGroupingAfterDialogSelect(E.getSource().getSelectedItem().getBindingContext().getObject()["CONTEXT"]);},items:{path:"/",template:new sap.m.StandardListItem({title:"{Name}",selected:"{selected}"})}}).setModel(new sap.ui.model.json.JSONModel());this.aOne=[{Name:oSapSplUtils.getBundle().getText("NONE"),CONTEXT:["Trucks","None"],selected:true},{Name:oSapSplUtils.getBundle().getText("DEVICE_TYPE"),CONTEXT:["Trucks","DeviceType"],selected:false}];this.aTwo=[{Name:oSapSplUtils.getBundle().getText("NONE"),CONTEXT:["Users","None"],selected:true},{Name:oSapSplUtils.getBundle().getText("ROLE"),CONTEXT:["Users","Role"],selected:false}];}var g=new sap.m.Dialog({title:oSapSplUtils.getBundle().getText("GROUPBY_BUTTON_TOOLTIP"),endButton:new sap.m.Button({text:oSapSplUtils.getBundle().getText("CANCEL"),press:function(){this.getParent().close();}}),content:[t.oList]});if(e.getSource().sId.split("--")[1]==="sapSplUsageLogDetailsTrucksTableGroupBy"){t.oList.getModel().setData(this.aOne);}else if(e.getSource().sId.split("--")[1]==="sapSplUsageLogDetailsUsersTableGroupBy"){t.oList.getModel().setData(this.aTwo);}g.open().attachAfterOpen(function(){oSapSplUtils.fnSyncStyleClass(g);});},fnHandleGroupingAfterDialogSelect:function(c){if(c[0]==="Trucks"){if(c[1]!=="None"){this.getView().byId("sapSplUsageLogDetailsTrucksTable").getBinding("items").sort(new sap.ui.model.Sorter(c[1],true,function(C){var k=C.getProperty("DeviceType");if(!k){return{key:"No Device",text:oSapSplUtils.getBundle().getText("GROUP_HEADER_NO_DEVICE")};}else{return{key:k,text:k};}}));}else{this.getView().byId("sapSplUsageLogDetailsTrucksTable").getBinding("items").sort([]);}}if(c[0]==="Users"){if(c[1]!=="None"){this.getView().byId("sapSplUsageLogDetailsUsersTable").getBinding("items").sort(new sap.ui.model.Sorter(c[1],true,function(C){var k=C.getProperty("Role");if(!k){return{key:"No Role",text:k};}else{return{key:k,text:k};}}));}else{this.getView().byId("sapSplUsageLogDetailsUsersTable").getBinding("items").sort([]);}}},onAfterRendering:function(){}});
