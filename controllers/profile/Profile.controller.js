/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
jQuery.sap.require("splReusable.libs.SapSplAppErrorHandler");jQuery.sap.require("sap.m.MessageBox");sap.ui.controller("splController.profile.Profile",{oCompanyProfileModel:{},oCompanyDetails:{},oUsageLogModel:null,onInit:function(){this.customDate1=null;this.customDate2=null;splReusable.libs.SapSplStyleSheetLoader.loadStyle("./resources/styles/sapSplProfile");sap.ui.getCore().setModel(new sap.ui.model.json.JSONModel({editButton:true}),"profileButtonVisibilityModel");this.getView().byId("sapSplEditHubButton").addCustomData(new sap.ui.core.CustomData({key:"EditHubDetails",value:"EditHubDetails"}));this.getView().byId("sapSplAddHubButton").addCustomData(new sap.ui.core.CustomData({key:"AddHub",value:"AddHub"}));this.getView().byId("sapSplDeregisterMyCompanyButton").addCustomData(new sap.ui.core.CustomData({key:"DeregisterHub",value:"DeregisterHub"}));this.sSelectedTimeHorizon="C";var d={results:[{name:oSapSplUtils.getBundle().getText("CURRENT_MONTH"),key:"C"},{name:oSapSplUtils.getBundle().getText("LAST_MONTH"),key:"L"},{name:oSapSplUtils.getBundle().getText("LAST_QUARTER"),key:"Q"},{name:oSapSplUtils.getBundle().getText("LAST_QUARTER_TODATE"),key:"QTD"},{name:oSapSplUtils.getBundle().getText("MANUAL_SELECTION"),key:"Manual"}]};this.sapSplUsageTimeHorizonModel=new sap.ui.model.json.JSONModel();this.sapSplUsageTimeHorizonModel.setData(d);this.byId("SapSplUsageTimeHorizon").setModel(this.sapSplUsageTimeHorizonModel);this.byId("SapSplUsageTimeHorizon").setModel(this.sapSplUsageTimeHorizonModel);if(this.byId("SapSplUsageTimeHorizon")){this.byId("SapSplUsageTimeHorizon").addEventDelegate({onAfterRendering:function(e){e.srcControl.$().on("focusout",function(e){e.stopPropagation();});}});}},onBeforeRendering:function(){},handleIconTabSelect:function(e){if(e&&e.getParameter("key")!==undefined){if(e.getParameter("key")==="sapSplUsageInfo"){sap.ui.getCore().getModel("profileButtonVisibilityModel").getData()["editButton"]=false;sap.ui.getCore().getModel("profileButtonVisibilityModel").refresh();this.byId("sapSnlhCompnayTourSettingsSaveButton").setVisible(false);this.byId("sapSnlhCompnayTourSettingsCancelButton").setVisible(false);this.handleUsagelogTabSelect();this.byId("SapSplUsageTimeHorizon").focus();}else if(e.getParameter("key")==="sapSplCompanyInfo"){sap.ui.getCore().getModel("profileButtonVisibilityModel").getData()["editButton"]=true;sap.ui.getCore().getModel("profileButtonVisibilityModel").refresh();this.byId("sapSnlhCompnayTourSettingsSaveButton").setVisible(false);this.byId("sapSnlhCompnayTourSettingsCancelButton").setVisible(false);this.byId("btnEditCompanyProfile").setVisible(splReusable.libs.SapSplModelFormatters.showEditable(this.oCompanyProfileModel.getData().isEditable,sap.ui.getCore().getModel("profileButtonVisibilityModel").getData().editButton));}else if(e.getParameter("key")==="sapSnlhCompanyTourSettings"){sap.ui.getCore().getModel("profileButtonVisibilityModel").getData()["editButton"]=true;sap.ui.getCore().getModel("profileButtonVisibilityModel").refresh();if(!sap.ui.getCore().getModel("SapSnlhCompanyTourSettingsModel")){var s=new sap.ui.model.json.JSONModel({});this.initializeThresholdJson();sap.ui.getCore().setModel(s,"SapSnlhCompanyTourSettingsModel");this.getView().byId("sapSnlhTourSettingsTable").setModel(sap.ui.getCore().getModel("SapSnlhCompanyTourSettingsModel"));this.getView().byId("sapSnlhTourSettingsTable").addEventDelegate({onAfterRendering:function(e){var r;var t=e.srcControl.getItems();for(var i=0;i<t.length;i++){r=sap.ui.getCore().byId(t[i].getCells()[6].getItems()[0].getCells()[0].sId).$()[0].textContent.replace(new RegExp(oSapSplUtils.getBundle().getText("TOUR_SETTINGS_WARNING"),'g'),'<span class=sapSnlhOrangeText>'+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_WARNING")+'</span>');sap.ui.getCore().byId(t[i].getCells()[6].getItems()[0].getCells()[0].sId).$()[0].innerHTML=r;r=sap.ui.getCore().byId(t[i].getCells()[6].getItems()[1].getCells()[0].sId).$()[0].textContent.replace(new RegExp(oSapSplUtils.getBundle().getText("TOUR_SETTINGS_CRITICAL"),'g'),'<span class=sapSnlhRedText>'+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_CRITICAL")+'</span>');sap.ui.getCore().byId(t[i].getCells()[6].getItems()[1].getCells()[0].sId).$()[0].innerHTML=r;}}});}this.fireAjaxToGetListOfThresholdRules();}}else{$.sap.log.error("SAP Connected Logistics Profile","Icon tab switch event handler error","SAPSCL");}},fireAjaxToGetListOfThresholdRules:function(){var t=this;oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/app/services/appl.xsodata/TourPreference"),method:"GET",async:true,success:function(r){var d=[];d=r.d.results;if(d&&d.length>0){d.sort(splReusable.libs.SapSplModelFormatters.sortThresholdRulesObjectBasedOnLowerThreshold);d[0].fromArray=t.thresholdArray;for(var i=0;i<d.length;i++){d[i].toSelectError=false;d[i].fromSelectError=false;if(i!==0){d[i].fromArray=t.getThresholdArrayForSelectControl(parseInt(d[i-1].LowerThreshold));d[i].isEnabled=false;}else{d[i].isEnabled=true;}d[i].toArray=t.getThresholdArrayForSelectControl(parseInt(d[i].LowerThreshold));if(d[i].UpperThreshold===null){d[i].UpperThreshold="518460";}}sap.ui.getCore().getModel("SapSnlhCompanyTourSettingsModel").setData({data:d,isEdit:false});}else{sap.ui.getCore().getModel("SapSnlhCompanyTourSettingsModel").setData({data:[],isEdit:false});}},error:function(){sap.ui.getCore().getModel("SapSnlhCompanyTourSettingsModel").setData({data:[],isEdit:false});}});},onAfterRendering:function(){this.byId("profilePage").setTitle(oSapSplUtils.getBundle().getText("HEADER_COMPANY_PROFILE"));this.byId("btnEditCompanyProfile").setProperty("text",oSapSplUtils.getBundle().getText("MY_COLLEAGUES_EDIT_BUTTON")).setTooltip(oSapSplUtils.getBundle().getText("MY_COLLEAGUES_EDIT_BUTTON"));this.byId("sapSplCompanyHeaderInfoIcon").setText(oSapSplUtils.getBundle().getText("INFORMATION_LABEL")).setTooltip(oSapSplUtils.getBundle().getText("INFORMATION_LABEL"));this.byId("sapSplUsageLogIcon").setText(oSapSplUtils.getBundle().getText("USAGE_LOG_LABEL")).setTooltip(oSapSplUtils.getBundle().getText("USAGE_LOG_LABEL"));this.byId("sapSplCompanyProfileStreet").setText(oSapSplUtils.getBundle().getText("STREET"));this.byId("sapSplCompanyProfileTown").setText(oSapSplUtils.getBundle().getText("TOWN"));this.byId("sapSplCompanyProfileDistrict").setText(oSapSplUtils.getBundle().getText("DISTRICT"));this.byId("sapSplCompanyProfileCountry").setText(oSapSplUtils.getBundle().getText("COUNTRY"));this.byId("sapSplCompanyProfilePhone").setText(oSapSplUtils.getBundle().getText("PHONE"));this.byId("sapSplCompanyProfileFax").setText(oSapSplUtils.getBundle().getText("FAX"));this.byId("sapSplComanyProfileWebsite").setText(oSapSplUtils.getBundle().getText("COMPANY_PROFILE_COMPANY_WEBSITE"));this.byId("SapSplUsageLogHeader").setNumberUnit(oSapSplUtils.getBundle().getText("BILLABLE_DAYS"));this.byId("sapSplUsageLogHeaderlabel").setText(oSapSplUtils.getBundle().getText("USAGE_DETAIL"));this.HorizonText=oSapSplUtils.getBundle().getText("CURRENT_MONTH");},onBeforeShow:function(){},updateBindings:function(e){var t=this;oSapSplUtils.showHeaderButton({showButton:true,sNavToPage:"splView.tileContainer.MasterTileContainer",navIcon:"sap-icon://home"});function c(){var A={};function b(r){if(r.d.results&&r.d.results.length===0){t.getView().byId("sapSplAddHubButton").setEnabled(false);t.getView().byId("sapSplAddHubButton").setTooltip(oSapSplUtils.getBundle().getText("NO_HUBS_AVAILABLE_TO_CONNECT_TO"));}}function d(){}var o={url:oSapSplUtils.getServiceMetadata(SapSplEnums.RootApp,true)+"/PossibleOwnerList?$format=json&$filter=isConnected eq 0",success:b,error:d,handleBusyIndicator:false};A=oSapSplAjaxFactory.fireAjaxCall(o);}function _(e,i){this.oCompanyDetails=oSapSplUtils.getCompanyDetails();this.oCompanyDetails.MyOwnerList=t.fnCallToFetchConnectedhubs();oSapSplUtils.setCompanyDetails(oSapSplUtils.getCompanyDetails());c();i.oCompanyProfileModel.setData(this.oCompanyDetails);i.byId("profilePage").setModel(i.oCompanyProfileModel);}function a(e,i){if(e.backData&&e.backData.goBackWithData===1){var A={};var u=oSapSplUtils.getServiceMetadata(SapSplEnums.RootApp,true)+"/MyOrganization/?$format=json";function b(r){var k=["spl-change-prompt-subscr","spl-change-prompt-tour"];var K=oSapSplUtils.getKeys("session",k);var f=false;if(!(r.d.results[0]["MyOwnerList"])){r.d.results[0].MyOwnerList=oSapSplUtils.getCompanyDetails().MyOwnerList;}oSapSplUtils.setCompanyDetails(r.d.results[0]);var m=new sap.ui.model.json.JSONModel();m.setData(r.d.results[0]);i.byId("profilePage").setModel(m);for(var g in K){if(K.hasOwnProperty(g)){oSapSplUtils.getStorageInstance("session").remove(g);f=true;}}if(f){oSapSplEventFactory.dispatch("reloadApp");}};function d(x){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getBundle().getText("GENERIC_ERROR_MESSAGE"),details:oSapSplUtils.getErrorMessagesfromErrorPayload(x.responseText)},function(){});};var o={url:u,success:b,error:d,handleBusyIndicator:false};A=oSapSplAjaxFactory.fireAjaxCall(o);}else{i.oCompanyProfileModel.setData(oSapSplUtils.getCompanyDetails());i.byId("profilePage").setModel(i.oCompanyProfileModel);}c();}if(!this.oCompanyProfileModel.hasOwnProperty("oData")){this.oCompanyProfileModel=new sap.ui.model.json.JSONModel();}if(e.data&&!e.backData.hasOwnProperty("goBackWithData")){_(e,this);}else{a(e,this);}},fnCallToFetchConnectedhubs:function(){var c=[];var u=oSapSplUtils.getServiceMetadata(SapSplEnums.RootApp,true)+"/PossibleOwnerList?$format=json&$filter=isConnected eq 1";var a,A={};function s(r){if(r.d.results.length>0){c=r.d.results;}}function e(){}a={url:u,async:false,success:s,error:e};A=oSapSplAjaxFactory.fireAjaxCall(a);return c;},onExit:function(){},refreshAccountStatus:function(){var t=this;var a={};var u=oSapSplUtils.getServiceMetadata(SapSplEnums.RootApp,true)+"/MyOrganization/?$select=BuPaReplication&$format=json";var A={url:u,method:"GET",success:function(r){var m=t.byId("sapSplCompanyProfileHeader").getModel();var d=m.getData();d.BuPaReplication=r.d.results[0].BuPaReplication;m.setData(d);},handleBusyIndicator:true};a=oSapSplAjaxFactory.fireAjaxCall(A);},handleProfileBackNavigation:function(){oSplBaseApplication.getAppInstance().back();},handleProfileEditActionEvent:function(){if(this.byId("sapSplCompanyProfileIconTabBar").getSelectedKey()==="sapSnlhCompanyTourSettings"){var t=this.byId("sapSnlhTourSettingsTable");this.byId("btnEditCompanyProfile").setVisible(false);this.byId("sapSnlhCompnayTourSettingsSaveButton").setVisible(true);this.byId("sapSnlhCompnayTourSettingsCancelButton").setVisible(true);this.byId("sapSnlhTourSettingsTable").setMode("Delete");this.byId("sapSnlhTourSettingsAddRuleLink").setVisible(true);var m=$.extend(true,{},sap.ui.getCore().getModel("SapSnlhCompanyTourSettingsModel").getData());m.isEdit=true;this.toDeleteArray=[];sap.ui.getCore().getModel("SapSnlhCompanyTourSettingsModel").setData(m);this.previousModelData=$.extend(true,{},sap.ui.getCore().getModel("SapSnlhCompanyTourSettingsModel").getData());window.setTimeout(function(){if(sap.ui.getCore().byId("splView.profile.Profile--sapSnlhTourSettingsTable")&&sap.ui.getCore().byId("splView.profile.Profile--sapSnlhTourSettingsTable").getItems()[0]){if(sap.ui.getCore().byId("splView.profile.Profile--sapSnlhTourSettingsTable").getItems()[0].getCells()[2]){sap.ui.getCore().byId("splView.profile.Profile--sapSnlhTourSettingsTable").getItems()[0].getCells()[2].focus();}}},100);}else{if(!oSplBaseApplication.getAppInstance().getPage("splView.profile.EditProfile")){var e=sap.ui.view({viewName:"splView.profile.EditProfile",id:"splView.profile.EditProfile",type:sap.ui.core.mvc.ViewType.XML});e.addEventDelegate({onBeforeShow:function(E){this.oPayloadObject.Header=[];this.getData(E);}},e.getController());oSplBaseApplication.getAppInstance().addPage(e);}oSplBaseApplication.getAppInstance().to("splView.profile.EditProfile",{cDetails:oSapSplUtils.getCompanyDetails()});}},handleProfileSaveActionEvent:function(){},btnCancelCompanyEditProfile:function(){},handleDeregisterOfCompany:function(n,r,h,s){var t=this;jQuery.sap.require("splReusable.libs.DeregistrationHandler");function a(){var p={"inputHasChangeMode":true,"Relation":[{"UUID":r,"ChangeMode":"D"}]};function _(){oSapSplUtils.sLO4S="app";if(n===1){oSapSplUtils.getStorageInstance("local").put("src",2);window.location.href=SapSplEnums.REDIRPATH;}else{sap.m.MessageToast.show(oSapSplUtils.getBundle().getText("APPLICATION_RELOADING"),{duration:2000,onClose:function(){_();}});oSapSplEventFactory.dispatch("reloadApp");}}function b(){oSapSplBusyDialog.getBusyDialogInstance().open();oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getServiceMetadata("bupa",true),method:"POST",data:JSON.stringify(p),dataType:"json",beforeSend:function(x){x.setRequestHeader("X-CSRF-Token",oSapSplUtils.getCSRFToken());x.setRequestHeader("Content-Type","application/json;charset=utf-8");},success:function(){oSapSplBusyDialog.getBusyDialogInstance().close();t.oDialog.close();sap.m.MessageToast.show(oSapSplUtils.getBundle().getText("COMPANY_DEREGISTRATION_SUCCESSFUL_TOAST"),{duration:2000,onClose:function(){_();}});},error:function(x){oSapSplBusyDialog.getBusyDialogInstance().close();oSapSplAppErrorHandler.show(x,false,null,function(d){jQuery.sap.log.info("SAP Connected Logistics","Dialog close Event fired "+d.m,"SAPSCL");});}});}b();}oSapSplDeregistrationHandler.launch(h,function(){a();},function(){},function(){},function(){});},handleTSIWalletLaunchPress:function(){function _(d){var D=new sap.m.Dialog({height:"400px",width:"400px",title:oSapSplUtils.getBundle().getText("TSI_WALLET_TITLE"),endButton:new sap.m.Button({text:oSapSplUtils.getBundle().getText("CLOSE_TSI_WALLET_DIALOG"),press:function(){D.close();}}),afterClose:function(){D.destroy();},content:[new sap.ui.core.HTML({content:"<iframe width=\"600\" seamless=\"seamless\" frameborder=\"0\" height=\"600\" onload=parent.scrollTo(0,0); src = "+encodeURI(d.url+"?"+d.token)+"/>"})]});D.open().attachAfterOpen(function(){oSapSplUtils.fnSyncStyleClass(D);});}var a={};var t=this;function T(x){x.setRequestHeader("X-CSRF-Token",oSapSplUtils.getCSRFToken());}function f(d,c,x){try{if(d.constructor===String){try{d=JSON.parse(d);}catch(e){jQuery.sap.log.fatal("Wallet management","Wallet management parsing of data failed with error "+e.message,"SAPSCL");}}if(d&&d.url&&d.token){_(d);}}catch(e){jQuery.sap.log.fatal("Invalid character identified in response of service");oSapSplAppErrorHandler.show(x,false,null,null);}}function b(x){oSapSplAppErrorHandler.show(x,false,null,null);}a={url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/app/services/configureTSIWallet.xsjs/"),method:"POST",data:JSON.stringify(t.getPayLoadForCustomerAccount()),beforeSend:T,success:f,error:b};oSapSplAjaxFactory.fireAjaxCall(a);},handleAddEditHubOperatorPress:function(e){var t=this;var T=null;var b=null;var f=false;var s=null;var o=null;var S,a,h=null;function c(m){t.Relation=m.results;}function d(m){oSapSplBusyDialog.getBusyDialogInstance().close();if(m&&m["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:m["status"]+" "+m.statusText,details:m.responseText});}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(m.responseText))["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(m.responseText))["ufErrorObject"]});}}function g(){var m=sap.ui.getCore().getModel("myConfigODataModel");var D=null,q="$filter=FromRole eq '"+oSapSplUtils.getCompanyDetails().Role+"' and ToRole eq 'LSPACEOP' and (Scope eq 'OWNER' or Scope eq 'SERVICE_SUBSCRIPTION')",I=false;var u="/BusinessPartnerRoleRelation";if(m){m.read(u,D,q,I,c,d);}}function p(m,q){var u={};u["UUID"]=oSapSplUtils.getCompanyDetails().UUID;u["BasicInfo.Type"]="O";u["BasicInfo.CompanyID"]=oSapSplUtils.getCompanyDetails().UUID;u["BasicInfo.ID"]=oSapSplUtils.getCompanyDetails().BasicInfo_ID;u["isVisibleOnSearch"]=m;u["ChangeMode"]="U";u["OwnerUUID"]=q;return[u];}function i(m,q,C,u){var v=[];var R={};if(C==="Create"){R["UUID"]=oSapSplUtils.getUUID();R["FromPartner"]=oSapSplUtils.getCompanyDetails().UUID;R["ToPartner"]=m;if(t.Relation[0].Scope==="OWNER"){R["Relation"]=t.Relation[0].Name;}else if(t.Relation[1].Scope==="OWNER"){R["Relation"]=t.Relation[1].Name;}R["Text"]="";R["Status"]="1";R["ObjectType"]="BuPa-O";R["InstanceUUID"]=null;R["ChangeMode"]="I";v.push(R);R={};R["UUID"]=oSapSplUtils.getUUID();R["FromPartner"]=oSapSplUtils.getCompanyDetails().UUID;R["ToPartner"]=m;if(t.Relation[0].Scope==="SERVICE_SUBSCRIPTION"){R["Relation"]=t.Relation[0].Name;}else if(t.Relation[1].Scope==="SERVICE_SUBSCRIPTION"){R["Relation"]=t.Relation[1].Name;}R["Text"]="";R["Status"]="1";R["ObjectType"]="SubscriptionProduct";R["InstanceUUID"]=q;R["ChangeMode"]="I";v.push(R);}else if(C==="Edit"){R["UUID"]=u;R["ChangeMode"]="D";v.push(R);R={};R["UUID"]=oSapSplUtils.getUUID();R["FromPartner"]=oSapSplUtils.getCompanyDetails().UUID;R["ToPartner"]=m;if(t.Relation[0].Scope==="SERVICE_SUBSCRIPTION"){R["Relation"]=t.Relation[0].Name;}else if(t.Relation[1].Scope==="SERVICE_SUBSCRIPTION"){R["Relation"]=t.Relation[1].Name;}R["Text"]="";R["Status"]="1";R["ObjectType"]="SubscriptionProduct";R["InstanceUUID"]=q;R["ChangeMode"]="I";v.push(R);}return v;}function F(m){var q={};function u(y){y.setRequestHeader("X-CSRF-Token",oSapSplUtils.getCSRFToken());y.setRequestHeader("Cache-Control","max-age=0");}function v(y,z,A){oSapSplBusyDialog.getBusyDialogInstance().close();t.oDialog.close();if(y.constructor===String){y=JSON.parse(y);}if(A["status"]===200&&y["Error"].length===0){if(t.oDialog.getContent()[0].getViewData().Text==="Create"){sap.m.MessageToast.show(oSapSplUtils.getBundle().getText("ADD_NEW_HUB_SUCCESSFUL_TOAST"));}else if(t.oDialog.getContent()[0].getViewData().Text==="Edit"){sap.m.MessageToast.show(oSapSplUtils.getBundle().getText("CHANGES_SAVED_SUCCESS"));}oSapSplUtils.sLO4S="app";oSapSplEventFactory.dispatch("reloadApp");}else if(y["Error"].length>0){var B=oSapSplUtils.getErrorMessagesfromErrorPayload(y)["ufErrorObject"];sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(y)["errorWarningString"],details:B});}}function w(y){oSapSplBusyDialog.getBusyDialogInstance().close();if(y&&y["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:y["status"]+" "+y.statusText,details:y.responseText});}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(y.responseText))["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(y.responseText))["ufErrorObject"]});}}q={url:oSapSplUtils.getFQServiceUrl("sap/spl/xs/app/services/businessPartner.xsjs"),method:"POST",contentType:"json; charset=UTF-8",async:false,cache:false,data:JSON.stringify(m),beforeSend:u,success:v,error:w};var x=oSapSplAjaxFactory.fireAjaxCall(q);}function r(m){oSapSplBusyDialog.getBusyDialogInstance({title:oSapSplUtils.getBundle().getText("BUSY_DIALOG_MESSAGE")}).open();window.setTimeout(F(m),10);}function j(){var m={inputHasChangeMode:true};var q=null;var u=null;var v=null;var w=null;if(this.getParent().getParent().getContent()[0].getController().byId("BuPaIsVisibleCheckBox").getSelected()){w="1";}else{w="0";}if(this.getParent().getParent().getContent()[0].getViewData().Text==="Create"){g();q=this.getParent().getParent().getContent()[0].getController().byId("SelectNewHub").getSelectedItem().getBindingContext().getProperty().OwnerID;u=this.getParent().getParent().getContent()[0].getController().byId("SubscriptionPackage").getSelectedItem().getBindingContext().getProperty().ProductUUID;m.Header=p(w,q);m["Relation"]=i(q,u,"Create");r(m);}else if(this.getParent().getParent().getContent()[0].getViewData().Text==="Edit"){if((this.getParent().getParent().getContent()[0].getController().byId("SubscriptionPackage").getSelectedItem().getBindingContext().getProperty().Name!==t.selectedSubscriptionPackage)||oSapSplUtils.getIsDirty()){g();q=s.OwnerID;v=s.RelationUUID;u=this.getParent().getParent().getContent()[0].getController().byId("SubscriptionPackage").getSelectedItem().getBindingContext().getProperty().ProductUUID;m.Header=p(w,q);if(u!==s.SubscriptionUUID){m["Relation"]=i(q,u,"Edit",v);}r(m);}else{t.oDialog.close();sap.m.MessageToast.show(oSapSplUtils.getBundle().getText("CHANGES_SAVED_SUCCESS"));}}else if(this.getParent().getParent().getContent()[0].getViewData().Text==="Deregister"){g();t.handleDeregisterOfCompany(this.getParent().getParent().getContent()[0].getController().oSapSplHubListModel.getData().connectedHubs.length,this.getParent().getParent().getContent()[0].getController().byId("SelectOneOfAlreadyConnectedHubsToDeregister").getSelectedItem().getBindingContext().getProperty().OwnerRelationUUID,this.getParent().getParent().getContent()[0].getController().byId("SelectOneOfAlreadyConnectedHubsToDeregister").getSelectedItem().getBindingContext().getProperty().OwnerName,this.getParent().getParent().getContent()[0].getController().byId("SelectOneOfAlreadyConnectedHubsToDeregister").getSelectedItem().getBindingContext().getProperty().RelationUUID);}}function k(){var t=this;if(oSapSplUtils.getIsDirty()){sap.m.MessageBox.show(oSapSplUtils.getBundle().getText("DATA_LOSS_WARNING_TEXT"),sap.m.MessageBox.Icon.WARNING,oSapSplUtils.getBundle().getText("WARNING"),[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.CANCEL],function(m){if(m==="YES"){oSapSplUtils.setIsDirty(false);t.getParent().getParent().close();t.getParent().getParent().destroy();}},null,oSapSplUtils.fnSyncStyleClass("messageBox"));}else{oSapSplUtils.setIsDirty(false);this.getParent().getParent().close();this.getParent().getParent().destroy();}}if(e.getSource().getCustomData()[0].getKey()==="AddHub"){T=oSapSplUtils.getBundle().getText("ADD_HUB");b=oSapSplUtils.getBundle().getText("NEW_CONTACT_ADD");o="Create";}else if(e.getSource().getCustomData()[0].getKey()==="EditHubDetails"){T=oSapSplUtils.getBundle().getText("MY_COLLEAGUES_EDIT_BUTTON");b=oSapSplUtils.getBundle().getText("SAVE_PROFILE_ACTION");o="Edit";s=e.getSource().getBindingContext().getObject();}else if(e.getSource().getCustomData()[0].getKey()==="DeregisterHub"){T=oSapSplUtils.getBundle().getText("COMPANY_PROFILE_LINK_DEREGISTER_MY_COMPANY");b=oSapSplUtils.getBundle().getText("COMPANY_PROFILE_LINK_DEREGISTER_MY_COMPANY");o="Deregister";f=true;}h=this.oCompanyProfileModel.getData().MyOwnerList[0];var l=jQuery.extend(true,{},s);var n=sap.ui.view({viewName:"splView.dialogs.SplAddEditHubDialog",type:sap.ui.core.mvc.ViewType.XML,viewData:{View:this,Text:o,MyOwners:t.aMyOwnerList,SelectedHubForEdit:jQuery.extend(true,{},s),SelectedHubDetails:l,SelectedHubForCreateHub:jQuery.extend(true,{},h)}});this.oDialog=new sap.m.Dialog({height:"400px",width:"400px",title:T,id:"addEditDeregisterHubDialog",beginButton:new sap.m.Button({text:b,press:j,enabled:f}),endButton:new sap.m.Button({text:oSapSplUtils.getBundle().getText("CANCEL"),press:k}),afterClose:function(e){e.getSource().destroy();},content:n}).addStyleClass("addEditDeregisterHubDialog");this.oDialog.open().attachAfterOpen(function(){S=t.oDialog.getContent()[0].getContent()[0].getContent()[4].getSelectedItem();a=jQuery.extend(true,{},S);t.selectedSubscriptionPackage=t.oDialog.getContent()[0].getViewData().SelectedHubForEdit.SubscriptionProductName;t.selectedSubscriptionPackageName=t.oDialog.getContent()[0].getViewData().SelectedHubForEdit.SubscriptionName;oSapSplUtils.fnSyncStyleClass(t.oDialog);n.getController().setSubscriptionItem(a);});},getPayLoadForCustomerAccount:function(){var p={"BusinessPartnerUUID":oSapSplUtils.getCompanyDetails()["BasicInfo_CompanyID"],"reference":"FedEx-at-Logiweb","telematicDataProviderType":"Logiweb","description":"FedEx Logiweb account"};return p;},handleUsagelogTabSelect:function(){if(!this.oUsageLogModel){this.oUsageLogModel=new sap.ui.model.json.JSONModel();this.fetchUsageLogData();}},fetchUsageLogData:function(b,f,t){var a={};var A={};A={url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/app/services/usage.xsjs/"),method:"POST",data:JSON.stringify(this.getPayLoadForUsageLog(b,f,t)),beforeSend:jQuery.proxy(this.fetchUsageLogBeforeSend,this),success:jQuery.proxy(this.fetchUsageLogSuccess,this),error:jQuery.proxy(this.fetchUsageLogError,this)};a=oSapSplAjaxFactory.fireAjaxCall(A);},fetchUsageLogBeforeSend:function(x){x.setRequestHeader("X-CSRF-Token",oSapSplUtils.getCSRFToken());x.setRequestHeader("Content-Type","application/json");},fetchUsageLogSuccess:function(d){try{if(d.constructor===String){d=JSON.parse(d);}this.oUsageLogModel.setData({results:d});this.getView().byId("SapSplUsageDetail").setModel(this.oUsageLogModel);}catch(e){jQuery.sap.log.fatal("Invalid character identified in response of service");sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getBundle().getText("SPL_SYSTEM_RESPONSE_ERROR"),details:e.message});}},fetchUsageLogError:function(e){var t=this;if(e){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+" "+e.statusText,details:e.responseText},jQuery.proxy(t.fireCancelAction,t));}},getPayLoadForUsageLog:function(b,f,t){var p={},d={};if(!f){b=(b)?b:"C";d=oSapSplUtils.getDateRange(b);}else{d["from"]=f;d["to"]=t;}p["CompanyID"]=oSapSplUtils.getCompanyDetails()["UUID"];p["StartTime"]=d["from"];p["EndTime"]=d["to"];return p;},onSelectOfListItem:function(e){var d=null;if(!oSplBaseApplication.getAppInstance().getPage("splView.profile.UsageLogDetails")){var o=e.getSource().getSelectedItem().getBindingContext().getObject();var u=sap.ui.view({viewName:"splView.profile.UsageLogDetails",id:"splView.profile.UsageLogDetails",type:sap.ui.core.mvc.ViewType.XML,viewData:[o.UserCount,o.VehicleCount]});u.addEventDelegate({onBeforeShow:jQuery.proxy(u.getController().onBeforeShow,u.getController())});oSplBaseApplication.getAppInstance().addPage(u);}d=e.getSource().getSelectedItem().getBindingContext().getObject();d["Filter"]=this.HorizonText;oSplBaseApplication.getAppInstance().to("splView.profile.UsageLogDetails",{data:e.getSource().getSelectedItem().getBindingContext().getObject()});e.getSource().removeSelections();},openDateRangeSelectionDialog:function(d,D){var t=this,s=null;s={dateValue:d,secondDateValue:D,placeholder:oSapSplUtils.getBundle().getText("DATE_RANGE_PLACEHOLDER"),displayFormat:"dd.MM.yyyy",change:function(e){var v=e.getParameter("valid");var b=e.oSource;if(v){b.setValueState(sap.ui.core.ValueState.None);}else{b.setValueState(sap.ui.core.ValueState.Error);}}};var o=new sap.m.DateRangeSelection(s);var a=new sap.m.Dialog({title:oSapSplUtils.getBundle().getText("MANUAL_SELECTION"),content:[new sap.ui.layout.form.SimpleForm({content:[new sap.m.Label({text:oSapSplUtils.getBundle().getText("DATE_RANGE")}),o]})],beginButton:new sap.m.Button({text:oSapSplUtils.getBundle().getText("OK"),press:function(e){if(o.getValueState()==="None"){t.handleCreationOfCustomDateRange(e);}}}),endButton:new sap.m.Button({text:oSapSplUtils.getBundle().getText("CANCEL"),press:function(e){e.getSource().getParent().getParent().close();e.getSource().getParent().getParent().destroy();t.byId("SapSplUsageTimeHorizon").setSelectedKey(t.sSelectedTimeHorizon);}})});a.open();a.attachAfterOpen(function(e){oSapSplUtils.fnSyncStyleClass(e.getSource());});},handlePressOfTimeHorizon:function(e){var s=e.getParameters().selectedItem.getBindingContext().getProperty().key;if(s==="Manual"){this.openDateRangeSelectionDialog(this.customDate1,this.customDate2);}else if(e.getParameters().selectedItem.getBindingContext().getProperty().key==="customRange"){this.openDateRangeSelectionDialog(this.customDate1,this.customDate2);this.sSelectedTimeHorizon=s;}else{this.sSelectedTimeHorizon=s;this.fetchUsageLogData(s);}},handleCreationOfCustomDateRange:function(e){var t=[],d=null,m={},c=false;d=e.getSource().getParent().getParent().getContent()[0].getContent()[1];this.customDate1=d.getDateValue();this.customDate2=d.getSecondDateValue();this.customDate2.setHours(23);this.customDate2.setMinutes(59);this.customDate2.setSeconds(59);m=this.sapSplUsageTimeHorizonModel.getData();t=m.results;if(this.customDate1===null||this.customDate2===null){d.setValueState("Error");d.setValueStateText(oSapSplUtils.getBundle().getText("CUSTOM_RANGE_DATE_ERROR_STATE_TEXT"));}else{d.setValueState("None");for(var i=0;i<t.length;i++){if(t[i].key==="customRange"){c=true;t[i].name=d.getValue();break;}}if(c===false){t.push({key:"customRange",name:d.getValue()});}m["results"]=t;this.sapSplUsageTimeHorizonModel.setData(m);this.byId("SapSplUsageTimeHorizon").setSelectedKey("customRange");this.sSelectedTimeHorizon="customRange";this.fetchUsageLogData(null,this.customDate1,this.customDate2);e.getSource().getParent().close();e.getSource().getParent().destroy();}},onSelectOfTimeHorizon:function(e){var b=e.getSource().getSelectedItem().getBindingContext().getObject()["key"];this.fetchUsageLogData(b);this.HorizonText=e.getSource().getSelectedItem().getTitle();this.byId("SapSplUsageTimeHorizon").setText(oSapSplUtils.getBundle().getText("TIME_HORIZON",this.HorizonText));this.oTimeHorizonPopover.close();e.getSource().removeSelections();},handlePressOfCustomRange:function(){if(!this.UsageLogCustomDaterangeDialog){this.UsageLogCustomDaterangeDialog=sap.ui.xmlfragment("SapSplUsageLogCustomDateRange","splReusable.fragments.UsageLogCustomDaterange",this);sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogFromDate").addCustomData(new sap.ui.core.CustomData({key:"type",value:"from"}));sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogToDate").addCustomData(new sap.ui.core.CustomData({key:"type",value:"to"}));sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","CustomDateRangeToLabel").setText(oSapSplUtils.getBundle().getText("TO"));sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","CustomDateRangeFromLabel").setText(oSapSplUtils.getBundle().getText("FROM"));sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogOKButton").setText(oSapSplUtils.getBundle().getText("OK_BUTTON_TEXT"));sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogCancelButton").setText(oSapSplUtils.getBundle().getText("CANCEL"));sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogPage").setTitle(oSapSplUtils.getBundle().getText("SELECT_CUSTOM_TIME_RANGE"));}this.UsageLogCustomDaterangeDialog.open();},handlePressOfOk:function(){var f=null,t=null;f=splReusable.libs.SapSplModelFormatters.convertYyyymmddtoDate(sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogFromDate").getYyyymmdd());t=splReusable.libs.SapSplModelFormatters.convertYyyymmddtoDate(sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogToDate").getYyyymmdd());if(sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogFromDate").getYyyymmdd()&&sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogToDate").getYyyymmdd()){this.fetchUsageLogData(null,f,t);this.UsageLogCustomDaterangeDialog.close();}else{if(!sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogFromDate").getYyyymmdd()){sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogFromDate").setValueState(sap.ui.core.ValueState.Error);}if(!sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogToDate").getYyyymmdd()){sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogToDate").setValueState(sap.ui.core.ValueState.Error);}}},handlePressOfCancel:function(){this.UsageLogCustomDaterangeDialog.close();},handleChangeOfDatePicker:function(e){var f,t,d;f=splReusable.libs.SapSplModelFormatters.convertYyyymmddtoDate(sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogFromDate").getYyyymmdd());t=splReusable.libs.SapSplModelFormatters.convertYyyymmddtoDate(sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogToDate").getYyyymmdd());d=e.getSource();if(d.getCustomData()[0].getValue()==="from"){sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogFromDate").setValueState();}else{sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogToDate").setValueState();}if(f>t){sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogToDate").setYyyymmdd(sap.ui.core.Fragment.byId("SapSplUsageLogCustomDateRange","SapSplUsageLogFromDate").getYyyymmdd());}},fnHandlePressOfTourSettingsAddRuleLink:function(){var m=$.extend(true,{},sap.ui.getCore().getModel("SapSnlhCompanyTourSettingsModel").getData()),i,L,t,U;var f;if(m&&m.data&&m.data.length===0){i=true;L="-1";t=this.thresholdArray;U="-1";f=this.thresholdArray;}else{i=false;L=m.data[m.data.length-1].UpperThreshold;f=m.data[m.data.length-1].toArray;if(m.data[m.data.length-1].UpperThreshold!=="-1"){t=this.getThresholdArrayForSelectControl(parseInt(m.data[m.data.length-1].UpperThreshold));U=t[0].key;}else{t=m.data[m.data.length-1].toArray;U=t[0].key;}}var a={isEnabled:i,toArray:t,fromArray:f,LowerThreshold:L,UpperThreshold:U,WarningValue:"0",CriticalValue:"0",warningValueState:"None",warningValueStateText:"",criticalValueState:"None",criticalValueStateText:"",toSelectError:false,fromSelectError:false};m.data.push(a);sap.ui.getCore().getModel("SapSnlhCompanyTourSettingsModel").setData(m);window.setTimeout(function(){if(sap.ui.getCore().byId("splView.profile.Profile--sapSnlhTourSettingsTable")&&sap.ui.getCore().byId("splView.profile.Profile--sapSnlhTourSettingsTable").getItems()[0]){if(m.data&&m.data.length>1){if(sap.ui.getCore().byId("splView.profile.Profile--sapSnlhTourSettingsTable").getItems()[m.data.length-1].getCells()[5]){sap.ui.getCore().byId("splView.profile.Profile--sapSnlhTourSettingsTable").getItems()[m.data.length-1].getCells()[5].focus();}}else{if(sap.ui.getCore().byId("splView.profile.Profile--sapSnlhTourSettingsTable").getItems()[m.data.length-1].getCells()[2]){sap.ui.getCore().byId("splView.profile.Profile--sapSnlhTourSettingsTable").getItems()[m.data.length-1].getCells()[2].focus();}}}},100);},getThresholdArrayForSelectControl:function(L){if(L===-1){return this.thresholdArray;}else{return this.thresholdArray.filter(function(e){return(parseInt(e.key)===-1||parseInt(e.key)>L);});}},fnHandlePressDeleteOfTourSettingsTableItem:function(e){var i=parseInt(e.getParameter("listItem").getBindingContext().getPath().split("/")[2]);var m=$.extend(true,{},sap.ui.getCore().getModel("SapSnlhCompanyTourSettingsModel").getData());this.fnToCaptureLiveChangeToSetFlag();if(i!==0&&i!==(m.data.length-1)){m.data[i+1].LowerThreshold=m.data[i-1].UpperThreshold;m.data[i+1].fromArray=m.data[i-1].toArray;m.data[i+1].toArray=this.getThresholdArrayForSelectControl(parseInt(m.data[i+1].LowerThreshold));}if(m.data[i].UUID){this.toDeleteArray.push(m.data[i]);}m.data.splice(i,1);if(m.data.length>0){m.data[0].fromArray=this.thresholdArray;m.data[0].isEnabled=true;m.data[0].toArray=this.getThresholdArrayForSelectControl(parseInt(m.data[0].LowerThreshold));}sap.ui.getCore().getModel("SapSnlhCompanyTourSettingsModel").setData(m);},fnHandleChangeOfFromThreshold:function(e){var i=parseInt(e.getSource().getBindingContext().getPath().split("/")[2]);var k=e.getParameters().selectedItem.getKey();var m=$.extend(true,{},sap.ui.getCore().getModel("SapSnlhCompanyTourSettingsModel").getData());m.data[i].LowerThreshold=k;if(this.getIndexOfkeyFromThresholdArray(k)<this.getIndexOfkeyFromThresholdArray(m.data[i].UpperThreshold)){m.data[i].LowerThreshold=k;m=this.fnToValidateSelectControlEntries(m);}else if(m.data[i].UpperThreshold!=="-1"&&(this.getIndexOfkeyFromThresholdArray(k)>=this.getIndexOfkeyFromThresholdArray(m.data[i].UpperThreshold))){m=this.fnToValidateSelectControlEntries(m);}else{m.data=this.fnValidateSelectControl(m.data,i,k,1);}if((i===0)&&(this.getIndexOfkeyFromThresholdArray(k)===0)){m.data[i].fromSelectError=true;}else{m.data[i].fromSelectError=false;}this.fnToCaptureLiveChangeToSetFlag();sap.ui.getCore().getModel("SapSnlhCompanyTourSettingsModel").setData(m);},fnHandleChangeOfToThreshold:function(e){var i=parseInt(e.getSource().getBindingContext().getPath().split("/")[2]);var k=e.getParameters().selectedItem.getKey();var m=$.extend(true,{},sap.ui.getCore().getModel("SapSnlhCompanyTourSettingsModel").getData());m.data[i].UpperThreshold=k;if(m.data[i+1]&&(this.getIndexOfkeyFromThresholdArray(k)<this.getIndexOfkeyFromThresholdArray(m.data[i+1].UpperThreshold))){m.data[i+1].LowerThreshold=k;m=this.fnToValidateSelectControlEntries(m);}else if(m.data[i+1]&&m.data[i+1].UpperThreshold!=="-1"&&(this.getIndexOfkeyFromThresholdArray(k)>=this.getIndexOfkeyFromThresholdArray(m.data[i+1].UpperThreshold))){m.data[i+1].LowerThreshold=k;m=this.fnToValidateSelectControlEntries(m);}else{m=this.fnToValidateSelectControlEntries(m);m.data=this.fnValidateSelectControl(m.data,i,m.data[i].LowerThreshold,0);}this.fnToCaptureLiveChangeToSetFlag();sap.ui.getCore().getModel("SapSnlhCompanyTourSettingsModel").setData(m);},fnToValidateSelectControlEntries:function(m){for(var i=0;i<m.data.length;i++){if(i===0&&m.data[i].LowerThreshold!=="-1"&&this.getIndexOfkeyFromThresholdArray(m.data[i].LowerThreshold)>=this.getIndexOfkeyFromThresholdArray(m.data[i].UpperThreshold)){m.data[i].toSelectError=true;for(i=i+1;i<m.data.length;i++){m.data[i].toSelectError=true;}}else if(m.data[i+1]&&m.data[i+1].UpperThreshold!=="-1"&&this.getIndexOfkeyFromThresholdArray(m.data[i].UpperThreshold)>=this.getIndexOfkeyFromThresholdArray(m.data[i+1].UpperThreshold)){if(i!==0){m.data[i].toArray=this.getThresholdArrayForSelectControl(m.data[i].LowerThreshold);m.data[i].fromArray=this.getThresholdArrayForSelectControl(m.data[i-1].LowerThreshold);}m.data[i].toSelectError=false;for(i=i+1;i<m.data.length;i++){m.data[i].toSelectError=true;}}else{m.data[i].toSelectError=false;m.data[i].toArray=this.getThresholdArrayForSelectControl(m.data[i].LowerThreshold);if(i!==(m.data.length-1)){if(m.data[i].UpperThreshold==="-1"){m.data[i+1].toArray=m.data[i].toArray;}else{m.data[i+1].toArray=this.getThresholdArrayForSelectControl(m.data[i].UpperThreshold);}m.data[i+1].fromArray=m.data[i].toArray;}}}return m;},fnValidateSelectControl:function(m,a,k,b){var i;if(b===1){i=a;}else{i=a+1;}for(;i<m.length;i++){if(i!==a){if(m[i].fromArray===undefined){m[i].fromArray=[];}m[i].fromArray=m[i-1].toArray;if(b===0){m[i].LowerThreshold=m[i-1].UpperThreshold;}else{m[i].LowerThreshold=m[i].fromArray[0].key;}}if(b===0&&i===(a+1)){k=m[i].LowerThreshold;}if(m[i].toArray===undefined){m[i].toArray=[];}m[i].toArray=this.getThresholdArrayForSelectControl(parseInt(k,10));m[i].UpperThreshold=m[i].toArray[0].key;}return m;},getIndexOfkeyFromThresholdArray:function(k){for(var i=0;i<this.thresholdArray.length;i++){if(this.thresholdArray[i].key===k){break;}}return i;},fnHandleCompnayTourSettingsCancelButton:function(){var t=this;if(oSapSplUtils.getIsDirty()){sap.m.MessageBox.show(oSapSplUtils.getBundle().getText("DATA_LOSS_WARNING_TEXT"),sap.m.MessageBox.Icon.WARNING,oSapSplUtils.getBundle().getText("WARNING"),[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.CANCEL],function(s){if(s==="YES"){jQuery.proxy(t.fnHandlePerformCancelAction(),t);}});}else{this.fnHandlePerformCancelAction();}},fnHandlePerformCancelAction:function(){this.byId("btnEditCompanyProfile").setVisible(splReusable.libs.SapSplModelFormatters.showEditable(this.oCompanyProfileModel.getData().isEditable,sap.ui.getCore().getModel("profileButtonVisibilityModel").getData().editButton));this.byId("sapSnlhCompnayTourSettingsSaveButton").setVisible(false);this.byId("sapSnlhCompnayTourSettingsCancelButton").setVisible(false);this.byId("sapSnlhTourSettingsTable").setMode("None");this.byId("sapSnlhTourSettingsAddRuleLink").setVisible(false);oSapSplUtils.setIsDirty(false);var m=this.previousModelData;m.isEdit=false;sap.ui.getCore().getModel("SapSnlhCompanyTourSettingsModel").setData(m);},fireDelete:function(d){var p={};p=this.prepareDeletePayload();oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("sap/spl/xs/app/services/tourPreferences.xsjs"),method:"POST",async:false,data:JSON.stringify(p),success:function(a,s,m){if(a.constructor===String){a=JSON.parse(a);}if(a["Error"].length>0){var e=oSapSplUtils.getErrorMessagesfromErrorPayload(a)["ufErrorObject"];sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(a)["errorWarningString"],details:e});}},error:function(e){if(e&&e["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+" "+e.statusText,details:e.responseText});}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["ufErrorObject"]});}},complete:function(){}});},prepareDeletePayload:function(){var p=[],P={};for(var i=0;i<this.toDeleteArray.length;i++){P={};P.UUID=this.toDeleteArray[i].UUID;P.ChangeMode="D";P["OrganizationUUID"]=this.toDeleteArray[i].OrganizationUUID;p.push(P);}return{"inputHasChangeMode":true,"tourPreference":p};},fnHandleCompnayTourSettingsSaveButton:function(){var t=this,p;if(this.validateEntries()){oSapSplBusyDialog.getBusyDialogInstance({title:oSapSplUtils.getBundle().getText("BUSY_DIALOG_MESSAGE")}).open();if(this.toDeleteArray.length>0){this.fireDelete();}p=this.prepareTourSettingsPayload();oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("sap/spl/xs/app/services/tourPreferences.xsjs"),method:"PUT",async:false,data:JSON.stringify(p),success:function(d,s,m){oSapSplUtils.setIsDirty(false);oSapSplBusyDialog.getBusyDialogInstance().close();if(d.constructor===String){d=JSON.parse(d);}if(m["status"]===200&&d["Error"].length===0){sap.ca.ui.message.showMessageToast(oSapSplUtils.getBundle().getText("PROFILE_UPDATE_SUCCESSFUL"));t.byId("btnEditCompanyProfile").setVisible(splReusable.libs.SapSplModelFormatters.showEditable(t.oCompanyProfileModel.getData().isEditable,sap.ui.getCore().getModel("profileButtonVisibilityModel").getData().editButton));t.byId("sapSnlhCompnayTourSettingsSaveButton").setVisible(false);t.byId("sapSnlhCompnayTourSettingsCancelButton").setVisible(false);t.byId("sapSnlhTourSettingsTable").setMode("None");t.byId("sapSnlhTourSettingsAddRuleLink").setVisible(false);t.fireAjaxToGetListOfThresholdRules();}else if(d["Error"].length>0){var e=oSapSplUtils.getErrorMessagesfromErrorPayload(d)["ufErrorObject"];sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["errorWarningString"],details:e});}},error:function(e){oSapSplBusyDialog.getBusyDialogInstance().close();if(e&&e["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+" "+e.statusText,details:e.responseText});}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["ufErrorObject"]});}},complete:function(){}});}},validateEntries:function(){var m=sap.ui.getCore().getModel("SapSnlhCompanyTourSettingsModel").getData();var f=true,F=true,w,c;for(var i=0;i<m.data.length;i++){F=true;if(!(/^\d+(\.\d+)?$/i.test(m.data[i].WarningValue))&&!(m.data[i].WarningValue.trim()==="")){f=false;F=false;m.data[i].warningValueState="Error";m.data[i].warningValueStateText=oSapSplUtils.getBundle().getText("EMPTY_ERROR_MESSAGE");}else{m.data[i].warningValueState="None";}if(!(/^\d+(\.\d+)?$/i.test(m.data[i].CriticalValue))&&!(m.data[i].CriticalValue.trim()==="")){f=false;F=false;m.data[i].criticalValueState="Error";m.data[i].criticalValueStateText=oSapSplUtils.getBundle().getText("EMPTY_ERROR_MESSAGE");}else{m.data[i].criticalValueState="None";}if(F){if(m.data[i].WarningValue===""){w=0;}else{w=parseFloat(m.data[i].WarningValue);}if(m.data[i].CriticalValue===""){c=0;}else{c=parseFloat(m.data[i].CriticalValue);}if(c<=w){if(c===0&&w===0){m.data[i].criticalValueState="None";}else{f=false;m.data[i].criticalValueState="Error";}}else{m.data[i].criticalValueState="None";}}if(m.data[i].UpperThreshold==="-1"){m.data[i].toSelectError=true;}if(i===0){if(m.data[i].LowerThreshold==="-1"){m.data[i].fromSelectError=true;}else{m.data[i].fromSelectError=false;}}else{m.data[i].fromSelectError=false;}if(m.data[i].LowerThreshold!=="-1"&&m.data[i].UpperThreshold==="-1"){if(m.data[i].LowerThreshold!=="518460"){m.data[i].toSelectError=true;}else{m.data[i].fromSelectError=true;}}if(m.data[i].toSelectError||m.data[i].fromSelectError){f=false;}}if(!f){sap.ui.getCore().getModel("SapSnlhCompanyTourSettingsModel").setData(m);}return f;},prepareTourSettingsPayload:function(){var p={},a=[];var m=sap.ui.getCore().getModel("SapSnlhCompanyTourSettingsModel").getData();for(var i=0;i<m.data.length;i++){if(m.data[i].LowerThreshold==="-1"&&m.data[i].UpperThreshold==="-1"){break;}p={};if(m.data[i].UUID){p["UUID"]=m.data[i].UUID;}else{p["UUID"]=oSapSplUtils.getUUID();}p["OrganizationUUID"]=oSapSplUtils.getCompanyDetails().UUID;p["LowerThreshold"]=m.data[i].LowerThreshold;if(m.data[i].UpperThreshold==="518460"){p["UpperThreshold"]=null;}else{p["UpperThreshold"]=m.data[i].UpperThreshold;}if(m.data[i].WarningValue.trim()===""){p["WarningValue"]="0";}else{p["WarningValue"]=m.data[i].WarningValue.toString();}if(m.data[i].CriticalValue.trim()===""){p["CriticalValue"]="0";}else{p["CriticalValue"]=m.data[i].CriticalValue.toString();}a.push(p);if(m.data[i].UpperThreshold==="518460"||(m.data[i].LowerThreshold==="-1"&&m.data[i].UpperThreshold==="-1")){break;}}return{"tourPreference":a};},fnToCaptureLiveChangeToSetFlag:function(){if(!oSapSplUtils.getIsDirty()){oSapSplUtils.setIsDirty(true);}},initializeThresholdJson:function(){this.thresholdArray=[{key:"-1",value:""},{key:"0",value:"0"+" "+oSapSplUtils.getBundle().getText("MINUTES")},{key:"900",value:"15"+" "+oSapSplUtils.getBundle().getText("MINUTES")},{key:"1800",value:"30"+" "+oSapSplUtils.getBundle().getText("MINUTES")},{key:"2700",value:"45"+" "+oSapSplUtils.getBundle().getText("MINUTES")},{key:"3600",value:"1"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_HOUR")},{key:"7200",value:"2"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_HOURS")},{key:"10900",value:"3"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_HOURS")},{key:"14400",value:"4"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_HOURS")},{key:"18000",value:"5"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_HOURS")},{key:"21600",value:"6"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_HOURS")},{key:"25200",value:"7"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_HOURS")},{key:"28800",value:"8"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_HOURS")},{key:"32400",value:"9"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_HOURS")},{key:"36000",value:"10"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_HOURS")},{key:"39600",value:"11"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_HOURS")},{key:"43200",value:"12"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_HOURS")},{key:"46800",value:"13"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_HOURS")},{key:"50400",value:"14"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_HOURS")},{key:"54000",value:"15"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_HOURS")},{key:"57600",value:"16"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_HOURS")},{key:"61200",value:"17"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_HOURS")},{key:"64800",value:"18"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_HOURS")},{key:"68400",value:"19"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_HOURS")},{key:"72000",value:"20"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_HOURS")},{key:"75600",value:"21"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_HOURS")},{key:"79200",value:"22"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_HOURS")},{key:"82800",value:"23"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_HOURS")},{key:"86400",value:"1"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_DAY")},{key:"172800",value:"2"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_DAYS")},{key:"259200",value:"3"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_DAYS")},{key:"345600",value:"4"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_DAYS")},{key:"432000",value:"5"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_DAYS")},{key:"518400",value:"6"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_DAYS")},{key:"518460",value:"6+"+" "+oSapSplUtils.getBundle().getText("TOUR_SETTINGS_DAYS")}];}});
