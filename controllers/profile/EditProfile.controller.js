/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.controller("splController.profile.EditProfile",{bProfileIsModified:false,oPayloadObject:{"inputHasChangeMode":true,"Header":[]},localPersistency:{},oTransientPayload:{},oCompanyProfileModel:{},onInit:function(){var t=new sap.ui.model.json.JSONModel();var a=this;t.setData({tours:[{tourName:oSapSplUtils.getBundle().getText("TOUR_CREATION_MANUAL_ONLY"),tourMode:"M",id:"M",selected:false},{tourName:oSapSplUtils.getBundle().getText("TOUR_CREATION_BOTH"),tourMode:"",id:"B",selected:false},{tourName:oSapSplUtils.getBundle().getText("TOUR_CREATION_AUTOMATED_ONLY"),tourMode:"I",id:"I",selected:false}]});sap.ui.getCore().setModel(t,"splTourAutomationModel");sap.ui.getCore().setModel(new sap.ui.model.json.JSONModel({visible:true,subScriptionAccepted:false}),"splSearchVisibilityModel");this.getView().addEventDelegate({onAfterShow:function(){window.setTimeout(function(){a.byId("sapSplCompanyProfileImageInput").focus();},100);}});},tourOptionSelected:function(e){var t=null;function h(i,a,o,c){t=new sap.m.Dialog({contentHeight:"320px",contentWidth:"690px",state:sap.ui.core.ValueState.Warning,title:"{splI18NModel>CONFIRMATION_DIALOG_HEADER_TITLE}",buttons:[new sap.m.Button({text:"{splI18NModel>OK}",press:[function(){o();},i]}),new sap.m.Button({text:"{splI18NModel>CANCEL}",press:[function(){c();},i]})],content:sap.ui.view({viewName:"splView.dialogs.SplChangeTourPromptDialog",id:"splView.dialogs.SplChangeTourPromptDialog",type:sap.ui.core.mvc.ViewType.XML,viewData:{data:e.getSource().getSelectedContexts()[0]}}),afterClose:[function(){t.destroy();},i]});t.open().attachAfterOpen(function(){oSapSplUtils.fnSyncStyleClass(t);});}if(this.isTourDifferent(e.getSource().getSelectedContexts()[0].getProperty("tourMode"))){var i=this;var E=jQuery.extend(true,{},e);h(this,e.getSource().getSelectedContexts()[0].getProperty("tourMode"),function(){i.bProfileIsModified=true;oSapSplUtils.setIsDirty(i.bProfileIsModified);i.oTransientPayload["TourInputType"]=E.getSource().getSelectedContexts()[0].getProperty("tourMode");$.sap.log.info("SAP SCL Event","Event fired "+e,"SAPSCL");oSapSplUtils.getStorageInstance("session").put("spl-change-prompt-tour","x");i.localPersistency["spl-change-prompt-tour"]=E.getSource().getSelectedContexts()[0].getProperty("tourName");t.close();},function(){if(oSapSplUtils.getStorageInstance("session").get("spl-change-prompt-tour")){oSapSplUtils.getStorageInstance("session").remove("spl-change-prompt-tour");}var a=sap.ui.getCore().getModel("splTourAutomationModel").getData()["tours"];for(var c=0;c<a.length;c++){if(a[c]["tourMode"]===oSapSplUtils.getCompanyDetails()["TourInputType"]){sap.ui.getCore().getModel("splTourAutomationModel").getData()["tours"][c]["selected"]=true;i.localPersistency["spl-change-prompt-tour"]=null;sap.ui.getCore().getModel("splTourAutomationModel").refresh();}}i.oTransientPayload["TourInputType"]=oSapSplUtils.getCompanyDetails()["TourInputType"];$.sap.log.info("SAP SCL Event","Event fired "+e,"SAPSCL");t.close();});}},defineControlLabelsFromLocalizationBundle:function(){},commonLiveChange:function(){if(!this.bProfileIsModified){this.bProfileIsModified=true;}},handleRegNumberChange:function(e){this.bProfileIsModified=true;oSapSplUtils.setIsDirty(this.bProfileIsModified);$.sap.log.info("SAP SCL Event","Event fired "+e,"SAPSCL");},handleRegistryNumberChange:function(e){this.bProfileIsModified=true;oSapSplUtils.setIsDirty(this.bProfileIsModified);$.sap.log.info("SAP SCL Event","Event fired "+e,"SAPSCL");},handleCompanyNameChange:function(e){this.bProfileIsModified=true;oSapSplUtils.setIsDirty(this.bProfileIsModified);$.sap.log.info("SAP SCL Event","Event fired "+e,"SAPSCL");},handleWebsiteChange:function(e){this.bProfileIsModified=true;oSapSplUtils.setIsDirty(this.bProfileIsModified);$.sap.log.info("SAP SCL Event","Event fired "+e,"SAPSCL");},handleStreetChange:function(e){this.bProfileIsModified=true;oSapSplUtils.setIsDirty(this.bProfileIsModified);$.sap.log.info("SAP SCL Event","Event fired "+e,"SAPSCL");},handleDistrictChange:function(e){this.bProfileIsModified=true;oSapSplUtils.setIsDirty(this.bProfileIsModified);$.sap.log.info("SAP SCL Event","Event fired "+e,"SAPSCL");},handleCountryChange:function(e){this.bProfileIsModified=true;oSapSplUtils.setIsDirty(this.bProfileIsModified);$.sap.log.info("SAP SCL Event","Event fired "+e,"SAPSCL");},handlePhoneChange:function(e){this.bProfileIsModified=true;oSapSplUtils.setIsDirty(this.bProfileIsModified);$.sap.log.info("SAP SCL Event","Event fired "+e,"SAPSCL");},handleFaxChange:function(e){this.bProfileIsModified=true;oSapSplUtils.setIsDirty(this.bProfileIsModified);$.sap.log.info("SAP SCL Event","Event fired "+e,"SAPSCL");},handleTownChange:function(e){this.bProfileIsModified=true;oSapSplUtils.setIsDirty(this.bProfileIsModified);$.sap.log.info("SAP SCL Event","Event fired "+e,"SAPSCL");},onAfterRendering:function(){this.defineControlLabelsFromLocalizationBundle();},handleProfileBackNavigation:function(){this.goBackToCaller(0);},handleAddCompanyProfilePhoto:function(){this.byId("sapSplCompanyProfileImage").setSrc(this.byId("sapSplCompanyProfileImageInput").getValue());this.byId("sapSplCompanyProfileImage").setVisible(true);},handleImageUrlChange:function(e){this.byId("sapSplEditProfileAddImage").setEnabled(e.getParameter("newValue")!=="");this.bProfileIsModified=true;oSapSplUtils.setIsDirty(this.bProfileIsModified);this.oTransientPayload["ImageUrl"]=e.getParameter("newValue");},handleProductChange:function(e){var p=null;function h(i,s,o,c){p=new sap.m.Dialog({contentHeight:"280px",contentWidth:"670px",state:sap.ui.core.ValueState.Warning,title:"{splI18NModel>CONFIRMATION_DIALOG_HEADER_TITLE}",buttons:[new sap.m.Button({text:"{splI18NModel>OK}",enabled:{path:"splSearchVisibilityModel>/subScriptionAccepted"},press:[function(){o();},i]}),new sap.m.Button({text:"{splI18NModel>CANCEL}",press:[function(){c();},i]})],content:sap.ui.view({viewName:"splView.dialogs.SplChangeSubScriptionPromptDialog",id:"splView.dialogs.SplChangeSubScriptionPromptDialog",type:sap.ui.core.mvc.ViewType.XML,viewData:{data:e.getParameter("selectedItem")}}),afterClose:[function(){p.destroy();},i]});p.open().attachAfterOpen(function(){oSapSplUtils.fnSyncStyleClass(p);});}},goBackToCaller:function(g){oSplBaseApplication.getAppInstance().back({goBackWithData:g});},handleProfileSaveButtonPressEvent:function(){var t=this;this.createBaseSkeletonPayloadObject();this.oPayloadObject.Header[0]=this.oTransientPayload;this.constructPayloadForPost();oSapSplBusyDialog.getBusyDialogInstance({title:oSapSplUtils.getBundle().getText("BUSY_DIALOG_MESSAGE")}).open();oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getServiceMetadata("bupa",true),method:"PUT",dataType:"json",data:JSON.stringify(this.oPayloadObject),beforeSend:function(x){x.setRequestHeader("Content-Type","application/json;charset=utf-8");x.setRequestHeader("X-CSRF-Token",oSapSplUtils.getCSRFToken());},success:function(r,a,x){if(x.status===200&&x.status<400){var p=0,n=-10,_="'"+p+" "+n+"'";function c(){n=n-50;var b=_="'"+p+" "+n+"'";return b;};oSapSplUtils.setIsDirty(false);sap.m.MessageToast.show(oSapSplUtils.getBundle().getText("PROFILE_UPDATE_SUCCESSFUL"),{offset:_});if(oSapSplUtils.getStorageInstance("session").get("spl-change-prompt-subscr")==="x"){if((t.localPersistency["spl-change-prompt-subscr"]!==undefined)||(t.localPersistency["spl-change-prompt-subscr"]!==null)){sap.m.MessageToast.show(oSapSplUtils.getBundle().getText("SUBSCRIPTION_CHANGE_OK_TOAST",[t.localPersistency["spl-change-prompt-subscr"]]),{offset:c()});t.localPersistency["spl-change-prompt-subscr"]=null;}}if(oSapSplUtils.getStorageInstance("session").get("spl-change-prompt-tour")==="x"){if((t.localPersistency["spl-change-prompt-tour"]!==undefined)||(t.localPersistency["spl-change-prompt-tour"]!==null)){sap.m.MessageToast.show(oSapSplUtils.getBundle().getText("TOUR_CHANGE_OK_TOAST",[t.localPersistency["spl-change-prompt-tour"]]),{offset:c()});t.localPersistency["spl-change-prompt-tour"]=null;}}t.goBackToCaller(1);}},error:function(x){if(x.status>=400&&x.status<500){oSapSplAppErrorHandler.show(x,true,null,function(d){jQuery.sap.log.info("SAP Connected Logistics","Dialog close Event fired "+d.m,"SAPSCL");jQuery.sap.log.error("SPL User Profile","Profile update failed. Toast rendered and closed","SAPSCL");});}else{oSapSplAppErrorHandler.show(x,false,null,function(d){jQuery.sap.log.info("SAP Connected Logistics","Dialog close Event fired "+d.m,"SAPSCL");jQuery.sap.log.error("SPL User Profile","Profile update failed. Toast rendered and closed","SAPSCL");});}},complete:function(){oSapSplBusyDialog.getBusyDialogInstance({title:oSapSplUtils.getBundle().getText("BUSY_DIALOG_MESSAGE")}).close();}});},onBeforeShow:function(){},getData:function(e){var c=e.data.cDetails;var C=0,s=0;var m=new sap.ui.model.json.JSONModel();function _(){var t=sap.ui.getCore().getModel("splTourAutomationModel").getData()["tours"];for(C=0;C<t.length;C++){if(c["TourInputType"]===t[C]["tourMode"]){s=C;break;}}sap.ui.getCore().getModel("splTourAutomationModel").getData()["tours"][s]["selected"]=true;sap.ui.getCore().getModel("splTourAutomationModel").refresh();}function a(){sap.ui.getCore().getModel("splSearchVisibilityModel").getData()["visible"]=(c["isVisibleOnSearch"]===1)?true:false;}m.setDefaultBindingMode(sap.ui.model.BindingMode.OneWay);m.setData(c);this.byId("profileEditPage").setModel(m);_();a();},handleProfileCancelButtonPressEvent:function(){this.goBackToCaller(0);},createBaseSkeletonPayloadObject:function(){this.oTransientPayload["UUID"]=oSapSplUtils.getCompanyDetails()["UUID"];this.oTransientPayload["BasicInfo.ID"]=oSapSplUtils.getCompanyDetails()["BasicInfo_ID"];this.oTransientPayload["BasicInfo.CompanyID"]=oSapSplUtils.getCompanyDetails()["BasicInfo_CompanyID"];this.oTransientPayload["BasicInfo.Type"]=oSapSplUtils.getCompanyDetails()["BasicInfo_Type"];this.oTransientPayload["ChangeMode"]="U";},constructPayloadForPost:function(){this.oTransientPayload["Organization.Name"]=this.byId("sapSplCompanyProfileEditModeNameText").getValue();this.oTransientPayload["ImageUrl"]=this.byId("sapSplCompanyProfileImageInput").getValue();this.oTransientPayload["CommunicationInfo.Website"]=this.byId("sapSplCompanyProfileEditModeWebsiteText").getValue();this.oTransientPayload["PostalAddress.StreetName"]=this.byId("sapSplCompanyProfileEditModeStreetText").getValue();this.oTransientPayload["PostalAddress.Town"]=this.byId("sapSplCompanyProfileEditModeTownText").getValue();this.oTransientPayload["PostalAddress.District"]=this.byId("sapSplCompanyProfileEditModeDistrictText").getValue();this.oTransientPayload["CommunicationInfo.Phone"]=this.byId("sapSplCompanyProfileEditModePhoneText").getValue();this.oTransientPayload["CommunicationInfo.Fax"]=this.byId("sapSplCompanyProfileEditModeFaxText").getValue();this.oTransientPayload["PostalAddress.Country"]=this.byId("sapSplCompanyProfileEditModeCountryText").getValue();this.oTransientPayload["Organization.RegistrationNumber"]=this.byId("sapSplCompanyProfileEditRegistrationNumberText").getValue();this.oTransientPayload["Organization.Registry"]=this.byId("sapSplCompanyProfileEditModeRegistryText").getValue();},isTourDifferent:function(t){return(t!==oSapSplUtils.getCompanyDetails()["TourInputType"]);}});
