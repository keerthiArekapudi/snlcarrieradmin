/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.controller("splController.managetours.ToursOverview",{onBeforeShow:function(){var n="",g="",b="",t=this;n=jQuery.sap.getUriParameters().get("navToHome");g=jQuery.sap.getUriParameters().get("goto");b=this.byId("sapSplBackNavigationButton");window.setTimeout(function(){if(t.byId("sapSplTourOverviewSearchField")){t.byId("sapSplTourOverviewSearchField").focus();}},100);if(g){if(n&&n==="false"){b.setVisible(false);}else if(n&&n==="true"){b.setVisible(true);}else{b.setVisible(false);}}else{b.setVisible(true);}this.byId("SapSplToursOverView").removeSelections();this.byId("sapSplMarkAsFinished").setEnabled(splReusable.libs.SapSplModelFormatters.enableCompleteButton(0));if(!this.getView().getParent().getCustomData()[0]){this.getView().getParent().addCustomData(new sap.ui.core.CustomData({key:"flag",value:true}));}t.fnGetTourOverViewData();if(sap.ui.getCore().getModel("sapSplTourOverviewModel")){t.oSapSplTourOverviewrefreshHandle=window.setInterval(jQuery.proxy(t.fnGetTourOverViewData,t),60000);oSapSplUtils.setIntervalId(t.oSapSplTourOverviewrefreshHandle);}if(this.getView().getParent().getPages().length>1&&this.getView().getParent().getPages()[1].getController().oSapSplTourDetails){window.clearInterval(t.getView().getParent().getPages()[1].getController().oSapSplTourDetails);}},onAfterRendering:function(){oSapSplQuerySelectors.getInstance().setBackButtonTooltip();if(this.getView().getParent().getPreviousPage()&&(this.getView().getParent().getPreviousPage().sId==="TourDetails"||this.getView().getParent().getPreviousPage().sId==="CreateNewTour")){this.byId("toursOverviewHeader").setNumber(this.byId("SapSplToursOverView").getBinding("items").getLength());}},onInit:function(){this.fnDefineControlLabelsFromLocalizationBundle();splReusable.libs.SapSplStyleSheetLoader.loadStyle("./resources/styles/sapSplTourOverview");this.oSapSplApplModel=sap.ui.getCore().getModel("ToursOverviewODataModel");sap.ui.getCore().setModel(this.oSapSplApplModel,"ToursOverViewPageODataModel");this.getView().byId("SapSplToursOverView").setModel(sap.ui.getCore().getModel("ToursOverViewPageODataModel"));this.getView().byId("sapSplCreateNewTour").setModel(sap.ui.getCore().getModel("myCompanyDetails"));sap.ui.getCore().setModel(new sap.ui.model.json.JSONModel(),"sapSplTourOverviewModel");sap.ui.getCore().setModel(new sap.ui.model.json.JSONModel(),"sapSplTourDetailsModel");this.getView().byId("ToursOverViewPage").setModel(sap.ui.getCore().getModel("sapSplTourOverviewModel"));this.oSapSplStartTimeSorter=new sap.ui.model.Sorter("Planned_StartTime",true);this.oSapSplRegistrationNumberSorter=new sap.ui.model.Sorter("RegistrationNumber",false);this.getView().byId("SapSplToursOverView").getBinding("items").sort([this.oSapSplStartTimeSorter,this.oSapSplRegistrationNumberSorter]);this.fnGetTourOverViewData();this.handleIconTabBarSelect();this.TourSelectionCountObject={Unssigned:0,Active:0,Completed:0};},fnDefineControlLabelsFromLocalizationBundle:function(){this.getView().byId("toursOverviewHeader").setTitle(oSapSplUtils.getCompanyDetails().Organization_Name+" "+oSapSplUtils.getBundle().getText("TOURS"));this.getView().byId("ToursOverViewPageTitle").setText(oSapSplUtils.getBundle().getText("MANAGE_TOURS"));this.getView().byId("SapSplTourName").setText(oSapSplUtils.getBundle().getText("NAME"));this.getView().byId("SapSplTourID").setText(oSapSplUtils.getBundle().getText("TOUR_ID"));this.getView().byId("SapSplTourTruck").setText(oSapSplUtils.getBundle().getText("TRUCK"));this.getView().byId("SapSplTourStatus").setText(oSapSplUtils.getBundle().getText("VEHICLE_STATUS"));this.getView().byId("SapSplTourStartTime").setText(oSapSplUtils.getBundle().getText("TOUR_START_TIME"));this.getView().byId("SapSplTourEndTime").setText(oSapSplUtils.getBundle().getText("TOUR_END_TIME"));this.getView().byId("SapSplTourNumberOfDelays").setText(oSapSplUtils.getBundle().getText("NUM_OF_DELAYS"));this.getView().byId("SapSplTourDelay").setText(oSapSplUtils.getBundle().getText("TOUR_DELAY"));this.getView().byId("SapSplToursIconTabbarTitle").setText(oSapSplUtils.getBundle().getText("TOURS"));this.getView().byId("sapSplMonitorTourStatus").setText(oSapSplUtils.getBundle().getText("INCIDENTS_FOOTER_MANAGE_GEOFENCES"));this.getView().byId("sapSplCreateNewTour").setText(oSapSplUtils.getBundle().getText("CREATE_NEW_TOUR"));this.getView().byId("SapSplToursIconTabFilterUnassigned").setText(oSapSplUtils.getBundle().getText("FILTER_LABEL_UNASSIGNED"));this.getView().byId("SapSplToursIconTabFilterActive").setText(oSapSplUtils.getBundle().getText("FILTER_LABEL_ACTIVE"));this.getView().byId("SapSplToursIconTabFilterCompleted").setText(oSapSplUtils.getBundle().getText("FILTER_LABEL_COMPLETED"));this.getView().byId("SapSplToursOverView").setNoDataText(oSapSplUtils.getBundle().getText("TOURS_NO_DATA"));this.getView().byId("sapSplMarkAsFinished").setText(oSapSplUtils.getBundle().getText("MARK_AS_FINISHED"));},handleSelectionChange:function(e){var T,m={},t=this;if(!this.getView().getParent().getPage("TourDetails")){T=sap.ui.view({id:"TourDetails",viewName:"splView.managetours.TourDetails",type:sap.ui.core.mvc.ViewType.XML});T.addEventDelegate({onBeforeShow:jQuery.proxy(T.getController().onBeforeShow,T.getController())});this.getView().getParent().addPage(T);}sap.ui.getCore().getModel("sapSplTourDetailsModel").setData(e.getSource().getBindingContext().getObject());m.data=sap.ui.getCore().getModel("sapSplTourDetailsModel").getData();m.label={};m.label.Location=oSapSplUtils.getBundle().getText("INCIDENTS_LOCATION");m.label.Start=oSapSplUtils.getBundle().getText("START");m.label.End=oSapSplUtils.getBundle().getText("END");m.label.Process=oSapSplUtils.getBundle().getText("PROCESS");m.label.items=oSapSplUtils.getBundle().getText("ITEMS");m.label.ApproachStop=oSapSplUtils.getBundle().getText("PROCESS_APPROACHING_STOP");m.label.Arrival=oSapSplUtils.getBundle().getText("PROCESS_ARRIVAL");m.label.LoadingStart=oSapSplUtils.getBundle().getText("PROCESS_LOADING_START");m.label.UnloadingStart=oSapSplUtils.getBundle().getText("PROCESS_UNLOADING_START");m.label.LoadingEnd=oSapSplUtils.getBundle().getText("PROCESS_LOADING_END");m.label.UnloadingEnd=oSapSplUtils.getBundle().getText("PROCESS_UNLOADING_END");m.label.ProofOfDelievery=oSapSplUtils.getBundle().getText("PROCESS_PROOF_OF_DELIEVERY");m.label.Departure=oSapSplUtils.getBundle().getText("PROCESS_DEPARTURE");m.index={value:e.getSource().getParent().indexOfItem(e.getSource())};sap.ui.getCore().getModel("sapSplTourDetailsModel").setData(m);window.clearInterval(t.oSapSplTourOverviewrefreshHandle);this.getView().getParent().to("TourDetails");},handleIconTabBarSelect:function(){var b=this.getView().byId("SapSplToursOverView").getBinding("items"),k=this.getView().byId("idIconTabBar").getSelectedKey(),f,F,o,a,c=null;if(k==="UnAssigned"){f=new sap.ui.model.Filter("TourStatus","EQ","U");b.filter([f]);c=oSapSplUtils.getBundle().getText("FILTER_LABEL_UNASSIGNED_TOURS");if(this.TourSelectionCountObject.Unssigned>0){this.byId("sapSplMarkAsFinished").setEnabled(splReusable.libs.SapSplModelFormatters.enableCompleteButton(1));}else{this.byId("sapSplMarkAsFinished").setEnabled(splReusable.libs.SapSplModelFormatters.enableCompleteButton(0));}}else if(k==="Finished"){f=new sap.ui.model.Filter("TourStatus","EQ","C");b.filter([f]);c=oSapSplUtils.getBundle().getText("FILTER_LABEL_COMPLETED_TOURS");if(this.TourSelectionCountObject.Completed>0){this.byId("sapSplMarkAsFinished").setEnabled(splReusable.libs.SapSplModelFormatters.enableCompleteButton(1));}else{this.byId("sapSplMarkAsFinished").setEnabled(splReusable.libs.SapSplModelFormatters.enableCompleteButton(0));}}else if(k==="Active"){f=new sap.ui.model.Filter("TourStatus","EQ","S");F=new sap.ui.model.Filter("TourStatus","EQ","A");o=new sap.ui.model.Filter("TourStatus","EQ","L");a=new sap.ui.model.Filter("TourStatus","EQ","I");b.filter([f,F,o,a]);c=oSapSplUtils.getBundle().getText("FILTER_LABEL_ACTIVE_TOURS");if(this.TourSelectionCountObject.Active>0){this.byId("sapSplMarkAsFinished").setEnabled(splReusable.libs.SapSplModelFormatters.enableCompleteButton(1));}else{this.byId("sapSplMarkAsFinished").setEnabled(splReusable.libs.SapSplModelFormatters.enableCompleteButton(0));}}else{c=oSapSplUtils.getBundle().getText("TOURS");b.filter([]);}this.byId("toursOverviewHeader").setNumber(b.getLength());this.byId("toursOverviewHeader").setNumberUnit(c);},fnHandlePressCreateNewTour:function(){var C,t=this;if(!this.getView().getParent().getPage("CreateNewTour")){C=sap.ui.view({id:"CreateNewTour",viewName:"splView.managetours.CreateNewTour",type:sap.ui.core.mvc.ViewType.XML});C.addEventDelegate({onBeforeShow:jQuery.proxy(C.getController().onBeforeShow,C.getController())});C.getController().setUnifiedShellInstance(this.getView().getParent().getParent().getController().getUnifiedShellInstance());this.getView().getParent().addPage(C);}this.getView().getParent().to("CreateNewTour");window.clearInterval(t.oSapSplTourOverviewrefreshHandle);},fnHandleSuccessCallback:function(d){var m={};this.byId("SapSplToursOverView").setBusy(false);if(d&&d.results&&d.results instanceof Array){if(d.results.length===0){this.getView().byId("SapSplToursOverView").setNoDataText(oSapSplUtils.getBundle().getText("TOURS_NO_DATA"));}for(var i=0;i<d.results.length;i++){if(d.results[i].Stops&&d.results[i].Stops.results&&d.results[i].Stops.results instanceof Array){d.results[i].Stops.results.sort(splReusable.libs.SapSplModelFormatters.sortStopObjectBasedOnSequenceNumber);}}}m=sap.ui.getCore().getModel("sapSplTourOverviewModel").getData();d.count=m.count;if(d.hasOwnProperty("results")&&d.results instanceof Array){sap.ui.getCore().getModel("sapSplTourOverviewModel").setSizeLimit(d.results.length+1);}sap.ui.getCore().getModel("sapSplTourOverviewModel").setData(d);sap.ui.getCore().getModel("sapSplTourOverviewModel").updateBindings();},fnHandleErrorCallback:function(){sap.ui.core.Fragment.byId("TourDelayDetails","SapSclTourDelayDetailsTable").setBusy(false);},fnHandlePressMonitorTourStatus:function(){var n="splView.liveApp.liveApp",t=this;var N=null;if(!sap.ui.getCore().byId("sapSplBaseApplication").getPage(n)){N=sap.ui.view({viewName:n,id:n,type:sap.ui.core.mvc.ViewType.XML});N.addEventDelegate({onBeforeShow:jQuery.proxy(N.getController().onBeforeShow,N.getController())});sap.ui.getCore().byId("sapSplBaseApplication").addPage(N);}oSplBaseApplication.getAppInstance().to(n,"slide",{showBackButton:true});window.clearInterval(t.oSapSplTourOverviewrefreshHandle);},fnGetTourOverViewData:function(){this.oSapSplApplModel.refresh();},fnHandleBackNavigation:function(){var b=null;b=oSplBaseApplication.getAppInstance();if(b.getPreviousPage()){if(b.getPreviousPage().sId==="splView.tileContainer.MasterTileContainer"){sap.ui.getCore().byId("sapSplBaseUnifiedShell").removeAllHeadItems();}b.back();}else{b.to("splView.tileContainer.MasterTileContainer");sap.ui.getCore().byId("sapSplBaseUnifiedShell").removeAllHeadItems();}},fnHandleSearch:function(e){var s=e.mParameters.query;var p,t=this;if(s.length>2){p=this.prepareSearchPayload(s);this.callSearchService(p);}else{if(s.length===0){t.handleIconTabBarSelect();}}},prepareSearchPayload:function(s){var p={};p.UserID=oSapSplUtils.getLoggedOnUserDetails().usreID;p.ObjectType="Tour";p.SearchTerm=s;p.FuzzinessThershold=SapSplEnums.fuzzyThreshold;p.MaximumNumberOfRecords=SapSplEnums.numberOfRecords;p.ProvideDetails=false;p.SearchInNetwork=true;p.AdditionalCriteria={};p.AdditionalCriteria.BusinessPartnerType="P";return p;},callSearchService:function(p){var t=this;oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/app/services/Search.xsjs"),method:"POST",async:false,data:JSON.stringify(p),success:function(d,s,m){oSapSplBusyDialog.getBusyDialogInstance().close();if(d.constructor===String){d=JSON.parse(d);}if(m["status"]===200){t.fnApplySearchFilters(d);}},error:function(e){oSapSplBusyDialog.getBusyDialogInstance().close();if(e&&e["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+"\t"+e.statusText,details:e.responseText});}else{var r={};if(e.responseText.constructor===String){r=JSON.parse(e.responseText);}else{r=e.responseText;}sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(r)["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(r)["ufErrorObject"]});}},complete:function(){}});},fnApplySearchFilters:function(d){var f=[],t=[],b=null;this.getView().byId("SapSplToursOverView");b=this.getView().byId("SapSplToursOverView").getBinding("items");f=oSapSplUtils.getSearchItemFilters(d,"UUID");b.filter([]);this.handleIconTabBarSelect();if(b&&b.aFilters){t=b.aFilters;}if(t&&t instanceof Array&&t.length>0){t.push(f);b.filter(t);}else{if(!(f instanceof Array)){f=[f];}b.filter(f);}this.byId("toursOverviewHeader").setNumber(b.getLength());},handleSelectOfTour:function(e){var s=null;var a=null;this.getView().byId("sapSplMarkAsFinished").getModel().getData().count=e.getSource().getSelectedItems().length;this.byId("sapSplMarkAsFinished").setEnabled(splReusable.libs.SapSplModelFormatters.enableCompleteButton(this.getView().byId("sapSplMarkAsFinished").getModel().getData().count));s=e.getParameters().listItem.getBindingContext().getProperty().TourStatus;a=e.getParameters().listItem.getSelected();if(s==='U'){if(a===true){this.TourSelectionCountObject.Unssigned++;}else{this.TourSelectionCountObject.Unssigned--;}}else if(s==='C'){if(a===true){this.TourSelectionCountObject.Completed++;}else{this.TourSelectionCountObject.Completed--;}}else if(s==='S'||s==='A'||s==='L'||s==='I'){if(a===true){this.TourSelectionCountObject.Active++;}else{this.TourSelectionCountObject.Active--;}}},fnHandlePressFinish:function(){var i,m,t=[],q,s=this.byId("SapSplToursOverView").getSelectedItems(),a=this;m=s.length;for(i=0;i<m;i++){t.push(s[i].getBindingContext().getObject().UUID);}if(t.length>0){this.fnPostTourData(this.preparePayloadForCompletionOfTour(t));this.byId("SapSplToursOverView").removeSelections();this.byId("sapSplMarkAsFinished").setEnabled(false);this.getView().byId("sapSplMarkAsFinished").getModel().getData().count=0;}},preparePayloadForCompletionOfTour:function(t){var i,p=[],a={};for(i=0;i<t.length;i++){p.push({"UUID":t[i],"ChangeMode":"U"});}a["isTourMarkedForCompletion"]="1";a["inputHasChangeMode"]=true;a["Header"]=p;return a;},constructQueryParameters:function(u){var i=0;var m=0;var q="";if(u&&u instanceof Array){m=u.length;for(i=0;i<m;i++){q=q+" UUID eq X\'"+oSapSplUtils.base64ToHex(u[i])+"\'";if(i!==m-1){q=q+" or";}}}return q;},fnPostTourData:function(p){var t=this;oSapSplBusyDialog.getBusyDialogInstance().open();window.setTimeout(function(){oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/app/services/tour.xsjs"),method:"PUT",async:false,data:JSON.stringify(p),success:function(d,s,m){var c=new sap.ui.core.CustomData({key:"bRefreshTile",value:true});oSplBaseApplication.getAppInstance().getCurrentPage().destroyCustomData();oSplBaseApplication.getAppInstance().getCurrentPage().addCustomData(c);oSapSplBusyDialog.getBusyDialogInstance().close();if(d.constructor===String){d=JSON.parse(d);}if(m["status"]===200&&d["Error"].length===0){sap.ca.ui.message.showMessageToast(oSapSplUtils.getBundle().getText("TOUR_MARKED_COMPLTED",d.Header[0].Name));t.fnGetTourOverViewData();}else{var e=oSapSplUtils.getErrorMessagesfromErrorPayload(d)["ufErrorObject"];sap.ca.ui.message.showMessageBox({type:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["messageTitle"],message:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["errorWarningString"],details:e});}oSapSplUtils.setIsDirty(false);},error:function(e){oSapSplBusyDialog.getBusyDialogInstance().close();if(e&&e["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+" "+e.statusText,details:e.responseText});}else{if(e.responseText.constructor===String){e.responseText=JSON.parse(e.responseText);}sap.ca.ui.message.showMessageBox({type:oSapSplUtils.getErrorMessagesfromErrorPayload(e.responseText)["messageTitle"],message:oSapSplUtils.getErrorMessagesfromErrorPayload(e.responseText)["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(e.responseText)["ufErrorObject"]});}},complete:function(){}});},400);},fnTransformData:function(d){var h={},t={},I={},s={},a={},i,m,j,M,b,S,A;if(!this.oPayloadForTourCompletion){this.oPayloadForTourCompletion={};this.oPayloadForTourCompletion.isTourMarkedForCompletion="1";this.oPayloadForTourCompletion.inputHasChangeMode="true";this.oPayloadForTourCompletion.Header=[];this.oPayloadForTourCompletion.Text=[];this.oPayloadForTourCompletion.Stop=[];this.oPayloadForTourCompletion.Item=[];this.oPayloadForTourCompletion.StopItemAssignment=[];}h["UUID"]=d["UUID"];h["TourID"]=d["TourID"];h["VehicleUUID"]=d["VehicleUUID"];h["Status"]="C";h["OwnerID"]=d["OwnerID"];h["Name"]=d["Name"];h["EventSchema"]="default";h["Planned.StartTime"]=d["Planned_StartTime"];h["Planned.EndTime"]=d["Planned_EndTime"];h["Actual.StartTime"]=d["Actual_StartTime"];h["Actual.EndTime"]=d["Actual_EndTime"];h["isDeleted"]=d["isDeleted"];h["AuditTrail.CreatedBy"]=null;h["AuditTrail.ChangedBy"]=null;h["AuditTrail.CreationTime"]=null;h["AuditTrail.ChangeTime"]=null;h["ChangeMode"]="U";t["UUID"]=d["UUID"];t["Text"]=null;t["ChangeMode"]="U";if(d.Items&&d.Items.results&&d.Items.results.length>0){b=d.Items.results;m=b.length;for(i=0;i<m;i++){I["UUID"]=b[i].ItemUUID;I["ItemID"]=b[i].ItemID;I["TourUUID"]=b[i].TourUUID;I["Type"]=b[i].Type;I["Detail1"]=b[i].Detail1;I["Detail2"]=b[i].Detail2;I["Detail3"]=b[i].Detail3;I["DangerGoodsClass"]=b[i].DangerGoodsClass;I["isDeleted"]=b[i].isDeleted;I["ChangeMode"]="U";this.oPayloadForTourCompletion.Item.push(I);I={};}}if(d.Stops&&d.Stops.results&&d.Stops.results.length>0){S=d.Stops.results;m=S.length;for(i=0;i<m;i++){s["UUID"]=S[i].UUID;s["TourUUID"]=S[i].TourUUID;s["Sequence"]=S[i].Sequence;s["Name"]=S[i].Name;s["Description"]=S[i].Description;s["Geocordinate"]=null;s["Status"]=S[i].Status;s["LastReportedEvent"]=S[i].LastReportedEvent;s["Planned.ArrivalTime"]=S[i]["Planned_ArrivalTime"];s["Planned.DepartureTime"]=S[i]["Planned_DepartureTime"];s["Actual.ArrivalTime"]=S[i]["Actual_ArrivalTime"];s["Actual.DepartureTime"]=S[i]["Actual_DepartureTime"];s["LocationUUID"]=S[i]["LocationUUID"];s["isDeleted"]=S[i].isDeleted;s["ChangeMode"]="U";if(S[i].AssignedItems&&S[i].AssignedItems.results&&S[i].AssignedItems.results.length>0){A=S[i].AssignedItems.results;M=A.length;for(j=0;j<M;j++){a["UUID"]=oSapSplUtils.getUUID();a["TourUUID"]=A[j]["TourUUID"];a["StopUUID"]=A[j]["StopUUID"];a["ItemUUID"]=A[j]["ItemUUID"];a["Type"]=A[j]["AssignmentType"];a["isDeleted"]=A[j]["isDeleted"];a["ChangeMode"]="U";this.oPayloadForTourCompletion.StopItemAssignment.push(a);a={};}}this.oPayloadForTourCompletion.Stop.push(s);s={};}this.oPayloadForTourCompletion.Header.push(h);this.oPayloadForTourCompletion.Text.push(t);}},fnHandleNavigationSearch:function(v){if(v){this.byId("idIconTabBar").setSelectedKey("Active");this.byId("idIconTabBar").fireSelect();this.byId("sapSplTourOverviewSearchField").setValue(v);var e={};e.mParameters={};e.mParameters.query="";this.fnHandleSearch(e);e.mParameters.query="*"+v+"*";this.fnHandleSearch(e);}},fnHandleTourDelayDetailsLink:function(e){if(!this.oTourStopDelayDetailsPopover){this.oTourStopDelayDetailsPopover=sap.ui.xmlfragment("TourDelayDetails","splReusable.fragments.TourStopDelayDetails",this);this.oSplTourStopDelayDetialsModel=new sap.ui.model.json.JSONModel();sap.ui.core.Fragment.byId("TourDelayDetails","SapSclTourDelayDetailsPopoverTitle").setTitle(oSapSplUtils.getBundle().getText("DELAYS"));sap.ui.core.Fragment.byId("TourDelayDetails","SapSclTourDelayDetailsPopoverCloseButton").setText(oSapSplUtils.getBundle().getText("CLOSE"));sap.ui.core.Fragment.byId("TourDelayDetails","SapSclTourDelayDetailsTableArrival").setText(oSapSplUtils.getBundle().getText("TOUR_ARRIVAL"));sap.ui.core.Fragment.byId("TourDelayDetails","SapSclTourDelayDetailsTableDeparture").setText(oSapSplUtils.getBundle().getText("TOUR_DEPARTURE"));}sap.ui.core.Fragment.byId("TourDelayDetails","SapSclTourDelayDetailsTable").setBusy(true);this.oSplTourStopDelayDetialsModel.setData([]);this.getStopDetails(e.getSource().getBindingContext().getProperty());this.oTourStopDelayDetailsPopover.openBy(e.getSource());},getStopDetails:function(t){var T=[],q,a=this;T.push(t.UUID);q=this.constructQueryParameters(T);sap.ui.getCore().getModel("ToursOverViewPageODataModel").read("/Tours",false,["$expand=Stops&$filter="+q],null,jQuery.proxy(a.fnHandleSuccessCallbackForStopDetails,this),jQuery.proxy(a.fnHandleErrorCallback,this));},fnHandleSuccessCallbackForStopDetails:function(d){if(d&&d.hasOwnProperty("results")&&d.results instanceof Array){this.oSplTourStopDelayDetialsModel.setData(d.results[0].Stops);}else{this.oSplTourStopDelayDetialsModel.setData([]);}this.oTourStopDelayDetailsPopover.setModel(this.oSplTourStopDelayDetialsModel);this.oSapSplTourStopDelaySorter=new sap.ui.model.Sorter("Sequence",true,this.handleGroupingOfStops);sap.ui.core.Fragment.byId("TourDelayDetails","SapSclTourDelayDetailsTable").getBinding("items").sort([this.oSapSplTourStopDelaySorter]);sap.ui.core.Fragment.byId("TourDelayDetails","SapSclTourDelayDetailsTable").setBusy(false);},fnHandleTourDelayDetailsPopoverCloseButton:function(){this.oTourStopDelayDetailsPopover.close();},handleGroupingOfStops:function(c){var n=c.getProperty("Name");var k=c.getProperty("Sequence");return{key:k,text:n};}});
