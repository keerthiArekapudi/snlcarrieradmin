/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
jQuery.sap.require("splReusable.libs.SapSplTourTruckChart");sap.ui.controller("splController.managetours.TourDetails",{onInit:function(){var t=this;this.fnDefineControlLabelsFromLocalizationBundle();splReusable.libs.SapSplStyleSheetLoader.loadStyle("./resources/styles/sapSplLiveApp");splReusable.libs.SapSplStyleSheetLoader.loadStyle("./resources/styles/sapSplTourOverview");sap.ui.getCore().setModel(new sap.ui.model.json.JSONModel(),"ToursDetailStopsModel");this.oSapSplToursDetailODataModelStops=sap.ui.getCore().getModel("ToursDetailODataModelStops");sap.ui.getCore().setModel(this.oSapSplToursDetailODataModelStops,"ToursDetailODataModelStops");this.getView().byId("sapSplStopPanel").setModel(sap.ui.getCore().getModel("ToursDetailStopsModel"));this.getView().byId("toursOverviewHeader").setModel(sap.ui.getCore().getModel("sapSplTourDetailsModel"));this.getView().byId("sapSplTruckDetailsPanel").setModel(sap.ui.getCore().getModel("sapSplTourDetailsModel"));this.getView().byId("sapSnlhHeaderContainer").setModel(sap.ui.getCore().getModel("sapSplTourDetailsModel"));this.getView().byId("sapSplTourDetailsIconTabBar").setModel(sap.ui.getCore().getModel("sapSplTourDetailsModel"));this.getView().byId("sapSplToursEditButton").setModel(sap.ui.getCore().getModel("sapSplTourDetailsModel"));var m=sap.ui.getCore().getModel("sapSplTourDetailsModel").getData();m.showMapFullScreenButton=true;sap.ui.getCore().getModel("sapSplTourDetailsModel").setData(m);this.getView().byId("SapSplNavigationUp").addCustomData(new sap.ui.core.CustomData({key:"up",value:"up"}));this.getView().byId("SapSplNavigationDown").addCustomData(new sap.ui.core.CustomData({key:"down",value:"down"}));jQuery(window).resize(jQuery.proxy(this.fnRenderStyle,this));this.byId("sapSplToursMapContainer").addEventDelegate({onAfterRendering:function(){t.fnRenderStyle();}});this.fnInstantiateMap();},onAfterRendering:function(){},fnRenderStyle:function(){if(sap.ui.getCore().getModel("sapSplTourDetailsModel").getData().showMapFullScreenButton!==undefined&&sap.ui.getCore().getModel("sapSplTourDetailsModel").getData().showMapFullScreenButton===false){this.iWindowHeight=jQuery(window).height()*(0.6);}else{this.iWindowHeight=jQuery(window).height()*(0.4);}jQuery(".oSapSplTourDetailsMap").css("height",this.iWindowHeight+"px");},fnInstantiateMap:function(){this.oVBIModel=new sap.ui.model.json.JSONModel();this.oVBIModel.setData(oSapSplMapsDataMarshal.getMapsModelJSON(SapSplEnums.configJSON));sap.ui.getCore().setModel(this.oVBIModel,"oSapSplVBModelTourApp");this.getView().byId("oSapSplTourDetailsMap").bindProperty("config","oSapSplVBModelTourApp>/");this.getView().byId("oSapSplTourDetailsMap").setModel(sap.ui.getCore().getModel("oSapSplVBModelTourApp"));},fnHandleNavigationToLiveApp:function(t){var n="splView.liveApp.liveApp";var N=null;if(!sap.ui.getCore().byId("sapSplBaseApplication").getPage(n)){N=sap.ui.view({viewName:n,id:n,type:sap.ui.core.mvc.ViewType.XML});N.addEventDelegate({onBeforeShow:jQuery.proxy(N.getController().onBeforeShow,N.getController())});sap.ui.getCore().byId("sapSplBaseApplication").addPage(N);}var o={};o["FromApp"]="tours";o["TruckInfo"]=t;oSplBaseApplication.getAppInstance().to(n,"slide",o);},fnGetPathData:function(r,t,v){if(r.VehicleUUID){var f="$filter=UUID eq X\'"+oSapSplUtils.base64ToHex(r.VehicleUUID)+"\'";var s=r["Actual_StartTime"];var e=r["Actual_EndTime"];if(!s){s=r["Planned_StartTime"];}if(!e){e=r["Planned_EndTime"];}if(r.TourStatus==="I"){f+=" and (ReportedTime ge datetime'"+s.toJSON()+"')";}else{f+=" and (ReportedTime le datetime'"+e.toJSON()+"' and ReportedTime ge datetime'"+s.toJSON()+"')";}function S(p){this.fnPlotFirstPosition(r,p.results,v);this.getView().byId("sapSplTruckLocationPanel").setBusy(false);if(p){var P=p.results.length;var a="";var o={};for(var i=0;i<P;i++){if(p.results[i].PositionGeo){a+=oSapSplMapsDataMarshal.convertGeoJSONToString(JSON.parse(p.results[i].PositionGeo));if(i!==P-1){a+=";";}}}o["key"]="123";o["name"]="";o["coordinate"]=a;o["color"]="ARGB(0x99;0xAB;0x21;0x8E)";o["start"]="0";o["end"]="0";o["dotWidth"]="0";o["lineWidth"]="3";oSapSplMapsDataMarshal.fnShowTourPath(o,v);}};function E(){this.getView().byId("sapSplTruckLocationPanel").setBusy(false);jQuery.sap.log.error("Tour path","read failed","TourDetails.controller.js");};oSapSplBusyDialog.getBusyDialogInstance().open();sap.ui.getCore().getModel("ToursOverViewPageODataModel").read("/VehiclePositionHistory",null,[f],true,jQuery.proxy(S,this),jQuery.proxy(E,this));oSapSplBusyDialog.getBusyDialogInstance().close();}else{this.getView().byId("sapSplTruckLocationPanel").setBusy(false);return null;}},fnShowStopsOnMap:function(r,v){if(r&&r.Stops&&r.Stops.results){r.Stops.results.sort(function(a,b){Number(a.ActualSequence)-Number(b.ActualSequence);});oSapSplMapsDataMarshal.fnShowTourStops(r.Stops.results,v);}},fnPlotFirstPosition:function(r,p,v){if(p.length>0){p.sort(function(P,o){if(P.ReportedTime>o.ReportedTime){return 1;}if(P.ReportedTime>o.ReportedTime){return-1;}});r.Position.results=[p[0]];if(r.TourStatus==="I"){if(r.Position&&r.Position.results&&r.Position.results.constructor===Array){for(var i=0;i<r.Position.results.length;i++){r.Position.results[i].Position=r.Position.results[i].PositionGeo;oSapSplMapsDataMarshal.fnShowTruckFlags(r.Position.results[i],v);var c=oSapSplMapsDataMarshal.convertGeoJSONToString(JSON.parse(r.Position.results[i].Position)).split(";");v.zoomToGeoPosition(parseFloat(c[0],10),parseFloat(c[1],10),12);}}}}},fnShowPathOnMap:function(r,v){this.fnGetPathData(r,this,v);},fnShowTruckOnTheMap:function(r,v){oSapSplMapsDataMarshal.fnClearMap(v);if(r.TourStatus==="I"||r.TourStatus==="C"){this.byId("sapSplNavigateToLiveAppButton").setEnabled(true);if(r.VehicleUUID===null){this.byId("sapSplTruckLocationPanel").setVisible(false);}else{this.getView().byId("sapSplTruckLocationPanel").setBusy(true);this.byId("sapSplTruckLocationPanel").setVisible(true);this.fnShowPathOnMap(r,v);this.fnShowStopsOnMap(r,v);}}else{this.byId("sapSplTruckLocationPanel").setVisible(false);this.byId("sapSplNavigateToLiveAppButton").setEnabled(false);}},fnHandleClickOfNavigateButton:function(){this.fnHandleNavigationToLiveApp(sap.ui.getCore().getModel("sapSplTourDetailsModel").getData().data);},onBeforeShow:function(){sap.ui.getCore().getModel("sapSplTourDetailsModel").updateBindings();this.refreshsapSplTourDetailModel();this.currentUUID=sap.ui.getCore().getModel("sapSplTourDetailsModel").getData().data.UUID;},fnDefineControlLabelsFromLocalizationBundle:function(){this.getView().byId("sapSplNavigateToLiveAppButton").setText(oSapSplUtils.getBundle().getText("SHOW_IN_TRAFFIC_STATUS"));this.getView().byId("TourDetailPageTitle").setText(oSapSplUtils.getBundle().getText("TOUR_DETAILS"));this.getView().byId("sapSplSelectTruckLabel").setText(oSapSplUtils.getBundle().getText("TRUCK"));this.getView().byId("sapSplDriverLabel").setText(oSapSplUtils.getBundle().getText("DRIVER"));this.getView().byId("sapSplCommentLabel").setText(oSapSplUtils.getBundle().getText("COMMENTS"));this.getView().byId("sapSplTruckDetailsPanel").setHeaderText(oSapSplUtils.getBundle().getText("DETAILS"));this.getView().byId("sapSplStopPanel").setHeaderText(oSapSplUtils.getBundle().getText("STOPS"));this.getView().byId("sapSplToursEditButton").setText(oSapSplUtils.getBundle().getText("MY_COLLEAGUES_EDIT_BUTTON"));this.getView().byId("sapSplTourProgressLink").setText(oSapSplUtils.getBundle().getText("PROGRESS_OF_TOUR"));this.getView().byId("sapSplTruckLocationPanel").setHeaderText(oSapSplUtils.getBundle().getText("LOCATIONS"));},fnHandlePressOfUpButton:function(e){var I=null;if(sap.ui.getCore().getModel("sapSplTourDetailsModel").getData()&&sap.ui.getCore().getModel("sapSplTourDetailsModel").getData().index){I=sap.ui.getCore().getModel("sapSplTourDetailsModel").getData().index.value-1;}if(sap.ui.getCore().getModel("sapSplTourOverviewModel").getData()&&sap.ui.getCore().getModel("sapSplTourOverviewModel").getData().results&&sap.ui.getCore().getModel("sapSplTourOverviewModel").getData().results[I]){sap.ui.getCore().getModel("sapSplTourDetailsModel").getData().index.value--;sap.ui.getCore().getModel("sapSplTourDetailsModel").getData().data=sap.ui.getCore().getModel("sapSplTourOverviewModel").getData().results[I];sap.ui.getCore().getModel("sapSplTourDetailsModel").updateBindings();this.currentUUID=sap.ui.getCore().getModel("sapSplTourDetailsModel").getData().data.UUID;if(sap.ui.getCore().getModel("sapSplTourDetailsModel").getData().index.value-1>=sap.ui.getCore().getModel("sapSplTourOverviewModel").getData().results.length){e.getSource().setEnabled(false);}this.refreshsapSplTourDetailModel();this.fnShowTruckOnTheMap(sap.ui.getCore().getModel("sapSplTourDetailsModel").getData().data,this.byId("oSapSplTourDetailsMap"));}},fnHandlePressOfDownButton:function(e){var I=null;if(sap.ui.getCore().getModel("sapSplTourDetailsModel").getData()&&sap.ui.getCore().getModel("sapSplTourDetailsModel").getData().index){I=sap.ui.getCore().getModel("sapSplTourDetailsModel").getData().index.value+1;}if(sap.ui.getCore().getModel("sapSplTourOverviewModel").getData()&&sap.ui.getCore().getModel("sapSplTourOverviewModel").getData().results&&sap.ui.getCore().getModel("sapSplTourOverviewModel").getData().results[I]){sap.ui.getCore().getModel("sapSplTourDetailsModel").getData().index.value++;sap.ui.getCore().getModel("sapSplTourDetailsModel").getData().data=sap.ui.getCore().getModel("sapSplTourOverviewModel").getData().results[I];sap.ui.getCore().getModel("sapSplTourDetailsModel").updateBindings();this.currentUUID=sap.ui.getCore().getModel("sapSplTourDetailsModel").getData().data.UUID;if(sap.ui.getCore().getModel("sapSplTourDetailsModel").getData().index.value+1>=sap.ui.getCore().getModel("sapSplTourOverviewModel").getData().results.length){e.getSource().setEnabled(false);}this.refreshsapSplTourDetailModel();this.fnShowTruckOnTheMap(sap.ui.getCore().getModel("sapSplTourDetailsModel").getData().data,this.byId("oSapSplTourDetailsMap"));}},fnHandleTapOfBackbutton:function(){this.getView().getParent().to("ToursOverview");window.clearInterval(this.oSapSplTourDetails);},fnHandelPressOfEdit:function(){var v={};var C,t=this;var d=null;d=sap.ui.getCore().getModel("sapSplTourDetailsModel").getData();if(d&&d.data&&d.data.UUID){function h(a){if(a&&a.results&&a.results instanceof Array){d.data.Items=a;sap.ui.getCore().getModel("sapSplTourDetailsModel").getData(d);}};function H(){};sap.ui.getCore().getModel("ToursDetailODataModelStops").read("/TourItems",null,["$filter=TourUUID eq X\'"+oSapSplUtils.base64ToHex(d.data.UUID)+"\'"],false,jQuery.proxy(h,this),jQuery.proxy(H,this));}if(!this.getView().getParent().getPage("CreateNewTour")){C=sap.ui.view({id:"CreateNewTour",viewName:"splView.managetours.CreateNewTour",type:sap.ui.core.mvc.ViewType.XML});C.addEventDelegate({onBeforeShow:jQuery.proxy(C.getController().onBeforeShow,C.getController())});C.getController().setUnifiedShellInstance(this.getView().getParent().getParent().getController().getUnifiedShellInstance());this.getView().getParent().addPage(C);}v.TourData=sap.ui.getCore().getModel("sapSplTourDetailsModel").getData();v.isEdit=1;this.getView().getParent().to("CreateNewTour","slide",v);window.clearInterval(t.oSapSplTourDetails);},refreshsapSplTourDetailModel:function(){var t=this;window.clearInterval(t.oSapSplTourDetails);t.fnFetchTourDetails();if(sap.ui.getCore().getModel("sapSplTourDetailsModel").getData().data.TourStatus!=="C"&&sap.ui.getCore().getModel("sapSplTourDetailsModel").getData().data.TourStatus!=="D"){t.oSapSplTourDetails=window.setInterval(function(){t.fnFetchTourDetails();},60000);oSapSplUtils.setIntervalId(t.oSapSplTourDetails);}},fnFetchTourDetails:function(){var d=null,U=null,t=this;d=sap.ui.getCore().getModel("sapSplTourDetailsModel").getData();if(d&&d.data&&d.data.UUID){U=d.data.UUID;this.getView().byId("sapSplTruckDetailsPanel").setBusy(true);this.getView().byId("sapSplStopPanel").setBusy(true);this.getView().byId("sapSnlhHeaderContainer").setBusy(true);this.getView().byId("sapSplToursEditButton").setEnabled(false);sap.ui.getCore().getModel("ToursOverViewPageODataModel").read("/Tours",null,["$filter=UUID eq X\'"+oSapSplUtils.base64ToHex(U)+"\'","$orderby=Planned_StartTime  desc,RegistrationNumber"],null,jQuery.proxy(t.fnHandleSuccessCallback,this),jQuery.proxy(t.fnHandleErrorCallback,this));sap.ui.getCore().getModel("ToursDetailODataModelStops").read("/Tours(X"+"\'"+oSapSplUtils.base64ToHex(U)+"\')/Stops",null,[],null,jQuery.proxy(t.fnHandleSuccessCallbackForStops,this),jQuery.proxy(t.fnHandleErrorCallbackForStops,this));}},fnHandleSuccessCallback:function(d){var D=sap.ui.getCore().getModel("sapSplTourDetailsModel").getData(),s=[],p=[];this.getView().byId("sapSnlhHeaderContainer").setBusy(false);this.getView().byId("sapSplTruckDetailsPanel").setBusy(false);if(d&&d.results&&d.results instanceof Array){if(!(d.results[0].isEditable===0||d.results[0].TourStatus==="C"||d.results[0].TourStatus==="I")){this.getView().byId("sapSplToursEditButton").setEnabled(true);}D.data=d.results[0];if(d.results[0].UUID===this.currentUUID){if(D.showMapFullScreenButton===undefined){D.showMapFullScreenButton=true;}sap.ui.getCore().getModel("sapSplTourDetailsModel").setData(D);sap.ui.getCore().getModel("sapSplTourDetailsModel").updateBindings(true);}}},fnHandleSuccessCallbackForStops:function(d){var D=$.extend(true,[],sap.ui.getCore().getModel("sapSplTourDetailsModel").getData()),s=[],p=[];if(d&&d.results&&d.results instanceof Array){d.results.sort(splReusable.libs.SapSplModelFormatters.sortStopObjectBasedOnSequenceNumber);D.data.Stops=d;this.fnShowTruckOnTheMap(D.data,this.byId("oSapSplTourDetailsMap"));function h(d){if(d&&d.results&&d.results instanceof Array){s=d.results.filter(splReusable.libs.SapSplModelFormatters.getFilteredStopEvents);}if(s&&s instanceof Array){for(var i=0;i<D.data.Stops.results.length;i++){p=[];p=s.filter(splReusable.libs.SapSplModelFormatters.getFilteredParticularStopEvents,D.data.Stops.results[i]);D.data.Stops.results[i].Events=[];D.data.Stops.results[i].Events=p;}}if(D.data.Log.constructor===Object){D.data.Log=[];}D.data.Log=d;function f(d){this.getView().byId("sapSplStopPanel").setBusy(false);if(d&&d.results&&d.results instanceof Array){if(d.results.length>0){for(var i=0;i<d.results.length;i++){for(var j=0;j<D.data.Stops.results.length;j++){if(D.data.Stops.results[j].AssignedItems.results===undefined){D.data.Stops.results[j].AssignedItems.results=[];}if(d.results[i].StopUUID===D.data.Stops.results[j].UUID){D.data.Stops.results[j].AssignedItems.results.push(d.results[i]);}}}}else{for(var j=0;j<D.data.Stops.results.length;j++){if(D.data.Stops.results[j].AssignedItems.results===undefined){D.data.Stops.results[j].AssignedItems.results=[];}}}}sap.ui.getCore().getModel("ToursDetailStopsModel").setData(D);sap.ui.getCore().getModel("ToursDetailStopsModel").updateBindings(true);sap.ui.getCore().getModel("sapSplTourDetailsModel").setData(D);}function a(){this.getView().byId("sapSplStopPanel").setBusy(false);}sap.ui.getCore().getModel("ToursDetailODataModelStops").read("/Items",null,["$filter=TourUUID eq X\'"+oSapSplUtils.base64ToHex(D.data.UUID)+"\'"],null,jQuery.proxy(f,this),jQuery.proxy(a,this));};function H(){this.getView().byId("sapSplStopPanel").setBusy(false);};sap.ui.getCore().getModel("ToursOverViewPageODataModel").read("/Tours(X"+"\'"+oSapSplUtils.base64ToHex(D.data.UUID)+"\')/Log",null,[],null,jQuery.proxy(h,this),jQuery.proxy(H,this));}},fnHandleErrorCallback:function(){this.getView().byId("sapSplTruckDetailsPanel").setBusy(false);this.getView().byId("sapSnlhHeaderContainer").setBusy(false);},fnHandleErrorCallbackForStops:function(){this.getView().byId("sapSplStopPanel").setBusy(false);},openDetailWindow:function(e){var t=this;if(JSON.parse(e.getParameter("id"))["isTypeTruck"]){oSapSplMapsDataMarshal.fnAddTruckDetailWindowContent(e,function(){},t.byId("oSapSplTourDetailsMap"),true);}},bCanChangeTruckIcon:function(){function g(z){if(z<=10){return 1;}else{return 2;}}if(g(this.iCurZoom)===g(this.iPrevZoom)){return false;}else{return true;}},fnHandleZoomEventOnTheMap:function(e){var r=sap.ui.getCore().getModel("sapSplTourDetailsModel").getData().data;var v=this.byId("oSapSplTourDetailsMap");this.iPrevZoom=v.zoom;oSapSplMapsDataMarshal.fnGetMapZoom(v,e);this.iCurZoom=v.zoom;if(this.bCanChangeTruckIcon()===true){if(r.Position&&r.Position.results&&r.Position.results.constructor===Array){for(var i=0;i<r.Position.results.length;i++){oSapSplMapsDataMarshal.fnShowTruckFlags(r.Position.results[i],v);}}}},fnEventHandler:function(e){if(JSON.parse(e.getParameter("data")).Action.name==="ZOOM_EVENT"){this.fnHandleZoomEventOnTheMap(e);}},fnHandleTourProgressLink:function(){splReusable.libs.SapSplStyleSheetLoader.loadStyle("./resources/styles/sapSplTourProgress");var e=sap.ui.getCore().getModel("sapSplTourDetailsModel").getData().data.Log;var t=sap.ui.view({id:"SplTourProgressDialogView",viewName:"splView.dialogs.SplTourProgressDialog",type:sap.ui.core.mvc.ViewType.XML,viewData:e});var a=new sap.m.Dialog({title:oSapSplUtils.getBundle().getText("PROGRESS_OF_ALL_STOPS"),content:t,contentWidth:"20%"}).addStyleClass("sapSplTourProgressDialog").open();a.attachAfterOpen(function(){oSapSplUtils.fnSyncStyleClass(a);});function h(E){E.getSource().destroy();}a.attachAfterClose(jQuery.proxy(h,this));t.getController().setParentDialogInstance(a);},fnHandleMapFullScreen:function(){var m=sap.ui.getCore().getModel("sapSplTourDetailsModel").getData();m.showMapFullScreenButton=false;sap.ui.getCore().getModel("sapSplTourDetailsModel").setData(m);sap.ui.getCore().getModel("sapSplTourDetailsModel").updateBindings(true);},fnHandleMapExitFullScreen:function(){var m=sap.ui.getCore().getModel("sapSplTourDetailsModel").getData();m.showMapFullScreenButton=true;sap.ui.getCore().getModel("sapSplTourDetailsModel").setData(m);sap.ui.getCore().getModel("sapSplTourDetailsModel").updateBindings(true);}});
