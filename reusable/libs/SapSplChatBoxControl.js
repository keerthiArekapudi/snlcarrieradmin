/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
jQuery.sap.require("splReusable.exceptions.MissingParametersException");jQuery.sap.require("splReusable.exceptions.InvalidArrayException");jQuery.sap.require("splReusable.libs.SapSplModelFormatters");jQuery.sap.require("splReusable.libs.SapSplEnums");splReusable.libs.SapSplStyleSheetLoader.loadStyle("./resources/styles/sapSplChatBoxControl");jQuery.sap.declare("splReusable.libs.SapSplChatBoxControl");var bMessageReceived=false;var bChatListRendered=false;
function fnFetchDataForChat(t){var p="/ChatMessage?$orderby=ReportedTime desc&$inlinecount=allpages&$filter=ThreadUUID eq X'"+oSapSplUtils.base64ToHex(t.oChatBoxConfigData["ThreadUUID"])+"\'";if(t.totalCount&&t.totalCount<t.top){t.top=t.totalCount+1;}p=p+"&$top="+t.top;sap.ui.getCore().getModel("ChatODataModel").read(p,null,[""],true,function(r){t.oChatBoxModel.setSizeLimit(r.results.length+1);t.oChatBoxModel.setData(r.results);if(t.oChatBoxConfigData["chatBoxConsoleApp"]&&t.totalCount!==undefined){if(t.oChatBoxConsoleLeftListItemInstance&&parseInt(r["__count"],10)>t.totalCount){bMessageReceived=true;}}if(t.oChatBoxConfigData["chatBoxConsoleApp"]&&t.totalCount!==undefined){if(t.oChatBoxConfigData["chatBoxConsoleApp"].getCurrentPage().sId!==t.oChatBoxLayout.sId){if(t.oChatBoxConsoleLeftListItemInstance&&parseInt(r["__count"],10)>t.totalCount){t.oChatBoxConsoleLeftListItemInstance.setCounter(t.oChatBoxConsoleLeftListItemInstance.getCounter()+1);t.oChatBoxConsoleLeftListItemInstance.addStyleClass("chatBoxHasUnreadMessages");}else{bChatListRendered=true;}}}t.totalCount=parseInt(r["__count"],10);},function(){});}
function startPollingOfChatBox(t){if(t.oInterval!==undefined){clearInterval(t.oInterval);}t.oInterval=window.setInterval(function(){fnFetchDataForChat(t);},4000);oSapSplUtils.setIntervalId(t.oInterval);}
function fnHandleSelectionOfChatItem(e){e.getParameter("listItem").addStyleClass("listItemClicked");e.getParameter("listItem").setSelected(false);}
function getChatBoxListItem(d){var t=new sap.m.FeedListItem({text:"{Text}",timestamp:{parts:[{path:"ReportedTime"}],formatter:splReusable.libs.SapSplModelFormatters.returnMessageTimestamp},icon:"sap-icon://employee"});t.addEventDelegate({onAfterRendering:function(e){var b=e.srcControl.getBindingContext().getObject();var h=$("#"+e.srcControl.sId+" .sapMFeedListItemText").height();$("#"+e.srcControl.sId+" .sapMFeedListItem").parent().css("min-height",h+42+"px");$("#"+e.srcControl.sId+" .sapMFeedListItemFooter #"+e.srcControl.sId+"outBoundStatus").remove();if(b["MessageDirection"]==="S"){$("#"+e.srcControl.sId+" .sapMFeedListItemFooter").prepend("<div class='outBoundStatus' id="+e.srcControl.sId+"outBoundStatus"+"></div>");if(b["ReplicationStatus"]===0){new sap.m.Label({text:oSapSplUtils.getBundle().getText("DELIVERY_FAILED")}).placeAt(e.srcControl.sId+"outBoundStatus").addStyleClass("outBoundStatusError");}else if(b["ReplicationStatus"]===2){new sap.ui.core.Icon({src:"sap-icon://accept"}).placeAt(e.srcControl.sId+"outBoundStatus").addStyleClass("outBoundStatusOK");}}}});if(d==="right"){t.addStyleClass("sapSplChatBoxListItemRight");return t;}else{t.addStyleClass("sapSplChatBoxListItemLeft");return t;}}
function fnMakeAjaxCall(p,t,T,P){oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getServiceMetadata("message",true),method:"POST",async:false,data:JSON.stringify(p),success:function(d,s,m){if(d.constructor===String){d=JSON.parse(d);}if(m["status"]===200&&d["Error"].length===0){t.sCurrentMessage="";T.setValue("");t.top=t.top+1;t.bMessageAdded=true;fnFetchDataForChat(t);if(P){P.setColor("#00679e");}}},error:function(){T.setValue(t.sCurrentMessage);},complete:function(){}});}
function sendChatMessage(m,t,T,i){var u=oSapSplUtils.getUUID(),p=null;var h={},o={};h["UUID"]=u;h["TemplateUUID"]="";h["Priority"]="1";h["OwnerID"]=oSapSplUtils.getCompanyDetails()["BasicInfo_CompanyID"];h["SenderID"]=oSapSplUtils.getCompanyDetails()["BasicInfo_CompanyID"];h["Validity.StartTime"]=null;h["Validity.EndTime"]=null;h["AuditTrail.CreatedBy"]=null;h["AuditTrail.ChangedBy"]=null;h["AuditTrail.CreationTime"]=null;h["AuditTrail.ChangeTime"]=null;h["ThreadUUID"]=t.oChatBoxConfigData["ThreadUUID"];h["Type"]=t.oChatBoxConfigData["MessageType"];o["UUID"]=u;o["ShortText"]=m;o["LongText"]=m;var r="BusinessPartner";var s=[];var O={};O["RecipientUUID"]=t.oChatBoxConfigData["SenderID"];O["UUID"]=oSapSplUtils.getUUID();O["ParentUUID"]=u;O["RecipientType"]=r;O["isRead"]="0";s.push(O);if(i){p=i;}fnMakeAjaxCall({Header:[h],Recipient:s,Text:[o],Object:"MessageOccurrence"},t,T,p);}
function fnHandleClickOfPostMessageButton(e){sendChatMessage(this.sCurrentMessage,this,this.oChatBoxInputField,e.getSource());}
function fnHandleChatBoxInputFieldLiveChange(e){var l=e.getParameters().newValue;if(l!==""&&this.sCurrentMessage!==""&&l.substr(this.sCurrentMessage.length,l.length)==="\n"){sendChatMessage(this.sCurrentMessage,this,e.getSource());}else{this.sCurrentMessage=e.getParameters().newValue;}}
splReusable.libs.SapSplChatBoxControl=function(c){var t=this;this.oChatBoxConfigData=c;this.oChatBoxHeader=new sap.m.Toolbar({content:[new sap.m.Label({text:c["SenderName"]}).addStyleClass("sapSplChatBoxHeaderTitle")]}).addStyleClass("headerBorder").addStyleClass("chatBoxHeaderBar");this.oChatBoxList=new sap.m.List({showNoData:false,inset:false,width:"100%",select:fnHandleSelectionOfChatItem,mode:"None"}).addStyleClass("sapSplChatBoxList");this.oChatBoxList.bindAggregation("items","/",function(i,b){var d=null;if(b.getProperty("MessageDirection")==="S"){d=getChatBoxListItem("right",t);}else{d=getChatBoxListItem("left",t);}return d;});this.oChatBoxModel=new sap.ui.model.json.JSONModel();this.oChatBoxModel.setSizeLimit(400);this.oChatBoxList.setModel(this.oChatBoxModel);this.oChatBoxList.getBinding("items").sort(new sap.ui.model.Sorter("ReportedTime",false));function p(l){t.oMapObject={};l.iTotalHeight=undefined;for(var i=0;i<l.getItems().length;i++){var L=l.getItems()[i],I=l.getItems().length-l.indexOfItem(L),b=$("#"+L.sId).height();if(l.iTotalHeight===undefined){t.oMapObject[b]=I;l.iTotalHeight=b;}else{t.oMapObject[l.iTotalHeight+b]=I;l.iTotalHeight+=b;}}}function g(o,v){var k=Object.keys(o);var _=-1;for(var i=0;i<k.length;i++){if(v>=k[i]){_=o[k[i]];}}return _;}function a(M){if(M==="Collapse"){t.oChatBoxConfigData["chatBoxConsoleApp"].getParent().removeStyleClass("sapSplChatBoxConsole").addStyleClass("sapSplChatBoxConsoleClosed");t.oChatBoxConfigData["chatBoxConsoleApp"].getParent().getParent().removeStyleClass("sapSplChatBoxConsoleParent").addStyleClass("sapSplChatBoxConsoleParentClosed");$("#chatBoxConsoleContainerDiv").css("right","40.5em");}else{t.oChatBoxConfigData["chatBoxConsoleApp"].getParent().removeStyleClass("sapSplChatBoxConsoleClosed").addStyleClass("sapSplChatBoxConsole");t.oChatBoxConfigData["chatBoxConsoleApp"].getParent().getParent().removeStyleClass("sapSplChatBoxConsoleParentClosed").addStyleClass("sapSplChatBoxConsoleParent");$("#chatBoxConsoleContainerDiv").css("right","50.5em");}}this.oChatBoxList.addEventDelegate({onAfterRendering:function(e){var l=e.srcControl.getItems();if(l.length>0){bChatListRendered=true;p(e.srcControl);t.bMessageAdded=false;if(l[l.length-t.focusPoint]){if(sap.ui.Device.browser.name==="ie"){l[l.length-t.focusPoint].focus();}else{l[l.length-t.focusPoint].focus();}$(t.oChatBoxInputField)[0].focus();}else{l[l.length-1].focus();}}}});this.focusPoint=1;this.top=SapSplEnums.ChatBoxFetchThreshHold;this.bMessageAdded=false;this.oMapObject={};fnFetchDataForChat(this);this.oChatBoxInputField=new sap.m.TextArea({width:"100%",rows:2,placeholder:oSapSplUtils.getBundle().getText("CHAT_BOX_INPUT_PLACEHOLDER"),wrapping:"Soft",liveChange:jQuery.proxy(fnHandleChatBoxInputFieldLiveChange,t)}).addStyleClass("sapSplChatBoxInput").addEventDelegate({onAfterRendering:function(){setTimeout(function(){$(t.oChatBoxInputField)[0].focus();},1000);}});this.oListOfChatBoxes=null;this.sCurrentMessage="";this.oChatBoxLayout=new sap.m.Page({customHeader:this.oChatBoxHeader.addStyleClass("sapSplChatBoxHeaderLayout"),enableScrolling:false}).addEventDelegate({onAfterShow:function(e){setTimeout(function(){$(".sapSplChatBoxInputLayout textArea").css("height","3.65em");},500);if(sap.ui.Device.browser.name==="ff"){t.oChatBoxInputField.rerender();}var l=e.to.getContent()[0].getContent()[0].getItems();if(l.length>0){p(e.to.getContent()[0].getContent()[0]);t.bMessageAdded=false;if(l[l.length-t.focusPoint]){l[l.length-t.focusPoint].focus();}}t.bAfterShow=true;}}).addContent(new sap.m.Page({showHeader:false}).addStyleClass("sapSplChatBoxInnerPage").addEventDelegate({onAfterRendering:function(e){setTimeout(function(){$(".sapSplChatBoxInputLayout textArea").css("height","3.65em");},500);$("#"+e.srcControl.sId+" section").scroll(function(){var s=$(this).scrollTop();if(bMessageReceived==true&&t.bMessageAdded===false){if(bChatListRendered===true){if(sap.ui.Device.browser.name==="ie"&&s===0&&t.bAfterShow===true){t.bAfterShow=false;var l=t.oChatBoxList.getItems();setTimeout(function(){if(l[l.length-t.focusPoint]){l[l.length-t.focusPoint].focus();}},1000);}else{if(t.bMessageAdded!==undefined&&t.bMessageAdded===false){t.bMessageAdded=false;t.focusPoint=g(t.oMapObject,s+$(this).height()-10);}if(s===0&&t.bMessageAdded!==undefined&&t.bMessageAdded===false){t.top=t.top+SapSplEnums.ChatBoxFetchThreshHold;t.oMapObject={};fnFetchDataForChat(t);}}bChatListRendered=false;bMessageReceived=false;}}else if(bMessageReceived===false&&bChatListRendered===true){if(sap.ui.Device.browser.name==="ie"&&s===0&&t.bAfterShow===true){t.bAfterShow=false;var l=t.oChatBoxList.getItems();if(l[l.length-t.focusPoint]){l[l.length-t.focusPoint].focus();}}else{if(t.bMessageAdded!==undefined&&t.bMessageAdded===false){t.bMessageAdded=false;t.focusPoint=g(t.oMapObject,s+$(this).height()-10);}if(s===0&&t.bMessageAdded!==undefined&&t.bMessageAdded===false){t.top=t.top+SapSplEnums.ChatBoxFetchThreshHold;t.oMapObject={};fnFetchDataForChat(t);}}bChatListRendered=false;}else if(bMessageReceived===false&&bChatListRendered===false){if(sap.ui.Device.browser.name==="ie"&&s===0&&t.bAfterShow===true){t.bAfterShow=false;var l=t.oChatBoxList.getItems();if(l[l.length-t.focusPoint]){l[l.length-t.focusPoint].focus();}}else{if(t.bMessageAdded!==undefined&&t.bMessageAdded===false){t.bMessageAdded=false;t.focusPoint=g(t.oMapObject,s+$(this).height()-10);}if(s===0&&t.bMessageAdded!==undefined&&t.bMessageAdded===false){t.top=t.top+SapSplEnums.ChatBoxFetchThreshHold;t.oMapObject={};fnFetchDataForChat(t);}}}});}}).addContent(this.oChatBoxList.addStyleClass("sapSplChatBoxList"))).addStyleClass("sapSplChatBoxLayout").addContent(new sap.ui.layout.VerticalLayout().addContent(this.oChatBoxInputField).addContent(new sap.m.Bar({design:"Header",contentRight:[new sap.m.Button({type:"Emphasized",text:oSapSplUtils.getBundle().getText("SUBMIT"),press:jQuery.proxy(fnHandleClickOfPostMessageButton,this)}).addStyleClass("sapSplChatSubmitButton")]}).addStyleClass("sapSplChatBoxSubmitButtonLayout")).addStyleClass("sapSplChatBoxInputLayout"));this.oChatBoxLayout.setListOfChatBoxes=function(l){t.oListOfChatBoxes=l;};this.oChatBoxLayout.closeChatBox=function(){clearInterval(t.oInterval);var m=sap.ui.getCore().getModel("sapSplChatBoxConsoleLeftListModel").getData();for(var i=0;i<m.length;i++){if(m[i]["ThreadUUID"]===t.oChatBoxConfigData["ThreadUUID"]){m.splice(i,1);break;}}t.oChatBoxConfigData["headerLabel"].setText(oSapSplUtils.getBundle().getText("CHATBOX_CONSOLE_HEADER_LABEL",m.length.toString()));sap.ui.getCore().getModel("sapSplChatBoxConsoleLeftListModel").setData(m);if(m.length===1){a("Collapse");}else if(m.length===0){$(".sapSplChatBoxConsoleParent").hide("slow");$(".sapSplChatBoxConsoleParentClosed").hide("slow");}};this.oChatBoxLayout.startPolling=function(){startPollingOfChatBox(t);};this.oChatBoxLayout.setListItemInstance=function(i){t.oChatBoxConsoleLeftListItemInstance=i;};this.oChatBoxLayout.getListItemInstance=function(){if(t.oChatBoxConsoleLeftListItemInstance){return t.oChatBoxConsoleLeftListItemInstance;}else{return null;}};this.oChatBoxLayout.stopPolling=function(){clearInterval(t.oInterval);};this.oChatBoxLayout.rerenderTextAreaInstance=function(){$(t.oChatBoxInputField)[0].focus();};this.oChatBoxLayout.focusOnLastItem=function(){t.focusPoint=1;var l=t.oChatBoxList.getItems();if(l[l.length-t.focusPoint]){l[l.length-t.focusPoint].focus();}};startPollingOfChatBox(this);this.oChatBoxConfigData["chatBoxConsoleApp"].addPage(this.oChatBoxLayout);var m=sap.ui.getCore().getModel("sapSplChatBoxConsoleLeftListModel").getData();m.push(c);sap.ui.getCore().getModel("sapSplChatBoxConsoleLeftListModel").setData(m);if($(".sapSplChatBoxConsoleParentClosed").css("display")==="none"||$(".sapSplChatBoxConsoleParent").css("display")==="none"){$(".sapSplChatBoxConsoleParent").show("slow");$(".sapSplChatBoxConsoleParentClosed").show("slow");$("#chatBoxConsoleContainerDiv").css("right","40.5em");}if(m.length>1){a("Expand");}if(this.oChatBoxConfigData["canReplyToChat"]&&this.oChatBoxConfigData["canReplyToChat"]==="0"){this.oChatBoxInputField.getParent().setEnabled(false);this.oChatBoxInputField.setPlaceholder(oSapSplUtils.getBundle().getText("SEND_MESSAGE_DISABLED_PLACEHOLDER_TOOLTIP"));this.oChatBoxInputField.getParent().getContent()[1].getContentRight()[0].setTooltip(oSapSplUtils.getBundle().getText("SEND_MESSAGE_DISABLED_PLACEHOLDER_TOOLTIP"));}this.oChatBoxConfigData["headerLabel"].setText(oSapSplUtils.getBundle().getText("CHATBOX_CONSOLE_HEADER_LABEL",m.length));return this.oChatBoxLayout;};
splReusable.libs.SapSplChatBoxControl.prototype.refreshLiveFeedModel=function(){};
