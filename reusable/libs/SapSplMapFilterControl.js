/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
jQuery.sap.declare("splReusable.libs.SapSplMapFilterControl");jQuery.sap.require("splReusable.exceptions.MissingParametersException");jQuery.sap.require("splReusable.exceptions.InvalidArrayException");jQuery.sap.require("splReusable.libs.SapSplEnums");splReusable.libs.SapSplStyleSheetLoader.loadStyle("./resources/styles/sapSplMapFilter");
splReusable.libs.SapSplMapFilterControl=function(a){this.appliedFilters=[];this.showList=true;this.headerTitle=oSapSplUtils.getBundle().getText("MAP_FILTER_VISIBILITY_TITLE");this.headerLabelTitle=oSapSplUtils.getBundle().getText("MAP_FILTER_LABEL_TITLE");this.width="20rem";this.headerIcon="sap-icon://show";this.headerLabelIcon="sap-icon://blank-tag";this.oVBMapInstance=null;this.sPSURL=null;this.isRefresh=false;if(a.constructor===Object){if(!this.oMapFilterODataModel){this.oMapFilterODataModel=new sap.ui.model.odata.ODataModel(oSapSplUtils.getFQServiceUrl("/sap/spl/xs/app/services/appl.xsodata/"));}if(a["headerTitle"]){this.headerTitle=a["headerTitle"];}if(a["headerLabelTitle"]){this.headerLabelTitle=a["headerLabelTitle"];}if(a["showList"]&&a["showList"].constructor===Boolean){this.showList=a["showList"];}if(a["width"]&&a["width"].constructor===String){this.width=a["width"];}if(a["headerIcon"]&&a["headerIcon"].constructor===String){this.headerIcon=a["headerIcon"];}if(a["headerLabelIcon"]){this.headerIcon=a["headerLabelIcon"];}if(a["mapInstance"]&&a["mapInstance"].constructor===sap.ui.vbm.VBI){this.oVBMapInstance=a["mapInstance"];}}};
function fnSuccessOfGeoFenceRead(d,a,r){oSapSplBusyDialog.getBusyDialogInstance().close();if(!r){r=this;}var v=[],i;if(r.oVBMapInstance&&!r.oVBMapInstance.getParent().getParent().getParent().getParent().getParent().getParent().getParent().getController().selectedItems){r.oVBMapInstance.getParent().getParent().getParent().getParent().getParent().getParent().getParent().getController().selectedItems={};}if(r.oVBMapInstance.getParent().getParent().getParent().getParent().getParent().getParent().getParent().getController().newCreatedVisualObject){r.entity="";}for(i=0;i<d.results.length;i++){d.results[i].isSelected=false;if(r.oVBMapInstance.getParent().getParent().getParent().getParent().getParent().getParent().getParent().getController().newCreatedVisualObject){if(r.oVBMapInstance.getParent().getParent().getParent().getParent().getParent().getParent().getParent().getController().newCreatedVisualObject===d.results[i].LocationID){d.results[i].isSelected=true;r.oVBMapInstance.getParent().getParent().getParent().getParent().getParent().getParent().getParent().getController().newCreatedVisualObject=null;}else if(r.oVBMapInstance.getParent().getParent().getParent().getParent().getParent().getParent().getParent().getController().selectedItems[d.results[i].LocationID]){d.results[i].isSelected=true;}}else{if(d.results[i].Tag===r.entity){if(r.entityTypes==="B"){d.results[i].isSelected=r.entitySelected;}else{if(r.entityTypes==="O"&&d.results[i].isPublic==="0"){d.results[i].isSelected=r.entitySelected;}else if(r.entityTypes==="T"&&d.results[i].isPublic==="1"){d.results[i].isSelected=r.entitySelected;}else if(r.oVBMapInstance.getParent().getParent().getParent().getParent().getParent().getParent().getParent().getController().selectedItems){if(r.oVBMapInstance.getParent().getParent().getParent().getParent().getParent().getParent().getParent().getController().selectedItems[d.results[i].LocationID]){d.results[i].isSelected=true;}}}}else if(r.oVBMapInstance.getParent().getParent().getParent().getParent().getParent().getParent().getParent().getController().selectedItems){if(r.oVBMapInstance.getParent().getParent().getParent().getParent().getParent().getParent().getParent().getController().selectedItems[d.results[i].LocationID]){d.results[i].isSelected=true;}}}if(d.results[i].isSelected){if(d.results[i].Geometry){v.push(d.results[i]);}r.oVBMapInstance.getParent().getParent().getParent().getParent().getParent().getParent().getParent().getController().selectedItems[d.results[i].LocationID]=true;}else{r.oVBMapInstance.getParent().getParent().getParent().getParent().getParent().getParent().getParent().getController().selectedItems[d.results[i].LocationID]=false;}}d=r.oVBMapInstance.getParent().getParent().getParent().getParent().getParent().getParent().getParent().getController().fnToAddSIsSharedFieldToLeftPanelModel(d);if(this.isRefresh||r.entitySelected){sap.ui.getCore().getModel("SapSplLeftPanelListModel").setSizeLimit(d.results.length+1);sap.ui.getCore().getModel("SapSplLeftPanelListModel").setData(d.results);this.isRefresh=false;}else{var m=sap.ui.getCore().getModel("SapSplLeftPanelListModel").getData();for(i=0;i<m.length;i++){if(m[i].Tag===r.entity){if(r.entityTypes==="B"){m[i].isSelected=false;r.oVBMapInstance.getParent().getParent().getParent().getParent().getParent().getParent().getParent().getController().selectedItems[m[i].LocationID]=false;}else{if(r.entityTypes==="O"&&m[i].isPublic==="0"){m[i].isSelected=false;r.oVBMapInstance.getParent().getParent().getParent().getParent().getParent().getParent().getParent().getController().selectedItems[m[i].LocationID]=false;}else if(r.entityTypes==="T"&&m[i].isPublic==="1"){m[i].isSelected=false;r.oVBMapInstance.getParent().getParent().getParent().getParent().getParent().getParent().getParent().getController().selectedItems[m[i].LocationID]=false;}}}}sap.ui.getCore().getModel("SapSplLeftPanelListModel").setSizeLimit(m.length+1);sap.ui.getCore().getModel("SapSplLeftPanelListModel").setData(m);}r.entity="";oSapSplMapsDataMarshal.fnShowVOsOnMap(v,r.oVBMapInstance);if(r.fnCallback){r.fnCallback(v);}r.oVBMapInstance.getParent().getParent().getParent().getParent().getParent().getParent().getParent().getController().byId("SapSplLeftPanelBusyIndicatorLayout").removeStyleClass("SapSplLeftPanelBlocker");r.oVBMapInstance.getParent().getParent().getParent().getParent().getParent().getParent().getParent().getController().byId("SapSplLeftPanelBusyIndicatorLayout").addStyleClass("SapSplLeftPanelBlockerHide");}
function fnFailureOfGeoFenceRead(){}
function readForGeoFences(f,t){if(f.constructor===Array){t.appliedFilters=f;if(f.length===0){fnSuccessOfGeoFenceRead({results:[]},{},t);oSapSplMapsDataMarshal.fnClearMap(t.oVBMapInstance);if(t.fnCallback){t.fnCallback();}}else{oSapSplBusyDialog.getBusyDialogInstance({title:oSapSplUtils.getBundle().getText("BUSY_DIALOG_MESSAGE")}).open();t.oMapFilterODataModel.read("MyLocations",null,null,false,jQuery.proxy(fnSuccessOfGeoFenceRead,t),jQuery.proxy(fnFailureOfGeoFenceRead,t));}}else if(f.constructor===String&&f==="refresh"){if(t.appliedFilters.length===0){oSapSplMapsDataMarshal.fnClearMap(t.oVBMapInstance);}else{oSapSplBusyDialog.getBusyDialogInstance({title:oSapSplUtils.getBundle().getText("BUSY_DIALOG_MESSAGE")}).open();t.oMapFilterODataModel.read("MyLocations",null,null,false,jQuery.proxy(fnSuccessOfGeoFenceRead,t),jQuery.proxy(fnFailureOfGeoFenceRead,t));}}else{oSapSplBusyDialog.getBusyDialogInstance({title:oSapSplUtils.getBundle().getText("BUSY_DIALOG_MESSAGE")}).open();t.oMapFilterODataModel.read("MyLocations",null,null,false,jQuery.proxy(fnSuccessOfGeoFenceRead,t),jQuery.proxy(fnFailureOfGeoFenceRead,t));}}
function getFilterText(i){var f={"thirdParty":"isPublic eq '1'","myOrg":"isPublic eq '0'"};return f[i];}
function startStopPollingOfParkingSpace(m,t){if(m==="start"){if(!t.oFilterLayout.oPSInterval){t.oFilterLayout.oPSInterval=window.setInterval(function(){startStopPollingOfParkingSpace("start",t);},30000);}if(t.sPSURL){t.oMapFilterODataModel.read("MyLocations",null,null,true,jQuery.proxy(function(d){var v=[];for(var i=0;i<d.results.length;i++){d.results[i].isSelected=false;if(t.oVBMapInstance.getParent().getParent().getParent().getParent().getParent().getParent().getParent().getController().selectedItems[d.results[i].LocationID]){d.results[i].isSelected=true;v.push(d.results[i]);}}sap.ui.getCore().getModel("SapSplLeftPanelListModel").setSizeLimit(d.results.length+1);sap.ui.getCore().getModel("SapSplLeftPanelListModel").setData(d.results);oSapSplMapsDataMarshal.fnShowVOsOnMap(v,t.oVBMapInstance);if(t.fnCallback){t.fnCallback();}},t),jQuery.proxy(function(){jQuery.sap.log.error("startStopPollingOfParkingSpace","read for parking space failed","SapSplMapFilterControl.js");},t));}}else{window.clearInterval(t.oFilterLayout.oPSInterval);t.oFilterLayout.oPSInterval=null;}}
function getFilterUrl(e,t){var s={};var I=e.getSource().getParent().getParent().getParent().getItems();if(I.constructor===Array){for(var j=0;j<I.length;j++){var k=I[j].getBindingContext().getProperty("Value");var S=[];var a=I[j].getCells()[0].getContentRight();if(a.constructor===Array){for(var i=0;i<a.length;i++){if(a[i].hasStyleClass("opacityHigh")){S.push(a[i].getCustomData()[0].getValue().id.split("-")[0]);}}}s[k]=S;}}var U="$expand=GeofenceGates&$filter=";$.each(s,function(b,v){if(v.length>0){var L="((Tag eq "+"'"+b+"') and (";var c=[];for(var i=0;i<v.length;i++){c.push(getFilterText(v[i]));}for(var j=0;j<c.length;j++){L=L+c[j];if(j!==c.length-1){L=L+" or ";}else{L=L+")) or";}}U=U+L;if(b==="LC0002"){t.sPSURL="$filter=(Tag eq 'LC0002') and ("+L.split(") or")[0].split("and ")[1]+")";}}});if(U.search("LC0002")>-1){startStopPollingOfParkingSpace("start",t);}else{startStopPollingOfParkingSpace("stop",t);}if(U.indexOf("or",U.length-3)!==-1){U=U.substring(0,U.length-2);}if(U==="$expand=GeofenceGates&$filter="){readForGeoFences([],t);}else{readForGeoFences([U],t);}}
function fnOnRowSelectButtonClickOfLabel(e){var s=e.getSource();var S=e.getSource().getParent();var c=S.getContentRight();var h="";if(s&&s.constructor===sap.m.Button&&S&&S.constructor===sap.m.Bar&&c&&c.constructor===Array){if(s.hasStyleClass("opacityLow")){s.removeStyleClass("opacityLow");s.addStyleClass("opacityHigh");S.removeStyleClass("whiteBackground");S.addStyleClass("itemSelectedBackground");h="Show";}else{s.removeStyleClass("opacityHigh");s.addStyleClass("opacityLow");S.addStyleClass("whiteBackground");S.removeStyleClass("itemSelectedBackground");h="Hide";}var o={};o[e.getSource().getBindingContext().getObject().ID]=!s.hasStyleClass("opacityLow");this.oVBMapInstance.getParent().getParent().getParent().getParent().getParent().getParent().getParent().getController().fnLabelToggleControlToMapInterface(o);oSapSplMapsDataMarshal.fnHandleDetailWindowVisibility(h,e.getSource().getBindingContext().getObject().ID);}}
function handleClickOfObjectInMapFilter(t,c,a,T){var h;var l=a.oFilterLayout.getContent()[1].getItems(),s=null,S=null;for(var i=0;i<l.length;i++){if(l[i].getBindingContext().getObject()["ID"]===t){s=l[i].getCells()[0].getContentLeft()[0];S=l[i].getCells()[0];s.removeStyleClass("opacityLow");s.removeStyleClass("opacityHigh");if(c){s.addStyleClass("opacityLow");s.setEnabled(true);}else{s.addStyleClass("opacityHigh");s.setEnabled(false);}if(s.hasStyleClass("opacityLow")){s.removeStyleClass("opacityLow");s.addStyleClass("opacityHigh");S.removeStyleClass("whiteBackground");S.addStyleClass("itemSelectedBackground");h="Hide";}else{s.removeStyleClass("opacityHigh");s.addStyleClass("opacityLow");S.addStyleClass("whiteBackground");S.removeStyleClass("itemSelectedBackground");h="Show";}var o={};o[t]=!s.hasStyleClass("opacityLow");if(T&&T===true){o[t]=s.hasStyleClass("opacityLow");if(h==="Show"){h="Hide";}else{h="Show";}}a.oVBMapInstance.getParent().getParent().getParent().getParent().getParent().getParent().getParent().getController().fnLabelToggleControlToMapInterface(o);oSapSplMapsDataMarshal.fnHandleDetailWindowVisibility(h,t);}}}
function fnOnRowSelectButtonClick(e){var s=e.getSource();var S=e.getSource().getParent();var c=S.getContentRight();var t=this;this.oVBMapInstance.getParent().getParent().getParent().getParent().getParent().getParent().getParent().getController().byId("SapSplLeftPanelBusyIndicatorLayout").removeStyleClass("SapSplLeftPanelBlockerHide");this.oVBMapInstance.getParent().getParent().getParent().getParent().getParent().getParent().getParent().getController().byId("SapSplLeftPanelBusyIndicatorLayout").addStyleClass("SapSplLeftPanelBlocker");this.entity=e.getSource().getBindingContext().getProperty().Value;this.entityTypes="B";if(s.hasStyleClass("opacityLow")){this.entitySelected=true;}else{this.entitySelected=false;}if(s&&s.constructor===sap.m.Button&&S&&S.constructor===sap.m.Bar&&c&&c.constructor===Array){if(s.hasStyleClass("opacityLow")){s.removeStyleClass("opacityLow");s.addStyleClass("opacityHigh");for(var i=0;i<c.length;i++){c[i].removeStyleClass("opacityLow");c[i].addStyleClass("opacityHigh");}S.removeStyleClass("whiteBackground");S.addStyleClass("itemSelectedBackground");if(S.getBindingContext().getObject()["Value"]==="LC0004"){if(S.hasStyleClass("itemSelectedBackground")){handleClickOfObjectInMapFilter("Geofence",true,t);}else{handleClickOfObjectInMapFilter("Geofence",false,t,true);}}getFilterUrl(e,t);}else{s.removeStyleClass("opacityHigh");s.addStyleClass("opacityLow");for(var j=0;j<c.length;j++){c[j].removeStyleClass("opacityHigh");c[j].addStyleClass("opacityLow");}S.addStyleClass("whiteBackground");S.removeStyleClass("itemSelectedBackground");if(S.getBindingContext().getObject()["Value"]==="LC0004"){if(S.hasStyleClass("itemSelectedBackground")){handleClickOfObjectInMapFilter("Geofence",true,t);}else{handleClickOfObjectInMapFilter("Geofence",false,t,true);}}getFilterUrl(e,t);}}}
function fnOnSecondaryFilterClicked(e){var t=this;var s=null,S=null,o=null,a=true;s=e.getSource();S=e.getSource().getParent();o=S.getContentRight();this.oVBMapInstance.getParent().getParent().getParent().getParent().getParent().getParent().getParent().getController().byId("SapSplLeftPanelBusyIndicatorLayout").removeStyleClass("SapSplLeftPanelBlockerHide");this.oVBMapInstance.getParent().getParent().getParent().getParent().getParent().getParent().getParent().getController().byId("SapSplLeftPanelBusyIndicatorLayout").addStyleClass("SapSplLeftPanelBloker");this.entity=e.getSource().getCustomData()[0].getBindingContext().getProperty().Value;if(e.getSource().getCustomData()[0].getValue().id==="myOrg"){this.entityTypes="O";}else{this.entityTypes="T";}if(s.hasStyleClass("opacityLow")){this.entitySelected=true;}else{this.entitySelected=false;}if(s&&s.constructor===sap.m.Button&&S&&S.constructor===sap.m.Bar){if(s.hasStyleClass("opacityLow")){s.removeStyleClass("opacityLow");s.addStyleClass("opacityHigh");S.getContentLeft()[0].removeStyleClass("opacityLow");S.getContentLeft()[0].addStyleClass("opacityHigh");S.removeStyleClass("whiteBackground");S.addStyleClass("itemSelectedBackground");}else if(s.hasStyleClass("opacityHigh")){s.removeStyleClass("opacityHigh");s.addStyleClass("opacityLow");}for(var i=0;i<o.length;i++){if(!o[i].hasStyleClass("opacityLow")){a=false;}}if(a){S.removeStyleClass("itemSelectedBackground");S.addStyleClass("whiteBackground");S.getContentLeft()[0].removeStyleClass("opacityHigh");S.getContentLeft()[0].addStyleClass("opacityLow");}getFilterUrl(e,t);if(S.getBindingContext().getObject()["Value"]==="LC0004"){if(S.hasStyleClass("itemSelectedBackground")){handleClickOfObjectInMapFilter("Geofence",true,t);}else{handleClickOfObjectInMapFilter("Geofence",false,t,true);}}}}
splReusable.libs.SapSplMapFilterControl.prototype.setCallback=function(c){this.fnCallback=c;};
splReusable.libs.SapSplMapFilterControl.prototype.refreshMap=function(f){this.isRefresh=true;if(f){readForGeoFences(f,this);}else{readForGeoFences("refresh",this);}};
splReusable.libs.SapSplMapFilterControl.prototype.getFilter=function(){var t=this;var m=new sap.m.Table({width:t.width,rowHeight:1,mode:"SingleSelectMaster",headerToolbar:new sap.m.Toolbar({content:new sap.m.Bar({contentLeft:[new sap.m.Button({icon:t.headerIcon,enabled:false,press:function(){jQuery(".filterTable").hide();}}),new sap.m.Label({text:t.headerTitle,design:"Bold"})]}).addStyleClass("headerToolbar")}).addStyleClass("shadow"),columns:{template:new sap.m.Column()},items:{path:"/results",template:new sap.m.ColumnListItem({cells:[new sap.m.Bar({contentLeft:[new sap.m.Button({icon:"sap-icon://accept",press:jQuery.proxy(fnOnRowSelectButtonClick,t)}).addStyleClass("opacityLow"),new sap.m.Text({text:"{Value.description}"}).addStyleClass("geoFenceText")],contentMiddle:[],contentRight:[new sap.m.Button({type:"Transparent",icon:"sap-icon://collaborate",tooltip:oSapSplUtils.getBundle().getText("PRIVATE_VISIBILITY"),press:jQuery.proxy(fnOnSecondaryFilterClicked,t)}).addStyleClass("opacityLow").addCustomData(new sap.ui.core.CustomData({key:"ID",value:{id:"myOrg"}})),new sap.m.Button({type:"Transparent",icon:"sap-icon://family-care",tooltip:oSapSplUtils.getBundle().getText("PUBLIC_VISIBILITY"),press:jQuery.proxy(fnOnSecondaryFilterClicked,t)}).addStyleClass("opacityLow").addCustomData(new sap.ui.core.CustomData({key:"ID",value:{id:"thirdParty"}}))]}).addStyleClass("whiteBackground")]})}}).addStyleClass("filterTable");var l=new sap.m.Table({width:t.width,rowHeight:1,mode:"SingleSelectMaster",headerToolbar:new sap.m.Toolbar({content:new sap.m.Bar({contentLeft:[new sap.m.Button({icon:t.headerLabelIcon,enabled:false}),new sap.m.Label({text:t.headerLabelTitle,design:"Bold"})]}).addStyleClass("headerToolbar")}).addStyleClass("shadow"),columns:{template:new sap.m.Column()}}).addStyleClass("filterTable");l.setVisible(splReusable.libs.SapSplModelFormatters.sapSplGetVisibilityBasedOnSubscriptionModel(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["isTrucksLabelVisible"]));l.bindAggregation("items","/labelResults",function(i,o){var s="",S="";if(o.getObject()["checked"]&&o.getObject()["checked"]===true){s="opacityHigh";S="itemSelectedBackground";}else{s="opacityLow";S="whiteBackground";}return new sap.m.ColumnListItem({visible:"{visible}",cells:[new sap.m.Bar({contentLeft:[new sap.m.Button({enabled:"{enabled}",icon:"sap-icon://accept",press:jQuery.proxy(fnOnRowSelectButtonClickOfLabel,t)}).addStyleClass(s),new sap.m.Text({text:"{value}"}).addStyleClass("geoFenceText")],contentMiddle:[]}).addStyleClass(S)]});});m.addEventDelegate({onAfterRendering:function(){}});this.oFilterLayout=new sap.ui.layout.VerticalLayout().addContent(m).addContent(l).addStyleClass("sapSplMapFilterControlVerticalLayout");this.oFilterLayout.getMapFilterControlInstance=function(){return t;};return this.oFilterLayout;};
