/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
jQuery.sap.require("splReusable.exceptions.MissingParametersException");jQuery.sap.require("splReusable.exceptions.InvalidArrayException");jQuery.sap.require("splReusable.libs.SapSplModelFormatters");jQuery.sap.require("splReusable.libs.SapSplEnums");splReusable.libs.SapSplStyleSheetLoader.loadStyle("./resources/styles/SapSplCustomSearchControl");jQuery.sap.declare("splReusable.libs.SapSplCustomSearchControl");
function fnHandleOnAfterRenderingOfTheExpandedSearchList(){var l=$(window).height()-$(".sapUiUfdShellHead").height()+$(".sapSplExpandedSearchListHeader").height()-(2*$(".sapMFooter-CTX").height())-$(".sapSplFeedListToolbar").height();$(".sapSplExpandedSearchListContainer").css("height",l+"px");}
function fnHandleListItemClick(e){var c=e.getParameters().listItem.getBindingContext().getObject();this.oParentControllerInstance.fnSearchToMapInterface("show",[c]);}
function getExpandedSearchList(t){t.oExpandedSearchListCloseButton=new sap.m.Button({icon:"sap-icon://sys-cancel",press:function(e){e.getSource().getParent().getParent().getParent().setVisible(false);e.getSource().getParent().getParent().removeSelections();}});t.oExpandedListHeaderLabel=new sap.m.Text();return new sap.ui.layout.VerticalLayout().addStyleClass("sapSplExpandedSearchListContainer").addContent(new sap.m.List({mode:"SingleSelectMaster",headerToolbar:new sap.m.Toolbar({content:[t.oExpandedListHeaderLabel,new sap.m.ToolbarSpacer(),t.oExpandedSearchListCloseButton],design:"Transparent"}).addStyleClass("sapSplExpandedSearchListHeader"),items:{path:"/",template:new sap.m.CustomListItem({content:[new sap.m.Toolbar({visible:true,content:[new sap.m.Label({text:"{ObjectInfo/Name}"}).addStyleClass("sapSplSearchListName"),new sap.m.ToolbarSpacer(),new sap.m.Label({text:{path:"ObjectInfo/ObjectType",formatter:function(v){if(v==="Location"){return oSapSplUtils.getBundle().getText("LOCATION");}else if(v==="TrackableObject"){return oSapSplUtils.getBundle().getText("TRUCK");}else if(v==="Message"){return oSapSplUtils.getBundle().getText("INCIDENTS_DETAIL_FORM_TITLE");}else{return"";}}}}).addStyleClass("sapSplSearchListType")]}).addStyleClass("sapSplSearchListItemTemplate")]})},select:jQuery.proxy(fnHandleListItemClick,t)}).setModel(t.oCustomSearchModel).addStyleClass("sapSplExpandedSearchList")).addEventDelegate({onAfterRendering:fnHandleOnAfterRenderingOfTheExpandedSearchList});}
function fnHandleSearch(e,t){var s=t.oSearchList.getModel().getData();if(e===null){t.oParentControllerInstance.fnSearchToMapInterface("show",s);}else{if(!t.oSearchList.getSelectedItem()){if(e.getParameter("query").length!==0){t.oParentControllerInstance.fnSearchToMapInterface("show",s);}}else{t.oSearchList.fireSelect({listItem:t.oSearchList.getSelectedItem()});}}}
function fnPrepareSearchPayload(s){var p={};p.UserID=oSapSplUtils.getLoggedOnUserDetails().userId;p.ObjectType=["Location","TrackableObject","Message"];p.AdditionalCriteria={FilterAssignedVehicles:true};p.AdditionalCriteria.MessageObjectType="M";p.AdditionalCriteria.MessageType="I";p.AdditionalCriteria.FilterUnsubscribedVehicles=true;p.SearchTerm=s;p.FuzzinessThershold=SapSplEnums.fuzzyThreshold;p.MaximumNumberOfRecords=SapSplEnums.numberOfRecords;p.ProvideDetails=false;p.SearchInNetwork=true;return p;}
function fnGetSearchResults(s,t){var p=fnPrepareSearchPayload(s);oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("/sap/spl/xs/app/services/Search.xsjs"),method:"POST",async:false,data:JSON.stringify(p),success:function(d,a,m){oSapSplBusyDialog.getBusyDialogInstance().close();if((d.constructor!==Object)&&(d.constructor!==Array)){d=JSON.parse(d);}if(m["status"]===200){if(d.length===0){t.oSearchListPopover.close();}t.oSearchResults=d;}else if(d["Error"]&&d["Error"].length>0){var e=oSapSplUtils.getErrorMessagesfromErrorPayload(d)["ufErrorObject"];sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getErrorMessagesfromErrorPayload(d)["errorWarningString"],details:e});}},error:function(e){oSapSplBusyDialog.getBusyDialogInstance().close();if(e&&e["status"]===500){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e["status"]+"\t"+e.statusText,details:e.responseText});}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getBundle().getText("INCORRECT_ARGUMENTS_ERROR_MESSAGE"),details:oSapSplUtils.getErrorMessagesfromErrorPayload(JSON.parse(e.responseText))["ufErrorObject"]});}}});}
function fnHandleLiveChange(e,t){var v="";t.oSearchResults=null;if(e.getParameter("query")){v=e.getParameter("query");}else{v=e.getParameter("newValue");}if(v.length===0){t.oSearchListPopover.close();t.oSearchList.getBinding("items").filter([]);t.oCustomSearchModel.setData([]);t.oParentControllerInstance.fnSearchToMapInterface("reset");t.oCustomSearchLayout.getContent()[1].setVisible(false);t.iCounter=0;}else{if(v.length>=3){if(t.iCounter===0){t.oParentControllerInstance.fnSearchToMapInterface("clear");}if(t.oSearchList.getItems().length>0){t.oSearchListPopover.openBy(t.oSearchField);}t.iCounter++;fnGetSearchResults(v,t);t.oCustomSearchModel.setData(t.oSearchResults);}}}
splReusable.libs.SapSplCustomSearchControl=function(c){var t=this;this.oParentControllerInstance=c["controllerInstance"].getParent().getParent().getController();this.iCounter=0;this.iSearchListThreshold=5;this.oSearchField=new sap.m.SearchField({showSearchButton:false,showMagnifier:false,liveChange:function(E){fnHandleLiveChange(E,t);},search:function(E){fnHandleSearch(E,t);},width:"20em"}).addStyleClass("oSearchField");this.oSearchField.attachBrowserEvent("click",function(){if(t.oSearchList.getItems().length>0){t.oSearchListPopover.openBy(t.oSearchField);}});this.oSearchField.addEventDelegate({onAfterRendering:function(E){E.srcControl.$().keyup(function(E){if(t.oSearchList.getItems().length>0){var s=null;if(t.oSearchList.getSelectedItem()){s=t.oSearchList.indexOfItem(t.oSearchList.getSelectedItem());}else{s=-1;}if(E.keyCode===40&&s<t.oSearchList.getItems().length-1){t.oSearchList.setSelectedItem(t.oSearchList.getItems()[s+1]);}else if(E.keyCode===38&&s>=0){if(s===0){t.oSearchList.removeSelections();}else{t.oSearchList.setSelectedItem(t.oSearchList.getItems()[s-1]);}}}});}});this.oSearchList=new sap.m.List({showNoData:false,select:jQuery.proxy(fnHandleListItemClick,t),rememberSelections:false,mode:"SingleSelectMaster",visible:true}).addStyleClass("oSearchList");this.oSearchList.bindAggregation("items","/",function(i,o){var I=parseInt(o.sPath.split("/").pop(),10);if(I<t.iSearchListThreshold){return new sap.m.CustomListItem({content:[new sap.m.Toolbar({visible:true,content:[new sap.m.Label({text:"{ObjectInfo/Name}"}).addStyleClass("sapSplSearchListName"),new sap.m.ToolbarSpacer(),new sap.m.Label({text:{path:"ObjectInfo/ObjectType",formatter:function(v){if(v==="Location"){return oSapSplUtils.getBundle().getText("LOCATION");}else if(v==="TrackableObject"){return oSapSplUtils.getBundle().getText("TRUCK");}else if(v==="Message"){return oSapSplUtils.getBundle().getText("INCIDENTS_DETAIL_FORM_TITLE");}else{return"";}}}}).addStyleClass("sapSplSearchListType")]}).addStyleClass("sapSplSearchListItemTemplate")]});}else{return new sap.m.ObjectListItem({visible:false,title:"{ObjectInfo/Name}",firstStatus:new sap.m.ObjectStatus({text:"{ObjectInfo/ObjectType}",state:"None"})});}});this.oSearchList.addEventDelegate({onAfterRendering:function(E){if(E.srcControl.getItems().length>t.iSearchListThreshold){t.oSearchListFooter.setVisible(true);oSapSplUtils.getBundle().getText("VIEW_ALL_SEARCH_ITEMS",[E.srcControl.getItems().length]);t.oSearchListFooterText.setText(oSapSplUtils.getBundle().getText("VIEW_ALL_SEARCH_ITEMS",[E.srcControl.getItems().length]));}else{t.oSearchListFooter.setVisible(false);}}});this.oSearchListFooterText=new sap.m.Text();this.oSearchListFooterShowAllButton=new sap.m.Button({icon:"sap-icon://map-2",tooltip:oSapSplUtils.getBundle().getText("VIEW_ALL_SEARCHED_LOCATIONS_ON_MAP_TOOLTIP"),press:function(){fnHandleSearch(null,t);}});this.oSearchListFooterShowAllAsListButton=new sap.m.Button({icon:"sap-icon://list",tooltip:oSapSplUtils.getBundle().getText("VIEW_ALL_SEARCHED_LOCATIONS_IN_LIST_TOOLTIP"),press:function(){t.oExpandedListHeaderLabel.setText(oSapSplUtils.getBundle().getText("EXPANDED_SEARCH_LIST_HEADER_TEXT",[t.oSearchList.getItems().length,t.oSearchField.getValue()]));t.oCustomSearchLayout.getContent()[1].setVisible(true);}});this.oSearchListFooter=new sap.m.Toolbar({design:"Transparent",content:[this.oSearchListFooterText,new sap.m.ToolbarSpacer(),this.oSearchListFooterShowAllButton,this.oSearchListFooterShowAllAsListButton]}).setVisible(false);this.oCustomSearchModel=new sap.ui.model.json.JSONModel();this.oSearchList.setModel(this.oCustomSearchModel);var e=new sap.m.Button({icon:"sap-icon://search",tooltip:oSapSplUtils.getBundle().getText("SEARCH"),press:function(){t.oSearchFieldLayout.fnExpandCollapseSearchField("Expand");}});this.oSearchFieldLayout=new sap.ui.layout.HorizontalLayout().addContent(this.oSearchField).addContent(e);this.oCustomSearchLayout=new sap.ui.layout.VerticalLayout().addStyleClass("sapSplCustomSearchControlLayout");this.oCustomSearchLayout.addContent(this.oSearchFieldLayout).addContent(getExpandedSearchList(this).setVisible(false));this.oSearchListPopover=new sap.m.Popover({showHeader:false,placement:"Bottom",content:new sap.ui.layout.VerticalLayout().addContent(this.oSearchList),modal:false,footer:this.oSearchListFooter,offsetX:13,offsetY:-10}).addStyleClass("oSearchListPopover");this.oSearchListPopover.attachAfterOpen(function(){jQuery("#"+t.oSearchField.sId+" ."+"sapMSFI").css("z-index","100");jQuery("#"+t.oSearchField.sId+" ."+"sapMSFI").focus();});this.oSearchFieldLayout.fnExpandCollapseSearchField=function(m){var s=t.oSearchFieldLayout.getContent()[0];var C=t.oSearchFieldLayout.getContent()[1];if(m==="Collapse"){s.setVisible(false);C.setVisible(true);c["trafficStatusTitleLabel"].setVisible(true);}else{s.setVisible(true);C.setVisible(false);c["trafficStatusTitleLabel"].setVisible(false);setTimeout(function(){s.focus();},500);}};if(sap.ui.getCore().getModel("sapSplAppConfigDataModel").getData()["isSearchVisible"]===0){this.oSearchFieldLayout.setVisible(false);}else{this.oSearchFieldLayout.setVisible(true);this.oSearchFieldLayout.focus();}this.oSearchFieldLayout.fnExpandCollapseSearchField("Collapse");this.oCustomSearchLayout.getSearchFieldInstance=function(){return t.oSearchFieldLayout;};this.oCustomSearchLayout.getExpandedSearchListCloseButton=function(){if(t.oExpandedSearchListCloseButton){return t.oExpandedSearchListCloseButton;}else{return null;}};return this.oCustomSearchLayout;};
