/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
$.sap.require("sap.m.MessageBox");$.sap.require("splReusable.Enums");sap.ui.controller("controllers.WelcomePage",{isOptionalShown:false,selectedOwner:null,renderPsp:oSapSplUtils.getIncludePsp()==="x",helpPageUrl:"./help/SCLSelfRegistration_"+sap.ui.getCore().getConfiguration().getLocale().getLanguage().split("_")[0]+".pdf",registerLocalizationModel:function(){var l=new sap.ui.model.resource.ResourceModel({bundleUrl:"./resources/l10n/label.properties",bundleLocale:sap.ui.getCore().getConfiguration().getLocale(),async:true});sap.ui.getCore().setModel(l,"i18n");},handleWelcomePageHelpLoad:function(){var c=($(".sapUiBody").height()*0.88).toString()+"px",C=($(".sapUiBody").width()*0.9).toString()+"px";new sap.m.Dialog({contentHeight:"100%",contentWidth:"100%",customHeader:new sap.m.Bar({contentRight:new sap.m.Button({icon:"sap-icon://sys-cancel",press:function(e){e.getSource().getParent().getParent().destroy();}}),contentMiddle:[new sap.m.Label({text:"SAP Networked Logistics Hub",design:"Bold"})]}),content:[new sap.ui.core.HTML({content:"<iframe seamless=\"seamless\" height="+"\""+c+"\""+" width="+"\""+C+"\""+" scrolling=\"no\" frameborder=\"0\" src="+"\""+this.helpPageUrl+"\""+"></iframe>"})]}).open();},onInit:function(){var d={showRegForm:true,showFBPage:false,showMessageOnHeader:false,showLogonButton:true};var f=(this.renderPsp)?"$expand=RolesOfPotentialOwnedAccount,ProductList&$orderby=Organization_Name asc&$format=json":"$expand=RolesOfPotentialOwnedAccount,ProductList&$filter=(isOwnerSelf eq 0)&$orderby=Organization_Name asc&$format=json";var m=new sap.ui.model.json.JSONModel(d);sap.ui.getCore().setModel(m,"visibilityModel");this.oSapSplAppModel=new sap.ui.model.odata.ODataModel(oSapSplUtils.getFQServiceUrl("/sap/spl/xs/selfRegistration/data.xsodata/"));this.setBusyOnSelect(true);this.oSapSplAppModel.read("/Owners",null,[f],true,jQuery.proxy(this.fnSuccessCallback,this),jQuery.proxy(this.fnErrorCallback,this));if(oSapSplUtils.getDeviceID()){this.oSapSplAppModel.read("/Enumeration('VehicleType')/Values",null,null,true,jQuery.proxy(this.fnSuccessCallbackOfEnums,this),jQuery.proxy(this.fnErrorCallback,this));}this.serviceProductFilter=new sap.ui.model.Filter("isDefault",sap.ui.model.FilterOperator.EQ,"1");this.canMaintainTruck=new sap.ui.model.Filter("canMaintainTruck",sap.ui.model.FilterOperator.EQ,"1");this.BusyDialog=new sap.m.BusyDialog();var r=new sap.ui.model.json.JSONModel();this.getView().setModel(r);this.fnHandleDeviceIDParameter();this.getView().byId("sapSplSelfRegistrationFormRoleSelect").setEnabled(false);this.getView().byId("sapSplSelfRegistrationFormSubscriptionPackSelect").setEnabled(false);this.registerLocalizationModel();this.handleOnInitialization();var t=this;this.getView().addEventDelegate({onAfterShow:function(){t.getView().byId("sapSplSelfRegistrationFormFNameInput").focus();}});},handleOnInitialization:function(){if((document.referrer!==""&&document.referrer.toLowerCase().indexOf("logout/index.html")>-1)){if(localStorage.getItem("state.key_-src")==="2"){sap.ui.getCore().getModel("visibilityModel").getData()["showMessageOnHeader"]=false;sap.ui.getCore().getModel("visibilityModel").getData()["showRegForm"]=false;sap.ui.getCore().getModel("visibilityModel").getData()["showFBPage"]=true;sap.ui.getCore().getModel("visibilityModel").getData()["showLogonButton"]=false;sap.ui.getCore().getModel("visibilityModel").refresh();if(this.byId("sapSplLabelSelfDeletion")){this.byId("sapSplLabelSelfDeletion").setText(oSapSplUtils.getBundle().getText("SPL_FEEDBACK_ON_SUCCESSSFUL_DEL",["SAP Networked Logistics Hub"]));}localStorage.removeItem("state.key_-src");}}},onBeforeRendering:function(){},onAfterRendering:function(){},handleLogonOnSelfiePress:function(e){$.sap.log.info("SAP SCL Welcome Page","Event triggered: "+e,"SAPSCL");location.href="../index.html";},fnSuccessCallback:function(d,r){var t,T={},o={},a={};var s=new sap.ui.model.json.JSONModel(),S=new sap.ui.model.json.JSONModel(),b=new sap.ui.model.json.JSONModel();this.setBusyOnSelect(false);if(r.hasOwnProperty("body")){var D=JSON.parse(r.body);if(D.hasOwnProperty("d")){d=D["d"];if(d&&d.results&&oSapSplUtils.IsValidArray(d.results)){if(sap.ui.getCore().getModel("i18n")){T["Organization_Name"]=sap.ui.getCore().getModel("i18n").getProperty("SELECT_OPTION");o["RoleOfPotentialOwnedAccount_description"]=sap.ui.getCore().getModel("i18n").getProperty("SELECT_OPTION");a["Name.description"]=sap.ui.getCore().getModel("i18n").getProperty("SELECT_OPTION");}T["OrganizationUUID"]=null;o["RoleOfPotentialOwnedAccount"]=null;a["UUID"]=null;T["RolesOfPotentialOwnedAccount"]={results:[o]};T["ProductList"]={results:[a]};t=[T];d.results=t.concat(d.results);}}}s.setData(d);this.byId("sapSplSelfRegistrationFormOwnerSelect").setModel(s);this.byId("sapSplSelfRegistrationFormRoleSelect").rerender();if(d&&d.results&&d.results.length>0){S.setData(d.results[0].RolesOfPotentialOwnedAccount);b.setData(d.results[0].ProductList);}this.byId("sapSplSelfRegistrationFormRoleSelect").setModel(S);this.byId("sapSplSelfRegistrationFormSubscriptionPackSelect").setModel(b);},fnHandleChangeOfOwner:function(e){var r=null;var s=null;var d=null;d=e.getSource().getSelectedItem().getBindingContext().getObject();this.byId("sapSplSelfRegistrationFormSubscriptionPackSelect").setVisible(true);this.selectedOwner=d;this.byId("sapSplSelfRegistrationFormRoleSelect").getModel().setData(d.RolesOfPotentialOwnedAccount);this.byId("sapSplSelfRegistrationFormSubscriptionPackSelect").getModel().setData(d.ProductList);if(this.byId("sapSplSelfRegistrationFormRoleSelect").getSelectedItem()&&d&&d.RolesOfPotentialOwnedAccount&&d.RolesOfPotentialOwnedAccount&&d.RolesOfPotentialOwnedAccount.results&&d.RolesOfPotentialOwnedAccount.results.length>0){this.byId("sapSplSelfRegistrationFormRoleSelect").getSelectedItem().setKey(d.RolesOfPotentialOwnedAccount.results[0].RoleOfPotentialOwnedAccount);s=this.byId("sapSplSelfRegistrationFormRoleSelect").getSelectedItem().getKey();}r=new sap.ui.model.Filter("Role",sap.ui.model.FilterOperator.EQ,s);this.byId("sapSplSelfRegistrationFormSubscriptionPackSelect").getBinding("items").filter([r]);this.fnCheckSubscriptionProduct();this.getView().byId("sapSplSelfRegistrationFormRoleSelect").setEnabled(true);this.byId("sapSplSelfRegistrationFormSubscriptionPackSelect").setEnabled(true);},fnHandleChangeOfRole:function(){var s=this.byId("sapSplSelfRegistrationFormRoleSelect").getSelectedItem().getKey();var r=new sap.ui.model.Filter("Role",sap.ui.model.FilterOperator.EQ,s);this.byId("sapSplSelfRegistrationFormSubscriptionPackSelect").setVisible(true);this.byId("sapSplSelfRegistrationFormSubscriptionPackSelect").getBinding("items").filter([r]);this.fnCheckSubscriptionProduct();},fnCheckSubscriptionProduct:function(){var i=[];var d=[];var D=null;var m=null;var o=null;if(this.byId("sapSplSelfRegistrationFormSubscriptionPackSelect").getItems()&&this.byId("sapSplSelfRegistrationFormSubscriptionPackSelect").getItems().length===1){m=this.byId("sapSplSelfRegistrationFormSubscriptionPackSelect").getModel();i=this.byId("sapSplSelfRegistrationFormSubscriptionPackSelect").getItems();if(m){o=m.getData();if(o.hasOwnProperty("results")&&i instanceof Array&&i.length===1){this.byId("sapSplSelfRegistrationFormSubscriptionPackSelect").setVisible(false);d=this.byId("sapSplSelfRegistrationFormSubscriptionPackSelect").getItems()[0];if(d.getBindingContext()&&d.getBindingContext()&&d.getBindingContext().getObject()){if(d.getBindingContext().getObject().isDefault===1){D=d.getBindingContext().getObject().ProductUUID;}}this.byId("sapSplSelfRegistrationFormSubscriptionPackSelect").setSelectedKey(D);}}}},fnPostBusinessPartnerDetailsData:function(){var t=null,d=null,p=null,r=null,D=null;t=this;d=t.getView().getModel().getData();d["BasicInfo.ID"]=null;d["BasicInfo.Type"]="O";d["UUID"]=oSapSplUtils.getUUID();if(this.byId("sapSplSelfRegistrationFormOwnerSelect").getSelectedItem()){d["Owner"]=this.byId("sapSplSelfRegistrationFormOwnerSelect").getSelectedItem().getKey();}if(this.byId("sapSplSelfRegistrationFormSubscriptionPackSelect").getSelectedItem()){d["SubscriptionProduct"]=this.byId("sapSplSelfRegistrationFormSubscriptionPackSelect").getSelectedItem().getKey();}r={};r["UUID"]=oSapSplUtils.getUUID();r["Request"]=d.UUID;if(this.byId("sapSplSelfRegistrationFormRoleSelect").getSelectedItem()){r["Role"]=this.byId("sapSplSelfRegistrationFormRoleSelect").getSelectedItem().getKey();}p={};p["Header"]=[];p["Header"].push(d);p["Roles"]=[];p["Roles"].push(r);if(oSapSplUtils.getDeviceID()){D={};D["VehicleUUID"]=oSapSplUtils.getUUID();D["VehicleRegistrationNumber"]=this.byId("sapSplSelfRegistrationFormRegistrationNumberInput").getValue();D["VehiclePublicName"]=this.byId("sapSplSelfRegistrationFormVehiclePublicNameInput").getValue();D["VehicleType"]=this.byId("sapSplSelfRegistrationFormVehicleTypeInput").getSelectedKey();D["VehicleStatus"]="A";D["DeviceUUID"]=oSapSplUtils.getUUID();D["DeviceType"]="MOBILEIF";D["DeviceStatus"]="A";D["DeviceUniqueID"]=oSapSplUtils.getDeviceID();D["DevicePublicName"]=oSapSplUtils.getDeviceID();d.AdditionalParameters={};d.AdditionalParameters["DeviceVehicleAssignment"]=[];d.AdditionalParameters["DeviceVehicleAssignment"].push(D);}this.BusyDialog.open();$.ajax({url:oSapSplUtils.getFQServiceUrl("sap/spl/xs/selfRegistration/register.xsjs"),type:"POST",data:JSON.stringify(p),beforeSend:function(x){x.setRequestHeader("Content-Type","application/json;charset=UTF-8");},success:function(a,s,m){t.BusyDialog.close();if(a.constructor===String){a=JSON.parse(a);}if(m.status===202){var e=oSapSplUtils.getErrorMessagesfromErrorPayload(a);oSapSplUtils.showMessage({message:e.Status+" "+e.statusText,details:e});var b=new CustomEvent("SCL_Registration",{});document.dispatchEvent(b);}else if(m.status===200){sap.ca.ui.message.showMessageToast(oSapSplUtils.getBundle().getText("REQUEST_SENT"));t.fnHandleCancel();if(oSapSplUtils.getDeviceID()){location.replace(location.href.split("?")[0]);}}},error:function(a){var s=null,e=a.responseJSON;t.BusyDialog.close();if(a.status>=500){s=a.responseText;}else{if(a.responseText&&a.responseText.constructor===String){a.responseText=JSON.parse(a.responseText);}}if(e.hasOwnProperty("Error")){sap.ca.ui.message.showMessageBox({type:oSapSplUtils.getErrorMessagesfromErrorPayload(a.responseText)["messageTitle"],message:oSapSplUtils.getErrorMessagesfromErrorPayload(a.responseText)["errorWarningString"],details:oSapSplUtils.getErrorMessagesfromErrorPayload(a.responseText)["ufErrorObject"]});}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getBundle().getText("GENERIC_ERROR_MESSAGE"),details:s.toString()});}}});},fnHandleCancel:function(e){$.sap.log.info("SAP SCL Welcome Page","Event triggered: "+e,"SAPSCL");var d=this.fnReturnEmptyPayload();var o=this.byId("baseForm").getModel();o.setData(d);var R=this.byId("sapSplSelfRegistrationFormOwnerSelect").getModel().getData().results[0];this.byId("sapSplSelfRegistrationFormOwnerSelect").setSelectedKey(null);this.byId("sapSplSelfRegistrationFormRoleSelect").getModel().setData(R["RolesOfPotentialOwnedAccount"]);this.byId("sapSplSelfRegistrationFormSubscriptionPackSelect").getModel().setData(R["ProductList"]);this.byId("sapSplSelfRegistrationFormRoleSelect").setEnabled(false);this.byId("sapSplSelfRegistrationFormSubscriptionPackSelect").setEnabled(false);this.byId("sapSplSelfRegistrationFormVehiclePublicNameInput").setValue("");this.byId("sapSplSelfRegistrationFormRegistrationNumberInput").setValue("");this.byId("sapSplSelfRegistrationFormDeviceIDInput").setValue("");this.byId("sapSplSelfRegistrationFormVehicleTypeInput").setSelectedKey(null);this.byId("baseForm").setModel(o);},fnReturnEmptyPayload:function(){return{"UUID":null,"BasicInfo.ID":null,"BasicInfo.CompanyID":null,"BasicInfo.Type":"O","Organization.Name":null,"Organization.RegistrationNumber":null,"Organization.Registry":null,"PersonName.Title":null,"PersonName.Surname":null,"PersonName.GivenName":null,"PersonName.JobFunction":null,"PersonName.SurnamePrefix":null,"PostalAddress.Country":null,"PostalAddress.District":null,"PostalAddress.PostalCode":null,"PostalAddress.Street":null,"PostalAddress.StreetName":null,"PostalAddress.Town":null,"CommunicationInfo.EmailAddress":null,"CommunicationInfo.Fax":null,"CommunicationInfo.Phone":null,"CommunicationInfo.Website":null,"Owner":null,"InvitedByOrganization":null,"RequestType":"0","RequestStatus":"0"};},checkReferrer:function(){if(document.referrer&&document.referrer.indexOf("/sap/spl/ui/index.html")>-1){this.getView().byId("sapSplLogoutMessageLabel").setVisible(true);}},setBusyOnSelect:function(b){this.byId("sapSplSelfRegistrationFormRoleSelect").setBusy(b);this.byId("sapSplSelfRegistrationFormOwnerSelect").setBusy(b);this.byId("sapSplSelfRegistrationFormSubscriptionPackSelect").setBusy(b);},fnErrorCallback:function(r){var d;r=r.response;this.setBusyOnSelect(false);if(r.status===500){d=r.body;}else{if(r.body&&r.body.constructor===String){r.body=JSON.parse(r.body);}d=oSapSplUtils.getErrorMessagesfromErrorPayload(r.body)["ufErrorObject"];}if(r&&r.body&&r.body.error&&r.body.error.message){d=r.body.error.message.value;}oSapSplUtils.showMessage({message:r.statusCode+" : "+d});},handleLiveChange:function(e){e.getSource().setValueState();},fnHandleDeviceIDParameter:function(){if(oSapSplUtils.getDeviceID()){this.byId("sapSplSelfRegistrationFormDeviceIDInput").setVisible(true);this.byId("sapSPlSelfregistrationFormDeviceIDLabel").setVisible(true);this.byId("sapSPlSelfregistrationFormRegistrationNumberLabel").setVisible(true);this.byId("sapSPlSelfregistrationFormVehiclePublicNameLabel").setVisible(true);this.byId("sapSplSelfRegistrationFormVehicleTypeInput").setVisible(true);this.byId("sapSplSelfRegistrationFormRegistrationNumberInput").setVisible(true);this.byId("sapSplSelfRegistrationFormVehiclePublicNameInput").setVisible(true);this.byId("sapSPlSelfregistrationFormVehicleTypeLabel").setVisible(true);this.byId("sapSplSelfRegistrationFormDeviceIDInput").setValue(oSapSplUtils.getDeviceID());this.byId("sapSplSelfRegistrationFormRegistrationNumberInput").setValue(oSapSplUtils.getRegistrationNumber());}},fnSuccessCallbackOfEnums:function(d){var t={};t["Value"]=null;t["Value.description"]=oSapSplUtils.getBundle().getText("SELECT_OPTION");if(d.hasOwnProperty("results")&&d.results instanceof Array){d.results=[t].concat(d.results);}var m=new sap.ui.model.json.JSONModel(d);this.byId("sapSplSelfRegistrationFormVehicleTypeInput").setModel(m);}});
