/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
(function(w,s){function _(E){$.sap.log.info("SAP SCL Unified Shell","Session Management Button handler "+E.toString(),"SAPSCL");sap.m.MessageBox.show(oSapSplUtils.getBundle().getText("SPL_LOGOUT_PROMPT_MESSAGE"),{icon:sap.m.MessageBox.Icon.INFORMATION,title:oSapSplUtils.getBundle().getText("SPL_LOGOUT_PROMPT_DIALOG_HEADER"),actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(A){if(A===sap.m.MessageBox.Action.YES){oSapSplUtils.sLO4S="app";splReusable.libs.SapSplLogoutHandler.doLogout(null,null,function(x,t){w.location.replace(SapSplEnums.LOGOUTPAGE);});}else{return;}}});}function a(E){$.sap.log.info("SAP SCL Unified Shell","Profile Button handler "+E.toString(),"SAPSCL");if(s.getAppInstance().getPage("splView.profile.Profile")===null){var p=sap.ui.view({viewName:"splView.profile.Profile",id:"splView.profile.Profile",type:sap.ui.core.mvc.ViewType.XML});p.addEventDelegate({onBeforeShow:function(E){if(!E.data||!E.data.hasOwnProperty("cDetails")){E.data.cDetails=oSapSplUtils.getCompanyDetails();}p.getController().updateBindings(E);}},p.getController());s.getAppInstance().addPage(p);}s.getAppInstance().to("splView.profile.Profile",{cDetails:oSapSplUtils.getCompanyDetails()});}function b(E){$.sap.log.info("SAP SCL Unified Shell","Profile Button handler "+E.toString(),"SAPSCL");if(s.getAppInstance().getPage("splView.profile.UserProfile")===null){var p=sap.ui.view({viewName:"splView.profile.UserProfile",id:"splView.profile.UserProfile",type:sap.ui.core.mvc.ViewType.XML});p.addEventDelegate({onBeforeShow:function(E){if(!E.data||!E.data.hasOwnProperty("cDetails")){E.data.cDetails=sap.ui.getCore().getModel("loggedOnUserModel").getData()["profile"];}if(E.data.FromApp&&E.data.FromApp==="tours"){if(this.byId("sapSclProfileAndSettingIconTabBar").getSelectedKey()!=="sapSclIconTabFilterFollowTrucks"){this.byId("sapSclProfileAndSettingIconTabBar").setSelectedKey("sapSclIconTabFilterFollowTrucks");this.byId("sapSclProfileAndSettingIconTabBar").fireSelect({selectedKey:"sapSclIconTabFilterFollowTrucks"});}if(E.data.RegistrationNumber){this.fnHandleNavigationSearch(E.data.RegistrationNumber);}}p.getController().updateBindings(E);if(this.byId("sapSclProfileAndSettingIconTabBar")&&this.byId("sapSclProfileAndSettingIconTabBar").getSelectedKey()==="sapSclIconTabFilterFollowTrucks"){if(sap.ui.getCore().getModel("SapSclFollowTrucksOataModel")){sap.ui.getCore().getModel("SapSclFollowTrucksOataModel").refresh(true);}}}},p.getController());s.getAppInstance().addPage(p);}s.getAppInstance().to("splView.profile.UserProfile",{cDetails:sap.ui.getCore().getModel("loggedOnUserModel").getData()["profile"]});}function c(){var D=null,p=null,u=null,h=null;D=new sap.m.Button({text:oSapSplUtils.getBundle().getText("HEADER_LOGOUT"),tooltip:oSapSplUtils.getBundle().getText("HEADER_LOGOUT"),icon:"sap-icon://log",visible:!oSapSplUtils.getStartupError(),width:"100%",press:function(E){if(oSapSplUtils.getStartupError()){$.sap.log.warning("SAP SCL Unified Shell","Logging out of the system","SAPSCL");}_(E);}});function i(E){if(E.getSource().getText()===oSapSplUtils.getBundle().getText("HEADER_COMPANY_PROFILE")){a(E);}else if(E.getSource().getText()===oSapSplUtils.getBundle().getText("HEADER_USER_PROFILE")){b(E);}}p=new sap.m.Button({text:oSapSplUtils.getBundle().getText("HEADER_COMPANY_PROFILE"),tooltip:oSapSplUtils.getBundle().getText("HEADER_COMPANY_PROFILE"),icon:"sap-icon://org-chart",visible:!oSapSplUtils.getStartupError(),press:function(E){if(!oSapSplUtils.getStartupError()){E.preventDefault();}h.close();i(E);}});u=new sap.m.Button({text:oSapSplUtils.getBundle().getText("HEADER_USER_PROFILE"),tooltip:oSapSplUtils.getBundle().getText("HEADER_USER_PROFILE"),icon:"sap-icon://person-placeholder",visible:!oSapSplUtils.getStartupError(),press:function(E){if(!oSapSplUtils.getStartupError()){E.preventDefault();}h.close();i(E);}});h=new sap.m.ActionSheet({placement:sap.m.PlacementType.Bottom,showCancelButton:false,title:oSapSplUtils.getBundle().getText("HEADER_WELCOME_LABEL",[splReusable.libs.SapSplModelFormatters.displayNameFormatterBP(oSapSplUtils.getLoggedOnUserDetails().firstName,oSapSplUtils.getLoggedOnUserDetails().lastName)]),buttons:[u,p,D]}).attachAfterClose(function(E){E.getSource().destroy();});return h;}function d(t){t.oNotificationsPopover.getContent()[0].setNoDataText(oSapSplUtils.getBundle().getText("NO_NEW_NOTIFICATIONS"));oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("sap/spl/xs/app/services/appl.xsodata/")+"ReplicationEntities?&$format=json&$filter=ReplicationStatus ne 2",method:"GET",success:function(h){t.oNotificationsPopoverModel.setData(h.d.results);},error:function(h){$.sap.log.error("SAP SCL Shell","Notifications fetch Error","SAPSCL");},complete:function(){t.oNotificationsPopover.setBusy(false);}});}function e(E){if(!this.oNotificationsPopoverModel){this.oNotificationsPopoverModel=new sap.ui.model.json.JSONModel();}if(!this.oNotificationsPopover){this.oNotificationsPopover=sap.ui.xmlfragment("notificationsPopoverFragment","splReusable.fragments.NotificationsPopover",this);sap.ui.core.Fragment.byId("notificationsPopoverFragment","sapSplShellHeaderNotificationsPopoverListItem").addEventDelegate({onAfterRendering:function(E){E.srcControl.$().find(".sapMIBar").css("height",E.srcControl.$().find(".sapMText").height()+15+"px");}});this.oNotificationsPopover.setModel(this.oNotificationsPopoverModel);}if(this.oInterval){clearInterval(this.oInterval);}this.oNotificationsPopover.openBy(E.getSource());d(this);this.oInterval=w.setInterval(function(){d(this);},60000);}var S=sap.ui.unified.ShellHeadUserItem({username:"{parts:[{path:'loggedOnUserModel>/profile/PersonName_GivenName'},{path:'loggedOnUserModel>/profile/PersonName_Surname'}],formatter:'splReusable.libs.SapSplModelFormatters.displayNameFormatter'}",tooltip:"{parts:[{path:'loggedOnUserModel>/profile/CommunicationInfo_EmailAddress'}]}",image:"sap-icon://account",press:[function(E){c().openBy(E.oSource);},this]});function f(E){oSapSplHelpHandler.launchHelp(E,null,null,null,null,function(E){$.sap.log.info("SAP SCL Unified Shell","Help Button handler "+E.toString(),"SAPSCL");});}function g(){var D=new sap.m.Dialog({contentHeight:"100%",contentWidth:"100%",showHeader:true,title:oSapSplUtils.getBundle().getText("LOGGER"),rightButton:new sap.m.Button({icon:"sap-icon://sys-cancel",tooltip:oSapSplUtils.getBundle().getText("CLOSE"),press:function(E){$.sap.log.info("SAP SCL Unified Shell","Logger Close handler "+E.toString(),"SAPSCL");D.destroy();}}),initialFocus:"sapSplLogExportToCSV",content:sap.ui.view({viewName:"splView.logger.Logger",id:"splView.logger.Logger",type:sap.ui.core.mvc.ViewType.XML}),beforeClose:function(E){E.getSource().getContent().destroy();}});D.open();}w["splBaseUnifiedShell"]=new sap.ui.unified.Shell("sapSplBaseUnifiedShell",{icon:encodeURIComponent("resources/icons/sap_logo.png"),searchVisible:true,headEndItems:[new sap.ui.unified.ShellHeadItem({icon:"sap-icon://marketing-campaign",tooltip:oSapSplUtils.getBundle().getText("NOTIFICATIONS"),press:[function(E){e(E);},this]}),new sap.ui.unified.ShellHeadItem({tooltip:oSapSplUtils.getBundle().getText("SAP_CONNECTED_LOGISTICS_HELP"),icon:"sap-icon://sys-help",visible:"{helpModel>/helpVisible}",press:[function(E){f(E);},this]})],user:S,content:s.getData()}).addStyleClass("sapSplShellItemsSize");if(oSapSplUtils.getFromQueryParameterMap("spl-show-log")==="1"){w["splBaseUnifiedShell"].addHeadEndItem(new sap.ui.unified.ShellHeadItem({tooltip:oSapSplUtils.getBundle().getText("SPLUNIFIEDSHELL_HEADER_OPTIONS_LOGS"),icon:"sap-icon://list",press:[function(E){$.sap.log.info("SAP SCL Unified Shell","Logger Button handler "+E.toString(),"SAPSCL");g();},this]}));}this.fnDoRefreshItem=function(E){var t=this;var F="$select=ReplicationStatus&$filter=("+encodeURIComponent("UUID_1 eq "+"X"+"\'"+oSapSplUtils.base64ToHex(E.getSource().getBindingContext().getObject()["UUID_1"])+"\'")+")";var T=jQuery.extend(true,{},E);E.getSource().getParent().getParent().setBusy(true);oSapSplAjaxFactory.fireAjaxCall({url:oSapSplUtils.getFQServiceUrl("sap/spl/xs/app/services/appl.xsodata/")+"ReplicationEntities?&$format=json&"+F,method:"GET",success:function(D){T.getSource().getParent().getParent().setBusy(false);var m=t.oNotificationsPopoverModel.getData();var h=m.length;for(var i=0;i<h;i++){if(m[i]["UUID_1"]===T.getSource().getBindingContext().getObject()["UUID_1"]){m[i]["ReplicationStatus"]=D.d.results[0].ReplicationStatus;t.oNotificationsPopoverModel.setData(m);}}},error:function(h){$.sap.log.error("SAP SCL Shell","Notifications fetch Error","SAPSCL");}});};this.fnHandleNavigationFromNotification=function(E){E.getSource().getParent().removeSelections();var n=E.getSource().getBindingContext().getObject().Entity;var A=E.getSource().getBindingContext().getObject().AppPath;function h(){var N=null;var o={};o["FromApp"]="Notifications";if(n==="vehicles"){o["RegistrationNumber"]=E.getSource().getBindingContext().getObject().Desc_1;o["Device_ID"]=E.getSource().getBindingContext().getObject().Desc_2;}else if(n==="myBusinessPartners"){o["RegistrationNumber"]=E.getSource().getBindingContext().getObject().Desc_1;A="splView.profile.Profile";}o["showBackButton"]=true;if(!sap.ui.getCore().byId("sapSplBaseApplication").getPage(A)){N=sap.ui.view({viewName:A,id:A,type:sap.ui.core.mvc.ViewType.XML});if(A==="splView.profile.Profile"){$.sap.log.info("SAP SCL Unified Shell","Profile Button handler "+E.toString(),"SAPSCL");if(s.getAppInstance().getPage("splView.profile.Profile")===null){N.addEventDelegate({onBeforeShow:function(E){if(!E.data||!E.data.hasOwnProperty("cDetails")){E.data.cDetails=oSapSplUtils.getCompanyDetails();}N.getController().updateBindings(E);}},N.getController());s.getAppInstance().addPage(N);}s.getAppInstance().to("splView.profile.Profile",{cDetails:oSapSplUtils.getCompanyDetails()});}else{N.addEventDelegate({onBeforeShow:jQuery.proxy(N.getController().onBeforeShow,N.getController())});}sap.ui.getCore().byId("sapSplBaseApplication").addPage(N);}if(sap.ui.getCore().byId("sapSplBaseApplication").getCurrentPage().sId!==A){s.getAppInstance().to(A,"slide",o);}else{if(n==="vehicles"&&sap.ui.getCore().byId("sapSplBaseApplication").getPage("splView.vehicles.VehicleMasterDetail")){sap.ui.getCore().byId("sapSplBaseApplication").getPage("splView.vehicles.VehicleMasterDetail").byId("SapSplVehicleMasterDetailSplitApp").getMasterPages()[0].byId("sapSplVehicleSearch").setValue(o["RegistrationNumber"]);sap.ui.getCore().byId("sapSplBaseApplication").getPage("splView.vehicles.VehicleMasterDetail").byId("SapSplVehicleMasterDetailSplitApp").getMasterPages()[0].getController().fnHandleNavigationSearch(o["RegistrationNumber"]);}}}h();};}(window,oSplBaseApplication));
