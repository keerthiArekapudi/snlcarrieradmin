/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
jQuery.sap.require("splReusable.libs.Utils");jQuery.sap.require("splReusable.libs.MapsDataMarshal");jQuery.sap.require("splReusable.libs.SapSplModelFormatters");jQuery.sap.require("splReusable.libs.SapSplModel");jQuery.sap.require("sap.ca.ui.message.message");jQuery.sap.require("splReusable.libs.SapSplBusyDialoglib");jQuery.sap.require("splReusable.libs.SapSplMessageBoxlib");jQuery.sap.require("sap.m.MessageBox");jQuery.sap.require("sap.m.MessageToast");jQuery.sap.require("sap.m.InstanceManager");jQuery.sap.require("splReusable.libs.SplTracer");jQuery.sap.require("splReusable.libs.SapSplLogoutHandler");jQuery.sap.require("splReusable.libs.SapSplGlobalQuerySelectors");jQuery.sap.require("splReusable.libs.SapSplTileRefresher");jQuery.sap.require("splReusable.libs.SapSplHelpHandler");jQuery.sap.require("splReusable.libs.SapSplAppErrorHandler");jQuery.sap.require("splReusable.libs.SapSplSessionHandler");jQuery.sap.require("splReusable.events.EventsFactory");jQuery.sap.require("splReusable.libs.SapSplStyleSheetLoader");jQuery.sap.require("splReusable.libs.SapSplAjaxFactory");jQuery.sap.require("splReusable.libs.SapSplUserPreferences");(function(){try{oSapSplUtils.setReferrer();function c(i){var u;if(jQuery.sap.getUriParameters().get("spl-mock-mode")==="true"){$.sap.log.info("SAP SCL DEMO MODE!!!!","Demo mode initializer","SAPSCL");var r={"email":"admin.carrier1@sap.com","userId":"CL_CARRIER1_ADMIN","firstName":"Admin","lastName":"Carrier 1","isSAML":false,"notificationMessages":[],"Error":[],"HttpStatusCode":200},m=r;oSapSplUtils.setInitializerDetails(m);if(m.notificationMessages&&m.notificationMessages.length>0){var n="",o;for(o=0;o<m.notificationMessages.length;o++){if(o===0){n=n+m.notificationMessages[o].LongText+" "+oSapSplUtils.getBundle().getText("SEND_MESSAGE_VALID_FROM")+" "+splReusable.libs.SapSplModelFormatters.convertDateTimeToStringBasedOnLocaleInMediumFormat(new Date(m.notificationMessages[o]["Validity.StartTime"]))+" "+oSapSplUtils.getBundle().getText("SEND_MESSAGE_VALID_UNTIL")+" "+splReusable.libs.SapSplModelFormatters.convertDateTimeToStringBasedOnLocaleInMediumFormat(new Date(m.notificationMessages[o]["Validity.EndTime"]));}else{n+="\n\n"+m.notificationMessages[o].LongText+" "+oSapSplUtils.getBundle().getText("SEND_MESSAGE_VALID_FROM")+" "+splReusable.libs.SapSplModelFormatters.convertDateTimeToStringBasedOnLocaleInMediumFormat(new Date(m.notificationMessages[o]["Validity.StartTime"]))+" "+oSapSplUtils.getBundle().getText("SEND_MESSAGE_VALID_UNTIL")+" "+splReusable.libs.SapSplModelFormatters.convertDateTimeToStringBasedOnLocaleInMediumFormat(new Date(m.notificationMessages[o]["Validity.EndTime"]));}}sap.m.MessageBox.show(n,sap.m.MessageBox.Icon.INFORMATION,oSapSplUtils.getBundle().getText("NOTIFICATIONS"),[sap.m.MessageBox.Action.OK],null,null,oSapSplUtils.fnSyncStyleClass("messageBox"));}i({data:r,xhr:null,status:null});}else{u=oSapSplUtils.getServiceMetadata(SapSplEnums.Init,true);jQuery.ajax({url:u,type:"GET",async:true,success:function(m,t,p){jQuery.sap.log.info("Entity Check","Entities check completed","SAPSCL");oSapSplUtils.setInitializerDetails(m);i({data:m,xhr:p,status:t});if(m.notificationMessages&&m.notificationMessages.length>0){var n="",o;for(o=0;o<m.notificationMessages.length;o++){if(o===0){n=n+m.notificationMessages[o].LongText+" "+oSapSplUtils.getBundle().getText("SEND_MESSAGE_VALID_FROM")+" "+splReusable.libs.SapSplModelFormatters.convertDateTimeToStringBasedOnLocaleInMediumFormat(new Date(m.notificationMessages[o]["Validity.StartTime"]))+" "+oSapSplUtils.getBundle().getText("SEND_MESSAGE_VALID_UNTIL")+" "+splReusable.libs.SapSplModelFormatters.convertDateTimeToStringBasedOnLocaleInMediumFormat(new Date(m.notificationMessages[o]["Validity.EndTime"]));}else{n+="\n\n"+m.notificationMessages[o].LongText+" "+oSapSplUtils.getBundle().getText("SEND_MESSAGE_VALID_FROM")+" "+splReusable.libs.SapSplModelFormatters.convertDateTimeToStringBasedOnLocaleInMediumFormat(new Date(m.notificationMessages[o]["Validity.StartTime"]))+" "+oSapSplUtils.getBundle().getText("SEND_MESSAGE_VALID_UNTIL")+" "+splReusable.libs.SapSplModelFormatters.convertDateTimeToStringBasedOnLocaleInMediumFormat(new Date(m.notificationMessages[o]["Validity.EndTime"]));}}sap.m.MessageBox.show(n,sap.m.MessageBox.Icon.INFORMATION,oSapSplUtils.getBundle().getText("NOTIFICATIONS"),[sap.m.MessageBox.Action.OK],null,null,oSapSplUtils.fnSyncStyleClass("messageBox"));}},error:function(p,t){jQuery.sap.log.fatal("Entity Check","Entities check failed. Operations might fail","SAPSCL");i({data:null,xhr:p,status:t});}});}};function a(A){sap.ui.getCore().applyTheme(oSapSplUtils.getLoggedOnUserDetails()["profile"].Theme);oSapSplUtils.setHCBMode(oSapSplUtils.getLoggedOnUserDetails()["profile"].Theme==="sap_hcb");A();};function g(i){var u=new sap.ui.model.odata.ODataModel(oSapSplUtils.getServiceMetadata("app",true));u.read("/MyUsers",{context:null,urlParameters:"$filter=(isMyself eq 1)&$format=json",async:true,success:function(D,r){var m=jQuery.parseJSON(r.body);if(m.d.results.length>0){oSapSplUtils.setLoggedOnUserDetails({profile:m.d.results[0]});i({data:m,result:"OK"});}else{i({data:null,result:"ERROR"});}},error:function(E){i({data:null,result:"ERROR"});}});};function h(_,i){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getBundle().getText("UNSUPPORTED_BROWSER",[_])},function(){i();});};function l(){var B=sap.ui.Device.browser.name;var _=null;var i=sap.ui.Device.browser.versionStr;$.sap.log.info("SAP SPL Startup","Application running from host"+document.URL,"SAPSCL");(function(){var m="";for(var K in sap.ui.Device.browser){if(sap.ui.Device.browser.hasOwnProperty(K)){m+=K+":"+sap.ui.Device.browser[K]+"\n";}}$.sap.log.info("Browser version",JSON.stringify(m),"SAPSCL");}());if(navigator){if(navigator.userAgent){_=navigator.userAgent;}else{$.sap.log.fatal("Navigator support","Navigator User agent not supported. Some functionalities might suffer","SAPSCL");}}else{$.sap.log.fatal("Navigator support","Navigator not supported. Some functionalities might suffer","SAPSCL");}$.sap.log.info("Browser identified",(navigator)?((navigator.userAgent)?navigator.userAgent:"Navigator unsupported. Error"):"Navigator Not supported. Fatal","SAPSCL");if(sap.ui.Device.browser.mobile!==undefined&&sap.ui.Device.browser.mobile!==null){if(sap.ui.Device.browser.mobile.constructor===Boolean){if(sap.ui.Device.browser.mobile){jQuery.sap.log.info("Browser Support","Application is running on a Mobile Device","SAPSCL");if(sap.ui.Device.os.name==="Android"){switch(B){case"cr":jQuery.sap.log.info("Browser Support","Google Chrome, Version "+i+"\t"+_,"SAPSCL");break;case"an":jQuery.sap.log.info("Browser Support","Android stock browser, Version "+i+"\t"+_,"SAPSCL");break;default:jQuery.sap.log.fatal("Browser Support","Unsupported Browser:"+i+"\t"+_,"SAPSCL");h(_);throw new Error("Browser is not supported");}}else if(sap.ui.Device.os.name==="iOS"){switch(B){case"sf":jQuery.sap.log.info("Browser Support","Safari, Version "+i+"\t"+_,"SAPSCL");break;default:jQuery.sap.log.fatal("Browser Support","Unsupported Browser:"+i+"\t"+_,"SAPSCL");h(_);throw new Error("Browser is not supported");}}else{jQuery.sap.log.fatal("Browser Support","Unsupported Browser:"+i+"\t"+_,"SAPSCL");}}else{jQuery.sap.log.info("Browser Support","Application is running on a Desktop","SAPSCL");if(B!==undefined&&B!==null){if(B.constructor===String&&B.length===2){switch(B){case"cr":jQuery.sap.log.info("Browser Support","Google Chrome, Version "+i+"\t"+_,"SAPSCL");break;case"ff":jQuery.sap.log.info("Browser Support","FireFox, Version "+i+"\t"+_,"SAPSCL");break;case"sf":jQuery.sap.log.info("Browser Support","Safari, Version "+i+"\t"+_,"SAPSCL");break;case"an":jQuery.sap.log.info("Browser Support","Android stock browser, Version "+i+"\t"+_,"SAPSCL");break;case"ie":jQuery.sap.log.info("Browser Support","Internet Explorer, Version "+i+"\t"+_,"SAPSCL");break;default:jQuery.sap.log.fatal("Browser Support","Unsupported Browser:"+i+"\t"+_,"SAPSCL");h(_);throw new Error("Browser is not supported");}}else{jQuery.sap.log.fatal("Browser Support","Fatal Type Error while checking for browser support.","SAPSCL");throw new TypeError();}}else{h(_);throw new Error("Browser is not supported");}}}else{jQuery.sap.log.fatal("Browser Support","Unsupported Browser:"+i+"\t"+_,"SAPSCL");h(_);throw new TypeError();}}else{jQuery.sap.log.fatal("Browser Support","Unsupported Browser:"+i+"\t"+_,"SAPSCL");h(_);throw new ReferenceError();}if(window){if(!window.localStorage){jQuery.sap.log.error("Browser Check","Local Storage not supported by this browser. Some Core functionalitites might not work","SAPSCL");throw new Error("Your Browser does not support localStorage");}else if(!window.sessionStorage){jQuery.sap.log.error("Browser Check","Session Storage not supported by this browser","SAPSCL");throw new Error("Your Browser does not support sessionStorage");}}else{jQuery.sap.log.fatal("Browser Check","Window object not supported. Critical features might fail","SAPSCL");throw new Error("Your Browser does not support window object");}$.sap.log.info("jQuery Check","Found version:"+$.fn.jquery,"SAPSCL");$.sap.log.info("SCL Locale Check","Running in Locale: "+sap.ui.getCore().getConfiguration().getLocale().getLanguage(),"SAPSCL");};function s(i){jQuery.ajax({type:"get",url:"./config/Services.json",dataType:"json",async:true,cache:false}).done(function(u){var S=u;oSapSplUtils.setServiceMetadata(S);i();jQuery.sap.log.info("Service Initializer","Application configuration fetched successfully","SAPSCL");}).fail(function(){jQuery.sap.log.error("Startup Error","Failure of storeAllServiceUrls() function's service call","SAPCL");});};function b(){splReusable.libs.SplTracer.trace(0,"Startup setNamedModels");var S=oSapSplUtils.getServiceMetadata(SapSplEnums.RootApp,false);var r=new splModels.odata.ODataModel({url:oSapSplUtils.getServiceMetadata(SapSplEnums.RootApp,true),json:true,headers:{"Cache-Control":"max-age=0","Content-Type":"application/json;charset=UTF-8"},tokenHandling:true,withCredentials:false,loadMetadataAsync:false,handleTimeOut:true,defaultCountMode:sap.ui.model.odata.CountMode.Both,numberOfSecondsBeforeTimeOut:10000});var t=oSapSplUtils.getAllowedTilesList();if(t.length===null||t.length===undefined){jQuery.sap.log.error("Empty applications list. Authorizations need to be verfied");return;}function _(r,m,n){if(n===undefined||n===null||!oSapSplUtils.IsValidArray(n)){throw new splReusable.exceptions.InvalidArrayException({messge:"Invalid Aray Usage",source:"Startup",options:{severity:SapSplEnums.fatal}});}if(n.hasOwnProperty("length")&&n.length>0){for(var N=0;N<n.length;N++){var o={};o=$.extend(true,{},r);sap.ui.getCore().setModel(o,n[N]);}}}for(var T=0;T<t.length;T++){for(var i=0;i<S.usedBy.length;i++){if(t[T].AppID===S.usedBy[i].appId){_(r,S.value,S.usedBy[i].namedModels);}}}var u=new splModels.odata.ODataModel({url:oSapSplUtils.getServiceMetadata("utils",true),json:true,headers:{"Cache-Control":"max-age=0"},tokenHandling:true,withCredentials:false,loadMetadataAsync:true,handleTimeOut:true,numberOfSecondsBeforeTimeOut:10000});sap.ui.getCore().setModel(u,"sapSplUtilsModel");};function d(u){splReusable.libs.SplTracer.trace("0","Startup");if(u&&u.constructor===Array){var B={},m=null;for(var i=0;i<u.length;i++){B[u[i]["AppID"]]=false;}m=new sap.ui.model.json.JSONModel(B);sap.ui.getCore().setModel(m,"SapSplBackButtonVisibilityModel");jQuery.sap.log.info("SCLUI","Nav button state set","SAPSCL");}splReusable.libs.SplTracer.trace("1","Startup");};function f(i,u){jQuery.ajax({url:oSapSplUtils.getServiceMetadata(SapSplEnums.RootApp,true)+"/MyOrganization/?$format=json&$expand=Owner",type:"Get",contentType:"application/json",success:function(r){oSapSplUtils.setCompanyDetails(r.d.results[0]);if(r.d.results[0].BuPaReplication===1||r.d.results[0].BuPaReplication===4){sap.m.MessageBox.show(oSapSplUtils.getBundle().getText("ACC_CREATION_STATUS_FAILED",r.d.results[0].Organization_Name),{title:oSapSplUtils.getBundle().getText("ACC_STATE_ERROR"),icon:sap.m.MessageBox.Icon.ERROR,actions:[sap.m.MessageBox.Action.CLOSE],onClose:function(){}});}else if(r.d.results[0].BuPaReplication===3){sap.m.MessageBox.show(oSapSplUtils.getBundle().getText("ACC_CREATION_STATUS_PENDING",r.d.results[0].Organization_Name),{title:oSapSplUtils.getBundle().getText("ACC_STATE_WARNING"),icon:sap.m.MessageBox.Icon.WARNING,actions:[sap.m.MessageBox.Action.CLOSE],onClose:function(){}});}d(u);i();}});};function C(){jQuery.sap.includeScript("./startup/DirectAppLauncher.js","dalLoaderScript",function(){},function(){jQuery.sap.log.error("DAL Load failed");});};function L(){sap.ui.getCore().byId("sapSplBaseApplication").addPage(new sap.ui.view({viewName:"splView.tileContainer.MasterTileContainer",id:"splView.tileContainer.MasterTileContainer",type:sap.ui.core.mvc.ViewType.XML}));sap.ui.getCore().byId("sapSplBaseApplication").setInitialPage("splView.tileContainer.MasterTileContainer");};function j(){var S=oSapSplUtils.getServiceMetadata(SapSplEnums.RootApp,true);var m=new sap.ui.model.odata.ODataModel(S,true);var D=m.read("/UIApps",undefined,["$expand=AppConfig&$orderby=SequenceNumber asc"],false,function _OnSuccess(r){if(r&&r.results.length===0){jQuery.sap.require("sap.ca.ui.message.message");oSapSplUtils.setStartupError(true);sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getBundle().getText("APP_STARTUP_FAIL_ON_INIT"),details:oSapSplUtils.getErrorMessagesfromErrorPayload(r)["ufErrorObject"]},function(){jQuery.sap.log.fatal("Startup Error","Application startup failed with missing privileges","SAPSCL");return;});}else{oSapSplUtils.setAllowedTilesList(r.results);b();sap.ui.getCore().setModel(new sap.ui.model.json.JSONModel(),"sapSplAppConfigDataModel");oSapSplUtils.setStartupError(false);f(function(){if(jQuery.sap.getUriParameters().get("goto")&&oSapSplUtils.checkAppPermission(jQuery.sap.getUriParameters().get("goto"))){C();}else{L();}},r.results);}},function _OnError(E){jQuery.sap.log.error("UI Apps load failed with error: "+E.toString());});};jQuery.sap.log.info("Using SAPUI5 version: "+sap.ui.version.toString(),"Supported version","SAP SPL Startup");function k(){(function(){for(var i in $.sap.getUriParameters().mParams){if($.sap.getUriParameters().mParams.hasOwnProperty(i)){oSapSplUtils.setInQueryParameterMap(i,$.sap.getUriParameters().mParams[i][0]);}}}());(function(){var u;if(jQuery.sap.getUriParameters().get("spl-mock-mode")=="true"){u="model/app/helpType.json";}else{u=oSapSplUtils.getFQServiceUrl("/sap/spl/xs/app/services/helpType.xsjs");}$.ajax({url:u,success:function(r){$.sap.log.info("SAP Connected Logistics Help","Help Info type fetched: "+r,"SAPSCL");oSapSplUtils.setHelpType(r);},error:function(){$.sap.log.warning("SAP Connected Logistics Help","Unable to fetch Help Type. Defaulting to HTML","SAPSCL");}});}());sap.ui.getCore().setModel(new sap.ui.model.json.JSONModel({helpVisible:false}),"helpModel");l();oSapSplUtils.fnSetSystemType();if($.sap.getUriParameters().get("spl-trace")==="on"){jQuery.sap.log.setLevel(jQuery.sap.log.Level.TRACE);}(function(){$(window).bind("beforeunload",function(){if(oSapSplUtils.sLO4S==="nav"){return"Save your changes before your proceed";}});$(window).bind("unload",function(){if(oSapSplUtils.sLO4S==="nav"){splReusable.libs.SapSplLogoutHandler.doLogout(function(){},function(){});}});}());jQuery.sap.includeScript(encodeURIComponent("startup/AppContainer.js"),"appContainerLoader",function(){splReusable.libs.SplTracer.trace(0,"SPL Startup Pre Unified Shell creation");jQuery.sap.includeScript(encodeURIComponent("startup/SplUnifiedShellCreator.js"),"unifiedShellScript",function(){s(function(){if(jQuery.sap.getUriParameters().get("spl-mock-mode")!=="true"){(function(){jQuery.ajax({url:oSapSplUtils.getServiceMetadata("token",true),cache:false,beforeSend:function(i){i.setRequestHeader("X-CSRF-Token","Fetch");},success:function(r,t,i){oSapSplUtils.setCSRFToken(i.getResponseHeader("X-CSRF-Token"));},error:function(i,t,m){jQuery.sap.log.fatal("CSRF Token Fetch Error","Error occured while fetching token. \n"+m,"App Startup");}});}());}c(function(D){if(D.data&&D.data!==null&&(D.data["isSAML"]!==undefined||D.data["firstName"]||D.data["lastName"]||D.data["email"])){$.sap.log.info("SPL Startup","User logged in as "+JSON.stringify(D.data.email),"SAPSCL");$("#splLoggedOnUser").html("<h5><i>"+"Logging in "+D.data.email+"</i></h5>");$.sap.log.info("SPL Startup","Setting logged on user details on Utility reuse","SAPSCL");oSapSplUtils.setLoggedOnUserDetails(D.data);g(function(r){if(r==="ERROR"){jQuery.sap.log.fatal("User Profile Check","Unable to fetch user profile information. Some operations might suffer","SAPSCL");return;}a(function(){$.sap.log.info("Theme applied");splReusable.libs.SapSplStyleSheetLoader.loadStyle("./resources/styles/splUnifiedShellHeaderSearch","css","splUnifiedShellSearch",function(){jQuery.sap.log.info("Loaded SPL Unified Shell styles in "+sap.ui.getCore().getConfiguration().getTheme());},function(){jQuery.sap.log.error("Failed to load SPL Unified Shell styles");});});});$.sap.log.info("SPL Startup","Getting supported Apps List","SAPSCL");j();$.sap.log.info("SPL Startup","Fetching first set of identifiers","SAPSCL");oSapSplUtils.fetchUUIDs();window["splBaseUnifiedShell"].placeAt("content");if($("#splLoggedOnUser")){$("#splLoggedOnUser").remove();}if(jQuery("#splash-screen")){jQuery("#splash-screen").fadeOut("slow",function(){jQuery("#splash-screen").remove();if(oSapSplUtils.fnGetSystemType()==="D"){$("#sapSplBaseUnifiedShell").addClass("sapUiSizeCompact");}});oSapSplQuerySelectors.getInstance().setHeaderUserNameTooltip();}}else{jQuery.sap.require("sap.ca.ui.message.message");oSapSplUtils.setStartupError(true);$.sap.log.error("SAP SCL Application Startup","Startup encountered errors"+oSapSplUtils.getBundle().getText("APP_STARTUP_FAIL_ON_INIT"),"SAPSCL");sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:oSapSplUtils.getBundle().getText("APP_STARTUP_FAIL_ON_INIT"),details:D.xhr.statusText},function(){$("#splashDiv").remove();$(".sapUiBody").removeClass("sapUiBody");$("#splErrorDiv").append(D.xhr.responseText);});return;}});});splReusable.libs.SplTracer.trace(1,"SPL Startup Pre Unified Shell creation");},function(){jQuery.sap.log.fatal("SPL Startup","An error occured while trying to create unified shell container","SAPSCL");return;});},function(){jQuery.sap.log.fatal("SPL Startup","Failure while loading App Container","SAPSCL");return;});};oSapSplUtils.isInIframe(function(r){if(!r){$.sap.log.info("SPL Startup","IFrame check successful","SAPSCL");k();}else{$.sap.log.info("SPL Startup","Invalid container invocation. Aborting","SAPSCL");sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:"Fatal Error",details:"Invalid application invocation"});throw new Error();}});}catch(e){if(e.constructor===ReferenceError()){jQuery.sap.log.error("SPL Startup",(e&&e.stack)?e.stack:"Reference Error in startup","SAPSCL");}else if(e.constructor===TypeError()){jQuery.sap.log.error("SPL Startup",(e&&e.stack)?e.stack:"Reference Error in startup","SAPSCL");}else{jQuery.sap.log.error("SPL Startup",(e&&e.message)?e.message:"Error","SAPSCL");}}}());
